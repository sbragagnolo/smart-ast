base 64 content
base64alarm
	^'Ly8gU3RyaW5nIFV0aWxzIHYwLjENCg0KLy8vIEB0aXRsZSBTdHJpbmcgVXRpbHMgLSBTdHJpbmcgdXRpbGl0eSBmdW5jdGlvbnMNCi8vLyBAYXV0aG9yIFBpcGVyIE1lcnJpYW0gLSANCmxpYnJhcnkgU3RyaW5nTGliIHsNCiAgICAvKg0KICAgICAqICBBZGRyZXNzOiAweDQ0M2I1MzU1OWQzMzcyNzczNzMxNzEyODBlYzU3MDI5NzE4MjAzZmINCiAgICAgKi8NCg0KICAgIC8vLyBAZGV2IENvbnZlcnRzIGFuIHVuc2lnbmVkIGludGVnZXJ0IHRvIGl0cyBzdHJpbmcgcmVwcmVzZW50YXRpb24uDQogICAgLy8vIEBwYXJhbSB2IFRoZSBudW1iZXIgdG8gYmUgY29udmVydGVkLg0KICAgIGZ1bmN0aW9uIHVpbnRUb0J5dGVzKHVpbnQgdikgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXMzMiByZXQpIHsNCiAgICAgICAgaWYgKHYgPT0gMCkgew0KICAgICAgICAgICAgcmV0ID0gJzAnOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgd2hpbGUgKHYgPiAwKSB7DQogICAgICAgICAgICAgICAgcmV0ID0gYnl0ZXMzMih1aW50KHJldCkgLyAoMiAqKiA4KSk7DQogICAgICAgICAgICAgICAgcmV0IHw9IGJ5dGVzMzIoKCh2ICUgMTApICsgNDgpICogMiAqKiAoOCAqIDMxKSk7DQogICAgICAgICAgICAgICAgdiAvPSAxMDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmV0Ow0KICAgIH0NCg0KICAgIC8vLyBAZGV2IENvbnZlcnRzIGEgbnVtZXJpYyBzdHJpbmcgdG8gaXQncyB1bnNpZ25lZCBpbnRlZ2VyIHJlcHJlc2VudGF0aW9uLg0KICAgIC8vLyBAcGFyYW0gdiBUaGUgc3RyaW5nIHRvIGJlIGNvbnZlcnRlZC4NCiAgICBmdW5jdGlvbiBieXRlc1RvVUludChieXRlczMyIHYpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgcmV0KSB7DQogICAgICAgIGlmICh2ID09IDB4MCkgew0KICAgICAgICAgICAgdGhyb3c7DQogICAgICAgIH0NCg0KICAgICAgICB1aW50IGRpZ2l0Ow0KDQogICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IDMyOyBpKyspIHsNCiAgICAgICAgICAgIGRpZ2l0ID0gdWludCgodWludCh2KSAvICgyICoqICg4ICogKDMxIC0gaSkpKSkgJiAweGZmKTsNCiAgICAgICAgICAgIGlmIChkaWdpdCA9PSAwKSB7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIGlmIChkaWdpdCA8IDQ4IHx8IGRpZ2l0ID4gNTcpIHsNCiAgICAgICAgICAgICAgICB0aHJvdzsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldCAqPSAxMDsNCiAgICAgICAgICAgIHJldCArPSAoZGlnaXQgLSA0OCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQp9DQoNCg0KLy8gQWNjb3VudGluZyB2MC4xIChub3QgdGhlIHNhbWUgYXMgdGhlIDAuMSByZWxlYXNlIG9mIHRoaXMgbGlicmFyeSkNCg0KLy8vIEB0aXRsZSBBY2NvdW50aW5nIExpYiAtIEFjY291bnRpbmcgdXRpbGl0aWVzDQovLy8gQGF1dGhvciBQaXBlciBNZXJyaWFtIC0gDQpsaWJyYXJ5IEFjY291bnRpbmdMaWIgew0KICAgICAgICAvKg0KICAgICAgICAgKiAgQWRkcmVzczogMHg3ZGU2MTVkOGE1MTc0NmE5ZjEwZjcyYTU5M2ZiNWIzNzE4ZGMzZDUyDQogICAgICAgICAqLw0KICAgICAgICBzdHJ1Y3QgQmFuayB7DQogICAgICAgICAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQpIGFjY291bnRCYWxhbmNlczsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vLyBAZGV2IExvdyBsZXZlbCBtZXRob2QgZm9yIGFkZGluZyBmdW5kcyB0byBhbiBhY2NvdW50LiAgUHJvdGVjdHMgYWdhaW5zdCBvdmVyZmxvdy4NCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBCYW5rIGluc3RhbmNlIHRvIG9wZXJhdGUgb24uDQogICAgICAgIC8vLyBAcGFyYW0gYWNjb3VudEFkZHJlc3MgVGhlIGFkZHJlc3Mgb2YgdGhlIGFjY291bnQgdGhlIGZ1bmRzIHNob3VsZCBiZSBhZGRlZCB0by4NCiAgICAgICAgLy8vIEBwYXJhbSB2YWx1ZSBUaGUgYW1vdW50IHRoYXQgc2hvdWxkIGJlIGFkZGVkIHRvIHRoZSBhY2NvdW50Lg0KICAgICAgICBmdW5jdGlvbiBhZGRGdW5kcyhCYW5rIHN0b3JhZ2Ugc2VsZiwgYWRkcmVzcyBhY2NvdW50QWRkcmVzcywgdWludCB2YWx1ZSkgcHVibGljIHsNCiAgICAgICAgICAgICAgICBpZiAoc2VsZi5hY2NvdW50QmFsYW5jZXNbYWNjb3VudEFkZHJlc3NdICsgdmFsdWUgPCBzZWxmLmFjY291bnRCYWxhbmNlc1thY2NvdW50QWRkcmVzc10pIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgT3ZlcmZsb3cuDQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdzsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50QmFsYW5jZXNbYWNjb3VudEFkZHJlc3NdICs9IHZhbHVlOw0KICAgICAgICB9DQoNCiAgICAgICAgZXZlbnQgX0RlcG9zaXQoYWRkcmVzcyBpbmRleGVkIF9mcm9tLCBhZGRyZXNzIGluZGV4ZWQgYWNjb3VudEFkZHJlc3MsIHVpbnQgdmFsdWUpOw0KICAgICAgICAvLy8gQGRldiBGdW5jdGlvbiB3cmFwcGVyIGFyb3VuZCB0aGUgX0RlcG9zaXQgZXZlbnQgc28gdGhhdCBpdCBjYW4gYmUgdXNlZCBieSBjb250cmFjdHMuICBDYW4gYmUgdXNlZCB0byBsb2cgYSBkZXBvc2l0IHRvIGFuIGFjY291bnQuDQogICAgICAgIC8vLyBAcGFyYW0gX2Zyb20gVGhlIGFkZHJlc3MgdGhhdCBkZXBvc2l0ZWQgdGhlIGZ1bmRzLg0KICAgICAgICAvLy8gQHBhcmFtIGFjY291bnRBZGRyZXNzIFRoZSBhZGRyZXNzIG9mIHRoZSBhY2NvdW50IHRoZSBmdW5kcyB3ZXJlIGFkZGVkIHRvLg0KICAgICAgICAvLy8gQHBhcmFtIHZhbHVlIFRoZSBhbW91bnQgdGhhdCB3YXMgYWRkZWQgdG8gdGhlIGFjY291bnQuDQogICAgICAgIGZ1bmN0aW9uIERlcG9zaXQoYWRkcmVzcyBfZnJvbSwgYWRkcmVzcyBhY2NvdW50QWRkcmVzcywgdWludCB2YWx1ZSkgcHVibGljIHsNCiAgICAgICAgICAgIF9EZXBvc2l0KF9mcm9tLCBhY2NvdW50QWRkcmVzcywgdmFsdWUpOw0KICAgICAgICB9DQoNCg0KICAgICAgICAvLy8gQGRldiBTYWZlIGZ1bmN0aW9uIGZvciBkZXBvc2l0aW5nIGZ1bmRzLiAgUmV0dXJucyBib29sZWFuIGZvciB3aGV0aGVyIHRoZSBkZXBvc2l0IHdhcyBzdWNjZXNzZnVsDQogICAgICAgIC8vLyBAcGFyYW0gc2VsZiBUaGUgQmFuayBpbnN0YW5jZSB0byBvcGVyYXRlIG9uLg0KICAgICAgICAvLy8gQHBhcmFtIGFjY291bnRBZGRyZXNzIFRoZSBhZGRyZXNzIG9mIHRoZSBhY2NvdW50IHRoZSBmdW5kcyBzaG91bGQgYmUgYWRkZWQgdG8uDQogICAgICAgIC8vLyBAcGFyYW0gdmFsdWUgVGhlIGFtb3VudCB0aGF0IHNob3VsZCBiZSBhZGRlZCB0byB0aGUgYWNjb3VudC4NCiAgICAgICAgZnVuY3Rpb24gZGVwb3NpdChCYW5rIHN0b3JhZ2Ugc2VsZiwgYWRkcmVzcyBhY2NvdW50QWRkcmVzcywgdWludCB2YWx1ZSkgcHVibGljIHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgICAgICBhZGRGdW5kcyhzZWxmLCBhY2NvdW50QWRkcmVzcywgdmFsdWUpOw0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQoNCiAgICAgICAgZXZlbnQgX1dpdGhkcmF3YWwoYWRkcmVzcyBpbmRleGVkIGFjY291bnRBZGRyZXNzLCB1aW50IHZhbHVlKTsNCg0KICAgICAgICAvLy8gQGRldiBGdW5jdGlvbiB3cmFwcGVyIGFyb3VuZCB0aGUgX1dpdGhkcmF3YWwgZXZlbnQgc28gdGhhdCBpdCBjYW4gYmUgdXNlZCBieSBjb250cmFjdHMuICBDYW4gYmUgdXNlZCB0byBsb2cgYSB3aXRoZHJhd2wgZnJvbSBhbiBhY2NvdW50Lg0KICAgICAgICAvLy8gQHBhcmFtIGFjY291bnRBZGRyZXNzIFRoZSBhZGRyZXNzIG9mIHRoZSBhY2NvdW50IHRoZSBmdW5kcyB3ZXJlIHdpdGhkcmF3biBmcm9tLg0KICAgICAgICAvLy8gQHBhcmFtIHZhbHVlIFRoZSBhbW91bnQgdGhhdCB3YXMgd2l0aGRyYXduIHRvIHRoZSBhY2NvdW50Lg0KICAgICAgICBmdW5jdGlvbiBXaXRoZHJhd2FsKGFkZHJlc3MgYWNjb3VudEFkZHJlc3MsIHVpbnQgdmFsdWUpIHB1YmxpYyB7DQogICAgICAgICAgICBfV2l0aGRyYXdhbChhY2NvdW50QWRkcmVzcywgdmFsdWUpOw0KICAgICAgICB9DQoNCiAgICAgICAgZXZlbnQgX0luc3VmZmljaWVudEZ1bmRzKGFkZHJlc3MgaW5kZXhlZCBhY2NvdW50QWRkcmVzcywgdWludCB2YWx1ZSwgdWludCBiYWxhbmNlKTsNCg0KICAgICAgICAvLy8gQGRldiBGdW5jdGlvbiB3cmFwcGVyIGFyb3VuZCB0aGUgX0luc3VmZmljaWVudEZ1bmRzIGV2ZW50IHNvIHRoYXQgaXQgY2FuIGJlIHVzZWQgYnkgY29udHJhY3RzLiAgQ2FuIGJlIHVzZWQgdG8gbG9nIGEgZmFpbGVkIHdpdGhkcmF3bCBmcm9tIGFuIGFjY291bnQuDQogICAgICAgIC8vLyBAcGFyYW0gYWNjb3VudEFkZHJlc3MgVGhlIGFkZHJlc3Mgb2YgdGhlIGFjY291bnQgdGhlIGZ1bmRzIHdlcmUgdG8gYmUgd2l0aGRyYXduIGZyb20uDQogICAgICAgIC8vLyBAcGFyYW0gdmFsdWUgVGhlIGFtb3VudCB0aGF0IHdhcyBhdHRlbXB0ZWQgdG8gYmUgd2l0aGRyYXduIGZyb20gdGhlIGFjY291bnQuDQogICAgICAgIC8vLyBAcGFyYW0gYmFsYW5jZSBUaGUgY3VycmVudCBiYWxhbmNlIG9mIHRoZSBhY2NvdW50Lg0KICAgICAgICBmdW5jdGlvbiBJbnN1ZmZpY2llbnRGdW5kcyhhZGRyZXNzIGFjY291bnRBZGRyZXNzLCB1aW50IHZhbHVlLCB1aW50IGJhbGFuY2UpIHB1YmxpYyB7DQogICAgICAgICAgICBfSW5zdWZmaWNpZW50RnVuZHMoYWNjb3VudEFkZHJlc3MsIHZhbHVlLCBiYWxhbmNlKTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vLyBAZGV2IExvdyBsZXZlbCBtZXRob2QgZm9yIHJlbW92aW5nIGZ1bmRzIGZyb20gYW4gYWNjb3VudC4gIFByb3RlY3RzIGFnYWluc3QgdW5kZXJmbG93Lg0KICAgICAgICAvLy8gQHBhcmFtIHNlbGYgVGhlIEJhbmsgaW5zdGFuY2UgdG8gb3BlcmF0ZSBvbi4NCiAgICAgICAgLy8vIEBwYXJhbSBhY2NvdW50QWRkcmVzcyBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudCB0aGUgZnVuZHMgc2hvdWxkIGJlIGRlZHVjdGVkIGZyb20uDQogICAgICAgIC8vLyBAcGFyYW0gdmFsdWUgVGhlIGFtb3VudCB0aGF0IHNob3VsZCBiZSBkZWR1Y3RlZCBmcm9tIHRoZSBhY2NvdW50Lg0KICAgICAgICBmdW5jdGlvbiBkZWR1Y3RGdW5kcyhCYW5rIHN0b3JhZ2Ugc2VsZiwgYWRkcmVzcyBhY2NvdW50QWRkcmVzcywgdWludCB2YWx1ZSkgcHVibGljIHsNCiAgICAgICAgICAgICAgICAvKg0KICAgICAgICAgICAgICAgICAqICBIZWxwZXIgZnVuY3Rpb24gdGhhdCBzaG91bGQgYmUgdXNlZCBmb3IgYW55IHJlZHVjdGlvbiBvZg0KICAgICAgICAgICAgICAgICAqICBhY2NvdW50IGZ1bmRzLiAgSXQgaGFzIGVycm9yIGNoZWNraW5nIHRvIHByZXZlbnQNCiAgICAgICAgICAgICAgICAgKiAgdW5kZXJmbG93aW5nIHRoZSBhY2NvdW50IGJhbGFuY2Ugd2hpY2ggd291bGQgYmUgUkVBTExZIGJhZC4NCiAgICAgICAgICAgICAgICAgKi8NCiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPiBzZWxmLmFjY291bnRCYWxhbmNlc1thY2NvdW50QWRkcmVzc10pIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFByZXZlbnQgVW5kZXJmbG93Lg0KICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3c7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHNlbGYuYWNjb3VudEJhbGFuY2VzW2FjY291bnRBZGRyZXNzXSAtPSB2YWx1ZTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vLyBAZGV2IFNhZmUgZnVuY3Rpb24gZm9yIHdpdGhkcmF3aW5nIGZ1bmRzLiAgUmV0dXJucyBib29sZWFuIGZvciB3aGV0aGVyIHRoZSBkZXBvc2l0IHdhcyBzdWNjZXNzZnVsIGFzIHdlbGwgYXMgc2VuZGluZyB0aGUgYW1vdW50IGluIGV0aGVyIHRvIHRoZSBhY2NvdW50IGFkZHJlc3MuDQogICAgICAgIC8vLyBAcGFyYW0gc2VsZiBUaGUgQmFuayBpbnN0YW5jZSB0byBvcGVyYXRlIG9uLg0KICAgICAgICAvLy8gQHBhcmFtIGFjY291bnRBZGRyZXNzIFRoZSBhZGRyZXNzIG9mIHRoZSBhY2NvdW50IHRoZSBmdW5kcyBzaG91bGQgYmUgd2l0aGRyYXduIGZyb20uDQogICAgICAgIC8vLyBAcGFyYW0gdmFsdWUgVGhlIGFtb3VudCB0aGF0IHNob3VsZCBiZSB3aXRoZHJhd24gZnJvbSB0aGUgYWNjb3VudC4NCiAgICAgICAgZnVuY3Rpb24gd2l0aGRyYXcoQmFuayBzdG9yYWdlIHNlbGYsIGFkZHJlc3MgYWNjb3VudEFkZHJlc3MsIHVpbnQgdmFsdWUpIHB1YmxpYyByZXR1cm5zIChib29sKSB7DQogICAgICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAgICAgKiAgUHVibGljIEFQSSBmb3Igd2l0aGRyYXdpbmcgZnVuZHMuDQogICAgICAgICAgICAgICAgICovDQogICAgICAgICAgICAgICAgaWYgKHNlbGYuYWNjb3VudEJhbGFuY2VzW2FjY291bnRBZGRyZXNzXSA+PSB2YWx1ZSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgZGVkdWN0RnVuZHMoc2VsZiwgYWNjb3VudEFkZHJlc3MsIHZhbHVlKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYWNjb3VudEFkZHJlc3Muc2VuZCh2YWx1ZSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUG90ZW50aWFsbHkgc2VuZGluZyBtb25leSB0byBhIGNvbnRyYWN0IHRoYXQNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaGFzIGEgZmFsbGJhY2sgZnVuY3Rpb24uICBTbyBpbnN0ZWFkLCB0cnkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHJhbmZlcnJpbmcgdGhlIGZ1bmRzIHdpdGggdGhlIGNhbGwgYXBpLg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFjY291bnRBZGRyZXNzLmNhbGwudmFsdWUodmFsdWUpKCkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXZlcnQgdGhlIGVudGlyZSB0cmFuc2FjdGlvbi4gIE5vDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbmVlZCB0byBkZXN0cm95IHRoZSBmdW5kcy4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdzsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfQ0KfQ0KDQovLyBHcm92ZSB2MC4zIChub3QgdGhlIHNhbWUgYXMgdGhlIDAuMyByZWxlYXNlIG9mIHRoaXMgbGlicmFyeSkNCg0KDQovLy8gQHRpdGxlIEdyb3ZlTGliIC0gTGlicmFyeSBmb3IgcXVlcmlhYmxlIGluZGV4ZWQgb3JkZXJlZCBkYXRhLg0KLy8vIEBhdXRob3IgUGlwZXJNZXJyaWFtIC0gDQpsaWJyYXJ5IEdyb3ZlTGliIHsNCiAgICAgICAgLyoNCiAgICAgICAgICogIEluZGV4ZXMgZm9yIG9yZGVyZWQgZGF0YQ0KICAgICAgICAgKg0KICAgICAgICAgKiAgQWRkcmVzczogMHg5MjBjODkwYTkwZGI4ZmJhNzYwNDg2NGIwY2YzOGVlNjY3MzMxMzIzDQogICAgICAgICAqLw0KICAgICAgICBzdHJ1Y3QgSW5kZXggew0KICAgICAgICAgICAgICAgIGJ5dGVzMzIgcm9vdDsNCiAgICAgICAgICAgICAgICBtYXBwaW5nIChieXRlczMyID0+IE5vZGUpIG5vZGVzOw0KICAgICAgICB9DQoNCiAgICAgICAgc3RydWN0IE5vZGUgew0KICAgICAgICAgICAgICAgIGJ5dGVzMzIgaWQ7DQogICAgICAgICAgICAgICAgaW50IHZhbHVlOw0KICAgICAgICAgICAgICAgIGJ5dGVzMzIgcGFyZW50Ow0KICAgICAgICAgICAgICAgIGJ5dGVzMzIgbGVmdDsNCiAgICAgICAgICAgICAgICBieXRlczMyIHJpZ2h0Ow0KICAgICAgICAgICAgICAgIHVpbnQgaGVpZ2h0Ow0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gbWF4KHVpbnQgYSwgdWludCBiKSBpbnRlcm5hbCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICBpZiAoYSA+PSBiKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGE7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qDQogICAgICAgICAqICBOb2RlIGdldHRlcnMNCiAgICAgICAgICovDQogICAgICAgIC8vLyBAZGV2IFJldHJpZXZlIHRoZSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIG5vZGUuDQogICAgICAgIC8vLyBAcGFyYW0gaW5kZXggVGhlIGluZGV4IHRoYXQgdGhlIG5vZGUgaXMgcGFydCBvZi4NCiAgICAgICAgLy8vIEBwYXJhbSBpZCBUaGUgaWQgZm9yIHRoZSBub2RlIHRvIGJlIGxvb2tlZCB1cC4NCiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUlkKEluZGV4IHN0b3JhZ2UgaW5kZXgsIGJ5dGVzMzIgaWQpIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzMzIpIHsNCiAgICAgICAgICAgIHJldHVybiBpbmRleC5ub2Rlc1tpZF0uaWQ7DQogICAgICAgIH0NCg0KICAgICAgICAvLy8gQGRldiBSZXRyaWV2ZSB0aGUgdmFsdWUgZm9yIHRoZSBub2RlLg0KICAgICAgICAvLy8gQHBhcmFtIGluZGV4IFRoZSBpbmRleCB0aGF0IHRoZSBub2RlIGlzIHBhcnQgb2YuDQogICAgICAgIC8vLyBAcGFyYW0gaWQgVGhlIGlkIGZvciB0aGUgbm9kZSB0byBiZSBsb29rZWQgdXAuDQogICAgICAgIGZ1bmN0aW9uIGdldE5vZGVWYWx1ZShJbmRleCBzdG9yYWdlIGluZGV4LCBieXRlczMyIGlkKSBjb25zdGFudCByZXR1cm5zIChpbnQpIHsNCiAgICAgICAgICAgIHJldHVybiBpbmRleC5ub2Rlc1tpZF0udmFsdWU7DQogICAgICAgIH0NCg0KICAgICAgICAvLy8gQGRldiBSZXRyaWV2ZSB0aGUgaGVpZ2h0IG9mIHRoZSBub2RlLg0KICAgICAgICAvLy8gQHBhcmFtIGluZGV4IFRoZSBpbmRleCB0aGF0IHRoZSBub2RlIGlzIHBhcnQgb2YuDQogICAgICAgIC8vLyBAcGFyYW0gaWQgVGhlIGlkIGZvciB0aGUgbm9kZSB0byBiZSBsb29rZWQgdXAuDQogICAgICAgIGZ1bmN0aW9uIGdldE5vZGVIZWlnaHQoSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgcmV0dXJuIGluZGV4Lm5vZGVzW2lkXS5oZWlnaHQ7DQogICAgICAgIH0NCg0KICAgICAgICAvLy8gQGRldiBSZXRyaWV2ZSB0aGUgcGFyZW50IGlkIG9mIHRoZSBub2RlLg0KICAgICAgICAvLy8gQHBhcmFtIGluZGV4IFRoZSBpbmRleCB0aGF0IHRoZSBub2RlIGlzIHBhcnQgb2YuDQogICAgICAgIC8vLyBAcGFyYW0gaWQgVGhlIGlkIGZvciB0aGUgbm9kZSB0byBiZSBsb29rZWQgdXAuDQogICAgICAgIGZ1bmN0aW9uIGdldE5vZGVQYXJlbnQoSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXMzMikgew0KICAgICAgICAgICAgcmV0dXJuIGluZGV4Lm5vZGVzW2lkXS5wYXJlbnQ7DQogICAgICAgIH0NCg0KICAgICAgICAvLy8gQGRldiBSZXRyaWV2ZSB0aGUgbGVmdCBjaGlsZCBpZCBvZiB0aGUgbm9kZS4NCiAgICAgICAgLy8vIEBwYXJhbSBpbmRleCBUaGUgaW5kZXggdGhhdCB0aGUgbm9kZSBpcyBwYXJ0IG9mLg0KICAgICAgICAvLy8gQHBhcmFtIGlkIFRoZSBpZCBmb3IgdGhlIG5vZGUgdG8gYmUgbG9va2VkIHVwLg0KICAgICAgICBmdW5jdGlvbiBnZXROb2RlTGVmdENoaWxkKEluZGV4IHN0b3JhZ2UgaW5kZXgsIGJ5dGVzMzIgaWQpIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzMzIpIHsNCiAgICAgICAgICAgIHJldHVybiBpbmRleC5ub2Rlc1tpZF0ubGVmdDsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vLyBAZGV2IFJldHJpZXZlIHRoZSByaWdodCBjaGlsZCBpZCBvZiB0aGUgbm9kZS4NCiAgICAgICAgLy8vIEBwYXJhbSBpbmRleCBUaGUgaW5kZXggdGhhdCB0aGUgbm9kZSBpcyBwYXJ0IG9mLg0KICAgICAgICAvLy8gQHBhcmFtIGlkIFRoZSBpZCBmb3IgdGhlIG5vZGUgdG8gYmUgbG9va2VkIHVwLg0KICAgICAgICBmdW5jdGlvbiBnZXROb2RlUmlnaHRDaGlsZChJbmRleCBzdG9yYWdlIGluZGV4LCBieXRlczMyIGlkKSBjb25zdGFudCByZXR1cm5zIChieXRlczMyKSB7DQogICAgICAgICAgICByZXR1cm4gaW5kZXgubm9kZXNbaWRdLnJpZ2h0Ow0KICAgICAgICB9DQoNCiAgICAgICAgLy8vIEBkZXYgUmV0cmlldmUgdGhlIG5vZGUgaWQgb2YgdGhlIG5leHQgbm9kZSBpbiB0aGUgdHJlZS4NCiAgICAgICAgLy8vIEBwYXJhbSBpbmRleCBUaGUgaW5kZXggdGhhdCB0aGUgbm9kZSBpcyBwYXJ0IG9mLg0KICAgICAgICAvLy8gQHBhcmFtIGlkIFRoZSBpZCBmb3IgdGhlIG5vZGUgdG8gYmUgbG9va2VkIHVwLg0KICAgICAgICBmdW5jdGlvbiBnZXRQcmV2aW91c05vZGUoSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXMzMikgew0KICAgICAgICAgICAgTm9kZSBzdG9yYWdlIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbaWRdOw0KDQogICAgICAgICAgICBpZiAoY3VycmVudE5vZGUuaWQgPT0gMHgwKSB7DQogICAgICAgICAgICAgICAgLy8gVW5rbm93biBub2RlLCBqdXN0IHJldHVybiAweDA7DQogICAgICAgICAgICAgICAgcmV0dXJuIDB4MDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgTm9kZSBtZW1vcnkgY2hpbGQ7DQoNCiAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5sZWZ0ICE9IDB4MCkgew0KICAgICAgICAgICAgICAgIC8vIFRyYWNlIGxlZnQgdG8gbGF0ZXN0IGNoaWxkIGluIGxlZnQgdHJlZS4NCiAgICAgICAgICAgICAgICBjaGlsZCA9IGluZGV4Lm5vZGVzW2N1cnJlbnROb2RlLmxlZnRdOw0KDQogICAgICAgICAgICAgICAgd2hpbGUgKGNoaWxkLnJpZ2h0ICE9IDApIHsNCiAgICAgICAgICAgICAgICAgICAgY2hpbGQgPSBpbmRleC5ub2Rlc1tjaGlsZC5yaWdodF07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZC5pZDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnBhcmVudCAhPSAweDApIHsNCiAgICAgICAgICAgICAgICAvLyBOb3cgd2UgdHJhY2UgYmFjayB1cCB0aHJvdWdoIHBhcmVudCByZWxhdGlvbnNoaXBzLCBsb29raW5nDQogICAgICAgICAgICAgICAgLy8gZm9yIGEgbGluayB3aGVyZSB0aGUgY2hpbGQgaXMgdGhlIHJpZ2h0IGNoaWxkIG9mIGl0J3MNCiAgICAgICAgICAgICAgICAvLyBwYXJlbnQuDQogICAgICAgICAgICAgICAgTm9kZSBzdG9yYWdlIHBhcmVudCA9IGluZGV4Lm5vZGVzW2N1cnJlbnROb2RlLnBhcmVudF07DQogICAgICAgICAgICAgICAgY2hpbGQgPSBjdXJyZW50Tm9kZTsNCg0KICAgICAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7DQogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQucmlnaHQgPT0gY2hpbGQuaWQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnQuaWQ7DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LnBhcmVudCA9PSAweDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGNoaWxkID0gcGFyZW50Ow0KICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBpbmRleC5ub2Rlc1twYXJlbnQucGFyZW50XTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIFRoaXMgaXMgdGhlIGZpcnN0IG5vZGUsIGFuZCBoYXMgbm8gcHJldmlvdXMgbm9kZS4NCiAgICAgICAgICAgIHJldHVybiAweDA7DQogICAgICAgIH0NCg0KICAgICAgICAvLy8gQGRldiBSZXRyaWV2ZSB0aGUgbm9kZSBpZCBvZiB0aGUgcHJldmlvdXMgbm9kZSBpbiB0aGUgdHJlZS4NCiAgICAgICAgLy8vIEBwYXJhbSBpbmRleCBUaGUgaW5kZXggdGhhdCB0aGUgbm9kZSBpcyBwYXJ0IG9mLg0KICAgICAgICAvLy8gQHBhcmFtIGlkIFRoZSBpZCBmb3IgdGhlIG5vZGUgdG8gYmUgbG9va2VkIHVwLg0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0Tm9kZShJbmRleCBzdG9yYWdlIGluZGV4LCBieXRlczMyIGlkKSBjb25zdGFudCByZXR1cm5zIChieXRlczMyKSB7DQogICAgICAgICAgICBOb2RlIHN0b3JhZ2UgY3VycmVudE5vZGUgPSBpbmRleC5ub2Rlc1tpZF07DQoNCiAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5pZCA9PSAweDApIHsNCiAgICAgICAgICAgICAgICAvLyBVbmtub3duIG5vZGUsIGp1c3QgcmV0dXJuIDB4MDsNCiAgICAgICAgICAgICAgICByZXR1cm4gMHgwOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBOb2RlIG1lbW9yeSBjaGlsZDsNCg0KICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnJpZ2h0ICE9IDB4MCkgew0KICAgICAgICAgICAgICAgIC8vIFRyYWNlIHJpZ2h0IHRvIGVhcmxpZXN0IGNoaWxkIGluIHJpZ2h0IHRyZWUuDQogICAgICAgICAgICAgICAgY2hpbGQgPSBpbmRleC5ub2Rlc1tjdXJyZW50Tm9kZS5yaWdodF07DQoNCiAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQubGVmdCAhPSAwKSB7DQogICAgICAgICAgICAgICAgICAgIGNoaWxkID0gaW5kZXgubm9kZXNbY2hpbGQubGVmdF07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZC5pZDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnBhcmVudCAhPSAweDApIHsNCiAgICAgICAgICAgICAgICAvLyBpZiB0aGUgbm9kZSBpcyB0aGUgbGVmdCBjaGlsZCBvZiBpdCdzIHBhcmVudCwgdGhlbiB0aGUNCiAgICAgICAgICAgICAgICAvLyBwYXJlbnQgaXMgdGhlIG5leHQgb25lLg0KICAgICAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBwYXJlbnQgPSBpbmRleC5ub2Rlc1tjdXJyZW50Tm9kZS5wYXJlbnRdOw0KICAgICAgICAgICAgICAgIGNoaWxkID0gY3VycmVudE5vZGU7DQoNCiAgICAgICAgICAgICAgICB3aGlsZSAodHJ1ZSkgew0KICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LmxlZnQgPT0gY2hpbGQuaWQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnQuaWQ7DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LnBhcmVudCA9PSAweDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGNoaWxkID0gcGFyZW50Ow0KICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBpbmRleC5ub2Rlc1twYXJlbnQucGFyZW50XTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvLyBOb3cgd2UgbmVlZCB0byB0cmFjZSBhbGwgdGhlIHdheSB1cCBjaGVja2luZyB0byBzZWUgaWYgYW55IHBhcmVudCBpcyB0aGUgDQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIFRoaXMgaXMgdGhlIGZpbmFsIG5vZGUuDQogICAgICAgICAgICByZXR1cm4gMHgwOw0KICAgICAgICB9DQoNCg0KICAgICAgICAvLy8gQGRldiBVcGRhdGVzIG9yIEluc2VydHMgdGhlIGlkIGludG8gdGhlIGluZGV4IGF0IGl0cyBhcHByb3ByaWF0ZSBsb2NhdGlvbiBiYXNlZCBvbiB0aGUgdmFsdWUgcHJvdmlkZWQuDQogICAgICAgIC8vLyBAcGFyYW0gaW5kZXggVGhlIGluZGV4IHRoYXQgdGhlIG5vZGUgaXMgcGFydCBvZi4NCiAgICAgICAgLy8vIEBwYXJhbSBpZCBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGRhdGEgZWxlbWVudCB0aGUgaW5kZXggbm9kZSB3aWxsIHJlcHJlc2VudC4NCiAgICAgICAgLy8vIEBwYXJhbSB2YWx1ZSBUaGUgdmFsdWUgb2YgdGhlIGRhdGEgZWxlbWVudCB0aGF0IHJlcHJlc2VudHMgaXQncyB0b3RhbCBvcmRlcmluZyB3aXRoIHJlc3BlY3QgdG8gb3RoZXIgZWxlbWVudGVzLg0KICAgICAgICBmdW5jdGlvbiBpbnNlcnQoSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCwgaW50IHZhbHVlKSBwdWJsaWMgew0KICAgICAgICAgICAgICAgIGlmIChpbmRleC5ub2Rlc1tpZF0uaWQgPT0gaWQpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gQSBub2RlIHdpdGggdGhpcyBpZCBhbHJlYWR5IGV4aXN0cy4gIElmIHRoZSB2YWx1ZSBpcw0KICAgICAgICAgICAgICAgICAgICAvLyB0aGUgc2FtZSwgdGhlbiBqdXN0IHJldHVybiBlYXJseSwgb3RoZXJ3aXNlLCByZW1vdmUgaXQNCiAgICAgICAgICAgICAgICAgICAgLy8gYW5kIHJlaW5zZXJ0IGl0Lg0KICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXgubm9kZXNbaWRdLnZhbHVlID09IHZhbHVlKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlKGluZGV4LCBpZCk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgdWludCBsZWZ0SGVpZ2h0Ow0KICAgICAgICAgICAgICAgIHVpbnQgcmlnaHRIZWlnaHQ7DQoNCiAgICAgICAgICAgICAgICBieXRlczMyIHByZXZpb3VzTm9kZUlkID0gMHgwOw0KDQogICAgICAgICAgICAgICAgaWYgKGluZGV4LnJvb3QgPT0gMHgwKSB7DQogICAgICAgICAgICAgICAgICAgIGluZGV4LnJvb3QgPSBpZDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgTm9kZSBzdG9yYWdlIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbaW5kZXgucm9vdF07DQoNCiAgICAgICAgICAgICAgICAvLyBEbyBpbnNlcnRpb24NCiAgICAgICAgICAgICAgICB3aGlsZSAodHJ1ZSkgew0KICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUuaWQgPT0gMHgwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGEgbmV3IHVucG9wdWxhdGVkIG5vZGUuDQogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5pZCA9IGlkOw0KICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUucGFyZW50ID0gcHJldmlvdXNOb2RlSWQ7DQogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWx1ZSA9IHZhbHVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIHByZXZpb3VzIG5vZGUgaWQuDQogICAgICAgICAgICAgICAgICAgIHByZXZpb3VzTm9kZUlkID0gY3VycmVudE5vZGUuaWQ7DQoNCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIG5ldyBub2RlIGJlbG9uZ3MgaW4gdGhlIHJpZ2h0IHN1YnRyZWUNCiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID49IGN1cnJlbnROb2RlLnZhbHVlKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUucmlnaHQgPT0gMHgwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUucmlnaHQgPSBpZDsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbY3VycmVudE5vZGUucmlnaHRdOw0KICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAvLyBUaGUgbmV3IG5vZGUgYmVsb25ncyBpbiB0aGUgbGVmdCBzdWJ0cmVlLg0KICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUubGVmdCA9PSAweDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmxlZnQgPSBpZDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGluZGV4Lm5vZGVzW2N1cnJlbnROb2RlLmxlZnRdOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vIFJlYmFsYW5jZSB0aGUgdHJlZQ0KICAgICAgICAgICAgICAgIF9yZWJhbGFuY2VUcmVlKGluZGV4LCBjdXJyZW50Tm9kZS5pZCk7DQogICAgICAgIH0NCg0KICAgICAgICAvLy8gQGRldiBDaGVja3Mgd2hldGhlciBhIG5vZGUgZm9yIHRoZSBnaXZlbiB1bmlxdWUgaWRlbnRpZmllciBleGlzdHMgd2l0aGluIHRoZSBnaXZlbiBpbmRleC4NCiAgICAgICAgLy8vIEBwYXJhbSBpbmRleCBUaGUgaW5kZXggdGhhdCBzaG91bGQgYmUgc2VhcmNoZWQNCiAgICAgICAgLy8vIEBwYXJhbSBpZCBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGRhdGEgZWxlbWVudCB0byBjaGVjayBmb3IuDQogICAgICAgIGZ1bmN0aW9uIGV4aXN0cyhJbmRleCBzdG9yYWdlIGluZGV4LCBieXRlczMyIGlkKSBjb25zdGFudCByZXR1cm5zIChib29sKSB7DQogICAgICAgICAgICByZXR1cm4gKGluZGV4Lm5vZGVzW2lkXS5pZCA9PSBpZCk7DQogICAgICAgIH0NCg0KICAgICAgICAvLy8gQGRldiBSZW1vdmUgdGhlIG5vZGUgZm9yIHRoZSBnaXZlbiB1bmlxdWUgaWRlbnRpZmllciBmcm9tIHRoZSBpbmRleC4NCiAgICAgICAgLy8vIEBwYXJhbSBpbmRleCBUaGUgaW5kZXggdGhhdCBzaG91bGQgYmUgcmVtb3ZlZA0KICAgICAgICAvLy8gQHBhcmFtIGlkIFRoZSB1bmlxdWUgaWRlbnRpZmllciBvZiB0aGUgZGF0YSBlbGVtZW50IHRvIHJlbW92ZS4NCiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlKEluZGV4IHN0b3JhZ2UgaW5kZXgsIGJ5dGVzMzIgaWQpIHB1YmxpYyB7DQogICAgICAgICAgICBOb2RlIHN0b3JhZ2UgcmVwbGFjZW1lbnROb2RlOw0KICAgICAgICAgICAgTm9kZSBzdG9yYWdlIHBhcmVudDsNCiAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBjaGlsZDsNCiAgICAgICAgICAgIGJ5dGVzMzIgcmViYWxhbmNlT3JpZ2luOw0KDQogICAgICAgICAgICBOb2RlIHN0b3JhZ2Ugbm9kZVRvRGVsZXRlID0gaW5kZXgubm9kZXNbaWRdOw0KDQogICAgICAgICAgICBpZiAobm9kZVRvRGVsZXRlLmlkICE9IGlkKSB7DQogICAgICAgICAgICAgICAgLy8gVGhlIGlkIGRvZXMgbm90IGV4aXN0IGluIHRoZSB0cmVlLg0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKG5vZGVUb0RlbGV0ZS5sZWZ0ICE9IDB4MCB8fCBub2RlVG9EZWxldGUucmlnaHQgIT0gMHgwKSB7DQogICAgICAgICAgICAgICAgLy8gVGhpcyBub2RlIGlzIG5vdCBhIGxlYWYgbm9kZSBhbmQgdGh1cyBtdXN0IHJlcGxhY2UgaXRzZWxmIGluDQogICAgICAgICAgICAgICAgLy8gaXQncyB0cmVlIGJ5IGVpdGhlciB0aGUgcHJldmlvdXMgb3IgbmV4dCBub2RlLg0KICAgICAgICAgICAgICAgIGlmIChub2RlVG9EZWxldGUubGVmdCAhPSAweDApIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBub2RlIGlzIGd1YXJhbnRlZWQgdG8gbm90IGhhdmUgYSByaWdodCBjaGlsZC4NCiAgICAgICAgICAgICAgICAgICAgcmVwbGFjZW1lbnROb2RlID0gaW5kZXgubm9kZXNbZ2V0UHJldmlvdXNOb2RlKGluZGV4LCBub2RlVG9EZWxldGUuaWQpXTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgbm9kZSBpcyBndWFyYW50ZWVkIHRvIG5vdCBoYXZlIGEgbGVmdCBjaGlsZC4NCiAgICAgICAgICAgICAgICAgICAgcmVwbGFjZW1lbnROb2RlID0gaW5kZXgubm9kZXNbZ2V0TmV4dE5vZGUoaW5kZXgsIG5vZGVUb0RlbGV0ZS5pZCldOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAvLyBUaGUgcmVwbGFjZW1lbnROb2RlIGlzIGd1YXJhbnRlZWQgdG8gaGF2ZSBhIHBhcmVudC4NCiAgICAgICAgICAgICAgICBwYXJlbnQgPSBpbmRleC5ub2Rlc1tyZXBsYWNlbWVudE5vZGUucGFyZW50XTsNCg0KICAgICAgICAgICAgICAgIC8vIEtlZXAgbm90ZSBvZiB0aGUgbG9jYXRpb24gdGhhdCBvdXIgdHJlZSByZWJhbGFuY2luZyBzaG91bGQNCiAgICAgICAgICAgICAgICAvLyBzdGFydCBhdC4NCiAgICAgICAgICAgICAgICByZWJhbGFuY2VPcmlnaW4gPSByZXBsYWNlbWVudE5vZGUuaWQ7DQoNCiAgICAgICAgICAgICAgICAvLyBKb2luIHRoZSBwYXJlbnQgb2YgdGhlIHJlcGxhY2VtZW50IG5vZGUgd2l0aCBhbnkgc3VidHJlZSBvZg0KICAgICAgICAgICAgICAgIC8vIHRoZSByZXBsYWNlbWVudCBub2RlLiAgV2UgY2FuIGd1YXJhbnRlZSB0aGF0IHRoZSByZXBsYWNlbWVudA0KICAgICAgICAgICAgICAgIC8vIG5vZGUgaGFzIGF0IG1vc3Qgb25lIHN1YnRyZWUgYmVjYXVzZSBvZiBob3cgZ2V0TmV4dE5vZGUgYW5kDQogICAgICAgICAgICAgICAgLy8gZ2V0UHJldmlvdXNOb2RlIGFyZSB1c2VkLg0KICAgICAgICAgICAgICAgIGlmIChwYXJlbnQubGVmdCA9PSByZXBsYWNlbWVudE5vZGUuaWQpIHsNCiAgICAgICAgICAgICAgICAgICAgcGFyZW50LmxlZnQgPSByZXBsYWNlbWVudE5vZGUucmlnaHQ7DQogICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlbWVudE5vZGUucmlnaHQgIT0gMHgwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IGluZGV4Lm5vZGVzW3JlcGxhY2VtZW50Tm9kZS5yaWdodF07DQogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZC5wYXJlbnQgPSBwYXJlbnQuaWQ7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYgKHBhcmVudC5yaWdodCA9PSByZXBsYWNlbWVudE5vZGUuaWQpIHsNCiAgICAgICAgICAgICAgICAgICAgcGFyZW50LnJpZ2h0ID0gcmVwbGFjZW1lbnROb2RlLmxlZnQ7DQogICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlbWVudE5vZGUubGVmdCAhPSAweDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkID0gaW5kZXgubm9kZXNbcmVwbGFjZW1lbnROb2RlLmxlZnRdOw0KICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQucGFyZW50ID0gcGFyZW50LmlkOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy8gTm93IHdlIHJlcGxhY2UgdGhlIG5vZGVUb0RlbGV0ZSB3aXRoIHRoZSByZXBsYWNlbWVudE5vZGUuDQogICAgICAgICAgICAgICAgLy8gVGhpcyBpbmNsdWRlcyBwYXJlbnQvY2hpbGQgcmVsYXRpb25zaGlwcyBmb3IgYWxsIG9mIHRoZQ0KICAgICAgICAgICAgICAgIC8vIHBhcmVudCwgdGhlIGxlZnQgY2hpbGQsIGFuZCB0aGUgcmlnaHQgY2hpbGQuDQogICAgICAgICAgICAgICAgcmVwbGFjZW1lbnROb2RlLnBhcmVudCA9IG5vZGVUb0RlbGV0ZS5wYXJlbnQ7DQogICAgICAgICAgICAgICAgaWYgKG5vZGVUb0RlbGV0ZS5wYXJlbnQgIT0gMHgwKSB7DQogICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IGluZGV4Lm5vZGVzW25vZGVUb0RlbGV0ZS5wYXJlbnRdOw0KICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LmxlZnQgPT0gbm9kZVRvRGVsZXRlLmlkKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQubGVmdCA9IHJlcGxhY2VtZW50Tm9kZS5pZDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LnJpZ2h0ID09IG5vZGVUb0RlbGV0ZS5pZCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50LnJpZ2h0ID0gcmVwbGFjZW1lbnROb2RlLmlkOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgbm9kZSB3ZSBhcmUgZGVsZXRpbmcgaXMgdGhlIHJvb3Qgbm9kZSB1cGRhdGUgdGhlDQogICAgICAgICAgICAgICAgICAgIC8vIGluZGV4IHJvb3Qgbm9kZSBwb2ludGVyLg0KICAgICAgICAgICAgICAgICAgICBpbmRleC5yb290ID0gcmVwbGFjZW1lbnROb2RlLmlkOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIHJlcGxhY2VtZW50Tm9kZS5sZWZ0ID0gbm9kZVRvRGVsZXRlLmxlZnQ7DQogICAgICAgICAgICAgICAgaWYgKG5vZGVUb0RlbGV0ZS5sZWZ0ICE9IDB4MCkgew0KICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IGluZGV4Lm5vZGVzW25vZGVUb0RlbGV0ZS5sZWZ0XTsNCiAgICAgICAgICAgICAgICAgICAgY2hpbGQucGFyZW50ID0gcmVwbGFjZW1lbnROb2RlLmlkOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIHJlcGxhY2VtZW50Tm9kZS5yaWdodCA9IG5vZGVUb0RlbGV0ZS5yaWdodDsNCiAgICAgICAgICAgICAgICBpZiAobm9kZVRvRGVsZXRlLnJpZ2h0ICE9IDB4MCkgew0KICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IGluZGV4Lm5vZGVzW25vZGVUb0RlbGV0ZS5yaWdodF07DQogICAgICAgICAgICAgICAgICAgIGNoaWxkLnBhcmVudCA9IHJlcGxhY2VtZW50Tm9kZS5pZDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIGlmIChub2RlVG9EZWxldGUucGFyZW50ICE9IDB4MCkgew0KICAgICAgICAgICAgICAgIC8vIFRoZSBub2RlIGJlaW5nIGRlbGV0ZWQgaXMgYSBsZWFmIG5vZGUgc28gd2Ugb25seSBlcmFzZSBpdCdzDQogICAgICAgICAgICAgICAgLy8gcGFyZW50IGxpbmthZ2UuDQogICAgICAgICAgICAgICAgcGFyZW50ID0gaW5kZXgubm9kZXNbbm9kZVRvRGVsZXRlLnBhcmVudF07DQoNCiAgICAgICAgICAgICAgICBpZiAocGFyZW50LmxlZnQgPT0gbm9kZVRvRGVsZXRlLmlkKSB7DQogICAgICAgICAgICAgICAgICAgIHBhcmVudC5sZWZ0ID0gMHgwOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZiAocGFyZW50LnJpZ2h0ID09IG5vZGVUb0RlbGV0ZS5pZCkgew0KICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmlnaHQgPSAweDA7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy8ga2VlcCBub3RlIG9mIHdoZXJlIHRoZSByZWJhbGFuY2luZyBzaG91bGQgYmVnaW4uDQogICAgICAgICAgICAgICAgcmViYWxhbmNlT3JpZ2luID0gcGFyZW50LmlkOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBib3RoIGEgbGVhZiBub2RlIGFuZCB0aGUgcm9vdCBub2RlLCBzbyB3ZSBuZWVkIHRvDQogICAgICAgICAgICAgICAgLy8gdW5zZXQgdGhlIHJvb3Qgbm9kZSBwb2ludGVyLg0KICAgICAgICAgICAgICAgIGluZGV4LnJvb3QgPSAweDA7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIE5vdyB3ZSB6ZXJvIG91dCBhbGwgb2YgdGhlIGZpZWxkcyBvbiB0aGUgbm9kZVRvRGVsZXRlLg0KICAgICAgICAgICAgbm9kZVRvRGVsZXRlLmlkID0gMHgwOw0KICAgICAgICAgICAgbm9kZVRvRGVsZXRlLnZhbHVlID0gMDsNCiAgICAgICAgICAgIG5vZGVUb0RlbGV0ZS5wYXJlbnQgPSAweDA7DQogICAgICAgICAgICBub2RlVG9EZWxldGUubGVmdCA9IDB4MDsNCiAgICAgICAgICAgIG5vZGVUb0RlbGV0ZS5yaWdodCA9IDB4MDsNCg0KICAgICAgICAgICAgLy8gV2FsayBiYWNrIHVwIHRoZSB0cmVlIHJlYmFsYW5jaW5nDQogICAgICAgICAgICBpZiAocmViYWxhbmNlT3JpZ2luICE9IDB4MCkgew0KICAgICAgICAgICAgICAgIF9yZWJhbGFuY2VUcmVlKGluZGV4LCByZWJhbGFuY2VPcmlnaW4pOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgYnl0ZXMyIGNvbnN0YW50IEdUID0gIj4iOw0KICAgICAgICBieXRlczIgY29uc3RhbnQgTFQgPSAiPCI7DQogICAgICAgIGJ5dGVzMiBjb25zdGFudCBHVEUgPSAiPj0iOw0KICAgICAgICBieXRlczIgY29uc3RhbnQgTFRFID0gIjw9IjsNCiAgICAgICAgYnl0ZXMyIGNvbnN0YW50IEVRID0gIj09IjsNCg0KICAgICAgICBmdW5jdGlvbiBfY29tcGFyZShpbnQgbGVmdCwgYnl0ZXMyIG9wZXJhdG9yLCBpbnQgcmlnaHQpIGludGVybmFsIHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgIGlmIChvcGVyYXRvciA9PSBHVCkgew0KICAgICAgICAgICAgICAgIHJldHVybiAobGVmdCA+IHJpZ2h0KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChvcGVyYXRvciA9PSBMVCkgew0KICAgICAgICAgICAgICAgIHJldHVybiAobGVmdCA8IHJpZ2h0KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChvcGVyYXRvciA9PSBHVEUpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gKGxlZnQgPj0gcmlnaHQpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKG9wZXJhdG9yID09IExURSkgew0KICAgICAgICAgICAgICAgIHJldHVybiAobGVmdCA8PSByaWdodCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAob3BlcmF0b3IgPT0gRVEpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gKGxlZnQgPT0gcmlnaHQpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBJbnZhbGlkIG9wZXJhdG9yLg0KICAgICAgICAgICAgdGhyb3c7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBfZ2V0TWF4aW11bShJbmRleCBzdG9yYWdlIGluZGV4LCBieXRlczMyIGlkKSBpbnRlcm5hbCByZXR1cm5zIChpbnQpIHsNCiAgICAgICAgICAgICAgICBOb2RlIHN0b3JhZ2UgY3VycmVudE5vZGUgPSBpbmRleC5ub2Rlc1tpZF07DQoNCiAgICAgICAgICAgICAgICB3aGlsZSAodHJ1ZSkgew0KICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUucmlnaHQgPT0gMHgwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudE5vZGUudmFsdWU7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBpbmRleC5ub2Rlc1tjdXJyZW50Tm9kZS5yaWdodF07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gX2dldE1pbmltdW0oSW5kZXggc3RvcmFnZSBpbmRleCwgYnl0ZXMzMiBpZCkgaW50ZXJuYWwgcmV0dXJucyAoaW50KSB7DQogICAgICAgICAgICAgICAgTm9kZSBzdG9yYWdlIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbaWRdOw0KDQogICAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLmxlZnQgPT0gMHgwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudE5vZGUudmFsdWU7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBpbmRleC5ub2Rlc1tjdXJyZW50Tm9kZS5sZWZ0XTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgIH0NCg0KDQogICAgICAgIC8qKiBAZGV2IFF1ZXJ5IHRoZSBpbmRleCBmb3IgdGhlIGVkZ2UtbW9zdCBub2RlIHRoYXQgc2F0aXNmaWVzIHRoZQ0KICAgICAgICAgKiAgZ2l2ZW4gcXVlcnkuICBGb3IgPiwgPj0sIGFuZCA9PSwgdGhpcyB3aWxsIGJlIHRoZSBsZWZ0LW1vc3Qgbm9kZQ0KICAgICAgICAgKiAgdGhhdCBzYXRpc2ZpZXMgdGhlIGNvbXBhcmlzb24uICBGb3IgPCBhbmQgPD0gdGhpcyB3aWxsIGJlIHRoZQ0KICAgICAgICAgKiAgcmlnaHQtbW9zdCBub2RlIHRoYXQgc2F0aXNmaWVzIHRoZSBjb21wYXJpc29uLg0KICAgICAgICAgKi8NCiAgICAgICAgLy8vIEBwYXJhbSBpbmRleCBUaGUgaW5kZXggdGhhdCBzaG91bGQgYmUgcXVlcmllZA0KICAgICAgICAvKiogQHBhcmFtIG9wZXJhdG9yIE9uZSBvZiAnPicsICc+PScsICc8JywgJzw9JywgJz09JyB0byBzcGVjaWZ5IHdoYXQNCiAgICAgICAgICogIHR5cGUgb2YgY29tcGFyaXNvbiBvcGVyYXRvciBzaG91bGQgYmUgdXNlZC4NCiAgICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIHF1ZXJ5KEluZGV4IHN0b3JhZ2UgaW5kZXgsIGJ5dGVzMiBvcGVyYXRvciwgaW50IHZhbHVlKSBwdWJsaWMgcmV0dXJucyAoYnl0ZXMzMikgew0KICAgICAgICAgICAgICAgIGJ5dGVzMzIgcm9vdE5vZGVJZCA9IGluZGV4LnJvb3Q7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYgKHJvb3ROb2RlSWQgPT0gMHgwKSB7DQogICAgICAgICAgICAgICAgICAgIC8vIEVtcHR5IHRyZWUuDQogICAgICAgICAgICAgICAgICAgIHJldHVybiAweDA7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgTm9kZSBzdG9yYWdlIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbcm9vdE5vZGVJZF07DQoNCiAgICAgICAgICAgICAgICB3aGlsZSAodHJ1ZSkgew0KICAgICAgICAgICAgICAgICAgICBpZiAoX2NvbXBhcmUoY3VycmVudE5vZGUudmFsdWUsIG9wZXJhdG9yLCB2YWx1ZSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGhhdmUgZm91bmQgYSBtYXRjaCBidXQgaXQgbWlnaHQgbm90IGJlIHRoZQ0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gKmNvcnJlY3QqIG1hdGNoLg0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChvcGVyYXRvciA9PSBMVCkgfHwgKG9wZXJhdG9yID09IExURSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOZWVkIHRvIGtlZXAgdHJhdmVyc2luZyByaWdodCB1bnRpbCB0aGlzIGlzIG5vDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbG9uZ2VyIHRydWUuDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnJpZ2h0ID09IDB4MCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudE5vZGUuaWQ7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfY29tcGFyZShfZ2V0TWluaW11bShpbmRleCwgY3VycmVudE5vZGUucmlnaHQpLCBvcGVyYXRvciwgdmFsdWUpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZXJlIGFyZSBzdGlsbCBub2RlcyB0byB0aGUgcmlnaHQgdGhhdA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBtYXRjaC4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBpbmRleC5ub2Rlc1tjdXJyZW50Tm9kZS5yaWdodF07DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudE5vZGUuaWQ7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgob3BlcmF0b3IgPT0gR1QpIHx8IChvcGVyYXRvciA9PSBHVEUpIHx8IChvcGVyYXRvciA9PSBFUSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOZWVkIHRvIGtlZXAgdHJhdmVyc2luZyBsZWZ0IHVudGlsIHRoaXMgaXMgbm8NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsb25nZXIgdHJ1ZS4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUubGVmdCA9PSAweDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnROb2RlLmlkOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2NvbXBhcmUoX2dldE1heGltdW0oaW5kZXgsIGN1cnJlbnROb2RlLmxlZnQpLCBvcGVyYXRvciwgdmFsdWUpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbY3VycmVudE5vZGUubGVmdF07DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudE5vZGUuaWQ7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICBpZiAoKG9wZXJhdG9yID09IExUKSB8fCAob3BlcmF0b3IgPT0gTFRFKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLmxlZnQgPT0gMHgwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhlcmUgYXJlIG5vIG5vZGVzIHRoYXQgYXJlIGxlc3MgdGhhbiB0aGUgdmFsdWUNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzbyByZXR1cm4gbnVsbC4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMHgwOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBpbmRleC5ub2Rlc1tjdXJyZW50Tm9kZS5sZWZ0XTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgaWYgKChvcGVyYXRvciA9PSBHVCkgfHwgKG9wZXJhdG9yID09IEdURSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5yaWdodCA9PSAweDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGVyZSBhcmUgbm8gbm9kZXMgdGhhdCBhcmUgZ3JlYXRlciB0aGFuIHRoZSB2YWx1ZQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNvIHJldHVybiBudWxsLg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAweDA7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGluZGV4Lm5vZGVzW2N1cnJlbnROb2RlLnJpZ2h0XTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgaWYgKG9wZXJhdG9yID09IEVRKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUudmFsdWUgPCB2YWx1ZSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5yaWdodCA9PSAweDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDB4MDsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBpbmRleC5ub2Rlc1tjdXJyZW50Tm9kZS5yaWdodF07DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS52YWx1ZSA+IHZhbHVlKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLmxlZnQgPT0gMHgwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAweDA7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbY3VycmVudE5vZGUubGVmdF07DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBfcmViYWxhbmNlVHJlZShJbmRleCBzdG9yYWdlIGluZGV4LCBieXRlczMyIGlkKSBpbnRlcm5hbCB7DQogICAgICAgICAgICAvLyBUcmFjZSBiYWNrIHVwIHJlYmFsYW5jaW5nIHRoZSB0cmVlIGFuZCB1cGRhdGluZyBoZWlnaHRzIGFzDQogICAgICAgICAgICAvLyBuZWVkZWQuLg0KICAgICAgICAgICAgTm9kZSBzdG9yYWdlIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbaWRdOw0KDQogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgew0KICAgICAgICAgICAgICAgIGludCBiYWxhbmNlRmFjdG9yID0gX2dldEJhbGFuY2VGYWN0b3IoaW5kZXgsIGN1cnJlbnROb2RlLmlkKTsNCg0KICAgICAgICAgICAgICAgIGlmIChiYWxhbmNlRmFjdG9yID09IDIpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gUmlnaHQgcm90YXRpb24gKHRyZWUgaXMgaGVhdnkgb24gdGhlIGxlZnQpDQogICAgICAgICAgICAgICAgICAgIGlmIChfZ2V0QmFsYW5jZUZhY3RvcihpbmRleCwgY3VycmVudE5vZGUubGVmdCkgPT0gLTEpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZSBzdWJ0cmVlIGlzIGxlYW5pbmcgcmlnaHQgc28gaXQgbmVlZCB0byBiZQ0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gcm90YXRlZCBsZWZ0IGJlZm9yZSB0aGUgY3VycmVudCBub2RlIGlzIHJvdGF0ZWQNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJpZ2h0Lg0KICAgICAgICAgICAgICAgICAgICAgICAgX3JvdGF0ZUxlZnQoaW5kZXgsIGN1cnJlbnROb2RlLmxlZnQpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIF9yb3RhdGVSaWdodChpbmRleCwgY3VycmVudE5vZGUuaWQpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGlmIChiYWxhbmNlRmFjdG9yID09IC0yKSB7DQogICAgICAgICAgICAgICAgICAgIC8vIExlZnQgcm90YXRpb24gKHRyZWUgaXMgaGVhdnkgb24gdGhlIHJpZ2h0KQ0KICAgICAgICAgICAgICAgICAgICBpZiAoX2dldEJhbGFuY2VGYWN0b3IoaW5kZXgsIGN1cnJlbnROb2RlLnJpZ2h0KSA9PSAxKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgc3VidHJlZSBpcyBsZWFuaW5nIGxlZnQgc28gaXQgbmVlZCB0byBiZQ0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gcm90YXRlZCByaWdodCBiZWZvcmUgdGhlIGN1cnJlbnQgbm9kZSBpcyByb3RhdGVkDQogICAgICAgICAgICAgICAgICAgICAgICAvLyBsZWZ0Lg0KICAgICAgICAgICAgICAgICAgICAgICAgX3JvdGF0ZVJpZ2h0KGluZGV4LCBjdXJyZW50Tm9kZS5yaWdodCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgX3JvdGF0ZUxlZnQoaW5kZXgsIGN1cnJlbnROb2RlLmlkKTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBpZiAoKC0xIDw9IGJhbGFuY2VGYWN0b3IpICYmIChiYWxhbmNlRmFjdG9yIDw9IDEpKSB7DQogICAgICAgICAgICAgICAgICAgIF91cGRhdGVOb2RlSGVpZ2h0KGluZGV4LCBjdXJyZW50Tm9kZS5pZCk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnBhcmVudCA9PSAweDApIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gUmVhY2hlZCB0aGUgcm9vdCB3aGljaCBtYXkgYmUgbmV3IGR1ZSB0byB0cmVlDQogICAgICAgICAgICAgICAgICAgIC8vIHJvdGF0aW9uLCBzbyBzZXQgaXQgYXMgdGhlIHJvb3QgYW5kIHRoZW4gYnJlYWsuDQogICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gaW5kZXgubm9kZXNbY3VycmVudE5vZGUucGFyZW50XTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIF9nZXRCYWxhbmNlRmFjdG9yKEluZGV4IHN0b3JhZ2UgaW5kZXgsIGJ5dGVzMzIgaWQpIGludGVybmFsIHJldHVybnMgKGludCkgew0KICAgICAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBub2RlID0gaW5kZXgubm9kZXNbaWRdOw0KDQogICAgICAgICAgICAgICAgcmV0dXJuIGludChpbmRleC5ub2Rlc1tub2RlLmxlZnRdLmhlaWdodCkgLSBpbnQoaW5kZXgubm9kZXNbbm9kZS5yaWdodF0uaGVpZ2h0KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIF91cGRhdGVOb2RlSGVpZ2h0KEluZGV4IHN0b3JhZ2UgaW5kZXgsIGJ5dGVzMzIgaWQpIGludGVybmFsIHsNCiAgICAgICAgICAgICAgICBOb2RlIHN0b3JhZ2Ugbm9kZSA9IGluZGV4Lm5vZGVzW2lkXTsNCg0KICAgICAgICAgICAgICAgIG5vZGUuaGVpZ2h0ID0gbWF4KGluZGV4Lm5vZGVzW25vZGUubGVmdF0uaGVpZ2h0LCBpbmRleC5ub2Rlc1tub2RlLnJpZ2h0XS5oZWlnaHQpICsgMTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIF9yb3RhdGVMZWZ0KEluZGV4IHN0b3JhZ2UgaW5kZXgsIGJ5dGVzMzIgaWQpIGludGVybmFsIHsNCiAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBvcmlnaW5hbFJvb3QgPSBpbmRleC5ub2Rlc1tpZF07DQoNCiAgICAgICAgICAgIGlmIChvcmlnaW5hbFJvb3QucmlnaHQgPT0gMHgwKSB7DQogICAgICAgICAgICAgICAgLy8gQ2Fubm90IHJvdGF0ZSBsZWZ0IGlmIHRoZXJlIGlzIG5vIHJpZ2h0IG9yaWdpbmFsUm9vdCB0byByb3RhdGUgaW50bw0KICAgICAgICAgICAgICAgIC8vIHBsYWNlLg0KICAgICAgICAgICAgICAgIHRocm93Ow0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBUaGUgcmlnaHQgY2hpbGQgaXMgdGhlIG5ldyByb290LCBzbyBpdCBnZXRzIHRoZSBvcmlnaW5hbA0KICAgICAgICAgICAgLy8gYG9yaWdpbmFsUm9vdC5wYXJlbnRgIGFzIGl0J3MgcGFyZW50Lg0KICAgICAgICAgICAgTm9kZSBzdG9yYWdlIG5ld1Jvb3QgPSBpbmRleC5ub2Rlc1tvcmlnaW5hbFJvb3QucmlnaHRdOw0KICAgICAgICAgICAgbmV3Um9vdC5wYXJlbnQgPSBvcmlnaW5hbFJvb3QucGFyZW50Ow0KDQogICAgICAgICAgICAvLyBUaGUgb3JpZ2luYWwgcm9vdCBuZWVkcyB0byBoYXZlIGl0J3MgcmlnaHQgY2hpbGQgbnVsbGVkIG91dC4NCiAgICAgICAgICAgIG9yaWdpbmFsUm9vdC5yaWdodCA9IDB4MDsNCg0KICAgICAgICAgICAgaWYgKG9yaWdpbmFsUm9vdC5wYXJlbnQgIT0gMHgwKSB7DQogICAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgaXMgYSBwYXJlbnQgbm9kZSwgaXQgbmVlZHMgdG8gbm93IHBvaW50IGRvd253YXJkIGF0DQogICAgICAgICAgICAgICAgLy8gdGhlIG5ld1Jvb3Qgd2hpY2ggaXMgcm90YXRpbmcgaW50byB0aGUgcGxhY2Ugd2hlcmUgYG5vZGVgIHdhcy4NCiAgICAgICAgICAgICAgICBOb2RlIHN0b3JhZ2UgcGFyZW50ID0gaW5kZXgubm9kZXNbb3JpZ2luYWxSb290LnBhcmVudF07DQoNCiAgICAgICAgICAgICAgICAvLyBmaWd1cmUgb3V0IGlmIHdlJ3JlIGEgbGVmdCBvciByaWdodCBjaGlsZCBhbmQgaGF2ZSB0aGUNCiAgICAgICAgICAgICAgICAvLyBwYXJlbnQgcG9pbnQgdG8gdGhlIG5ldyBub2RlLg0KICAgICAgICAgICAgICAgIGlmIChwYXJlbnQubGVmdCA9PSBvcmlnaW5hbFJvb3QuaWQpIHsNCiAgICAgICAgICAgICAgICAgICAgcGFyZW50LmxlZnQgPSBuZXdSb290LmlkOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZiAocGFyZW50LnJpZ2h0ID09IG9yaWdpbmFsUm9vdC5pZCkgew0KICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmlnaHQgPSBuZXdSb290LmlkOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KDQogICAgICAgICAgICBpZiAobmV3Um9vdC5sZWZ0ICE9IDApIHsNCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgbmV3IHJvb3QgaGFkIGEgbGVmdCBjaGlsZCwgdGhhdCBtb3ZlcyB0byBiZSB0aGUNCiAgICAgICAgICAgICAgICAvLyBuZXcgcmlnaHQgY2hpbGQgb2YgdGhlIG9yaWdpbmFsIHJvb3Qgbm9kZQ0KICAgICAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBsZWZ0Q2hpbGQgPSBpbmRleC5ub2Rlc1tuZXdSb290LmxlZnRdOw0KICAgICAgICAgICAgICAgIG9yaWdpbmFsUm9vdC5yaWdodCA9IGxlZnRDaGlsZC5pZDsNCiAgICAgICAgICAgICAgICBsZWZ0Q2hpbGQucGFyZW50ID0gb3JpZ2luYWxSb290LmlkOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBVcGRhdGUgdGhlIG5ld1Jvb3QncyBsZWZ0IG5vZGUgdG8gcG9pbnQgYXQgdGhlIG9yaWdpbmFsIG5vZGUuDQogICAgICAgICAgICBvcmlnaW5hbFJvb3QucGFyZW50ID0gbmV3Um9vdC5pZDsNCiAgICAgICAgICAgIG5ld1Jvb3QubGVmdCA9IG9yaWdpbmFsUm9vdC5pZDsNCg0KICAgICAgICAgICAgaWYgKG5ld1Jvb3QucGFyZW50ID09IDB4MCkgew0KICAgICAgICAgICAgICAgIGluZGV4LnJvb3QgPSBuZXdSb290LmlkOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBUT0RPOiBhcmUgYm90aCBvZiB0aGVzZSB1cGRhdGVzIG5lY2Vzc2FyeT8NCiAgICAgICAgICAgIF91cGRhdGVOb2RlSGVpZ2h0KGluZGV4LCBvcmlnaW5hbFJvb3QuaWQpOw0KICAgICAgICAgICAgX3VwZGF0ZU5vZGVIZWlnaHQoaW5kZXgsIG5ld1Jvb3QuaWQpOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gX3JvdGF0ZVJpZ2h0KEluZGV4IHN0b3JhZ2UgaW5kZXgsIGJ5dGVzMzIgaWQpIGludGVybmFsIHsNCiAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBvcmlnaW5hbFJvb3QgPSBpbmRleC5ub2Rlc1tpZF07DQoNCiAgICAgICAgICAgIGlmIChvcmlnaW5hbFJvb3QubGVmdCA9PSAweDApIHsNCiAgICAgICAgICAgICAgICAvLyBDYW5ub3Qgcm90YXRlIHJpZ2h0IGlmIHRoZXJlIGlzIG5vIGxlZnQgbm9kZSB0byByb3RhdGUgaW50bw0KICAgICAgICAgICAgICAgIC8vIHBsYWNlLg0KICAgICAgICAgICAgICAgIHRocm93Ow0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBUaGUgbGVmdCBjaGlsZCBpcyB0YWtpbmcgdGhlIHBsYWNlIG9mIG5vZGUsIHNvIHdlIHVwZGF0ZSBpdCdzDQogICAgICAgICAgICAvLyBwYXJlbnQgdG8gYmUgdGhlIG9yaWdpbmFsIHBhcmVudCBvZiB0aGUgbm9kZS4NCiAgICAgICAgICAgIE5vZGUgc3RvcmFnZSBuZXdSb290ID0gaW5kZXgubm9kZXNbb3JpZ2luYWxSb290LmxlZnRdOw0KICAgICAgICAgICAgbmV3Um9vdC5wYXJlbnQgPSBvcmlnaW5hbFJvb3QucGFyZW50Ow0KDQogICAgICAgICAgICAvLyBOdWxsIG91dCB0aGUgb3JpZ2luYWxSb290LmxlZnQNCiAgICAgICAgICAgIG9yaWdpbmFsUm9vdC5sZWZ0ID0gMHgwOw0KDQogICAgICAgICAgICBpZiAob3JpZ2luYWxSb290LnBhcmVudCAhPSAweDApIHsNCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgbm9kZSBoYXMgYSBwYXJlbnQsIHVwZGF0ZSB0aGUgY29ycmVjdCBjaGlsZCB0byBwb2ludA0KICAgICAgICAgICAgICAgIC8vIGF0IHRoZSBuZXdSb290IG5vdy4NCiAgICAgICAgICAgICAgICBOb2RlIHN0b3JhZ2UgcGFyZW50ID0gaW5kZXgubm9kZXNbb3JpZ2luYWxSb290LnBhcmVudF07DQoNCiAgICAgICAgICAgICAgICBpZiAocGFyZW50LmxlZnQgPT0gb3JpZ2luYWxSb290LmlkKSB7DQogICAgICAgICAgICAgICAgICAgIHBhcmVudC5sZWZ0ID0gbmV3Um9vdC5pZDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYgKHBhcmVudC5yaWdodCA9PSBvcmlnaW5hbFJvb3QuaWQpIHsNCiAgICAgICAgICAgICAgICAgICAgcGFyZW50LnJpZ2h0ID0gbmV3Um9vdC5pZDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmIChuZXdSb290LnJpZ2h0ICE9IDB4MCkgew0KICAgICAgICAgICAgICAgIE5vZGUgc3RvcmFnZSByaWdodENoaWxkID0gaW5kZXgubm9kZXNbbmV3Um9vdC5yaWdodF07DQogICAgICAgICAgICAgICAgb3JpZ2luYWxSb290LmxlZnQgPSBuZXdSb290LnJpZ2h0Ow0KICAgICAgICAgICAgICAgIHJpZ2h0Q2hpbGQucGFyZW50ID0gb3JpZ2luYWxSb290LmlkOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBVcGRhdGUgdGhlIG5ldyByb290J3MgcmlnaHQgbm9kZSB0byBwb2ludCB0byB0aGUgb3JpZ2luYWwgbm9kZS4NCiAgICAgICAgICAgIG9yaWdpbmFsUm9vdC5wYXJlbnQgPSBuZXdSb290LmlkOw0KICAgICAgICAgICAgbmV3Um9vdC5yaWdodCA9IG9yaWdpbmFsUm9vdC5pZDsNCg0KICAgICAgICAgICAgaWYgKG5ld1Jvb3QucGFyZW50ID09IDB4MCkgew0KICAgICAgICAgICAgICAgIGluZGV4LnJvb3QgPSBuZXdSb290LmlkOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBSZWNvbXB1dGUgaGVpZ2h0cy4NCiAgICAgICAgICAgIF91cGRhdGVOb2RlSGVpZ2h0KGluZGV4LCBvcmlnaW5hbFJvb3QuaWQpOw0KICAgICAgICAgICAgX3VwZGF0ZU5vZGVIZWlnaHQoaW5kZXgsIG5ld1Jvb3QuaWQpOw0KICAgICAgICB9DQp9DQoNCg0KLy8gUmVzb3VyY2UgUG9vbCB2MC4xLjAgKGhhcyBiZWVuIG1vZGlmaWVkIGZyb20gdGhlIG1haW4gcmVsZWFzZWQgdmVyc2lvbiBvZiB0aGlzIGxpYnJhcnkpDQoNCg0KLy8gQHRpdGxlIFJlc291cmNlUG9vbExpYiAtIExpYnJhcnkgZm9yIGEgc2V0IG9mIHJlc291cmNlcyB0aGF0IGFyZSByZWFkeSBmb3IgdXNlLg0KLy8gQGF1dGhvciBQaXBlciBNZXJyaWFtIA0KbGlicmFyeSBSZXNvdXJjZVBvb2xMaWIgew0KICAgICAgICAvKg0KICAgICAgICAgKiAgQWRkcmVzczogMHhkNmJiZDE2ZWFhNmVhM2Y3MWE0NThiZmZjNjRjMGNhMjRmYzhjNThlDQogICAgICAgICAqLw0KICAgICAgICBzdHJ1Y3QgUG9vbCB7DQogICAgICAgICAgICAgICAgdWludCByb3RhdGlvbkRlbGF5Ow0KICAgICAgICAgICAgICAgIHVpbnQgb3ZlcmxhcFNpemU7DQogICAgICAgICAgICAgICAgdWludCBmcmVlemVQZXJpb2Q7DQoNCiAgICAgICAgICAgICAgICB1aW50IF9pZDsNCg0KICAgICAgICAgICAgICAgIEdyb3ZlTGliLkluZGV4IGdlbmVyYXRpb25TdGFydDsNCiAgICAgICAgICAgICAgICBHcm92ZUxpYi5JbmRleCBnZW5lcmF0aW9uRW5kOw0KDQogICAgICAgICAgICAgICAgbWFwcGluZyAodWludCA9PiBHZW5lcmF0aW9uKSBnZW5lcmF0aW9uczsNCiAgICAgICAgICAgICAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQpIGJvbmRzOw0KICAgICAgICB9DQoNCiAgICAgICAgLyoNCiAgICAgICAgICogR2VuZXJhdGlvbnMgaGF2ZSB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXMuDQogICAgICAgICAqDQogICAgICAgICAqIDEuIE11c3QgYWx3YXlzIG92ZXJsYXAgYnkgYSBtaW5pbXVtIGFtb3VudCBzcGVjaWZpZWQgYnkgTUlOX09WRVJMQVAuDQogICAgICAgICAqDQogICAgICAgICAqICAgIDEgICAyICAgMyAgIDQgICA1ICAgNiAgIDcgICA4ICAgOSAgIDEwICAxMSAgMTIgIDEzDQogICAgICAgICAqICAgIFsxOi0tLS0tLS0tLS0tLS0tLS0tXQ0KICAgICAgICAgKiAgICAgICAgICAgICAgICBbNDotLS0tLS0tLS0tLS0tLS0tLS0tLS0+DQogICAgICAgICAqLw0KICAgICAgICBzdHJ1Y3QgR2VuZXJhdGlvbiB7DQogICAgICAgICAgICAgICAgdWludCBpZDsNCiAgICAgICAgICAgICAgICB1aW50IHN0YXJ0QXQ7DQogICAgICAgICAgICAgICAgdWludCBlbmRBdDsNCiAgICAgICAgICAgICAgICBhZGRyZXNzW10gbWVtYmVyczsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vLyBAZGV2IENyZWF0ZXMgdGhlIG5leHQgZ2VuZXJhdGlvbiBmb3IgdGhlIGdpdmVuIHBvb2wuICBBbGwgbWVtYmVycyBmcm9tIHRoZSBjdXJyZW50IGdlbmVyYXRpb24gYXJlIGNhcnJpZWQgb3ZlciAod2l0aCB0aGVpciBvcmRlciByYW5kb21pemVkKS4gIFRoZSBjdXJyZW50IGdlbmVyYXRpb24gd2lsbCBoYXZlIGl0J3MgZW5kQXQgYmxvY2sgc2V0Lg0KICAgICAgICAvLy8gQHBhcmFtIHNlbGYgVGhlIHBvb2wgdG8gb3BlcmF0ZSBvbi4NCiAgICAgICAgZnVuY3Rpb24gY3JlYXRlTmV4dEdlbmVyYXRpb24oUG9vbCBzdG9yYWdlIHNlbGYpIHB1YmxpYyByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAgICAgKiAgQ3JlYXQgYSBuZXcgcG9vbCBnZW5lcmF0aW9uIHdpdGggYWxsIG9mIHRoZSBjdXJyZW50DQogICAgICAgICAgICAgICAgICogIGdlbmVyYXRpb24ncyBtZW1iZXJzIGNvcGllZCBvdmVyIGluIHJhbmRvbSBvcmRlci4NCiAgICAgICAgICAgICAgICAgKi8NCiAgICAgICAgICAgICAgICBHZW5lcmF0aW9uIHN0b3JhZ2UgcHJldmlvdXNHZW5lcmF0aW9uID0gc2VsZi5nZW5lcmF0aW9uc1tzZWxmLl9pZF07DQoNCiAgICAgICAgICAgICAgICBzZWxmLl9pZCArPSAxOw0KICAgICAgICAgICAgICAgIEdlbmVyYXRpb24gc3RvcmFnZSBuZXh0R2VuZXJhdGlvbiA9IHNlbGYuZ2VuZXJhdGlvbnNbc2VsZi5faWRdOw0KICAgICAgICAgICAgICAgIG5leHRHZW5lcmF0aW9uLmlkID0gc2VsZi5faWQ7DQogICAgICAgICAgICAgICAgbmV4dEdlbmVyYXRpb24uc3RhcnRBdCA9IGJsb2NrLm51bWJlciArIHNlbGYuZnJlZXplUGVyaW9kICsgc2VsZi5yb3RhdGlvbkRlbGF5Ow0KICAgICAgICAgICAgICAgIEdyb3ZlTGliLmluc2VydChzZWxmLmdlbmVyYXRpb25TdGFydCwgU3RyaW5nTGliLnVpbnRUb0J5dGVzKG5leHRHZW5lcmF0aW9uLmlkKSwgaW50KG5leHRHZW5lcmF0aW9uLnN0YXJ0QXQpKTsNCg0KICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0dlbmVyYXRpb24uaWQgPT0gMCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyB0aGUgZmlyc3QgZ2VuZXJhdGlvbiBzbyB3ZSBqdXN0IG5lZWQgdG8gc2V0DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBpdCdzIGBpZGAgYW5kIGBzdGFydEF0YC4NCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXh0R2VuZXJhdGlvbi5pZDsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIGVuZCBkYXRlIGZvciB0aGUgY3VycmVudCBnZW5lcmF0aW9uLg0KICAgICAgICAgICAgICAgIHByZXZpb3VzR2VuZXJhdGlvbi5lbmRBdCA9IGJsb2NrLm51bWJlciArIHNlbGYuZnJlZXplUGVyaW9kICsgc2VsZi5yb3RhdGlvbkRlbGF5ICsgc2VsZi5vdmVybGFwU2l6ZTsNCiAgICAgICAgICAgICAgICBHcm92ZUxpYi5pbnNlcnQoc2VsZi5nZW5lcmF0aW9uRW5kLCBTdHJpbmdMaWIudWludFRvQnl0ZXMocHJldmlvdXNHZW5lcmF0aW9uLmlkKSwgaW50KHByZXZpb3VzR2VuZXJhdGlvbi5lbmRBdCkpOw0KDQogICAgICAgICAgICAgICAgLy8gTm93IHdlIGNvcHkgdGhlIG1lbWJlcnMgb2YgdGhlIHByZXZpb3VzIGdlbmVyYXRpb24gb3ZlciB0bw0KICAgICAgICAgICAgICAgIC8vIHRoZSBuZXh0IGdlbmVyYXRpb24gYXMgd2VsbCBhcyByYW5kb21pemluZyB0aGVpciBvcmRlci4NCiAgICAgICAgICAgICAgICBhZGRyZXNzW10gbWVtb3J5IG1lbWJlcnMgPSBwcmV2aW91c0dlbmVyYXRpb24ubWVtYmVyczsNCg0KICAgICAgICAgICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IG1lbWJlcnMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gUGljayBhICpyYW5kb20qIGluZGV4IGFuZCBwdXNoIGl0IG9udG8gdGhlIG5leHQNCiAgICAgICAgICAgICAgICAgICAgLy8gZ2VuZXJhdGlvbidzIG1lbWJlcnMuDQogICAgICAgICAgICAgICAgICAgIHVpbnQgaW5kZXggPSB1aW50KHNoYTMoYmxvY2suYmxvY2toYXNoKGJsb2NrLm51bWJlcikpKSAlIChtZW1iZXJzLmxlbmd0aCAtIG5leHRHZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoKTsNCiAgICAgICAgICAgICAgICAgICAgbmV4dEdlbmVyYXRpb24ubWVtYmVycy5sZW5ndGggKz0gMTsNCiAgICAgICAgICAgICAgICAgICAgbmV4dEdlbmVyYXRpb24ubWVtYmVyc1tuZXh0R2VuZXJhdGlvbi5tZW1iZXJzLmxlbmd0aCAtIDFdID0gbWVtYmVyc1tpbmRleF07DQoNCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlbiBtb3ZlIHRoZSBtZW1iZXIgYXQgdGhlIGxhc3QgaW5kZXggaW50byB0aGUgcGlja2VkDQogICAgICAgICAgICAgICAgICAgIC8vIGluZGV4J3MgbG9jYXRpb24uDQogICAgICAgICAgICAgICAgICAgIG1lbWJlcnNbaW5kZXhdID0gbWVtYmVyc1ttZW1iZXJzLmxlbmd0aCAtIDFdOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIHJldHVybiBuZXh0R2VuZXJhdGlvbi5pZDsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vLyBAZGV2IFJldHVybnMgdGhlIGZpcnN0IGdlbmVyYXRpb24gaWQgdGhhdCBmdWxseSBjb250YWlucyB0aGUgYmxvY2sgd2luZG93IHByb3ZpZGVkLg0KICAgICAgICAvLy8gQHBhcmFtIHNlbGYgVGhlIHBvb2wgdG8gb3BlcmF0ZSBvbi4NCiAgICAgICAgLy8vIEBwYXJhbSBsZWZ0Qm91bmQgVGhlIGxlZnQgYm91bmQgZm9yIHRoZSBibG9jayB3aW5kb3cgKGluY2x1c2l2ZSkNCiAgICAgICAgLy8vIEBwYXJhbSByaWdodEJvdW5kIFRoZSByaWdodCBib3VuZCBmb3IgdGhlIGJsb2NrIHdpbmRvdyAoaW5jbHVzaXZlKQ0KICAgICAgICBmdW5jdGlvbiBnZXRHZW5lcmF0aW9uRm9yV2luZG93KFBvb2wgc3RvcmFnZSBzZWxmLCB1aW50IGxlZnRCb3VuZCwgdWludCByaWdodEJvdW5kKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICAvLyBUT0RPOiB0ZXN0cw0KICAgICAgICAgICAgICAgIHZhciBsZWZ0ID0gR3JvdmVMaWIucXVlcnkoc2VsZi5nZW5lcmF0aW9uU3RhcnQsICI8PSIsIGludChsZWZ0Qm91bmQpKTsNCg0KICAgICAgICAgICAgICAgIGlmIChsZWZ0ICE9IDB4MCkgew0KICAgICAgICAgICAgICAgICAgICBHZW5lcmF0aW9uIG1lbW9yeSBsZWZ0Q2FuZGlkYXRlID0gc2VsZi5nZW5lcmF0aW9uc1tTdHJpbmdMaWIuYnl0ZXNUb1VJbnQobGVmdCldOw0KICAgICAgICAgICAgICAgICAgICBpZiAobGVmdENhbmRpZGF0ZS5zdGFydEF0IDw9IGxlZnRCb3VuZCAmJiAobGVmdENhbmRpZGF0ZS5lbmRBdCA+PSByaWdodEJvdW5kIHx8IGxlZnRDYW5kaWRhdGUuZW5kQXQgPT0gMCkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsZWZ0Q2FuZGlkYXRlLmlkOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgdmFyIHJpZ2h0ID0gR3JvdmVMaWIucXVlcnkoc2VsZi5nZW5lcmF0aW9uRW5kLCAiPj0iLCBpbnQocmlnaHRCb3VuZCkpOw0KICAgICAgICAgICAgICAgIGlmIChyaWdodCAhPSAweDApIHsNCiAgICAgICAgICAgICAgICAgICAgR2VuZXJhdGlvbiBtZW1vcnkgcmlnaHRDYW5kaWRhdGUgPSBzZWxmLmdlbmVyYXRpb25zW1N0cmluZ0xpYi5ieXRlc1RvVUludChyaWdodCldOw0KICAgICAgICAgICAgICAgICAgICBpZiAocmlnaHRDYW5kaWRhdGUuc3RhcnRBdCA8PSBsZWZ0Qm91bmQgJiYgKHJpZ2h0Q2FuZGlkYXRlLmVuZEF0ID49IHJpZ2h0Qm91bmQgfHwgcmlnaHRDYW5kaWRhdGUuZW5kQXQgPT0gMCkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByaWdodENhbmRpZGF0ZS5pZDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIHJldHVybiAwOw0KICAgICAgICB9DQoNCiAgICAgICAgLy8vIEBkZXYgUmV0dXJucyB0aGUgZmlyc3QgZ2VuZXJhdGlvbiBpbiB0aGUgZnV0dXJlIHRoYXQgaGFzIG5vdCB5ZXQgc3RhcnRlZC4NCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBwb29sIHRvIG9wZXJhdGUgb24uDQogICAgICAgIGZ1bmN0aW9uIGdldE5leHRHZW5lcmF0aW9uSWQoUG9vbCBzdG9yYWdlIHNlbGYpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsNCiAgICAgICAgICAgIC8vIFRPRE86IHRlc3RzDQogICAgICAgICAgICAgICAgdmFyIG5leHQgPSBHcm92ZUxpYi5xdWVyeShzZWxmLmdlbmVyYXRpb25TdGFydCwgIj4iLCBpbnQoYmxvY2subnVtYmVyKSk7DQogICAgICAgICAgICAgICAgaWYgKG5leHQgPT0gMHgwKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiAwOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nTGliLmJ5dGVzVG9VSW50KG5leHQpOw0KICAgICAgICB9DQoNCiAgICAgICAgLy8vIEBkZXYgUmV0dXJucyB0aGUgZmlyc3QgZ2VuZXJhdGlvbiB0aGF0IGlzIGN1cnJlbnRseSBhY3RpdmUuDQogICAgICAgIC8vLyBAcGFyYW0gc2VsZiBUaGUgcG9vbCB0byBvcGVyYXRlIG9uLg0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50R2VuZXJhdGlvbklkKFBvb2wgc3RvcmFnZSBzZWxmKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICAvLyBUT0RPOiB0ZXN0cw0KICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gR3JvdmVMaWIucXVlcnkoc2VsZi5nZW5lcmF0aW9uRW5kLCAiPiIsIGludChibG9jay5udW1iZXIpKTsNCiAgICAgICAgICAgICAgICBpZiAobmV4dCAhPSAweDApIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZ0xpYi5ieXRlc1RvVUludChuZXh0KTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBuZXh0ID0gR3JvdmVMaWIucXVlcnkoc2VsZi5nZW5lcmF0aW9uU3RhcnQsICI8PSIsIGludChibG9jay5udW1iZXIpKTsNCiAgICAgICAgICAgICAgICBpZiAobmV4dCAhPSAweDApIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZ0xpYi5ieXRlc1RvVUludChuZXh0KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIDA7DQogICAgICAgIH0NCg0KICAgICAgICAvKg0KICAgICAgICAgKiAgUG9vbCBtZW1iZXJzaGlwIEFQSQ0KICAgICAgICAgKi8NCiAgICAgICAgLy8vIEBkZXYgUmV0dXJucyBhIGJvb2xlYW4gZm9yIHdoZXRoZXIgdGhlIGdpdmVuIGFkZHJlc3MgaXMgaW4gdGhlIGdpdmVuIGdlbmVyYXRpb24uDQogICAgICAgIC8vLyBAcGFyYW0gc2VsZiBUaGUgcG9vbCB0byBvcGVyYXRlIG9uLg0KICAgICAgICAvLy8gQHBhcmFtIHJlc291cmNlQWRkcmVzcyBUaGUgYWRkcmVzcyB0byBjaGVjayBtZW1iZXJzaGlwIG9mDQogICAgICAgIC8vLyBAcGFyYW0gZ2VuZXJhdGlvbklkIFRoZSBpZCBvZiB0aGUgZ2VuZXJhdGlvbiB0byBjaGVjay4NCiAgICAgICAgZnVuY3Rpb24gaXNJbkdlbmVyYXRpb24oUG9vbCBzdG9yYWdlIHNlbGYsIGFkZHJlc3MgcmVzb3VyY2VBZGRyZXNzLCB1aW50IGdlbmVyYXRpb25JZCkgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgew0KICAgICAgICAgICAgLy8gVE9ETzogdGVzdHMNCiAgICAgICAgICAgIGlmIChnZW5lcmF0aW9uSWQgPT0gMCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIEdlbmVyYXRpb24gbWVtb3J5IGdlbmVyYXRpb24gPSBzZWxmLmdlbmVyYXRpb25zW2dlbmVyYXRpb25JZF07DQogICAgICAgICAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBnZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICBpZiAoZ2VuZXJhdGlvbi5tZW1iZXJzW2ldID09IHJlc291cmNlQWRkcmVzcykgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCg0KICAgICAgICAvLy8gQGRldiBSZXR1cm5zIGEgYm9vbGVhbiBmb3Igd2hldGhlciB0aGUgZ2l2ZW4gYWRkcmVzcyBpcyBpbiB0aGUgY3VycmVudCBnZW5lcmF0aW9uLg0KICAgICAgICAvLy8gQHBhcmFtIHNlbGYgVGhlIHBvb2wgdG8gb3BlcmF0ZSBvbi4NCiAgICAgICAgLy8vIEBwYXJhbSByZXNvdXJjZUFkZHJlc3MgVGhlIGFkZHJlc3MgdG8gY2hlY2sgbWVtYmVyc2hpcCBvZg0KICAgICAgICBmdW5jdGlvbiBpc0luQ3VycmVudEdlbmVyYXRpb24oUG9vbCBzdG9yYWdlIHNlbGYsIGFkZHJlc3MgcmVzb3VyY2VBZGRyZXNzKSBjb25zdGFudCByZXR1cm5zIChib29sKSB7DQogICAgICAgICAgICAvLyBUT0RPOiB0ZXN0cw0KICAgICAgICAgICAgcmV0dXJuIGlzSW5HZW5lcmF0aW9uKHNlbGYsIHJlc291cmNlQWRkcmVzcywgZ2V0Q3VycmVudEdlbmVyYXRpb25JZChzZWxmKSk7DQogICAgICAgIH0NCg0KICAgICAgICAvLy8gQGRldiBSZXR1cm5zIGEgYm9vbGVhbiBmb3Igd2hldGhlciB0aGUgZ2l2ZW4gYWRkcmVzcyBpcyBpbiB0aGUgbmV4dCBxdWV1ZWQgZ2VuZXJhdGlvbi4NCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBwb29sIHRvIG9wZXJhdGUgb24uDQogICAgICAgIC8vLyBAcGFyYW0gcmVzb3VyY2VBZGRyZXNzIFRoZSBhZGRyZXNzIHRvIGNoZWNrIG1lbWJlcnNoaXAgb2YNCiAgICAgICAgZnVuY3Rpb24gaXNJbk5leHRHZW5lcmF0aW9uKFBvb2wgc3RvcmFnZSBzZWxmLCBhZGRyZXNzIHJlc291cmNlQWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgew0KICAgICAgICAgICAgLy8gVE9ETzogdGVzdHMNCiAgICAgICAgICAgIHJldHVybiBpc0luR2VuZXJhdGlvbihzZWxmLCByZXNvdXJjZUFkZHJlc3MsIGdldE5leHRHZW5lcmF0aW9uSWQoc2VsZikpOw0KICAgICAgICB9DQoNCiAgICAgICAgLy8vIEBkZXYgUmV0dXJucyBhIGJvb2xlYW4gZm9yIHdoZXRoZXIgdGhlIGdpdmVuIGFkZHJlc3MgaXMgaW4gZWl0aGVyIHRoZSBjdXJyZW50IGdlbmVyYXRpb24gb3IgdGhlIG5leHQgcXVldWVkIGdlbmVyYXRpb24uDQogICAgICAgIC8vLyBAcGFyYW0gc2VsZiBUaGUgcG9vbCB0byBvcGVyYXRlIG9uLg0KICAgICAgICAvLy8gQHBhcmFtIHJlc291cmNlQWRkcmVzcyBUaGUgYWRkcmVzcyB0byBjaGVjayBtZW1iZXJzaGlwIG9mDQogICAgICAgIGZ1bmN0aW9uIGlzSW5Qb29sKFBvb2wgc3RvcmFnZSBzZWxmLCBhZGRyZXNzIHJlc291cmNlQWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgew0KICAgICAgICAgICAgLy8gVE9ETzogdGVzdHMNCiAgICAgICAgICAgIHJldHVybiAoaXNJbkN1cnJlbnRHZW5lcmF0aW9uKHNlbGYsIHJlc291cmNlQWRkcmVzcykgfHwgaXNJbk5leHRHZW5lcmF0aW9uKHNlbGYsIHJlc291cmNlQWRkcmVzcykpOw0KICAgICAgICB9DQoNCiAgICAgICAgZXZlbnQgX0FkZGVkVG9HZW5lcmF0aW9uKGFkZHJlc3MgaW5kZXhlZCByZXNvdXJjZUFkZHJlc3MsIHVpbnQgaW5kZXhlZCBnZW5lcmF0aW9uSWQpOw0KICAgICAgICAvLy8gQGRldiBGdW5jdGlvbiB0byBleHBvc2UgdGhlIF9BZGRlZFRvR2VuZXJhdGlvbiBldmVudCB0byBjb250cmFjdHMuDQogICAgICAgIC8vLyBAcGFyYW0gcmVzb3VyY2VBZGRyZXNzIFRoZSBhZGRyZXNzIHRoYXQgd2FzIGFkZGVkDQogICAgICAgIC8vLyBAcGFyYW0gZ2VuZXJhdGlvbklkIFRoZSBpZCBvZiB0aGUgZ2VuZXJhdGlvbi4NCiAgICAgICAgZnVuY3Rpb24gQWRkZWRUb0dlbmVyYXRpb24oYWRkcmVzcyByZXNvdXJjZUFkZHJlc3MsIHVpbnQgZ2VuZXJhdGlvbklkKSBwdWJsaWMgew0KICAgICAgICAgICAgICAgIF9BZGRlZFRvR2VuZXJhdGlvbihyZXNvdXJjZUFkZHJlc3MsIGdlbmVyYXRpb25JZCk7DQogICAgICAgIH0NCg0KICAgICAgICBldmVudCBfUmVtb3ZlZEZyb21HZW5lcmF0aW9uKGFkZHJlc3MgaW5kZXhlZCByZXNvdXJjZUFkZHJlc3MsIHVpbnQgaW5kZXhlZCBnZW5lcmF0aW9uSWQpOw0KICAgICAgICAvLy8gQGRldiBGdW5jdGlvbiB0byBleHBvc2UgdGhlIF9BZGRlZFRvR2VuZXJhdGlvbiBldmVudCB0byBjb250cmFjdHMuDQogICAgICAgIC8vLyBAcGFyYW0gcmVzb3VyY2VBZGRyZXNzIFRoZSBhZGRyZXNzIHRoYXQgd2FzIHJlbW92ZWQuDQogICAgICAgIC8vLyBAcGFyYW0gZ2VuZXJhdGlvbklkIFRoZSBpZCBvZiB0aGUgZ2VuZXJhdGlvbi4NCiAgICAgICAgZnVuY3Rpb24gUmVtb3ZlZEZyb21HZW5lcmF0aW9uKGFkZHJlc3MgcmVzb3VyY2VBZGRyZXNzLCB1aW50IGdlbmVyYXRpb25JZCkgcHVibGljIHsNCiAgICAgICAgICAgICAgICBfUmVtb3ZlZEZyb21HZW5lcmF0aW9uKHJlc291cmNlQWRkcmVzcywgZ2VuZXJhdGlvbklkKTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vLyBAZGV2IFJldHVybnMgYSBib29sZWFuIGFzIHRvIHdoZXRoZXIgdGhlIHByb3ZpZGVkIGFkZHJlc3MgaXMgYWxsb3dlZCB0byBlbnRlciB0aGUgcG9vbCBhdCB0aGlzIHRpbWUuDQogICAgICAgIC8vLyBAcGFyYW0gc2VsZiBUaGUgcG9vbCB0byBvcGVyYXRlIG9uLg0KICAgICAgICAvLy8gQHBhcmFtIHJlc291cmNlQWRkcmVzcyBUaGUgYWRkcmVzcyBpbiBxdWVzdGlvbg0KICAgICAgICAvLy8gQHBhcmFtIG1pbmltdW1Cb25kIFRoZSBtaW5pbXVtIGJvbmQgYW1vdW50IHRoYXQgc2hvdWxkIGJlIHJlcXVpcmVkIGZvciBlbnRyeS4NCiAgICAgICAgZnVuY3Rpb24gY2FuRW50ZXJQb29sKFBvb2wgc3RvcmFnZSBzZWxmLCBhZGRyZXNzIHJlc291cmNlQWRkcmVzcywgdWludCBtaW5pbXVtQm9uZCkgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgew0KICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAqICAtIGJvbmQNCiAgICAgICAgICAgICAqICAtIHBvb2wgaXMgb3Blbg0KICAgICAgICAgICAgICogIC0gbm90IGFscmVhZHkgaW4gaXQuDQogICAgICAgICAgICAgKiAgLSBub3QgYWxyZWFkeSBsZWZ0IGl0Lg0KICAgICAgICAgICAgICovDQogICAgICAgICAgICAvLyBUT0RPOiB0ZXN0cw0KICAgICAgICAgICAgaWYgKHNlbGYuYm9uZHNbcmVzb3VyY2VBZGRyZXNzXSA8IG1pbmltdW1Cb25kKSB7DQogICAgICAgICAgICAgICAgLy8gSW5zdWZmaWNpZW50IGJvbmQgYmFsYW5jZTsNCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmIChpc0luUG9vbChzZWxmLCByZXNvdXJjZUFkZHJlc3MpKSB7DQogICAgICAgICAgICAgICAgLy8gQWxyZWFkeSBpbiB0aGUgcG9vbCBlaXRoZXIgaW4gdGhlIG5leHQgdXBjb21pbmcgZ2VuZXJhdGlvbg0KICAgICAgICAgICAgICAgIC8vIG9yIHRoZSBjdXJyZW50bHkgYWN0aXZlIGdlbmVyYXRpb24uDQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB2YXIgbmV4dEdlbmVyYXRpb25JZCA9IGdldE5leHRHZW5lcmF0aW9uSWQoc2VsZik7DQogICAgICAgICAgICBpZiAobmV4dEdlbmVyYXRpb25JZCAhPSAwKSB7DQogICAgICAgICAgICAgICAgdmFyIG5leHRHZW5lcmF0aW9uID0gc2VsZi5nZW5lcmF0aW9uc1tuZXh0R2VuZXJhdGlvbklkXTsNCiAgICAgICAgICAgICAgICBpZiAoYmxvY2subnVtYmVyICsgc2VsZi5mcmVlemVQZXJpb2QgPj0gbmV4dEdlbmVyYXRpb24uc3RhcnRBdCkgew0KICAgICAgICAgICAgICAgICAgICAvLyBOZXh0IGdlbmVyYXRpb24gc3RhcnRzIHRvbyBzb29uLg0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vLyBAZGV2IEFkZHMgdGhlIGFkZHJlc3MgdG8gcG9vbCBieSBhZGRpbmcgdGhlbSB0byB0aGUgbmV4dCBnZW5lcmF0aW9uIChhcyB3ZWxsIGFzIGNyZWF0aW5nIGl0IGlmIGl0IGRvZXNuJ3QgZXhpc3QpLg0KICAgICAgICAvLy8gQHBhcmFtIHNlbGYgVGhlIHBvb2wgdG8gb3BlcmF0ZSBvbi4NCiAgICAgICAgLy8vIEBwYXJhbSByZXNvdXJjZUFkZHJlc3MgVGhlIGFkZHJlc3MgdG8gYmUgYWRkZWQgdG8gdGhlIHBvb2wNCiAgICAgICAgLy8vIEBwYXJhbSBtaW5pbXVtQm9uZCBUaGUgbWluaW11bSBib25kIGFtb3VudCB0aGF0IHNob3VsZCBiZSByZXF1aXJlZCBmb3IgZW50cnkuDQogICAgICAgIGZ1bmN0aW9uIGVudGVyUG9vbChQb29sIHN0b3JhZ2Ugc2VsZiwgYWRkcmVzcyByZXNvdXJjZUFkZHJlc3MsIHVpbnQgbWluaW11bUJvbmQpIHB1YmxpYyByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICBpZiAoIWNhbkVudGVyUG9vbChzZWxmLCByZXNvdXJjZUFkZHJlc3MsIG1pbmltdW1Cb25kKSkgew0KICAgICAgICAgICAgICAgIHRocm93Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdWludCBuZXh0R2VuZXJhdGlvbklkID0gZ2V0TmV4dEdlbmVyYXRpb25JZChzZWxmKTsNCiAgICAgICAgICAgIGlmIChuZXh0R2VuZXJhdGlvbklkID09IDApIHsNCiAgICAgICAgICAgICAgICAvLyBObyBuZXh0IGdlbmVyYXRpb24gaGFzIGZvcm1lZCB5ZXQgc28gY3JlYXRlIGl0Lg0KICAgICAgICAgICAgICAgIG5leHRHZW5lcmF0aW9uSWQgPSBjcmVhdGVOZXh0R2VuZXJhdGlvbihzZWxmKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIEdlbmVyYXRpb24gc3RvcmFnZSBuZXh0R2VuZXJhdGlvbiA9IHNlbGYuZ2VuZXJhdGlvbnNbbmV4dEdlbmVyYXRpb25JZF07DQogICAgICAgICAgICAvLyBub3cgYWRkIHRoZSBuZXcgYWRkcmVzcy4NCiAgICAgICAgICAgIG5leHRHZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoICs9IDE7DQogICAgICAgICAgICBuZXh0R2VuZXJhdGlvbi5tZW1iZXJzW25leHRHZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoIC0gMV0gPSByZXNvdXJjZUFkZHJlc3M7DQogICAgICAgICAgICByZXR1cm4gbmV4dEdlbmVyYXRpb25JZDsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vLyBAZGV2IFJldHVybnMgYSBib29sZWFuIGFzIHRvIHdoZXRoZXIgdGhlIHByb3ZpZGVkIGFkZHJlc3MgaXMgYWxsb3dlZCB0byBleGl0IHRoZSBwb29sIGF0IHRoaXMgdGltZS4NCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBwb29sIHRvIG9wZXJhdGUgb24uDQogICAgICAgIC8vLyBAcGFyYW0gcmVzb3VyY2VBZGRyZXNzIFRoZSBhZGRyZXNzIGluIHF1ZXN0aW9uDQogICAgICAgIGZ1bmN0aW9uIGNhbkV4aXRQb29sKFBvb2wgc3RvcmFnZSBzZWxmLCBhZGRyZXNzIHJlc291cmNlQWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgew0KICAgICAgICAgICAgaWYgKCFpc0luQ3VycmVudEdlbmVyYXRpb24oc2VsZiwgcmVzb3VyY2VBZGRyZXNzKSkgew0KICAgICAgICAgICAgICAgIC8vIE5vdCBpbiB0aGUgcG9vbC4NCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHVpbnQgbmV4dEdlbmVyYXRpb25JZCA9IGdldE5leHRHZW5lcmF0aW9uSWQoc2VsZik7DQogICAgICAgICAgICBpZiAobmV4dEdlbmVyYXRpb25JZCA9PSAwKSB7DQogICAgICAgICAgICAgICAgLy8gTmV4dCBnZW5lcmF0aW9uIGhhc24ndCBiZWVuIGdlbmVyYXRlZCB5ZXQuDQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmIChzZWxmLmdlbmVyYXRpb25zW25leHRHZW5lcmF0aW9uSWRdLnN0YXJ0QXQgLSBzZWxmLmZyZWV6ZVBlcmlvZCA8PSBibG9jay5udW1iZXIpIHsNCiAgICAgICAgICAgICAgICAvLyBOZXh0IGdlbmVyYXRpb24gc3RhcnRzIHRvbyBzb29uLg0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8gVGhleSBjYW4gbGVhdmUgaWYgdGhleSBhcmUgc3RpbGwgaW4gdGhlIG5leHQgZ2VuZXJhdGlvbi4NCiAgICAgICAgICAgIC8vIG90aGVyd2lzZSB0aGV5IGhhdmUgYWxyZWFkeSBsZWZ0IGl0Lg0KICAgICAgICAgICAgcmV0dXJuIGlzSW5OZXh0R2VuZXJhdGlvbihzZWxmLCByZXNvdXJjZUFkZHJlc3MpOw0KICAgICAgICB9DQoNCg0KICAgICAgICAvLy8gQGRldiBSZW1vdmVzIHRoZSBhZGRyZXNzIGZyb20gdGhlIHBvb2wgYnkgcmVtb3ZpbmcgdGhlbSBmcm9tIHRoZSBuZXh0IGdlbmVyYXRpb24gKGFzIHdlbGwgYXMgY3JlYXRpbmcgaXQgaWYgaXQgZG9lc24ndCBleGlzdCkNCiAgICAgICAgLy8vIEBwYXJhbSBzZWxmIFRoZSBwb29sIHRvIG9wZXJhdGUgb24uDQogICAgICAgIC8vLyBAcGFyYW0gcmVzb3VyY2VBZGRyZXNzIFRoZSBhZGRyZXNzIGluIHF1ZXN0aW9uDQogICAgICAgIGZ1bmN0aW9uIGV4aXRQb29sKFBvb2wgc3RvcmFnZSBzZWxmLCBhZGRyZXNzIHJlc291cmNlQWRkcmVzcykgcHVibGljIHJldHVybnMgKHVpbnQpIHsNCiAgICAgICAgICAgIGlmICghY2FuRXhpdFBvb2woc2VsZiwgcmVzb3VyY2VBZGRyZXNzKSkgew0KICAgICAgICAgICAgICAgIHRocm93Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdWludCBuZXh0R2VuZXJhdGlvbklkID0gZ2V0TmV4dEdlbmVyYXRpb25JZChzZWxmKTsNCiAgICAgICAgICAgIGlmIChuZXh0R2VuZXJhdGlvbklkID09IDApIHsNCiAgICAgICAgICAgICAgICAvLyBObyBuZXh0IGdlbmVyYXRpb24gaGFzIGZvcm1lZCB5ZXQgc28gY3JlYXRlIGl0Lg0KICAgICAgICAgICAgICAgIG5leHRHZW5lcmF0aW9uSWQgPSBjcmVhdGVOZXh0R2VuZXJhdGlvbihzZWxmKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIC8vIFJlbW92ZSB0aGVtIGZyb20gdGhlIGdlbmVyYXRpb24NCiAgICAgICAgICAgIHJlbW92ZUZyb21HZW5lcmF0aW9uKHNlbGYsIG5leHRHZW5lcmF0aW9uSWQsIHJlc291cmNlQWRkcmVzcyk7DQogICAgICAgICAgICByZXR1cm4gbmV4dEdlbmVyYXRpb25JZDsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vLyBAZGV2IFJlbW92ZXMgdGhlIGFkZHJlc3MgZnJvbSBhIGdlbmVyYXRpb24ncyBtZW1iZXJzIGFycmF5LiBSZXR1cm5zIGJvb2xlYW4gYXMgdG8gd2hldGhlciByZW1vdmFsIHdhcyBzdWNjZXNzZnVsLg0KICAgICAgICAvLy8gQHBhcmFtIHNlbGYgVGhlIHBvb2wgdG8gb3BlcmF0ZSBvbi4NCiAgICAgICAgLy8vIEBwYXJhbSBnZW5lcmF0aW9uSWQgVGhlIGlkIG9mIHRoZSBnZW5lcmF0aW9uIHRvIG9wZXJhdGUgb24uDQogICAgICAgIC8vLyBAcGFyYW0gcmVzb3VyY2VBZGRyZXNzIFRoZSBhZGRyZXNzIHRvIGJlIHJlbW92ZWQuDQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUZyb21HZW5lcmF0aW9uKFBvb2wgc3RvcmFnZSBzZWxmLCB1aW50IGdlbmVyYXRpb25JZCwgYWRkcmVzcyByZXNvdXJjZUFkZHJlc3MpIHB1YmxpYyByZXR1cm5zIChib29sKXsNCiAgICAgICAgICAgIEdlbmVyYXRpb24gc3RvcmFnZSBnZW5lcmF0aW9uID0gc2VsZi5nZW5lcmF0aW9uc1tnZW5lcmF0aW9uSWRdOw0KICAgICAgICAgICAgLy8gbm93IHJlbW92ZSB0aGUgYWRkcmVzcw0KICAgICAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgZ2VuZXJhdGlvbi5tZW1iZXJzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgaWYgKGdlbmVyYXRpb24ubWVtYmVyc1tpXSA9PSByZXNvdXJjZUFkZHJlc3MpIHsNCiAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGlvbi5tZW1iZXJzW2ldID0gZ2VuZXJhdGlvbi5tZW1iZXJzW2dlbmVyYXRpb24ubWVtYmVycy5sZW5ndGggLSAxXTsNCiAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGlvbi5tZW1iZXJzLmxlbmd0aCAtPSAxOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCg0KICAgICAgICAvKg0KICAgICAgICAgKiAgQm9uZGluZw0KICAgICAgICAgKi8NCg0KICAgICAgICAvLy8gQGRldiBTdWJ0cmFjdHMgdGhlIGFtb3VudCBmcm9tIGFuIGFjY291bnQncyBib25kIGJhbGFuY2UuDQogICAgICAgIC8vLyBAcGFyYW0gc2VsZiBUaGUgcG9vbCB0byBvcGVyYXRlIG9uLg0KICAgICAgICAvLy8gQHBhcmFtIHJlc291cmNlQWRkcmVzcyBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudA0KICAgICAgICAvLy8gQHBhcmFtIHZhbHVlIFRoZSB2YWx1ZSB0byBzdWJ0cmFjdC4NCiAgICAgICAgZnVuY3Rpb24gZGVkdWN0RnJvbUJvbmQoUG9vbCBzdG9yYWdlIHNlbGYsIGFkZHJlc3MgcmVzb3VyY2VBZGRyZXNzLCB1aW50IHZhbHVlKSBwdWJsaWMgew0KICAgICAgICAgICAgICAgIC8qDQogICAgICAgICAgICAgICAgICogIGRlZHVjdCBmdW5kcyBmcm9tIGEgYm9uZCB2YWx1ZSB3aXRob3V0IHJpc2sgb2YgYW4NCiAgICAgICAgICAgICAgICAgKiAgdW5kZXJmbG93Lg0KICAgICAgICAgICAgICAgICAqLw0KICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA+IHNlbGYuYm9uZHNbcmVzb3VyY2VBZGRyZXNzXSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gUHJldmVudCBVbmRlcmZsb3cuDQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdzsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgc2VsZi5ib25kc1tyZXNvdXJjZUFkZHJlc3NdIC09IHZhbHVlOw0KICAgICAgICB9DQoNCiAgICAgICAgLy8vIEBkZXYgQWRkcyB0aGUgYW1vdW50IHRvIGFuIGFjY291bnQncyBib25kIGJhbGFuY2UuDQogICAgICAgIC8vLyBAcGFyYW0gc2VsZiBUaGUgcG9vbCB0byBvcGVyYXRlIG9uLg0KICAgICAgICAvLy8gQHBhcmFtIHJlc291cmNlQWRkcmVzcyBUaGUgYWRkcmVzcyBvZiB0aGUgYWNjb3VudA0KICAgICAgICAvLy8gQHBhcmFtIHZhbHVlIFRoZSB2YWx1ZSB0byBhZGQuDQogICAgICAgIGZ1bmN0aW9uIGFkZFRvQm9uZChQb29sIHN0b3JhZ2Ugc2VsZiwgYWRkcmVzcyByZXNvdXJjZUFkZHJlc3MsIHVpbnQgdmFsdWUpIHB1YmxpYyB7DQogICAgICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAgICAgKiAgQWRkIGZ1bmRzIHRvIGEgYm9uZCB2YWx1ZSB3aXRob3V0IHJpc2sgb2YgYW4NCiAgICAgICAgICAgICAgICAgKiAgb3ZlcmZsb3cuDQogICAgICAgICAgICAgICAgICovDQogICAgICAgICAgICAgICAgaWYgKHNlbGYuYm9uZHNbcmVzb3VyY2VBZGRyZXNzXSArIHZhbHVlIDwgc2VsZi5ib25kc1tyZXNvdXJjZUFkZHJlc3NdKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAvLyBQcmV2ZW50IE92ZXJmbG93DQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdzsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgc2VsZi5ib25kc1tyZXNvdXJjZUFkZHJlc3NdICs9IHZhbHVlOw0KICAgICAgICB9DQoNCiAgICAgICAgLy8vIEBkZXYgV2l0aGRyYXdzIGEgYm9uZCBhbW91bnQgZnJvbSBhbiBhZGRyZXNzJ3MgYm9uZCBhY2NvdW50LCBzZW5kaW5nIHRoZW0gdGhlIGNvcnJlc3BvbmRpbmcgYW1vdW50IGluIGV0aGVyLg0KICAgICAgICAvLy8gQHBhcmFtIHNlbGYgVGhlIHBvb2wgdG8gb3BlcmF0ZSBvbi4NCiAgICAgICAgLy8vIEBwYXJhbSByZXNvdXJjZUFkZHJlc3MgVGhlIGFkZHJlc3Mgb2YgdGhlIGFjY291bnQNCiAgICAgICAgLy8vIEBwYXJhbSB2YWx1ZSBUaGUgdmFsdWUgdG8gd2l0aGRyYXcuDQogICAgICAgIGZ1bmN0aW9uIHdpdGhkcmF3Qm9uZChQb29sIHN0b3JhZ2Ugc2VsZiwgYWRkcmVzcyByZXNvdXJjZUFkZHJlc3MsIHVpbnQgdmFsdWUsIHVpbnQgbWluaW11bUJvbmQpIHB1YmxpYyB7DQogICAgICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAgICAgKiAgT25seSBpZiB5b3UgYXJlIG5vdCBpbiBlaXRoZXIgb2YgdGhlIGN1cnJlbnQgY2FsbCBwb29scy4NCiAgICAgICAgICAgICAgICAgKi8NCiAgICAgICAgICAgICAgICAvLyBQcmV2ZW50IHVuZGVyZmxvdw0KICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA+IHNlbGYuYm9uZHNbcmVzb3VyY2VBZGRyZXNzXSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3c7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy8gRG8gYSBwZXJtaXNzaW9ucyBjaGVjayB0byBiZSBzdXJlIHRoZXkgY2FuIHdpdGhkcmF3IHRoZQ0KICAgICAgICAgICAgICAgIC8vIGZ1bmRzLg0KICAgICAgICAgICAgICAgIGlmIChpc0luUG9vbChzZWxmLCByZXNvdXJjZUFkZHJlc3MpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5ib25kc1tyZXNvdXJjZUFkZHJlc3NdIC0gdmFsdWUgPCBtaW5pbXVtQm9uZCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBkZWR1Y3RGcm9tQm9uZChzZWxmLCByZXNvdXJjZUFkZHJlc3MsIHZhbHVlKTsNCiAgICAgICAgICAgICAgICBpZiAoIXJlc291cmNlQWRkcmVzcy5zZW5kKHZhbHVlKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gUG90ZW50aWFsbHkgc2VuZGluZyBtb25leSB0byBhIGNvbnRyYWN0IHRoYXQNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhhcyBhIGZhbGxiYWNrIGZ1bmN0aW9uLiAgU28gaW5zdGVhZCwgdHJ5DQogICAgICAgICAgICAgICAgICAgICAgICAvLyB0cmFuZmVycmluZyB0aGUgZnVuZHMgd2l0aCB0aGUgY2FsbCBhcGkuDQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc291cmNlQWRkcmVzcy5jYWxsLmdhcyhtc2cuZ2FzKS52YWx1ZSh2YWx1ZSkoKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXZlcnQgdGhlIGVudGlyZSB0cmFuc2FjdGlvbi4gIE5vDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5lZWQgdG8gZGVzdHJveSB0aGUgZnVuZHMuDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93Ow0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KfQ0KDQoNCmNvbnRyYWN0IFJlbGF5IHsNCiAgICAgICAgYWRkcmVzcyBvcGVyYXRvcjsNCg0KICAgICAgICBmdW5jdGlvbiBSZWxheSgpIHsNCiAgICAgICAgICAgICAgICBvcGVyYXRvciA9IG1zZy5zZW5kZXI7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiByZWxheUNhbGwoYWRkcmVzcyBjb250cmFjdEFkZHJlc3MsIGJ5dGVzNCBhYmlTaWduYXR1cmUsIGJ5dGVzIGRhdGEpIHB1YmxpYyByZXR1cm5zIChib29sKSB7DQogICAgICAgICAgICAgICAgaWYgKG1zZy5zZW5kZXIgIT0gb3BlcmF0b3IpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXR1cm4gY29udHJhY3RBZGRyZXNzLmNhbGwoYWJpU2lnbmF0dXJlLCBkYXRhKTsNCiAgICAgICAgfQ0KfQ0KDQoNCg0KDQpsaWJyYXJ5IFNjaGVkdWxlZENhbGxMaWIgew0KICAgIC8qDQogICAgICogIEFkZHJlc3M6IDB4NWMzNjIzZGNlZjJkNTE2OGRiZTNlOGNjNTM4Nzg4Y2Q4OTEyZDg5OA0KICAgICAqLw0KICAgIHN0cnVjdCBDYWxsRGF0YWJhc2Ugew0KICAgICAgICBSZWxheSB1bmF1dGhvcml6ZWRSZWxheTsNCiAgICAgICAgUmVsYXkgYXV0aG9yaXplZFJlbGF5Ow0KDQogICAgICAgIGJ5dGVzMzIgbGFzdENhbGxLZXk7DQogICAgICAgIGJ5dGVzIGxhc3REYXRhOw0KICAgICAgICB1aW50IGxhc3REYXRhTGVuZ3RoOw0KICAgICAgICBieXRlczMyIGxhc3REYXRhSGFzaDsNCg0KICAgICAgICBSZXNvdXJjZVBvb2xMaWIuUG9vbCBjYWxsZXJQb29sOw0KICAgICAgICBHcm92ZUxpYi5JbmRleCBjYWxsSW5kZXg7DQoNCiAgICAgICAgQWNjb3VudGluZ0xpYi5CYW5rIGdhc0Jhbms7DQoNCiAgICAgICAgbWFwcGluZyAoYnl0ZXMzMiA9PiBDYWxsKSBjYWxsczsNCiAgICAgICAgbWFwcGluZyAoYnl0ZXMzMiA9PiBieXRlcykgZGF0YV9yZWdpc3RyeTsNCg0KICAgICAgICBtYXBwaW5nIChieXRlczMyID0+IGJvb2wpIGFjY291bnRBdXRob3JpemF0aW9uczsNCiAgICB9DQoNCiAgICBzdHJ1Y3QgQ2FsbCB7DQogICAgICAgICAgICBhZGRyZXNzIGNvbnRyYWN0QWRkcmVzczsNCiAgICAgICAgICAgIGFkZHJlc3Mgc2NoZWR1bGVkQnk7DQogICAgICAgICAgICB1aW50IGNhbGxlZEF0QmxvY2s7DQogICAgICAgICAgICB1aW50IHRhcmdldEJsb2NrOw0KICAgICAgICAgICAgdWludDggZ3JhY2VQZXJpb2Q7DQogICAgICAgICAgICB1aW50IG5vbmNlOw0KICAgICAgICAgICAgdWludCBiYXNlR2FzUHJpY2U7DQogICAgICAgICAgICB1aW50IGdhc1ByaWNlOw0KICAgICAgICAgICAgdWludCBnYXNVc2VkOw0KICAgICAgICAgICAgdWludCBnYXNDb3N0Ow0KICAgICAgICAgICAgdWludCBwYXlvdXQ7DQogICAgICAgICAgICB1aW50IGZlZTsNCiAgICAgICAgICAgIGFkZHJlc3MgZXhlY3V0ZWRCeTsNCiAgICAgICAgICAgIGJ5dGVzNCBhYmlTaWduYXR1cmU7DQogICAgICAgICAgICBib29sIGlzQ2FuY2VsbGVkOw0KICAgICAgICAgICAgYm9vbCB3YXNDYWxsZWQ7DQogICAgICAgICAgICBib29sIHdhc1N1Y2Nlc3NmdWw7DQogICAgICAgICAgICBieXRlczMyIGRhdGFIYXNoOw0KICAgIH0NCg0KICAgIC8vIFRoZSBhdXRob3IgKFBpcGVyIE1lcnJpYW0pIGFkZHJlc3MuDQogICAgYWRkcmVzcyBjb25zdGFudCBvd25lciA9IDB4ZDNjZGE5MTNkZWI2ZjY3OTY3Yjk5ZDY3YWNkZmExNzEyYzI5MzYwMTsNCg0KICAgIC8qDQogICAgICogIEdldHRlciBtZXRob2RzIGZvciBgQ2FsbGAgaW5mb3JtYXRpb24NCiAgICAgKi8NCiAgICBmdW5jdGlvbiBnZXRDYWxsQ29udHJhY3RBZGRyZXNzKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcykgew0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuY2FsbHNbY2FsbEtleV0uY29udHJhY3RBZGRyZXNzOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGdldENhbGxTY2hlZHVsZWRCeShDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGFkZHJlc3MpIHsNCiAgICAgICAgICAgIHJldHVybiBzZWxmLmNhbGxzW2NhbGxLZXldLnNjaGVkdWxlZEJ5Ow0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGdldENhbGxDYWxsZWRBdEJsb2NrKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuY2FsbHNbY2FsbEtleV0uY2FsbGVkQXRCbG9jazsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBnZXRDYWxsR3JhY2VQZXJpb2QoQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICByZXR1cm4gc2VsZi5jYWxsc1tjYWxsS2V5XS5ncmFjZVBlcmlvZDsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBnZXRDYWxsVGFyZ2V0QmxvY2soQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICByZXR1cm4gc2VsZi5jYWxsc1tjYWxsS2V5XS50YXJnZXRCbG9jazsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBnZXRDYWxsQmFzZUdhc1ByaWNlKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuY2FsbHNbY2FsbEtleV0uYmFzZUdhc1ByaWNlOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGdldENhbGxHYXNQcmljZShDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsNCiAgICAgICAgICAgIHJldHVybiBzZWxmLmNhbGxzW2NhbGxLZXldLmdhc1ByaWNlOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGdldENhbGxHYXNVc2VkKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuY2FsbHNbY2FsbEtleV0uZ2FzVXNlZDsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBnZXRDYWxsQUJJU2lnbmF0dXJlKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXM0KSB7DQogICAgICAgICAgICByZXR1cm4gc2VsZi5jYWxsc1tjYWxsS2V5XS5hYmlTaWduYXR1cmU7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gY2hlY2tJZkNhbGxlZChDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgIHJldHVybiBzZWxmLmNhbGxzW2NhbGxLZXldLndhc0NhbGxlZDsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBjaGVja0lmU3VjY2VzcyhDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgIHJldHVybiBzZWxmLmNhbGxzW2NhbGxLZXldLndhc1N1Y2Nlc3NmdWw7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gY2hlY2tJZkNhbmNlbGxlZChDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgIHJldHVybiBzZWxmLmNhbGxzW2NhbGxLZXldLmlzQ2FuY2VsbGVkOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGdldENhbGxEYXRhSGFzaChDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzMzIpIHsNCiAgICAgICAgICAgIHJldHVybiBzZWxmLmNhbGxzW2NhbGxLZXldLmRhdGFIYXNoOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGdldENhbGxQYXlvdXQoQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICByZXR1cm4gc2VsZi5jYWxsc1tjYWxsS2V5XS5wYXlvdXQ7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gZ2V0Q2FsbEZlZShDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsNCiAgICAgICAgICAgIHJldHVybiBzZWxmLmNhbGxzW2NhbGxLZXldLmZlZTsNCiAgICB9DQoNCiAgICAvKg0KICAgICAqICBTY2hlZHVsaW5nIEF1dGhvcml6YXRpb24gQVBJDQogICAgICovDQoNCiAgICBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGFkZHJlc3Mgc2NoZWR1bGVyQWRkcmVzcywgYWRkcmVzcyBjb250cmFjdEFkZHJlc3MpIHB1YmxpYyB7DQogICAgICAgICAgICBzZWxmLmFjY291bnRBdXRob3JpemF0aW9uc1tzaGEzKHNjaGVkdWxlckFkZHJlc3MsIGNvbnRyYWN0QWRkcmVzcyldID0gdHJ1ZTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiByZW1vdmVBdXRob3JpemF0aW9uKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGFkZHJlc3Mgc2NoZWR1bGVyQWRkcmVzcywgYWRkcmVzcyBjb250cmFjdEFkZHJlc3MpIHB1YmxpYyB7DQogICAgICAgICAgICBzZWxmLmFjY291bnRBdXRob3JpemF0aW9uc1tzaGEzKHNjaGVkdWxlckFkZHJlc3MsIGNvbnRyYWN0QWRkcmVzcyldID0gZmFsc2U7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gY2hlY2tBdXRob3JpemF0aW9uKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGFkZHJlc3Mgc2NoZWR1bGVyQWRkcmVzcywgYWRkcmVzcyBjb250cmFjdEFkZHJlc3MpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgIHJldHVybiBzZWxmLmFjY291bnRBdXRob3JpemF0aW9uc1tzaGEzKHNjaGVkdWxlckFkZHJlc3MsIGNvbnRyYWN0QWRkcmVzcyldOw0KICAgIH0NCg0KICAgIC8qDQogICAgICogIERhdGEgUmVnaXN0cnkgQVBJDQogICAgICovDQogICAgZnVuY3Rpb24gZ2V0Q2FsbERhdGEoQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zIChieXRlcykgew0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuZGF0YV9yZWdpc3RyeVtzZWxmLmNhbGxzW2NhbGxLZXldLmRhdGFIYXNoXTsNCiAgICB9DQoNCiAgICAvKg0KICAgICAqICBBUEkgdXNlZCBieSBBbGFybSBzZXJ2aWNlDQogICAgICovDQogICAgLy8gVGhlIG51bWJlciBvZiBibG9ja3MgdGhhdCBlYWNoIGNhbGxlciBpbiB0aGUgcG9vbCBoYXMgdG8gY29tcGxldGUgdGhlaXINCiAgICAvLyBjYWxsLg0KICAgIHVpbnQgY29uc3RhbnQgQ0FMTF9XSU5ET1dfU0laRSA9IDE2Ow0KDQogICAgZnVuY3Rpb24gZ2V0R2VuZXJhdGlvbklkRm9yQ2FsbChDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsNCiAgICAgICAgICAgIENhbGwgY2FsbCA9IHNlbGYuY2FsbHNbY2FsbEtleV07DQogICAgICAgICAgICByZXR1cm4gUmVzb3VyY2VQb29sTGliLmdldEdlbmVyYXRpb25Gb3JXaW5kb3coc2VsZi5jYWxsZXJQb29sLCBjYWxsLnRhcmdldEJsb2NrLCBjYWxsLnRhcmdldEJsb2NrICsgY2FsbC5ncmFjZVBlcmlvZCk7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gZ2V0RGVzaWduYXRlZENhbGxlcihDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlczMyIGNhbGxLZXksIHVpbnQgYmxvY2tOdW1iZXIpIGNvbnN0YW50IHJldHVybnMgKGFkZHJlc3MpIHsNCiAgICAgICAgICAgIC8qDQogICAgICAgICAgICAgKiAgUmV0dXJucyB0aGUgY2FsbGVyIGZyb20gdGhlIGN1cnJlbnQgY2FsbCBwb29sIHdobyBpcw0KICAgICAgICAgICAgICogIGRlc2lnbmF0ZWQgYXMgdGhlIGV4ZWN1dG9yIG9mIHRoaXMgY2FsbC4NCiAgICAgICAgICAgICAqLw0KICAgICAgICAgICAgQ2FsbCBjYWxsID0gc2VsZi5jYWxsc1tjYWxsS2V5XTsNCiAgICAgICAgICAgIGlmIChibG9ja051bWJlciA8IGNhbGwudGFyZ2V0QmxvY2sgfHwgYmxvY2tOdW1iZXIgPiBjYWxsLnRhcmdldEJsb2NrICsgY2FsbC5ncmFjZVBlcmlvZCkgew0KICAgICAgICAgICAgICAgICAgICAvLyBibG9ja051bWJlciBub3Qgd2l0aGluIGNhbGwgd2luZG93Lg0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gMHgwOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgaW4gZnJlZS1mb3ItYWxsIHdpbmRvdy4NCiAgICAgICAgICAgIHVpbnQgbnVtV2luZG93cyA9IGNhbGwuZ3JhY2VQZXJpb2QgLyBDQUxMX1dJTkRPV19TSVpFOw0KICAgICAgICAgICAgdWludCBibG9ja1dpbmRvdyA9IChibG9ja051bWJlciAtIGNhbGwudGFyZ2V0QmxvY2spIC8gQ0FMTF9XSU5ET1dfU0laRTsNCg0KICAgICAgICAgICAgaWYgKGJsb2NrV2luZG93ICsgMiA+IG51bVdpbmRvd3MpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gV2UgYXJlIHdpdGhpbiB0aGUgZnJlZS1mb3ItYWxsIHBlcmlvZC4NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDB4MDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8gTG9va3VwIHRoZSBwb29sIHRoYXQgZnVsbCBjb250YWlucyB0aGUgY2FsbCB3aW5kb3cgZm9yIHRoaXMNCiAgICAgICAgICAgIC8vIGNhbGwuDQogICAgICAgICAgICB1aW50IGdlbmVyYXRpb25JZCA9IFJlc291cmNlUG9vbExpYi5nZXRHZW5lcmF0aW9uRm9yV2luZG93KHNlbGYuY2FsbGVyUG9vbCwgY2FsbC50YXJnZXRCbG9jaywgY2FsbC50YXJnZXRCbG9jayArIGNhbGwuZ3JhY2VQZXJpb2QpOw0KICAgICAgICAgICAgaWYgKGdlbmVyYXRpb25JZCA9PSAwKSB7DQogICAgICAgICAgICAgICAgICAgIC8vIE5vIHBvb2wgY3VycmVudGx5IGluIG9wZXJhdGlvbi4NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDB4MDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHZhciBnZW5lcmF0aW9uID0gc2VsZi5jYWxsZXJQb29sLmdlbmVyYXRpb25zW2dlbmVyYXRpb25JZF07DQoNCiAgICAgICAgICAgIHVpbnQgb2Zmc2V0ID0gdWludChjYWxsS2V5KSAlIGdlbmVyYXRpb24ubWVtYmVycy5sZW5ndGg7DQogICAgICAgICAgICByZXR1cm4gZ2VuZXJhdGlvbi5tZW1iZXJzWyhvZmZzZXQgKyBibG9ja1dpbmRvdykgJSBnZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoXTsNCiAgICB9DQoNCiAgICBldmVudCBfQXdhcmRlZE1pc3NlZEJsb2NrQm9udXMoYWRkcmVzcyBpbmRleGVkIGZyb21DYWxsZXIsIGFkZHJlc3MgaW5kZXhlZCB0b0NhbGxlciwgdWludCBpbmRleGVkIGdlbmVyYXRpb25JZCwgYnl0ZXMzMiBjYWxsS2V5LCB1aW50IGJsb2NrTnVtYmVyLCB1aW50IGJvbnVzQW1vdW50KTsNCiAgICBmdW5jdGlvbiBBd2FyZGVkTWlzc2VkQmxvY2tCb251cyhhZGRyZXNzIGZyb21DYWxsZXIsIGFkZHJlc3MgdG9DYWxsZXIsIHVpbnQgZ2VuZXJhdGlvbklkLCBieXRlczMyIGNhbGxLZXksIHVpbnQgYmxvY2tOdW1iZXIsIHVpbnQgYm9udXNBbW91bnQpIHB1YmxpYyB7DQogICAgICAgIF9Bd2FyZGVkTWlzc2VkQmxvY2tCb251cyhmcm9tQ2FsbGVyLCB0b0NhbGxlciwgZ2VuZXJhdGlvbklkLCBjYWxsS2V5LCBibG9ja051bWJlciwgYm9udXNBbW91bnQpOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGdldE1pbmltdW1Cb25kKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgcmV0dXJuIHR4Lmdhc3ByaWNlICogYmxvY2suZ2FzbGltaXQ7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gZG9Cb25kQm9udXNUcmFuc2ZlcihDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBhZGRyZXNzIGZyb21DYWxsZXIsIGFkZHJlc3MgdG9DYWxsZXIpIGludGVybmFsIHJldHVybnMgKHVpbnQpIHsNCiAgICAgICAgICAgIHVpbnQgYm9udXNBbW91bnQgPSBnZXRNaW5pbXVtQm9uZCgpOw0KICAgICAgICAgICAgdWludCBib25kQmFsYW5jZSA9IHNlbGYuY2FsbGVyUG9vbC5ib25kc1tmcm9tQ2FsbGVyXTsNCg0KICAgICAgICAgICAgLy8gSWYgdGhlIGJvbmQgYmFsYW5jZSBpcyBsb3dlciB0aGFuIHRoZSBhd2FyZA0KICAgICAgICAgICAgLy8gYmFsYW5jZSwgdGhlbiBhZGp1c3QgdGhlIHJld2FyZCBhbW91bnQgdG8NCiAgICAgICAgICAgIC8vIG1hdGNoIHRoZSBib25kIGJhbGFuY2UuDQogICAgICAgICAgICBpZiAoYm9udXNBbW91bnQgPiBib25kQmFsYW5jZSkgew0KICAgICAgICAgICAgICAgICAgICBib251c0Ftb3VudCA9IGJvbmRCYWxhbmNlOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBUcmFuc2ZlciB0aGUgZnVuZHMgZnJvbUNhbGxlciA9PiB0b0NhbGxlcg0KICAgICAgICAgICAgUmVzb3VyY2VQb29sTGliLmRlZHVjdEZyb21Cb25kKHNlbGYuY2FsbGVyUG9vbCwgZnJvbUNhbGxlciwgYm9udXNBbW91bnQpOw0KICAgICAgICAgICAgUmVzb3VyY2VQb29sTGliLmFkZFRvQm9uZChzZWxmLmNhbGxlclBvb2wsIHRvQ2FsbGVyLCBib251c0Ftb3VudCk7DQoNCiAgICAgICAgICAgIHJldHVybiBib251c0Ftb3VudDsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBhd2FyZE1pc3NlZEJsb2NrQm9udXMoQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYWRkcmVzcyB0b0NhbGxlciwgYnl0ZXMzMiBjYWxsS2V5KSBwdWJsaWMgew0KICAgICAgICAgICAgdmFyIGNhbGwgPSBzZWxmLmNhbGxzW2NhbGxLZXldOw0KDQogICAgICAgICAgICB2YXIgZ2VuZXJhdGlvbiA9IHNlbGYuY2FsbGVyUG9vbC5nZW5lcmF0aW9uc1tSZXNvdXJjZVBvb2xMaWIuZ2V0R2VuZXJhdGlvbkZvcldpbmRvdyhzZWxmLmNhbGxlclBvb2wsIGNhbGwudGFyZ2V0QmxvY2ssIGNhbGwudGFyZ2V0QmxvY2sgKyBjYWxsLmdyYWNlUGVyaW9kKV07DQogICAgICAgICAgICB1aW50IGk7DQogICAgICAgICAgICB1aW50IGJvbnVzQW1vdW50Ow0KICAgICAgICAgICAgYWRkcmVzcyBmcm9tQ2FsbGVyOw0KDQogICAgICAgICAgICB1aW50IG51bVdpbmRvd3MgPSBjYWxsLmdyYWNlUGVyaW9kIC8gQ0FMTF9XSU5ET1dfU0laRTsNCiAgICAgICAgICAgIHVpbnQgYmxvY2tXaW5kb3cgPSAoYmxvY2subnVtYmVyIC0gY2FsbC50YXJnZXRCbG9jaykgLyBDQUxMX1dJTkRPV19TSVpFOw0KDQogICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBhcmUgd2l0aGluIHRoZSBmcmVlLWZvci1hbGwgcGVyaW9kLiAgSWYgc28sIHdlDQogICAgICAgICAgICAvLyBhd2FyZCBmcm9tIGFsbCBwb29sIG1lbWJlcnMuDQogICAgICAgICAgICBpZiAoYmxvY2tXaW5kb3cgKyAyID4gbnVtV2luZG93cykgew0KICAgICAgICAgICAgICAgICAgICBhZGRyZXNzIGZpcnN0Q2FsbGVyID0gZ2V0RGVzaWduYXRlZENhbGxlcihzZWxmLCBjYWxsS2V5LCBjYWxsLnRhcmdldEJsb2NrKTsNCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gY2FsbC50YXJnZXRCbG9jazsgaSA8PSBjYWxsLnRhcmdldEJsb2NrICsgY2FsbC5ncmFjZVBlcmlvZDsgaSArPSBDQUxMX1dJTkRPV19TSVpFKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbUNhbGxlciA9IGdldERlc2lnbmF0ZWRDYWxsZXIoc2VsZiwgY2FsbEtleSwgaSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZyb21DYWxsZXIgPT0gZmlyc3RDYWxsZXIgJiYgaSAhPSBjYWxsLnRhcmdldEJsb2NrKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSBoYXZlIGFscmVhZHkgZ29uZSB0aHJvdWdoIGFsbCBvZg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIHBvb2wgY2FsbGVycyBzbyB3ZSBzaG91bGQgYnJlYWsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG91dCBvZiB0aGUgbG9vcC4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZnJvbUNhbGxlciA9PSB0b0NhbGxlcikgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvbnVzQW1vdW50ID0gZG9Cb25kQm9udXNUcmFuc2ZlcihzZWxmLCBmcm9tQ2FsbGVyLCB0b0NhbGxlcik7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBMb2cgdGhlIGJvbnVzIHdhcyBhd2FyZGVkLg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIEF3YXJkZWRNaXNzZWRCbG9ja0JvbnVzKGZyb21DYWxsZXIsIHRvQ2FsbGVyLCBnZW5lcmF0aW9uLmlkLCBjYWxsS2V5LCBibG9jay5udW1iZXIsIGJvbnVzQW1vdW50KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIFNwZWNpYWwgY2FzZSBmb3Igc2luZ2xlIG1lbWJlciBhbmQgZW1wdHkgcG9vbHMNCiAgICAgICAgICAgIGlmIChnZW5lcmF0aW9uLm1lbWJlcnMubGVuZ3RoIDwgMikgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIE90aGVyd2lzZSB0aGUgYXdhcmQgY29tZXMgZnJvbSB0aGUgcHJldmlvdXMgY2FsbGVyLg0KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGdlbmVyYXRpb24ubWVtYmVycy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgICAgICAvLyBGaW5kIHdoZXJlIHRoZSBtZW1iZXIgaXMgaW4gdGhlIHBvb2wgYW5kDQogICAgICAgICAgICAgICAgICAgIC8vIGF3YXJkIGZyb20gdGhlIHByZXZpb3VzIHBvb2wgbWVtYmVycyBib25kLg0KICAgICAgICAgICAgICAgICAgICBpZiAoZ2VuZXJhdGlvbi5tZW1iZXJzW2ldID09IHRvQ2FsbGVyKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbUNhbGxlciA9IGdlbmVyYXRpb24ubWVtYmVyc1soaSArIGdlbmVyYXRpb24ubWVtYmVycy5sZW5ndGggLSAxKSAlIGdlbmVyYXRpb24ubWVtYmVycy5sZW5ndGhdOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9udXNBbW91bnQgPSBkb0JvbmRCb251c1RyYW5zZmVyKHNlbGYsIGZyb21DYWxsZXIsIHRvQ2FsbGVyKTsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIExvZyB0aGUgYm9udXMgd2FzIGF3YXJkZWQuDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgQXdhcmRlZE1pc3NlZEJsb2NrQm9udXMoZnJvbUNhbGxlciwgdG9DYWxsZXIsIGdlbmVyYXRpb24uaWQsIGNhbGxLZXksIGJsb2NrLm51bWJlciwgYm9udXNBbW91bnQpOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHRoZSBjYWxsZXIgZnJvbSB0aGUgbmV4dCBwb29sLg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChSZXNvdXJjZVBvb2xMaWIuZ2V0TmV4dEdlbmVyYXRpb25JZChzZWxmLmNhbGxlclBvb2wpID09IDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgdGhlIGZpcnN0IGFkZHJlc3MgdG8gbW9kaWZ5IHRoZQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY3VycmVudCBwb29sIHNvIHdlIG5lZWQgdG8gc2V0dXAgdGhlIG5leHQNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBvb2wuDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBSZXNvdXJjZVBvb2xMaWIuY3JlYXRlTmV4dEdlbmVyYXRpb24oc2VsZi5jYWxsZXJQb29sKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgUmVzb3VyY2VQb29sTGliLnJlbW92ZUZyb21HZW5lcmF0aW9uKHNlbGYuY2FsbGVyUG9vbCwgUmVzb3VyY2VQb29sTGliLmdldE5leHRHZW5lcmF0aW9uSWQoc2VsZi5jYWxsZXJQb29sKSwgZnJvbUNhbGxlcik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgfQ0KDQogICAgLyoNCiAgICAgKiAgRGF0YSByZWdpc3RyYXRpb24gQVBJDQogICAgICovDQogICAgZXZlbnQgX0RhdGFSZWdpc3RlcmVkKGJ5dGVzMzIgaW5kZXhlZCBkYXRhSGFzaCk7DQogICAgZnVuY3Rpb24gRGF0YVJlZ2lzdGVyZWQoYnl0ZXMzMiBkYXRhSGFzaCkgY29uc3RhbnQgew0KICAgICAgICBfRGF0YVJlZ2lzdGVyZWQoZGF0YUhhc2gpOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRGF0YShDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBieXRlcyBkYXRhKSBwdWJsaWMgew0KICAgICAgICAgICAgc2VsZi5sYXN0RGF0YS5sZW5ndGggPSBkYXRhLmxlbmd0aCAtIDQ7DQogICAgICAgICAgICBpZiAoZGF0YS5sZW5ndGggPiA0KSB7DQogICAgICAgICAgICAgICAgICAgIGZvciAodWludCBpID0gMDsgaSA8IHNlbGYubGFzdERhdGEubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxhc3REYXRhW2ldID0gZGF0YVtpICsgNF07DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHNlbGYuZGF0YV9yZWdpc3RyeVtzaGEzKHNlbGYubGFzdERhdGEpXSA9IHNlbGYubGFzdERhdGE7DQogICAgICAgICAgICBzZWxmLmxhc3REYXRhSGFzaCA9IHNoYTMoc2VsZi5sYXN0RGF0YSk7DQogICAgICAgICAgICBzZWxmLmxhc3REYXRhTGVuZ3RoID0gc2VsZi5sYXN0RGF0YS5sZW5ndGg7DQogICAgfQ0KDQogICAgLyoNCiAgICAgKiAgQ2FsbCBleGVjdXRpb24gQVBJDQogICAgICovDQogICAgLy8gVGhpcyBudW1iZXIgcmVwcmVzZW50cyB0aGUgY29uc3RhbnQgZ2FzIGNvc3Qgb2YgdGhlIGFkZGl0aW9uDQogICAgLy8gb3BlcmF0aW9ucyB0aGF0IG9jY3VyIGluIGBkb0NhbGxgIHRoYXQgY2Fubm90IGJlIHRyYWNrZWQgd2l0aA0KICAgIC8vIG1zZy5nYXMuDQogICAgdWludCBjb25zdGFudCBFWFRSQV9DQUxMX0dBUyA9IDE1MzMyMTsNCg0KICAgIC8vIFRoaXMgbnVtYmVyIHJlcHJlc2VudHMgdGhlIG92ZXJhbGwgb3ZlcmhlYWQgaW52b2x2ZWQgaW4gZXhlY3V0aW5nIGENCiAgICAvLyBzY2hlZHVsZWQgY2FsbC4NCiAgICB1aW50IGNvbnN0YW50IENBTExfT1ZFUkhFQUQgPSAxMjAxMDQ7DQoNCiAgICBldmVudCBfQ2FsbEV4ZWN1dGVkKGFkZHJlc3MgaW5kZXhlZCBleGVjdXRlZEJ5LCBieXRlczMyIGluZGV4ZWQgY2FsbEtleSk7DQogICAgZnVuY3Rpb24gQ2FsbEV4ZWN1dGVkKGFkZHJlc3MgZXhlY3V0ZWRCeSwgYnl0ZXMzMiBjYWxsS2V5KSBwdWJsaWMgew0KICAgICAgICBfQ2FsbEV4ZWN1dGVkKGV4ZWN1dGVkQnksIGNhbGxLZXkpOw0KICAgIH0NCiAgICBldmVudCBfQ2FsbEFib3J0ZWQoYWRkcmVzcyBpbmRleGVkIGV4ZWN1dGVkQnksIGJ5dGVzMzIgaW5kZXhlZCBjYWxsS2V5LCBieXRlczE4IHJlYXNvbik7DQogICAgZnVuY3Rpb24gQ2FsbEFib3J0ZWQoYWRkcmVzcyBleGVjdXRlZEJ5LCBieXRlczMyIGNhbGxLZXksIGJ5dGVzMTggcmVhc29uKSBwdWJsaWMgew0KICAgICAgICBfQ2FsbEFib3J0ZWQoZXhlY3V0ZWRCeSwgY2FsbEtleSwgcmVhc29uKTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBkb0NhbGwoQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYnl0ZXMzMiBjYWxsS2V5LCBhZGRyZXNzIG1zZ1NlbmRlcikgcHVibGljIHsNCiAgICAgICAgICAgIHVpbnQgZ2FzQmVmb3JlID0gbXNnLmdhczsNCg0KICAgICAgICAgICAgQ2FsbCBzdG9yYWdlIGNhbGwgPSBzZWxmLmNhbGxzW2NhbGxLZXldOw0KDQogICAgICAgICAgICBpZiAoY2FsbC53YXNDYWxsZWQpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGNhbGwgaGFzIGFscmVhZHkgYmVlbiBleGVjdXRlZCBzbyBkb24ndCBkbyBpdCBhZ2Fpbi4NCiAgICAgICAgICAgICAgICAgICAgX0NhbGxBYm9ydGVkKG1zZy5zZW5kZXIsIGNhbGxLZXksICJBTFJFQURZIENBTExFRCIpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmIChjYWxsLmlzQ2FuY2VsbGVkKSB7DQogICAgICAgICAgICAgICAgICAgIC8vIFRoZSBjYWxsIHdhcyBjYW5jZWxsZWQgc28gZG9uJ3QgZXhlY3V0ZSBpdC4NCiAgICAgICAgICAgICAgICAgICAgX0NhbGxBYm9ydGVkKG1zZy5zZW5kZXIsIGNhbGxLZXksICJDQU5DRUxMRUQiKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAoY2FsbC5jb250cmFjdEFkZHJlc3MgPT0gMHgwKSB7DQogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgY2FsbCBrZXkgZG9lc250IG1hcCB0byBhIHJlZ2lzdGVyZWQgY2FsbC4NCiAgICAgICAgICAgICAgICAgICAgX0NhbGxBYm9ydGVkKG1zZy5zZW5kZXIsIGNhbGxLZXksICJVTktOT1dOIik7DQogICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKGJsb2NrLm51bWJlciA8IGNhbGwudGFyZ2V0QmxvY2spIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gVGFyZ2V0IGJsb2NrIGhhc250IGhhcHBlbmVkIHlldC4NCiAgICAgICAgICAgICAgICAgICAgX0NhbGxBYm9ydGVkKG1zZy5zZW5kZXIsIGNhbGxLZXksICJUT08gRUFSTFkiKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAoYmxvY2subnVtYmVyID4gY2FsbC50YXJnZXRCbG9jayArIGNhbGwuZ3JhY2VQZXJpb2QpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIGJsb2NrY2hhaW4gaGFzIGFkdmFuY2VkIHBhc3NlZCB0aGUgcGVyaW9kIHdoZXJlDQogICAgICAgICAgICAgICAgICAgIC8vIGl0IHdhcyBhbGxvd2VkIHRvIGJlIGNhbGxlZC4NCiAgICAgICAgICAgICAgICAgICAgX0NhbGxBYm9ydGVkKG1zZy5zZW5kZXIsIGNhbGxLZXksICJUT08gTEFURSIpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHVpbnQgaGVsZEJhbGFuY2UgPSBnZXRDYWxsTWF4Q29zdChzZWxmLCBjYWxsS2V5KTsNCg0KICAgICAgICAgICAgaWYgKHNlbGYuZ2FzQmFuay5hY2NvdW50QmFsYW5jZXNbY2FsbC5zY2hlZHVsZWRCeV0gPCBoZWxkQmFsYW5jZSkgew0KICAgICAgICAgICAgICAgICAgICAvLyBUaGUgc2NoZWR1bGVkQnkncyBhY2NvdW50IGJhbGFuY2UgaXMgbGVzcyB0aGFuIHRoZQ0KICAgICAgICAgICAgICAgICAgICAvLyBjdXJyZW50IGdhc0xpbWl0IGFuZCB0aHVzIHBvdGVudGlhbGwgY2FuJ3QgcGF5IGZvcg0KICAgICAgICAgICAgICAgICAgICAvLyB0aGUgY2FsbC4NCg0KICAgICAgICAgICAgICAgICAgICAvLyBNYXJrIGl0IGFzIGNhbGxlZCBzaW5jZSBpdCB3YXMuDQogICAgICAgICAgICAgICAgICAgIGNhbGwud2FzQ2FsbGVkID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgIC8vIExvZyBpdC4NCiAgICAgICAgICAgICAgICAgICAgX0NhbGxBYm9ydGVkKG1zZy5zZW5kZXIsIGNhbGxLZXksICJJTlNVRkZJQ0lFTlRfRlVORFMiKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGlzIGNhbGxlciBpcyBhbGxvd2VkIHRvIGV4ZWN1dGUgdGhlIGNhbGwuDQogICAgICAgICAgICBpZiAoc2VsZi5jYWxsZXJQb29sLmdlbmVyYXRpb25zW1Jlc291cmNlUG9vbExpYi5nZXRDdXJyZW50R2VuZXJhdGlvbklkKHNlbGYuY2FsbGVyUG9vbCldLm1lbWJlcnMubGVuZ3RoID4gMCkgew0KICAgICAgICAgICAgICAgICAgICBhZGRyZXNzIGRlc2lnbmF0ZWRDYWxsZXIgPSBnZXREZXNpZ25hdGVkQ2FsbGVyKHNlbGYsIGNhbGxLZXksIGJsb2NrLm51bWJlcik7DQogICAgICAgICAgICAgICAgICAgIGlmIChkZXNpZ25hdGVkQ2FsbGVyICE9IDB4MCAmJiBkZXNpZ25hdGVkQ2FsbGVyICE9IG1zZ1NlbmRlcikgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgY2FsbCB3YXMgcmVzZXJ2ZWQgZm9yIHNvbWVvbmUgZnJvbSB0aGUNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBib25kZWQgcG9vbCBvZiBjYWxsZXJzIGFuZCBjYW4gb25seSBiZQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhbGxlZCBieSB0aGVtIGR1cmluZyB0aGlzIGJsb2NrIHdpbmRvdy4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfQ2FsbEFib3J0ZWQobXNnLnNlbmRlciwgY2FsbEtleSwgIldST05HX0NBTExFUiIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgIHVpbnQgYmxvY2tXaW5kb3cgPSAoYmxvY2subnVtYmVyIC0gY2FsbC50YXJnZXRCbG9jaykgLyBDQUxMX1dJTkRPV19TSVpFOw0KICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2tXaW5kb3cgPiAwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU29tZW9uZSBtaXNzZWQgdGhlaXIgY2FsbCBzbyB0aGlzIGNhbGxlcg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGdldHMgdG8gY2xhaW0gdGhlaXIgYm9uZCBmb3IgcGlja2luZyB1cA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZWlyIHNsYWNrLg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YXJkTWlzc2VkQmxvY2tCb251cyhzZWxmLCBtc2dTZW5kZXIsIGNhbGxLZXkpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIExvZyBtZXRhZGF0YSBhYm91dCB0aGUgY2FsbC4NCiAgICAgICAgICAgIGNhbGwuZ2FzUHJpY2UgPSB0eC5nYXNwcmljZTsNCiAgICAgICAgICAgIGNhbGwuZXhlY3V0ZWRCeSA9IG1zZ1NlbmRlcjsNCiAgICAgICAgICAgIGNhbGwuY2FsbGVkQXRCbG9jayA9IGJsb2NrLm51bWJlcjsNCg0KICAgICAgICAgICAgLy8gRmV0Y2ggdGhlIGNhbGwgZGF0YQ0KICAgICAgICAgICAgdmFyIGRhdGEgPSBzZWxmLmRhdGFfcmVnaXN0cnlbY2FsbC5kYXRhSGFzaF07DQoNCiAgICAgICAgICAgIC8vIER1cmluZyB0aGUgY2FsbCwgd2UgbmVlZCB0byBwdXQgZW5vdWdoIGZ1bmRzIHRvIHBheSBmb3IgdGhlDQogICAgICAgICAgICAvLyBjYWxsIG9uIGhvbGQgdG8gZW5zdXJlIHRoZXkgYXJlIGF2YWlsYWJsZSB0byBwYXkgdGhlIGNhbGxlci4NCiAgICAgICAgICAgIEFjY291bnRpbmdMaWIud2l0aGRyYXcoc2VsZi5nYXNCYW5rLCBjYWxsLnNjaGVkdWxlZEJ5LCBoZWxkQmFsYW5jZSk7DQoNCiAgICAgICAgICAgIC8vIE1hcmsgd2hldGhlciB0aGUgZnVuY3Rpb24gY2FsbCB3YXMgc3VjY2Vzc2Z1bC4NCiAgICAgICAgICAgIGlmIChjaGVja0F1dGhvcml6YXRpb24oc2VsZiwgY2FsbC5zY2hlZHVsZWRCeSwgY2FsbC5jb250cmFjdEFkZHJlc3MpKSB7DQogICAgICAgICAgICAgICAgICAgIGNhbGwud2FzU3VjY2Vzc2Z1bCA9IHNlbGYuYXV0aG9yaXplZFJlbGF5LnJlbGF5Q2FsbC5nYXMobXNnLmdhcyAtIENBTExfT1ZFUkhFQUQpKGNhbGwuY29udHJhY3RBZGRyZXNzLCBjYWxsLmFiaVNpZ25hdHVyZSwgZGF0YSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgY2FsbC53YXNTdWNjZXNzZnVsID0gc2VsZi51bmF1dGhvcml6ZWRSZWxheS5yZWxheUNhbGwuZ2FzKG1zZy5nYXMgLSBDQUxMX09WRVJIRUFEKShjYWxsLmNvbnRyYWN0QWRkcmVzcywgY2FsbC5hYmlTaWduYXR1cmUsIGRhdGEpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBBZGQgdGhlIGhlbGQgZnVuZHMgYmFjayBpbnRvIHRoZSBzY2hlZHVsZXIncyBhY2NvdW50Lg0KICAgICAgICAgICAgQWNjb3VudGluZ0xpYi5kZXBvc2l0KHNlbGYuZ2FzQmFuaywgY2FsbC5zY2hlZHVsZWRCeSwgaGVsZEJhbGFuY2UpOw0KDQogICAgICAgICAgICAvLyBNYXJrIHRoZSBjYWxsIGFzIGhhdmluZyBiZWVuIGV4ZWN1dGVkLg0KICAgICAgICAgICAgY2FsbC53YXNDYWxsZWQgPSB0cnVlOw0KDQogICAgICAgICAgICAvLyBDb21wdXRlIHRoZSBzY2FsYXIgKDAgLSAyMDApIGZvciB0aGUgZmVlLg0KICAgICAgICAgICAgdWludCBmZWVTY2FsYXIgPSBnZXRDYWxsRmVlU2NhbGFyKGNhbGwuYmFzZUdhc1ByaWNlLCBjYWxsLmdhc1ByaWNlKTsNCg0KICAgICAgICAgICAgLy8gTG9nIGhvdyBtdWNoIGdhcyB0aGlzIGNhbGwgdXNlZC4gIEVYVFJBX0NBTExfR0FTIGlzIGEgZml4ZWQNCiAgICAgICAgICAgIC8vIGFtb3VudCB0aGF0IHJlcHJlc2VudHMgdGhlIGdhcyB1c2FnZSBvZiB0aGUgY29tbWFuZHMgdGhhdA0KICAgICAgICAgICAgLy8gaGFwcGVuIGFmdGVyIHRoaXMgbGluZS4NCiAgICAgICAgICAgIGNhbGwuZ2FzVXNlZCA9IChnYXNCZWZvcmUgLSBtc2cuZ2FzICsgRVhUUkFfQ0FMTF9HQVMpOw0KICAgICAgICAgICAgY2FsbC5nYXNDb3N0ID0gY2FsbC5nYXNVc2VkICogY2FsbC5nYXNQcmljZTsNCg0KICAgICAgICAgICAgLy8gTm93IHdlIG5lZWQgdG8gcGF5IHRoZSBjYWxsZXIgYXMgd2VsbCBhcyBrZWVwIGZlZS4NCiAgICAgICAgICAgIC8vIGNhbGxlclBheW91dCAtPiBjYWxsIGNvc3QgKyAxJQ0KICAgICAgICAgICAgLy8gZmVlIC0+IDElIG9mIGNhbGxlclBheW91dA0KICAgICAgICAgICAgY2FsbC5wYXlvdXQgPSBjYWxsLmdhc0Nvc3QgKiBmZWVTY2FsYXIgKiAxMDEgLyAxMDAwMDsNCiAgICAgICAgICAgIGNhbGwuZmVlID0gY2FsbC5nYXNDb3N0ICogZmVlU2NhbGFyIC8gMTAwMDA7DQoNCiAgICAgICAgICAgIEFjY291bnRpbmdMaWIuZGVkdWN0RnVuZHMoc2VsZi5nYXNCYW5rLCBjYWxsLnNjaGVkdWxlZEJ5LCBjYWxsLnBheW91dCArIGNhbGwuZmVlKTsNCg0KICAgICAgICAgICAgQWNjb3VudGluZ0xpYi5hZGRGdW5kcyhzZWxmLmdhc0JhbmssIG1zZ1NlbmRlciwgY2FsbC5wYXlvdXQpOw0KICAgICAgICAgICAgQWNjb3VudGluZ0xpYi5hZGRGdW5kcyhzZWxmLmdhc0JhbmssIG93bmVyLCBjYWxsLmZlZSk7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gZ2V0Q2FsbE1heENvc3QoQ2FsbERhdGFiYXNlIHN0b3JhZ2Ugc2VsZiwgYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICAvKg0KICAgICAgICAgICAgICogIHR4Lmdhc3ByaWNlICogYmxvY2suZ2FzbGltaXQNCiAgICAgICAgICAgICAqICANCiAgICAgICAgICAgICAqLw0KICAgICAgICAgICAgLy8gY2FsbCBjb3N0ICsgMiUNCiAgICAgICAgICAgIHZhciBjYWxsID0gc2VsZi5jYWxsc1tjYWxsS2V5XTsNCg0KICAgICAgICAgICAgdWludCBnYXNDb3N0ID0gdHguZ2FzcHJpY2UgKiBibG9jay5nYXNsaW1pdDsNCiAgICAgICAgICAgIHVpbnQgZmVlU2NhbGFyID0gZ2V0Q2FsbEZlZVNjYWxhcihjYWxsLmJhc2VHYXNQcmljZSwgdHguZ2FzcHJpY2UpOw0KDQogICAgICAgICAgICByZXR1cm4gZ2FzQ29zdCAqIGZlZVNjYWxhciAqIDEwMiAvIDEwMDAwOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGdldENhbGxGZWVTY2FsYXIodWludCBiYXNlR2FzUHJpY2UsIHVpbnQgZ2FzUHJpY2UpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsNCiAgICAgICAgICAgIC8qDQogICAgICAgICAgICAgKiAgUmV0dXJuIGEgbnVtYmVyIGJldHdlZW4gMCAtIDIwMCB0byBzY2FsZSB0aGUgZmVlIGJhc2VkIG9uDQogICAgICAgICAgICAgKiAgdGhlIGdhcyBwcmljZSBzZXQgZm9yIHRoZSBjYWxsaW5nIHRyYW5zYWN0aW9uIGFzIGNvbXBhcmVkDQogICAgICAgICAgICAgKiAgdG8gdGhlIGdhcyBwcmljZSBvZiB0aGUgc2NoZWR1bGluZyB0cmFuc2FjdGlvbi4NCiAgICAgICAgICAgICAqDQogICAgICAgICAgICAgKiAgLSBudW1iZXIgYXBwcm9hY2hlcyB6ZXJvIGFzIHRoZSB0cmFuc2FjdGlvbiBnYXMgcHJpY2UgZ29lcw0KICAgICAgICAgICAgICogIGFib3ZlIHRoZSBnYXMgcHJpY2UgcmVjb3JkZWQgd2hlbiB0aGUgY2FsbCB3YXMgc2NoZWR1bGVkLg0KICAgICAgICAgICAgICoNCiAgICAgICAgICAgICAqICAtIHRoZSBudW1iZXIgYXBwcm9hY2hlcyAyMDAgYXMgdGhlIHRyYW5zYWN0aW9uIGdhcyBwcmljZQ0KICAgICAgICAgICAgICogIGRyb3BzIHVuZGVyIHRoZSBwcmljZSByZWNvcmRlZCB3aGVuIHRoZSBjYWxsIHdhcyBzY2hlZHVsZWQuDQogICAgICAgICAgICAgKg0KICAgICAgICAgICAgICogIFRoaXMgZW5jb3VyYWdlcyBsb3dlciBnYXMgY29zdHMgYXMgdGhlIGxvd2VyIHRoZSBnYXMgcHJpY2UNCiAgICAgICAgICAgICAqICBmb3IgdGhlIGV4ZWN1dGluZyB0cmFuc2FjdGlvbiwgdGhlIGhpZ2hlciB0aGUgcGF5b3V0IHRvIHRoZQ0KICAgICAgICAgICAgICogIGNhbGxlci4NCiAgICAgICAgICAgICAqLw0KICAgICAgICAgICAgaWYgKGdhc1ByaWNlID4gYmFzZUdhc1ByaWNlKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiAxMDAgKiBiYXNlR2FzUHJpY2UgLyBnYXNQcmljZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gMjAwIC0gMTAwICogYmFzZUdhc1ByaWNlIC8gKDIgKiBiYXNlR2FzUHJpY2UgLSBnYXNQcmljZSk7DQogICAgICAgICAgICB9DQogICAgfQ0KDQogICAgLyoNCiAgICAgKiAgQ2FsbCBTY2hlZHVsaW5nIEFQSQ0KICAgICAqLw0KDQogICAgLy8gVGhlIHJlc3VsdCBvZiBgc2hhKClgIHNvIHRoYXQgd2UgY2FuIHZhbGlkYXRlIHRoYXQgcGVvcGxlIGFyZW4ndA0KICAgIC8vIGxvb2tpbmcgdXAgY2FsbCBkYXRhIHRoYXQgZmFpbGVkIHRvIHJlZ2lzdGVyLg0KICAgIGJ5dGVzMzIgY29uc3RhbnQgZW1wdHlEYXRhSGFzaCA9IDB4YzVkMjQ2MDE4NmY3MjMzYzkyN2U3ZGIyZGNjNzAzYzBlNTAwYjY1M2NhODIyNzNiN2JmYWQ4MDQ1ZDg1YTQ3MDsNCg0KICAgIGZ1bmN0aW9uIGNvbXB1dGVDYWxsS2V5KGFkZHJlc3Mgc2NoZWR1bGVkQnksIGFkZHJlc3MgY29udHJhY3RBZGRyZXNzLCBieXRlczQgYWJpU2lnbmF0dXJlLCBieXRlczMyIGRhdGFIYXNoLCB1aW50IHRhcmdldEJsb2NrLCB1aW50OCBncmFjZVBlcmlvZCwgdWludCBub25jZSkgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXMzMikgew0KICAgICAgICAgICAgcmV0dXJuIHNoYTMoc2NoZWR1bGVkQnksIGNvbnRyYWN0QWRkcmVzcywgYWJpU2lnbmF0dXJlLCBkYXRhSGFzaCwgdGFyZ2V0QmxvY2ssIGdyYWNlUGVyaW9kLCBub25jZSk7DQogICAgfQ0KDQogICAgLy8gVGVuIG1pbnV0ZXMgaW50byB0aGUgZnV0dXJlLg0KICAgIHVpbnQgY29uc3RhbnQgTUFYX0JMT0NLU19JTl9GVVRVUkUgPSA0MDsNCg0KICAgIGV2ZW50IF9DYWxsU2NoZWR1bGVkKGJ5dGVzMzIgaW5kZXhlZCBjYWxsS2V5KTsNCiAgICBmdW5jdGlvbiBDYWxsU2NoZWR1bGVkKGJ5dGVzMzIgY2FsbEtleSkgcHVibGljIHsNCiAgICAgICAgX0NhbGxTY2hlZHVsZWQoY2FsbEtleSk7DQogICAgfQ0KICAgIGV2ZW50IF9DYWxsUmVqZWN0ZWQoYnl0ZXMzMiBpbmRleGVkIGNhbGxLZXksIGJ5dGVzMTUgcmVhc29uKTsNCiAgICBmdW5jdGlvbiBDYWxsUmVqZWN0ZWQoYnl0ZXMzMiBjYWxsS2V5LCBieXRlczE1IHJlYXNvbikgcHVibGljIHsNCiAgICAgICAgX0NhbGxSZWplY3RlZChjYWxsS2V5LCByZWFzb24pOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGdldENhbGxXaW5kb3dTaXplKCkgcHVibGljIHJldHVybnMgKHVpbnQpIHsNCiAgICAgICAgcmV0dXJuIENBTExfV0lORE9XX1NJWkU7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gZ2V0TWluaW11bUdyYWNlUGVyaW9kKCkgcHVibGljIHJldHVybnMgKHVpbnQpIHsNCiAgICAgICAgcmV0dXJuIDQgKiBDQUxMX1dJTkRPV19TSVpFOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbChDYWxsRGF0YWJhc2Ugc3RvcmFnZSBzZWxmLCBhZGRyZXNzIHNjaGVkdWxlckFkZHJlc3MsIGFkZHJlc3MgY29udHJhY3RBZGRyZXNzLCBieXRlczQgYWJpU2lnbmF0dXJlLCBieXRlczMyIGRhdGFIYXNoLCB1aW50IHRhcmdldEJsb2NrLCB1aW50OCBncmFjZVBlcmlvZCwgdWludCBub25jZSkgcHVibGljIHJldHVybnMgKGJ5dGVzMTUpIHsNCiAgICAgICAgICAgIC8qDQogICAgICAgICAgICAgKiBQcmltYXJ5IEFQSSBmb3Igc2NoZWR1bGluZyBhIGNhbGwuICBQcmlvciB0byBjYWxsaW5nIHRoaXMNCiAgICAgICAgICAgICAqIHRoZSBkYXRhIHNob3VsZCBhbHJlYWR5IGhhdmUgYmVlbiByZWdpc3RlcmVkIHRocm91Z2ggdGhlDQogICAgICAgICAgICAgKiBgcmVnaXN0ZXJEYXRhYCBBUEkuDQogICAgICAgICAgICAgKi8NCiAgICAgICAgICAgIGJ5dGVzMzIgY2FsbEtleSA9IGNvbXB1dGVDYWxsS2V5KHNjaGVkdWxlckFkZHJlc3MsIGNvbnRyYWN0QWRkcmVzcywgYWJpU2lnbmF0dXJlLCBkYXRhSGFzaCwgdGFyZ2V0QmxvY2ssIGdyYWNlUGVyaW9kLCBub25jZSk7DQoNCiAgICAgICAgICAgIGlmIChkYXRhSGFzaCAhPSBlbXB0eURhdGFIYXNoICYmIHNlbGYuZGF0YV9yZWdpc3RyeVtkYXRhSGFzaF0ubGVuZ3RoID09IDApIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgYWxsb3cgcmVnaXN0ZXJpbmcgY2FsbHMgaWYgdGhlIGRhdGEgaGFzaCBoYXMNCiAgICAgICAgICAgICAgICAgICAgLy8gbm90IGFjdHVhbGx5IGJlZW4gcmVnaXN0ZXJlZC4gIFRoZSBvbmx5IGV4Y2VwdGlvbiBpcw0KICAgICAgICAgICAgICAgICAgICAvLyB0aGUgKmVtcHR5RGF0YUhhc2gqLg0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gIk5PX0RBVEEiOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAodGFyZ2V0QmxvY2sgPCBibG9jay5udW1iZXIgKyBNQVhfQkxPQ0tTX0lOX0ZVVFVSRSkgew0KICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBhbGxvdyBzY2hlZHVsaW5nIGZ1cnRoZXIgdGhhbg0KICAgICAgICAgICAgICAgICAgICAvLyBNQVhfQkxPQ0tTX0lOX0ZVVFVSRQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gIlRPT19TT09OIjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIENhbGwgc3RvcmFnZSBjYWxsID0gc2VsZi5jYWxsc1tjYWxsS2V5XTsNCg0KICAgICAgICAgICAgaWYgKGNhbGwuY29udHJhY3RBZGRyZXNzICE9IDB4MCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gIkRVUExJQ0FURSI7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlmIChncmFjZVBlcmlvZCA8IGdldE1pbmltdW1HcmFjZVBlcmlvZCgpKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiAiR1JBQ0VfVE9PX1NIT1JUIjsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgc2VsZi5sYXN0Q2FsbEtleSA9IGNhbGxLZXk7DQoNCiAgICAgICAgICAgIGNhbGwuY29udHJhY3RBZGRyZXNzID0gY29udHJhY3RBZGRyZXNzOw0KICAgICAgICAgICAgY2FsbC5zY2hlZHVsZWRCeSA9IHNjaGVkdWxlckFkZHJlc3M7DQogICAgICAgICAgICBjYWxsLm5vbmNlID0gbm9uY2U7DQogICAgICAgICAgICBjYWxsLmFiaVNpZ25hdHVyZSA9IGFiaVNpZ25hdHVyZTsNCiAgICAgICAgICAgIGNhbGwuZGF0YUhhc2ggPSBkYXRhSGFzaDsNCiAgICAgICAgICAgIGNhbGwudGFyZ2V0QmxvY2sgPSB0YXJnZXRCbG9jazsNCiAgICAgICAgICAgIGNhbGwuZ3JhY2VQZXJpb2QgPSBncmFjZVBlcmlvZDsNCiAgICAgICAgICAgIGNhbGwuYmFzZUdhc1ByaWNlID0gdHguZ2FzcHJpY2U7DQoNCiAgICAgICAgICAgIC8vIFB1dCB0aGUgY2FsbCBpbnRvIHRoZSBncm92ZSBpbmRleC4NCiAgICAgICAgICAgIEdyb3ZlTGliLmluc2VydChzZWxmLmNhbGxJbmRleCwgY2FsbEtleSwgaW50KGNhbGwudGFyZ2V0QmxvY2spKTsNCg0KICAgICAgICAgICAgcmV0dXJuIDB4MDsNCiAgICB9DQoNCiAgICBldmVudCBfQ2FsbENhbmNlbGxlZChieXRlczMyIGluZGV4ZWQgY2FsbEtleSk7DQogICAgZnVuY3Rpb24gQ2FsbENhbmNlbGxlZChieXRlczMyIGNhbGxLZXkpIHB1YmxpYyB7DQogICAgICAgIF9DYWxsQ2FuY2VsbGVkKGNhbGxLZXkpOw0KICAgIH0NCg0KICAgIC8vIFR3byBtaW51dGVzDQogICAgdWludCBjb25zdGFudCBNSU5fQ0FOQ0VMX1dJTkRPVyA9IDg7DQoNCiAgICBmdW5jdGlvbiBjYW5jZWxDYWxsKENhbGxEYXRhYmFzZSBzdG9yYWdlIHNlbGYsIGJ5dGVzMzIgY2FsbEtleSwgYWRkcmVzcyBtc2dTZW5kZXIpIHB1YmxpYyByZXR1cm5zIChib29sKSB7DQogICAgICAgICAgICBDYWxsIHN0b3JhZ2UgY2FsbCA9IHNlbGYuY2FsbHNbY2FsbEtleV07DQogICAgICAgICAgICBpZiAoY2FsbC5zY2hlZHVsZWRCeSAhPSBtc2dTZW5kZXIpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gTm9ib2R5IGJ1dCB0aGUgc2NoZWR1bGVyIGNhbiBjYW5jZWwgYSBjYWxsLg0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoY2FsbC53YXNDYWxsZWQpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBjYW5jZWwgYSBjYWxsIHRoYXQgYWxyZWFkeSB3YXMgZXhlY3V0ZWQuDQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChjYWxsLnRhcmdldEJsb2NrIC0gTUlOX0NBTkNFTF9XSU5ET1cgPD0gYmxvY2subnVtYmVyKSB7DQogICAgICAgICAgICAgICAgICAgIC8vIENhbGwgY2Fubm90IGJlIGNhbmNlbGxlZCB0aGlzIGNsb3NlIHRvIGV4ZWN1dGlvbi4NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FsbC5pc0NhbmNlbGxlZCA9IHRydWU7DQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQp9DQoNCg0KLyoNCiAqICBFdGhlcmV1bSBBbGFybSBTZXJ2aWNlDQogKiAgVmVyc2lvbiAwLjQuMA0KICoNCiAqICBhZGRyZXNzOiAweDA3MzA3ZDBiMTM2YTc5YmFjNzE4ZjQzMzg4YWVkNzA2Mzg5YzQ1ODgNCiAqLw0KY29udHJhY3QgQWxhcm0gew0KICAgICAgICAvKg0KICAgICAgICAgKiAgQ29uc3RydWN0b3INCiAgICAgICAgICoNCiAgICAgICAgICogIC0gc2V0cyB1cCByZWxheXMNCiAgICAgICAgICogIC0gY29uZmlndXJlcyB0aGUgY2FsbGVyIHBvb2wuDQogICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBBbGFybSgpIHsNCiAgICAgICAgICAgICAgICBjYWxsRGF0YWJhc2UudW5hdXRob3JpemVkUmVsYXkgPSBuZXcgUmVsYXkoKTsNCiAgICAgICAgICAgICAgICBjYWxsRGF0YWJhc2UuYXV0aG9yaXplZFJlbGF5ID0gbmV3IFJlbGF5KCk7DQoNCiAgICAgICAgICAgICAgICBjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbC5mcmVlemVQZXJpb2QgPSA4MDsNCiAgICAgICAgICAgICAgICBjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbC5yb3RhdGlvbkRlbGF5ID0gODA7DQogICAgICAgICAgICAgICAgY2FsbERhdGFiYXNlLmNhbGxlclBvb2wub3ZlcmxhcFNpemUgPSAyNTY7DQogICAgICAgIH0NCg0KICAgICAgICBTY2hlZHVsZWRDYWxsTGliLkNhbGxEYXRhYmFzZSBjYWxsRGF0YWJhc2U7DQoNCiAgICAgICAgLy8gVGhlIGF1dGhvciAoUGlwZXIgTWVycmlhbSkgYWRkcmVzcy4NCiAgICAgICAgYWRkcmVzcyBjb25zdGFudCBvd25lciA9IDB4ZDNjZGE5MTNkZWI2ZjY3OTY3Yjk5ZDY3YWNkZmExNzEyYzI5MzYwMTsNCg0KICAgICAgICAvKg0KICAgICAgICAgKiAgQWNjb3VudCBNYW5hZ2VtZW50IEFQSQ0KICAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gZ2V0QWNjb3VudEJhbGFuY2UoYWRkcmVzcyBhY2NvdW50QWRkcmVzcykgY29uc3RhbnQgcHVibGljIHJldHVybnMgKHVpbnQpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbERhdGFiYXNlLmdhc0JhbmsuYWNjb3VudEJhbGFuY2VzW2FjY291bnRBZGRyZXNzXTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGRlcG9zaXQoKSBwdWJsaWMgew0KICAgICAgICAgICAgICAgIGRlcG9zaXQobXNnLnNlbmRlcik7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBkZXBvc2l0KGFkZHJlc3MgYWNjb3VudEFkZHJlc3MpIHB1YmxpYyB7DQogICAgICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAgICAgKiAgUHVibGljIEFQSSBmb3IgZGVwb3NpdGluZyBmdW5kcyBpbiBhIHNwZWNpZmllZCBhY2NvdW50Lg0KICAgICAgICAgICAgICAgICAqLw0KICAgICAgICAgICAgICAgIEFjY291bnRpbmdMaWIuZGVwb3NpdChjYWxsRGF0YWJhc2UuZ2FzQmFuaywgYWNjb3VudEFkZHJlc3MsIG1zZy52YWx1ZSk7DQogICAgICAgICAgICAgICAgQWNjb3VudGluZ0xpYi5EZXBvc2l0KG1zZy5zZW5kZXIsIGFjY291bnRBZGRyZXNzLCBtc2cudmFsdWUpOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gd2l0aGRyYXcodWludCB2YWx1ZSkgcHVibGljIHsNCiAgICAgICAgICAgICAgICAvKg0KICAgICAgICAgICAgICAgICAqICBQdWJsaWMgQVBJIGZvciB3aXRoZHJhd2luZyBmdW5kcy4NCiAgICAgICAgICAgICAgICAgKi8NCiAgICAgICAgICAgICAgICBpZiAoQWNjb3VudGluZ0xpYi53aXRoZHJhdyhjYWxsRGF0YWJhc2UuZ2FzQmFuaywgbXNnLnNlbmRlciwgdmFsdWUpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBBY2NvdW50aW5nTGliLldpdGhkcmF3YWwobXNnLnNlbmRlciwgdmFsdWUpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIEFjY291bnRpbmdMaWIuSW5zdWZmaWNpZW50RnVuZHMobXNnLnNlbmRlciwgdmFsdWUsIGNhbGxEYXRhYmFzZS5nYXNCYW5rLmFjY291bnRCYWxhbmNlc1ttc2cuc2VuZGVyXSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAgICAgKiAgRmFsbGJhY2sgZnVuY3Rpb24gdGhhdCBhbGxvd3MgZGVwb3NpdGluZyBmdW5kcyBqdXN0IGJ5DQogICAgICAgICAgICAgICAgICogIHNlbmRpbmcgYSB0cmFuc2FjdGlvbi4NCiAgICAgICAgICAgICAgICAgKi8NCiAgICAgICAgICAgICAgICBkZXBvc2l0KG1zZy5zZW5kZXIpOw0KICAgICAgICB9DQoNCiAgICAgICAgLyoNCiAgICAgICAgICogIFNjaGVkdWxpbmcgQXV0aG9yaXphdGlvbiBBUEkNCiAgICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIHVuYXV0aG9yaXplZEFkZHJlc3MoKSBjb25zdGFudCByZXR1cm5zIChhZGRyZXNzKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGFkZHJlc3MoY2FsbERhdGFiYXNlLnVuYXV0aG9yaXplZFJlbGF5KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGF1dGhvcml6ZWRBZGRyZXNzKCkgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcykgew0KICAgICAgICAgICAgICAgIHJldHVybiBhZGRyZXNzKGNhbGxEYXRhYmFzZS5hdXRob3JpemVkUmVsYXkpOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihhZGRyZXNzIHNjaGVkdWxlckFkZHJlc3MpIHB1YmxpYyB7DQogICAgICAgICAgICAgICAgU2NoZWR1bGVkQ2FsbExpYi5hZGRBdXRob3JpemF0aW9uKGNhbGxEYXRhYmFzZSwgc2NoZWR1bGVyQWRkcmVzcywgbXNnLnNlbmRlcik7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiByZW1vdmVBdXRob3JpemF0aW9uKGFkZHJlc3Mgc2NoZWR1bGVyQWRkcmVzcykgcHVibGljIHsNCiAgICAgICAgICAgICAgICBjYWxsRGF0YWJhc2UuYWNjb3VudEF1dGhvcml6YXRpb25zW3NoYTMoc2NoZWR1bGVyQWRkcmVzcywgbXNnLnNlbmRlcildID0gZmFsc2U7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBjaGVja0F1dGhvcml6YXRpb24oYWRkcmVzcyBzY2hlZHVsZXJBZGRyZXNzLCBhZGRyZXNzIGNvbnRyYWN0QWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBjYWxsRGF0YWJhc2UuYWNjb3VudEF1dGhvcml6YXRpb25zW3NoYTMoc2NoZWR1bGVyQWRkcmVzcywgY29udHJhY3RBZGRyZXNzKV07DQogICAgICAgIH0NCg0KICAgICAgICAvKg0KICAgICAgICAgKiAgQ2FsbGVyIGJvbmRpbmcNCiAgICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIGdldE1pbmltdW1Cb25kKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmdldE1pbmltdW1Cb25kKCk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBkZXBvc2l0Qm9uZCgpIHB1YmxpYyB7DQogICAgICAgICAgICAgICAgUmVzb3VyY2VQb29sTGliLmFkZFRvQm9uZChjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbCwgbXNnLnNlbmRlciwgbXNnLnZhbHVlKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIHdpdGhkcmF3Qm9uZCh1aW50IHZhbHVlKSBwdWJsaWMgew0KICAgICAgICAgICAgICAgIFJlc291cmNlUG9vbExpYi53aXRoZHJhd0JvbmQoY2FsbERhdGFiYXNlLmNhbGxlclBvb2wsIG1zZy5zZW5kZXIsIHZhbHVlLCBnZXRNaW5pbXVtQm9uZCgpKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldEJvbmRCYWxhbmNlKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRCb25kQmFsYW5jZShtc2cuc2VuZGVyKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldEJvbmRCYWxhbmNlKGFkZHJlc3MgY2FsbGVyQWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbC5ib25kc1tjYWxsZXJBZGRyZXNzXTsNCiAgICAgICAgfQ0KDQoNCiAgICAgICAgLyoNCiAgICAgICAgICogIFBvb2wgTWFuYWdlbWVudA0KICAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gZ2V0R2VuZXJhdGlvbkZvckNhbGwoYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICAgICAgdmFyIGNhbGwgPSBjYWxsRGF0YWJhc2UuY2FsbHNbY2FsbEtleV07DQogICAgICAgICAgICAgICAgcmV0dXJuIFJlc291cmNlUG9vbExpYi5nZXRHZW5lcmF0aW9uRm9yV2luZG93KGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLCBjYWxsLnRhcmdldEJsb2NrLCBjYWxsLnRhcmdldEJsb2NrICsgY2FsbC5ncmFjZVBlcmlvZCk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBnZXRHZW5lcmF0aW9uU2l6ZSh1aW50IGdlbmVyYXRpb25JZCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbC5nZW5lcmF0aW9uc1tnZW5lcmF0aW9uSWRdLm1lbWJlcnMubGVuZ3RoOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gZ2V0R2VuZXJhdGlvblN0YXJ0QXQodWludCBnZW5lcmF0aW9uSWQpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbERhdGFiYXNlLmNhbGxlclBvb2wuZ2VuZXJhdGlvbnNbZ2VuZXJhdGlvbklkXS5zdGFydEF0Ow0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gZ2V0R2VuZXJhdGlvbkVuZEF0KHVpbnQgZ2VuZXJhdGlvbklkKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLmdlbmVyYXRpb25zW2dlbmVyYXRpb25JZF0uZW5kQXQ7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50R2VuZXJhdGlvbklkKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBSZXNvdXJjZVBvb2xMaWIuZ2V0Q3VycmVudEdlbmVyYXRpb25JZChjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbCk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0R2VuZXJhdGlvbklkKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBSZXNvdXJjZVBvb2xMaWIuZ2V0TmV4dEdlbmVyYXRpb25JZChjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbCk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBpc0luUG9vbCgpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gUmVzb3VyY2VQb29sTGliLmlzSW5Qb29sKGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLCBtc2cuc2VuZGVyKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGlzSW5Qb29sKGFkZHJlc3MgY2FsbGVyQWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBSZXNvdXJjZVBvb2xMaWIuaXNJblBvb2woY2FsbERhdGFiYXNlLmNhbGxlclBvb2wsIGNhbGxlckFkZHJlc3MpOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gaXNJbkdlbmVyYXRpb24odWludCBnZW5lcmF0aW9uSWQpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gaXNJbkdlbmVyYXRpb24obXNnLnNlbmRlciwgZ2VuZXJhdGlvbklkKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGlzSW5HZW5lcmF0aW9uKGFkZHJlc3MgY2FsbGVyQWRkcmVzcywgdWludCBnZW5lcmF0aW9uSWQpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gUmVzb3VyY2VQb29sTGliLmlzSW5HZW5lcmF0aW9uKGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLCBjYWxsZXJBZGRyZXNzLCBnZW5lcmF0aW9uSWQpOw0KICAgICAgICB9DQoNCiAgICAgICAgLyoNCiAgICAgICAgICogIFBvb2wgTWV0YSBpbmZvcm1hdGlvbg0KICAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gZ2V0UG9vbEZyZWV6ZVBlcmlvZCgpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbERhdGFiYXNlLmNhbGxlclBvb2wuZnJlZXplUGVyaW9kOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gZ2V0UG9vbE92ZXJsYXBTaXplKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbC5vdmVybGFwU2l6ZTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldFBvb2xSb3RhdGlvbkRlbGF5KCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbC5yb3RhdGlvbkRlbGF5Ow0KICAgICAgICB9DQoNCiAgICAgICAgLyoNCiAgICAgICAgICogIFBvb2wgTWVtYmVyc2hpcA0KICAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gY2FuRW50ZXJQb29sKCkgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBSZXNvdXJjZVBvb2xMaWIuY2FuRW50ZXJQb29sKGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLCBtc2cuc2VuZGVyLCBnZXRNaW5pbXVtQm9uZCgpKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGNhbkVudGVyUG9vbChhZGRyZXNzIGNhbGxlckFkZHJlc3MpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gUmVzb3VyY2VQb29sTGliLmNhbkVudGVyUG9vbChjYWxsRGF0YWJhc2UuY2FsbGVyUG9vbCwgY2FsbGVyQWRkcmVzcywgZ2V0TWluaW11bUJvbmQoKSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBjYW5FeGl0UG9vbCgpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gUmVzb3VyY2VQb29sTGliLmNhbkV4aXRQb29sKGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLCBtc2cuc2VuZGVyKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGNhbkV4aXRQb29sKGFkZHJlc3MgY2FsbGVyQWRkcmVzcykgY29uc3RhbnQgcmV0dXJucyAoYm9vbCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBSZXNvdXJjZVBvb2xMaWIuY2FuRXhpdFBvb2woY2FsbERhdGFiYXNlLmNhbGxlclBvb2wsIGNhbGxlckFkZHJlc3MpOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gZW50ZXJQb29sKCkgcHVibGljIHsNCiAgICAgICAgICAgICAgICB1aW50IGdlbmVyYXRpb25JZCA9IFJlc291cmNlUG9vbExpYi5lbnRlclBvb2woY2FsbERhdGFiYXNlLmNhbGxlclBvb2wsIG1zZy5zZW5kZXIsIGdldE1pbmltdW1Cb25kKCkpOw0KICAgICAgICAgICAgICAgIFJlc291cmNlUG9vbExpYi5BZGRlZFRvR2VuZXJhdGlvbihtc2cuc2VuZGVyLCBnZW5lcmF0aW9uSWQpOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gZXhpdFBvb2woKSBwdWJsaWMgew0KICAgICAgICAgICAgICAgIHVpbnQgZ2VuZXJhdGlvbklkID0gUmVzb3VyY2VQb29sTGliLmV4aXRQb29sKGNhbGxEYXRhYmFzZS5jYWxsZXJQb29sLCBtc2cuc2VuZGVyKTsNCiAgICAgICAgICAgICAgICBSZXNvdXJjZVBvb2xMaWIuUmVtb3ZlZEZyb21HZW5lcmF0aW9uKG1zZy5zZW5kZXIsIGdlbmVyYXRpb25JZCk7DQogICAgICAgIH0NCg0KICAgICAgICAvKg0KICAgICAgICAgKiAgQ2FsbCBJbmZvcm1hdGlvbiBBUEkNCiAgICAgICAgICovDQoNCiAgICAgICAgZnVuY3Rpb24gZ2V0TGFzdENhbGxLZXkoKSBjb25zdGFudCByZXR1cm5zIChieXRlczMyKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxEYXRhYmFzZS5sYXN0Q2FsbEtleTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qDQogICAgICAgICAqICBHZXR0ZXIgbWV0aG9kcyBmb3IgYENhbGxgIGluZm9ybWF0aW9uDQogICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBnZXRDYWxsQ29udHJhY3RBZGRyZXNzKGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcykgew0KICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmdldENhbGxDb250cmFjdEFkZHJlc3MoY2FsbERhdGFiYXNlLCBjYWxsS2V5KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldENhbGxTY2hlZHVsZWRCeShieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGFkZHJlc3MpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZWR1bGVkQ2FsbExpYi5nZXRDYWxsU2NoZWR1bGVkQnkoY2FsbERhdGFiYXNlLCBjYWxsS2V5KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldENhbGxDYWxsZWRBdEJsb2NrKGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmdldENhbGxDYWxsZWRBdEJsb2NrKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBnZXRDYWxsR3JhY2VQZXJpb2QoYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0Q2FsbEdyYWNlUGVyaW9kKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBnZXRDYWxsVGFyZ2V0QmxvY2soYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0Q2FsbFRhcmdldEJsb2NrKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBnZXRDYWxsQmFzZUdhc1ByaWNlKGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmdldENhbGxCYXNlR2FzUHJpY2UoY2FsbERhdGFiYXNlLCBjYWxsS2V5KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldENhbGxHYXNQcmljZShieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZWR1bGVkQ2FsbExpYi5nZXRDYWxsR2FzUHJpY2UoY2FsbERhdGFiYXNlLCBjYWxsS2V5KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldENhbGxHYXNVc2VkKGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmdldENhbGxHYXNVc2VkKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBnZXRDYWxsQUJJU2lnbmF0dXJlKGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXM0KSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0Q2FsbEFCSVNpZ25hdHVyZShjYWxsRGF0YWJhc2UsIGNhbGxLZXkpOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gY2hlY2tJZkNhbGxlZChieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZWR1bGVkQ2FsbExpYi5jaGVja0lmQ2FsbGVkKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBjaGVja0lmU3VjY2VzcyhieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZWR1bGVkQ2FsbExpYi5jaGVja0lmU3VjY2VzcyhjYWxsRGF0YWJhc2UsIGNhbGxLZXkpOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gY2hlY2tJZkNhbmNlbGxlZChieXRlczMyIGNhbGxLZXkpIGNvbnN0YW50IHJldHVybnMgKGJvb2wpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gU2NoZWR1bGVkQ2FsbExpYi5jaGVja0lmQ2FuY2VsbGVkKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBnZXRDYWxsRGF0YUhhc2goYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zIChieXRlczMyKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0Q2FsbERhdGFIYXNoKGNhbGxEYXRhYmFzZSwgY2FsbEtleSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBnZXRDYWxsUGF5b3V0KGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmdldENhbGxQYXlvdXQoY2FsbERhdGFiYXNlLCBjYWxsS2V5KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldENhbGxGZWUoYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0Q2FsbEZlZShjYWxsRGF0YWJhc2UsIGNhbGxLZXkpOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gZ2V0Q2FsbE1heENvc3QoYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0Q2FsbE1heENvc3QoY2FsbERhdGFiYXNlLCBjYWxsS2V5KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldENhbGxEYXRhKGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXMpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbERhdGFiYXNlLmRhdGFfcmVnaXN0cnlbY2FsbERhdGFiYXNlLmNhbGxzW2NhbGxLZXldLmRhdGFIYXNoXTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qDQogICAgICAgICAqICBEYXRhIHJlZ2lzdHJhdGlvbiBBUEkNCiAgICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRGF0YSgpIHB1YmxpYyB7DQogICAgICAgICAgICAgICAgU2NoZWR1bGVkQ2FsbExpYi5yZWdpc3RlckRhdGEoY2FsbERhdGFiYXNlLCBtc2cuZGF0YSk7DQogICAgICAgICAgICAgICAgU2NoZWR1bGVkQ2FsbExpYi5EYXRhUmVnaXN0ZXJlZChjYWxsRGF0YWJhc2UubGFzdERhdGFIYXNoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldExhc3REYXRhSGFzaCgpIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzMzIpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbERhdGFiYXNlLmxhc3REYXRhSGFzaDsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldExhc3REYXRhTGVuZ3RoKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBjYWxsRGF0YWJhc2UubGFzdERhdGFMZW5ndGg7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBnZXRMYXN0RGF0YSgpIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxEYXRhYmFzZS5sYXN0RGF0YTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qDQogICAgICAgICAqICBDYWxsIGV4ZWN1dGlvbiBBUEkNCiAgICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIGRvQ2FsbChieXRlczMyIGNhbGxLZXkpIHB1YmxpYyB7DQogICAgICAgICAgICAgICAgU2NoZWR1bGVkQ2FsbExpYi5kb0NhbGwoY2FsbERhdGFiYXNlLCBjYWxsS2V5LCBtc2cuc2VuZGVyKTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qDQogICAgICAgICAqICBDYWxsIFNjaGVkdWxpbmcgQVBJDQogICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBnZXRNaW5pbXVtR3JhY2VQZXJpb2QoKSBjb25zdGFudCByZXR1cm5zICh1aW50KSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0TWluaW11bUdyYWNlUGVyaW9kKCk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGwoYWRkcmVzcyBjb250cmFjdEFkZHJlc3MsIGJ5dGVzNCBhYmlTaWduYXR1cmUsIGJ5dGVzMzIgZGF0YUhhc2gsIHVpbnQgdGFyZ2V0QmxvY2spIHB1YmxpYyB7DQogICAgICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAgICAgKiAgU2NoZWR1bGUgY2FsbCB3aXRoIGdyYWNlUGVyaW9kIGRlZmF1bHRlZCB0byAyNTUgYW5kIG5vbmNlDQogICAgICAgICAgICAgICAgICogIGRlZmF1bHRlZCB0byAwLg0KICAgICAgICAgICAgICAgICAqLw0KICAgICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbChjb250cmFjdEFkZHJlc3MsIGFiaVNpZ25hdHVyZSwgZGF0YUhhc2gsIHRhcmdldEJsb2NrLCAyNTUsIDApOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVDYWxsKGFkZHJlc3MgY29udHJhY3RBZGRyZXNzLCBieXRlczQgYWJpU2lnbmF0dXJlLCBieXRlczMyIGRhdGFIYXNoLCB1aW50IHRhcmdldEJsb2NrLCB1aW50OCBncmFjZVBlcmlvZCkgcHVibGljIHsNCiAgICAgICAgICAgICAgICAvKg0KICAgICAgICAgICAgICAgICAqICBTY2hlZHVsZSBjYWxsIHdpdGggbm9uY2UgZGVmYXVsdGVkIHRvIDAuDQogICAgICAgICAgICAgICAgICovDQogICAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsKGNvbnRyYWN0QWRkcmVzcywgYWJpU2lnbmF0dXJlLCBkYXRhSGFzaCwgdGFyZ2V0QmxvY2ssIGdyYWNlUGVyaW9kLCAwKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbChhZGRyZXNzIGNvbnRyYWN0QWRkcmVzcywgYnl0ZXM0IGFiaVNpZ25hdHVyZSwgYnl0ZXMzMiBkYXRhSGFzaCwgdWludCB0YXJnZXRCbG9jaywgdWludDggZ3JhY2VQZXJpb2QsIHVpbnQgbm9uY2UpIHB1YmxpYyB7DQogICAgICAgICAgICAgICAgLyoNCiAgICAgICAgICAgICAgICAgKiBQcmltYXJ5IEFQSSBmb3Igc2NoZWR1bGluZyBhIGNhbGwuICBQcmlvciB0byBjYWxsaW5nIHRoaXMNCiAgICAgICAgICAgICAgICAgKiB0aGUgZGF0YSBzaG91bGQgYWxyZWFkeSBoYXZlIGJlZW4gcmVnaXN0ZXJlZCB0aHJvdWdoIHRoZQ0KICAgICAgICAgICAgICAgICAqIGByZWdpc3RlckRhdGFgIEFQSS4NCiAgICAgICAgICAgICAgICAgKi8NCiAgICAgICAgICAgICAgICBieXRlczE1IHJlYXNvbiA9IFNjaGVkdWxlZENhbGxMaWIuc2NoZWR1bGVDYWxsKGNhbGxEYXRhYmFzZSwgbXNnLnNlbmRlciwgY29udHJhY3RBZGRyZXNzLCBhYmlTaWduYXR1cmUsIGRhdGFIYXNoLCB0YXJnZXRCbG9jaywgZ3JhY2VQZXJpb2QsIG5vbmNlKTsNCiAgICAgICAgICAgICAgICBieXRlczMyIGNhbGxLZXkgPSBTY2hlZHVsZWRDYWxsTGliLmNvbXB1dGVDYWxsS2V5KG1zZy5zZW5kZXIsIGNvbnRyYWN0QWRkcmVzcywgYWJpU2lnbmF0dXJlLCBkYXRhSGFzaCwgdGFyZ2V0QmxvY2ssIGdyYWNlUGVyaW9kLCBub25jZSk7DQoNCiAgICAgICAgICAgICAgICBpZiAocmVhc29uICE9IDB4MCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgU2NoZWR1bGVkQ2FsbExpYi5DYWxsUmVqZWN0ZWQoY2FsbEtleSwgcmVhc29uKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICBTY2hlZHVsZWRDYWxsTGliLkNhbGxTY2hlZHVsZWQoY2FsbEtleSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gY2FuY2VsQ2FsbChieXRlczMyIGNhbGxLZXkpIHB1YmxpYyB7DQogICAgICAgICAgICAgICAgaWYgKFNjaGVkdWxlZENhbGxMaWIuY2FuY2VsQ2FsbChjYWxsRGF0YWJhc2UsIGNhbGxLZXksIGFkZHJlc3MobXNnLnNlbmRlcikpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBTY2hlZHVsZWRDYWxsTGliLkNhbGxDYW5jZWxsZWQoY2FsbEtleSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgLyoNCiAgICAgICAgICogIE5leHQgQ2FsbCBBUEkNCiAgICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIGdldENhbGxXaW5kb3dTaXplKCkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmdldENhbGxXaW5kb3dTaXplKCk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBnZXRHZW5lcmF0aW9uSWRGb3JDYWxsKGJ5dGVzMzIgY2FsbEtleSkgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBTY2hlZHVsZWRDYWxsTGliLmdldEdlbmVyYXRpb25JZEZvckNhbGwoY2FsbERhdGFiYXNlLCBjYWxsS2V5KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldERlc2lnbmF0ZWRDYWxsZXIoYnl0ZXMzMiBjYWxsS2V5LCB1aW50IGJsb2NrTnVtYmVyKSBjb25zdGFudCByZXR1cm5zIChhZGRyZXNzKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIFNjaGVkdWxlZENhbGxMaWIuZ2V0RGVzaWduYXRlZENhbGxlcihjYWxsRGF0YWJhc2UsIGNhbGxLZXksIGJsb2NrTnVtYmVyKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldE5leHRDYWxsKHVpbnQgYmxvY2tOdW1iZXIpIGNvbnN0YW50IHJldHVybnMgKGJ5dGVzMzIpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gR3JvdmVMaWIucXVlcnkoY2FsbERhdGFiYXNlLmNhbGxJbmRleCwgIj49IiwgaW50KGJsb2NrTnVtYmVyKSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0Q2FsbFNpYmxpbmcoYnl0ZXMzMiBjYWxsS2V5KSBjb25zdGFudCByZXR1cm5zIChieXRlczMyKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIEdyb3ZlTGliLmdldE5leHROb2RlKGNhbGxEYXRhYmFzZS5jYWxsSW5kZXgsIGNhbGxLZXkpOw0KICAgICAgICB9DQp9'