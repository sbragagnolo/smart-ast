base 64 content
base64roT1
	^'cHJhZ21hIHNvbGlkaXR5XjAuNC44Ow0KDQpjb250cmFjdCBPd25hYmxlIHsNCiAgLy8gcmVwbGFjZSB3aXRoIHByb3BlciB6ZXBwZWxpbiBzbWFydCBjb250cmFjdA0KICBhZGRyZXNzIHB1YmxpYyBvd25lcjsNCg0KICBmdW5jdGlvbiBPd25hYmxlKCkgew0KICAgIG93bmVyID0gbXNnLnNlbmRlcjsNCiAgfQ0KDQogIG1vZGlmaWVyIG9ubHlPd25lcigpIHsNCiAgICBpZiAobXNnLnNlbmRlciAhPSBvd25lcikNCiAgICAgIHRocm93Ow0KICAgIF87DQogIH0NCg0KICBmdW5jdGlvbiB0cmFuc2Zlck93bmVyc2hpcChhZGRyZXNzIG5ld093bmVyKSBvbmx5T3duZXIgew0KICAgIGlmIChuZXdPd25lciAhPSBhZGRyZXNzKDApKQ0KICAgICAgb3duZXIgPSBuZXdPd25lcjsNCiAgfQ0KfQ0KDQoNCmNvbnRyYWN0IERlc3RydWN0YWJsZSBpcyBPd25hYmxlIHsNCiAgZnVuY3Rpb24gc2VsZmRlc3RydWN0KCkgZXh0ZXJuYWwgb25seU93bmVyIHsNCiAgICAvLyBmcmVlIGV0aGVyZXVtIG5ldHdvcmsgc3RhdGUgd2hlbiBkb25lDQogICAgc2VsZmRlc3RydWN0KG93bmVyKTsNCiAgfQ0KfQ0KDQoNCmNvbnRyYWN0IE1hdGggew0KICAvLyBzY2FsZSBvZiB0aGUgZW11bGF0ZWQgZml4ZWQgcG9pbnQgb3BlcmF0aW9ucw0KICB1aW50IGNvbnN0YW50IHB1YmxpYyBGUF9TQ0FMRSA9IDEwMDAwOw0KDQogIC8vIHRvZG86IHNob3VsZCBiZSBhIGxpYnJhcnkNCiAgZnVuY3Rpb24gZGl2Um91bmQodWludCB2LCB1aW50IGQpIGludGVybmFsIGNvbnN0YW50IHJldHVybnModWludCkgew0KICAgIC8vIHJvdW5kIHVwIGlmICUgaXMgaGFsZiBvciBtb3JlDQogICAgcmV0dXJuICh2ICsgKGQvMikpIC8gZDsNCiAgfQ0KDQogIGZ1bmN0aW9uIGFic0RpZmYodWludCB2MSwgdWludCB2MikgcHVibGljIGNvbnN0YW50IHJldHVybnModWludCkgew0KICAgIHJldHVybiB2MSA+IHYyID8gdjEgLSB2MiA6IHYyIC0gdjE7DQogIH0NCg0KICBmdW5jdGlvbiBzYWZlTXVsKHVpbnQgYSwgdWludCBiKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgIHVpbnQgYyA9IGEgKiBiOw0KICAgIGlmIChhID09IDAgfHwgYyAvIGEgPT0gYikNCiAgICAgIHJldHVybiBjOw0KICAgIGVsc2UNCiAgICAgIHRocm93Ow0KICB9DQoNCiAgZnVuY3Rpb24gc2FmZUFkZCh1aW50IGEsIHVpbnQgYikgaW50ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludCkgew0KICAgIHVpbnQgYyA9IGEgKyBiOw0KICAgIGlmICghKGM+PWEgJiYgYz49YikpDQogICAgICB0aHJvdzsNCiAgICByZXR1cm4gYzsNCiAgfQ0KfQ0KDQoNCmNvbnRyYWN0IFRpbWVTb3VyY2Ugew0KICB1aW50MzIgcHJpdmF0ZSBtb2NrTm93Ow0KDQogIGZ1bmN0aW9uIGN1cnJlbnRUaW1lKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQzMikgew0KICAgIC8vIHdlIGRvIG5vdCBzdXBwb3J0IGRhdGVzIG11Y2ggaW50byBmdXR1cmUgKFN1biwgMDcgRmViIDIxMDYgMDY6Mjg6MTUgR01UKQ0KICAgIGlmIChibG9jay50aW1lc3RhbXAgPiAweEZGRkZGRkZGKQ0KICAgICAgdGhyb3c7DQogICAgcmV0dXJuIG1vY2tOb3cgPiAwID8gbW9ja05vdyA6IHVpbnQzMihibG9jay50aW1lc3RhbXApOw0KICB9DQoNCiAgZnVuY3Rpb24gbW9ja1RpbWUodWludDMyIHQpIHB1YmxpYyB7DQogICAgLy8gbm8gbW9ja2luZyBvbiBtYWlubmV0DQogICAgaWYgKGJsb2NrLm51bWJlciA+IDMzMTYwMjkpDQogICAgICB0aHJvdzsNCiAgICBtb2NrTm93ID0gdDsNCiAgfQ0KfQ0KDQoNCmNvbnRyYWN0IEJhc2VPcHRpb25zQ29udmVydGVyIHsNCg0KICAvLyBtb2RpZmllcnMgYXJlIGluaGVyaXRlZCwgY2hlY2sgYG93bmVkYCBwYXR0ZXJuDQogIC8vICAgaHR0cDovL3NvbGlkaXR5LnJlYWR0aGVkb2NzLmlvL2VuL2RldmVsb3AvY29udHJhY3RzLmh0bWwjZnVuY3Rpb24tbW9kaWZpZXJzDQogIG1vZGlmaWVyIG9ubHlFU09QKCkgew0KICAgIGlmIChtc2cuc2VuZGVyICE9IGdldEVTT1AoKSkNCiAgICAgIHRocm93Ow0KICAgIF87DQogIH0NCg0KICAvLyByZXR1cm5zIEVTT1AgYWRkcmVzcyB3aGljaCBpcyBhIHNvbGUgZXhlY3V0b3Igb2YgZXhlcmNpc2VPcHRpb25zIGZ1bmN0aW9uDQogIGZ1bmN0aW9uIGdldEVTT1AoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcyk7DQogIC8vIGRlYWRsaW5lIGZvciBlbXBsb3llZXMgdG8gZXhlcmNpc2Ugb3B0aW9ucw0KICBmdW5jdGlvbiBnZXRFeGVyY2lzZVBlcmlvZERlYWRsaW5lKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKHVpbnQzMik7DQoNCiAgLy8gZXhlcmNpc2Ugb2Ygb3B0aW9ucyBmb3IgZ2l2ZW4gZW1wbG95ZWUgYW5kIGFtb3VudCwgcGxlYXNlIG5vdGUgdGhhdCBlbXBsb3llZSBhZGRyZXNzIG1heSBiZSAwDQogIC8vIC4uIGluIHdoaWNoIGNhc2UgdGhlIGludGVudGlvbiBpcyB0byBidXJuIG9wdGlvbnMNCiAgZnVuY3Rpb24gZXhlcmNpc2VPcHRpb25zKGFkZHJlc3MgZW1wbG95ZWUsIHVpbnQgcG9vbE9wdGlvbnMsIHVpbnQgZXh0cmFPcHRpb25zLCB1aW50IGJvbnVzT3B0aW9ucywNCiAgICBib29sIGFncmVlVG9BY2NlbGVyYXRlZFZlc3RpbmdCb251c0NvbmRpdGlvbnMpIG9ubHlFU09QIHB1YmxpYzsNCn0NCg0KY29udHJhY3QgRVNPUFR5cGVzIHsNCiAgLy8gZW51bXMgYXJlIG51bWJlcmVkIHN0YXJ0aW5nIGZyb20gMC4gTm90U2V0IGlzIHVzZWQgdG8gY2hlY2sgZm9yIG5vbiBleGlzdGluZyBtYXBwaW5nDQogIGVudW0gRW1wbG95ZWVTdGF0ZSB7IE5vdFNldCwgV2FpdGluZ0ZvclNpZ25hdHVyZSwgRW1wbG95ZWQsIFRlcm1pbmF0ZWQsIE9wdGlvbnNFeGVyY2lzZWQgfQ0KICAvLyBwbGVhc2Ugbm90ZSB0aGF0IDMyIGJpdCB1bnNpZ25lZCBpbnQgaXMgdXNlZCB0byByZXByZXNlbnQgVU5JWCB0aW1lIHdoaWNoIGlzIGVub3VnaCB0byByZXByZXNlbnQgZGF0ZXMgdW50aWwgU3VuLCAwNyBGZWIgMjEwNiAwNjoyODoxNSBHTVQNCiAgLy8gc3RvcmFnZSBhY2Nlc3MgaXMgb3B0aW1pemVkIHNvIHN0cnVjdCBsYXlvdXQgaXMgaW1wb3J0YW50DQogIHN0cnVjdCBFbXBsb3llZSB7DQogICAgICAvLyB3aGVuIHZlc3Rpbmcgc3RhcnRzDQogICAgICB1aW50MzIgaXNzdWVEYXRlOw0KICAgICAgLy8gd2FpdCBmb3IgZW1wbG95ZWUgc2lnbmF0dXJlIHVudGlsIHRoYXQgdGltZQ0KICAgICAgdWludDMyIHRpbWVUb1NpZ247DQogICAgICAvLyBkYXRlIHdoZW4gZW1wbG95ZWUgd2FzIHRlcm1pbmF0ZWQsIDAgZm9yIG5vdCB0ZXJtaW5hdGVkDQogICAgICB1aW50MzIgdGVybWluYXRlZEF0Ow0KICAgICAgLy8gd2hlbiBmYWRlIG91dCBzdGFydHMsIDAgZm9yIG5vdCBzZXQsIGluaXRhbGx5ID09IHRlcm1pbmF0ZWRBdA0KICAgICAgLy8gdXNlZCBvbmx5IHdoZW4gY2FsY3VsYXRpbmcgb3B0aW9ucyByZXR1cm5lZCB0byBwb29sDQogICAgICB1aW50MzIgZmFkZW91dFN0YXJ0czsNCiAgICAgIC8vIHBvb2xPcHRpb25zIGVtcGxveWVlIGdldHMgKGV4aXQgYm9udXMgbm90IGluY2x1ZGVkKQ0KICAgICAgdWludDMyIHBvb2xPcHRpb25zOw0KICAgICAgLy8gZXh0cmEgb3B0aW9ucyBlbXBsb3llZSBnZXRzIChuZXVmdW5kIHdpbGwgbm90IHRoaXMgb3B0aW9uKQ0KICAgICAgdWludDMyIGV4dHJhT3B0aW9uczsNCiAgICAgIC8vIHRpbWUgYXQgd2hpY2ggZW1wbG95ZWUgZ290IHN1c3BlbmRlZCwgMCAtIG5vdCBzdXNwZW5kZWQNCiAgICAgIHVpbnQzMiBzdXNwZW5kZWRBdDsNCiAgICAgIC8vIHdoYXQgaXMgZW1wbG95ZWUgY3VycmVudCBzdGF0dXMsIHRha2VzIDggYml0IGluIHN0b3JhZ2UNCiAgICAgIEVtcGxveWVlU3RhdGUgc3RhdGU7DQogICAgICAvLyBpbmRleCBpbiBpdGVyYWJsZSBtYXBwaW5nDQogICAgICB1aW50MTYgaWR4Ow0KICAgICAgLy8gcmVzZXJ2ZSB1bnRpbCBmdWxsIDI1NiBiaXQgd29yZA0KICAgICAgLy91aW50MjQgcmVzZXJ2ZWQ7DQogIH0NCg0KICBmdW5jdGlvbiBzZXJpYWxpemVFbXBsb3llZShFbXBsb3llZSBtZW1vcnkgZW1wbG95ZWUpDQogICAgaW50ZXJuYWwNCiAgICBjb25zdGFudA0KICAgIHJldHVybnModWludFs5XSBlbXApDQogIHsNCiAgICAgIC8vIGd1ZXNzIHdoYXQ6IHN0cnVjdCBsYXlvdXQgaW4gbWVtb3J5IGlzIGFsaWduZWQgdG8gd29yZCAoMjU2IGJpdHMpDQogICAgICAvLyBzdHJ1Y3QgaW4gc3RvcmFnZSBpcyBieXRlIGFsaWduZWQNCiAgICAgIGFzc2VtYmx5IHsNCiAgICAgICAgLy8gcmV0dXJuIG1lbW9yeSBhbGlnbmVkIHN0cnVjdCBhcyBhcnJheSBvZiB3b3Jkcw0KICAgICAgICAvLyBJIGp1c3Qgd29uZGVyIHdoZW4gJ2VtcGxveWVlJyBtZW1vcnkgaXMgZGVhbGxvY2F0ZWQNCiAgICAgICAgLy8gYW5zd2VyOiBtZW1vcnkgaXMgbm90IGRlYWxsb2NhdGVkIHVudGlsIHRyYW5zYWN0aW9uIGVuZHMNCiAgICAgICAgZW1wIDo9IGVtcGxveWVlDQogICAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBkZXNlcmlhbGl6ZUVtcGxveWVlKHVpbnRbOV0gc2VyaWFsaXplZEVtcGxveWVlKQ0KICAgIGludGVybmFsDQogICAgY29uc3RhbnQNCiAgICByZXR1cm5zIChFbXBsb3llZSBtZW1vcnkgZW1wKQ0KICB7DQogICAgICBhc3NlbWJseSB7IGVtcCA6PSBzZXJpYWxpemVkRW1wbG95ZWUgfQ0KICB9DQp9DQoNCmNvbnRyYWN0IENvZGVVcGRhdGVhYmxlIGlzIE93bmFibGUgew0KICAgIC8vIGFsbG93cyB0byBzdG9wIG9wZXJhdGlvbnMgYW5kIG1pZ3JhdGUgZGF0YSB0byBkaWZmZXJlbnQgY29udHJhY3QNCiAgICBlbnVtIENvZGVVcGRhdGVTdGF0ZSB7IEN1cnJlbnRDb2RlLCBPbmdvaW5nVXBkYXRlIC8qLCBDb2RlVXBkYXRlZCovfQ0KICAgIENvZGVVcGRhdGVTdGF0ZSBwdWJsaWMgY29kZVVwZGF0ZVN0YXRlOw0KDQogICAgbW9kaWZpZXIgaXNDdXJyZW50Q29kZSgpIHsNCiAgICAgIGlmIChjb2RlVXBkYXRlU3RhdGUgIT0gQ29kZVVwZGF0ZVN0YXRlLkN1cnJlbnRDb2RlKQ0KICAgICAgICB0aHJvdzsNCiAgICAgIF87DQogICAgfQ0KDQogICAgbW9kaWZpZXIgaW5Db2RlVXBkYXRlKCkgew0KICAgICAgaWYgKGNvZGVVcGRhdGVTdGF0ZSAhPSBDb2RlVXBkYXRlU3RhdGUuT25nb2luZ1VwZGF0ZSkNCiAgICAgICAgdGhyb3c7DQogICAgICBfOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGJlZ2luQ29kZVVwZGF0ZSgpIHB1YmxpYyBvbmx5T3duZXIgaXNDdXJyZW50Q29kZSB7DQogICAgICBjb2RlVXBkYXRlU3RhdGUgPSBDb2RlVXBkYXRlU3RhdGUuT25nb2luZ1VwZGF0ZTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBjYW5jZWxDb2RlVXBkYXRlKCkgcHVibGljIG9ubHlPd25lciBpbkNvZGVVcGRhdGUgew0KICAgICAgY29kZVVwZGF0ZVN0YXRlID0gQ29kZVVwZGF0ZVN0YXRlLkN1cnJlbnRDb2RlOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGNvbXBsZXRlQ29kZVVwZGF0ZSgpIHB1YmxpYyBvbmx5T3duZXIgaW5Db2RlVXBkYXRlIHsNCiAgICAgIHNlbGZkZXN0cnVjdChvd25lcik7DQogICAgfQ0KfQ0KDQpjb250cmFjdCBFbXBsb3llZXNMaXN0IGlzIEVTT1BUeXBlcywgT3duYWJsZSwgRGVzdHJ1Y3RhYmxlIHsNCiAgZXZlbnQgQ3JlYXRlRW1wbG95ZWUoYWRkcmVzcyBpbmRleGVkIGUsIHVpbnQzMiBwb29sT3B0aW9ucywgdWludDMyIGV4dHJhT3B0aW9ucywgdWludDE2IGlkeCk7DQogIGV2ZW50IFVwZGF0ZUVtcGxveWVlKGFkZHJlc3MgaW5kZXhlZCBlLCB1aW50MzIgcG9vbE9wdGlvbnMsIHVpbnQzMiBleHRyYU9wdGlvbnMsIHVpbnQxNiBpZHgpOw0KICBldmVudCBDaGFuZ2VFbXBsb3llZVN0YXRlKGFkZHJlc3MgaW5kZXhlZCBlLCBFbXBsb3llZVN0YXRlIG9sZFN0YXRlLCBFbXBsb3llZVN0YXRlIG5ld1N0YXRlKTsNCiAgZXZlbnQgUmVtb3ZlRW1wbG95ZWUoYWRkcmVzcyBpbmRleGVkIGUpOw0KICBtYXBwaW5nIChhZGRyZXNzID0+IEVtcGxveWVlKSBlbXBsb3llZXM7DQogIC8vIGFkZHJlc3NlcyBpbiB0aGUgbWFwcGluZywgZXZlcg0KICBhZGRyZXNzW10gcHVibGljIGFkZHJlc3NlczsNCg0KICBmdW5jdGlvbiBzaXplKCkgZXh0ZXJuYWwgY29uc3RhbnQgcmV0dXJucyAodWludDE2KSB7DQogICAgcmV0dXJuIHVpbnQxNihhZGRyZXNzZXMubGVuZ3RoKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHNldEVtcGxveWVlKGFkZHJlc3MgZSwgdWludDMyIGlzc3VlRGF0ZSwgdWludDMyIHRpbWVUb1NpZ24sIHVpbnQzMiB0ZXJtaW5hdGVkQXQsIHVpbnQzMiBmYWRlb3V0U3RhcnRzLA0KICAgIHVpbnQzMiBwb29sT3B0aW9ucywgdWludDMyIGV4dHJhT3B0aW9ucywgdWludDMyIHN1c3BlbmRlZEF0LCBFbXBsb3llZVN0YXRlIHN0YXRlKQ0KICAgIGV4dGVybmFsDQogICAgb25seU93bmVyDQogICAgcmV0dXJucyAoYm9vbCBpc05ldykNCiAgew0KICAgIHVpbnQxNiBlbXBJZHggPSBlbXBsb3llZXNbZV0uaWR4Ow0KICAgIGlmIChlbXBJZHggPT0gMCkgew0KICAgICAgLy8gbmV3IGVsZW1lbnQNCiAgICAgIHVpbnQgc2l6ZSA9IGFkZHJlc3Nlcy5sZW5ndGg7DQogICAgICBpZiAoc2l6ZSA9PSAweEZGRkYpDQogICAgICAgIHRocm93Ow0KICAgICAgaXNOZXcgPSB0cnVlOw0KICAgICAgZW1wSWR4ID0gdWludDE2KHNpemUgKyAxKTsNCiAgICAgIGFkZHJlc3Nlcy5wdXNoKGUpOw0KICAgICAgQ3JlYXRlRW1wbG95ZWUoZSwgcG9vbE9wdGlvbnMsIGV4dHJhT3B0aW9ucywgZW1wSWR4KTsNCiAgICB9IGVsc2Ugew0KICAgICAgaXNOZXcgPSBmYWxzZTsNCiAgICAgIFVwZGF0ZUVtcGxveWVlKGUsIHBvb2xPcHRpb25zLCBleHRyYU9wdGlvbnMsIGVtcElkeCk7DQogICAgfQ0KICAgIGVtcGxveWVlc1tlXSA9IEVtcGxveWVlKHsNCiAgICAgICAgaXNzdWVEYXRlOiBpc3N1ZURhdGUsDQogICAgICAgIHRpbWVUb1NpZ246IHRpbWVUb1NpZ24sDQogICAgICAgIHRlcm1pbmF0ZWRBdDogdGVybWluYXRlZEF0LA0KICAgICAgICBmYWRlb3V0U3RhcnRzOiBmYWRlb3V0U3RhcnRzLA0KICAgICAgICBwb29sT3B0aW9uczogcG9vbE9wdGlvbnMsDQogICAgICAgIGV4dHJhT3B0aW9uczogZXh0cmFPcHRpb25zLA0KICAgICAgICBzdXNwZW5kZWRBdDogc3VzcGVuZGVkQXQsDQogICAgICAgIHN0YXRlOiBzdGF0ZSwNCiAgICAgICAgaWR4OiBlbXBJZHgNCiAgICAgIH0pOw0KICB9DQoNCiAgZnVuY3Rpb24gY2hhbmdlU3RhdGUoYWRkcmVzcyBlLCBFbXBsb3llZVN0YXRlIHN0YXRlKQ0KICAgIGV4dGVybmFsDQogICAgb25seU93bmVyDQogIHsNCiAgICBpZiAoZW1wbG95ZWVzW2VdLmlkeCA9PSAwKQ0KICAgICAgdGhyb3c7DQogICAgQ2hhbmdlRW1wbG95ZWVTdGF0ZShlLCBlbXBsb3llZXNbZV0uc3RhdGUsIHN0YXRlKTsNCiAgICBlbXBsb3llZXNbZV0uc3RhdGUgPSBzdGF0ZTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHNldEZhZGVvdXRTdGFydHMoYWRkcmVzcyBlLCB1aW50MzIgZmFkZW91dFN0YXJ0cykNCiAgICBleHRlcm5hbA0KICAgIG9ubHlPd25lcg0KICB7DQogICAgaWYgKGVtcGxveWVlc1tlXS5pZHggPT0gMCkNCiAgICAgIHRocm93Ow0KICAgIFVwZGF0ZUVtcGxveWVlKGUsIGVtcGxveWVlc1tlXS5wb29sT3B0aW9ucywgZW1wbG95ZWVzW2VdLmV4dHJhT3B0aW9ucywgZW1wbG95ZWVzW2VdLmlkeCk7DQogICAgZW1wbG95ZWVzW2VdLmZhZGVvdXRTdGFydHMgPSBmYWRlb3V0U3RhcnRzOw0KICB9DQoNCiAgZnVuY3Rpb24gcmVtb3ZlRW1wbG95ZWUoYWRkcmVzcyBlKQ0KICAgIGV4dGVybmFsDQogICAgb25seU93bmVyDQogICAgcmV0dXJucyAoYm9vbCkNCiAgew0KICAgIHVpbnQxNiBlbXBJZHggPSBlbXBsb3llZXNbZV0uaWR4Ow0KICAgIGlmIChlbXBJZHggPiAwKSB7DQogICAgICAgIGRlbGV0ZSBlbXBsb3llZXNbZV07DQogICAgICAgIGRlbGV0ZSBhZGRyZXNzZXNbZW1wSWR4LTFdOw0KICAgICAgICBSZW1vdmVFbXBsb3llZShlKTsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICAgIHJldHVybiBmYWxzZTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHRlcm1pbmF0ZUVtcGxveWVlKGFkZHJlc3MgZSwgdWludDMyIGlzc3VlRGF0ZSwgdWludDMyIHRlcm1pbmF0ZWRBdCwgdWludDMyIGZhZGVvdXRTdGFydHMsIEVtcGxveWVlU3RhdGUgc3RhdGUpDQogICAgZXh0ZXJuYWwNCiAgICBvbmx5T3duZXINCiAgew0KICAgIGlmIChzdGF0ZSAhPSBFbXBsb3llZVN0YXRlLlRlcm1pbmF0ZWQpDQogICAgICAgIHRocm93Ow0KICAgIEVtcGxveWVlIGVtcGxveWVlID0gZW1wbG95ZWVzW2VdOyAvLyBnZXRzIHJlZmVyZW5jZSB0byBzdG9yYWdlIGFuZCBvcHRpbWl6ZXIgZG9lcyBpdCB3aXRoIG9uZSBTU1RPUkUNCiAgICBpZiAoZW1wbG95ZWUuaWR4ID09IDApDQogICAgICB0aHJvdzsNCiAgICBDaGFuZ2VFbXBsb3llZVN0YXRlKGUsIGVtcGxveWVlLnN0YXRlLCBzdGF0ZSk7DQogICAgZW1wbG95ZWUuc3RhdGUgPSBzdGF0ZTsNCiAgICBlbXBsb3llZS5pc3N1ZURhdGUgPSBpc3N1ZURhdGU7DQogICAgZW1wbG95ZWUudGVybWluYXRlZEF0ID0gdGVybWluYXRlZEF0Ow0KICAgIGVtcGxveWVlLmZhZGVvdXRTdGFydHMgPSBmYWRlb3V0U3RhcnRzOw0KICAgIGVtcGxveWVlLnN1c3BlbmRlZEF0ID0gMDsNCiAgICBVcGRhdGVFbXBsb3llZShlLCBlbXBsb3llZS5wb29sT3B0aW9ucywgZW1wbG95ZWUuZXh0cmFPcHRpb25zLCBlbXBsb3llZS5pZHgpOw0KICB9DQoNCiAgZnVuY3Rpb24gZ2V0RW1wbG95ZWUoYWRkcmVzcyBlKQ0KICAgIGV4dGVybmFsDQogICAgY29uc3RhbnQNCiAgICByZXR1cm5zICh1aW50MzIsIHVpbnQzMiwgdWludDMyLCB1aW50MzIsIHVpbnQzMiwgdWludDMyLCB1aW50MzIsIEVtcGxveWVlU3RhdGUpDQogIHsNCiAgICAgIEVtcGxveWVlIGVtcGxveWVlID0gZW1wbG95ZWVzW2VdOw0KICAgICAgaWYgKGVtcGxveWVlLmlkeCA9PSAwKQ0KICAgICAgICB0aHJvdzsNCiAgICAgIC8vIHdoZXJlIGlzIHN0cnVjdCB6aXAvdW56aXAgOj4NCiAgICAgIHJldHVybiAoZW1wbG95ZWUuaXNzdWVEYXRlLCBlbXBsb3llZS50aW1lVG9TaWduLCBlbXBsb3llZS50ZXJtaW5hdGVkQXQsIGVtcGxveWVlLmZhZGVvdXRTdGFydHMsDQogICAgICAgIGVtcGxveWVlLnBvb2xPcHRpb25zLCBlbXBsb3llZS5leHRyYU9wdGlvbnMsIGVtcGxveWVlLnN1c3BlbmRlZEF0LCBlbXBsb3llZS5zdGF0ZSk7DQogIH0NCg0KICAgZnVuY3Rpb24gaGFzRW1wbG95ZWUoYWRkcmVzcyBlKQ0KICAgICBleHRlcm5hbA0KICAgICBjb25zdGFudA0KICAgICByZXR1cm5zIChib29sKQ0KICAgew0KICAgICAgLy8gdGhpcyBpcyB2ZXJ5IGluZWZmaWNpZW50IC0gd2hvbGUgd29yZCBpcyBsb2FkZWQganVzdCB0byBjaGVjayB0aGlzDQogICAgICByZXR1cm4gZW1wbG95ZWVzW2VdLmlkeCAhPSAwOw0KICAgIH0NCg0KICBmdW5jdGlvbiBnZXRTZXJpYWxpemVkRW1wbG95ZWUoYWRkcmVzcyBlKQ0KICAgIGV4dGVybmFsDQogICAgY29uc3RhbnQNCiAgICByZXR1cm5zICh1aW50WzldKQ0KICB7DQogICAgRW1wbG95ZWUgbWVtb3J5IGVtcGxveWVlID0gZW1wbG95ZWVzW2VdOw0KICAgIGlmIChlbXBsb3llZS5pZHggPT0gMCkNCiAgICAgIHRocm93Ow0KICAgIHJldHVybiBzZXJpYWxpemVFbXBsb3llZShlbXBsb3llZSk7DQogIH0NCn0NCg0KY29udHJhY3QgRVJDMjBPcHRpb25zQ29udmVydGVyIGlzIEJhc2VPcHRpb25zQ29udmVydGVyLCBUaW1lU291cmNlLCBNYXRoIHsNCiAgLy8gc2VlIGJhc2UgY2xhc3MgZm9yIGV4cGxhbmF0aW9ucw0KICBhZGRyZXNzIGVzb3BBZGRyZXNzOw0KICB1aW50MzIgZXhlcmNpc2VQZXJpb2REZWFkbGluZTsNCiAgLy8gYmFsYW5jZXMgZm9yIGNvbnZlcnRlZCBvcHRpb25zDQogIG1hcHBpbmcoYWRkcmVzcyA9PiB1aW50KSBpbnRlcm5hbCBiYWxhbmNlczsNCiAgLy8gdG90YWwgc3VwcGx5DQogIHVpbnQgcHVibGljIHRvdGFsU3VwcGx5Ow0KDQogIC8vIGRlYWRsaW5lIGZvciBhbGwgb3B0aW9ucyBjb252ZXJzaW9uIGluY2x1ZGluZyBjb21wYW55J3MgYWN0aW9ucw0KICB1aW50MzIgcHVibGljIG9wdGlvbnNDb252ZXJzaW9uRGVhZGxpbmU7DQoNCiAgZXZlbnQgVHJhbnNmZXIoYWRkcmVzcyBpbmRleGVkIGZyb20sIGFkZHJlc3MgaW5kZXhlZCB0bywgdWludCB2YWx1ZSk7DQoNCiAgbW9kaWZpZXIgY29udmVydGluZygpIHsNCiAgICAvLyB0aHJvdyBhZnRlciBkZWFkbGluZQ0KICAgIGlmIChjdXJyZW50VGltZSgpID49IGV4ZXJjaXNlUGVyaW9kRGVhZGxpbmUpDQogICAgICB0aHJvdzsNCiAgICBfOw0KICB9DQoNCiAgbW9kaWZpZXIgY29udmVydGVkKCkgew0KICAgIC8vIHRocm93IGJlZm9yZSBkZWFkbGluZQ0KICAgIGlmIChjdXJyZW50VGltZSgpIDwgb3B0aW9uc0NvbnZlcnNpb25EZWFkbGluZSkNCiAgICAgIHRocm93Ow0KICAgIF87DQogIH0NCg0KDQogIGZ1bmN0aW9uIGdldEVTT1AoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcykgew0KICAgIHJldHVybiBlc29wQWRkcmVzczsNCiAgfQ0KDQogIGZ1bmN0aW9uIGdldEV4ZXJjaXNlUGVyaW9kRGVhZGxpbmUoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyh1aW50MzIpIHsNCiAgICByZXR1cm4gZXhlcmNpc2VQZXJpb2REZWFkbGluZTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGV4ZXJjaXNlT3B0aW9ucyhhZGRyZXNzIGVtcGxveWVlLCB1aW50IHBvb2xPcHRpb25zLCB1aW50IGV4dHJhT3B0aW9ucywgdWludCBib251c09wdGlvbnMsDQogICAgYm9vbCBhZ3JlZVRvQWNjZWxlcmF0ZWRWZXN0aW5nQm9udXNDb25kaXRpb25zKQ0KICAgIHB1YmxpYw0KICAgIG9ubHlFU09QDQogICAgY29udmVydGluZw0KICB7DQogICAgLy8gaWYgbm8gb3ZlcmZsb3cgb24gdG90YWxTdXBwbHksIG5vIG92ZXJmbG93cyBsYXRlcg0KICAgIHVpbnQgb3B0aW9ucyA9IHNhZmVBZGQoc2FmZUFkZChwb29sT3B0aW9ucywgZXh0cmFPcHRpb25zKSwgYm9udXNPcHRpb25zKTsNCiAgICB0b3RhbFN1cHBseSA9IHNhZmVBZGQodG90YWxTdXBwbHksIG9wdGlvbnMpOw0KICAgIGJhbGFuY2VzW2VtcGxveWVlXSArPSBvcHRpb25zOw0KICAgIFRyYW5zZmVyKDAsIGVtcGxveWVlLCBvcHRpb25zKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHRyYW5zZmVyKGFkZHJlc3MgX3RvLCB1aW50IF92YWx1ZSkgY29udmVydGVkIHB1YmxpYyB7DQogICAgaWYgKGJhbGFuY2VzW21zZy5zZW5kZXJdIDwgX3ZhbHVlKQ0KICAgICAgdGhyb3c7DQogICAgYmFsYW5jZXNbbXNnLnNlbmRlcl0gLT0gX3ZhbHVlOw0KICAgIGJhbGFuY2VzW190b10gKz0gX3ZhbHVlOw0KICAgIFRyYW5zZmVyKG1zZy5zZW5kZXIsIF90bywgX3ZhbHVlKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGJhbGFuY2VPZihhZGRyZXNzIF9vd25lcikgY29uc3RhbnQgcHVibGljIHJldHVybnMgKHVpbnQgYmFsYW5jZSkgew0KICAgIHJldHVybiBiYWxhbmNlc1tfb3duZXJdOw0KICB9DQoNCiAgZnVuY3Rpb24gKCkgcGF5YWJsZSB7DQogICAgdGhyb3c7DQogIH0NCg0KICBmdW5jdGlvbiBFUkMyME9wdGlvbnNDb252ZXJ0ZXIoYWRkcmVzcyBlc29wLCB1aW50MzIgZXhlcmNpc2VEZWFkbGluZSwgdWludDMyIGNvbnZlcnNpb25EZWFkbGluZSkgew0KICAgIGVzb3BBZGRyZXNzID0gZXNvcDsNCiAgICBleGVyY2lzZVBlcmlvZERlYWRsaW5lID0gZXhlcmNpc2VEZWFkbGluZTsNCiAgICBvcHRpb25zQ29udmVyc2lvbkRlYWRsaW5lID0gY29udmVyc2lvbkRlYWRsaW5lOw0KICB9DQp9DQoNCmNvbnRyYWN0IEVTT1BNaWdyYXRpb24gew0KICBtb2RpZmllciBvbmx5T2xkRVNPUCgpIHsNCiAgICBpZiAobXNnLnNlbmRlciAhPSBnZXRPbGRFU09QKCkpDQogICAgICB0aHJvdzsNCiAgICBfOw0KICB9DQoNCiAgLy8gcmV0dXJucyBFU09QIGFkZHJlc3Mgd2hpY2ggaXMgYSBzb2xlIGV4ZWN1dG9yIG9mIGV4ZXJjaXNlT3B0aW9ucyBmdW5jdGlvbg0KICBmdW5jdGlvbiBnZXRPbGRFU09QKCkgcHVibGljIGNvbnN0YW50IHJldHVybnMgKGFkZHJlc3MpOw0KDQogIC8vIG1pZ3JhdGUgZW1wbG95ZWUgdG8gbmV3IEVTT1AgY29udHJhY3QsIHRocm93cyBpZiBub3QgcG9zc2libGUNCiAgLy8gaW4gc2ltcGxlc3QgY2FzZSBuZXcgRVNPUCBjb250cmFjdCBzaG91bGQgZGVyaXZlIGZyb20gdGhpcyBjb250cmFjdCBhbmQgaW1wbGVtZW50IGFic3RyYWN0IG1ldGhvZHMNCiAgLy8gZW1wbG95ZWVzIGxpc3QgaXMgYXZhaWxhYmxlIGZvciBpbnNwZWN0aW9uIGJ5IGVtcGxveWVlIGFkZHJlc3MNCiAgLy8gcG9vbE9wdGlvbnMgYW5kIGV4dHJhT3B0aW9uIGlzIGFtb3VudCBvZiBvcHRpb25zIHRyYW5zZmVycmVkIG91dCBvZiBvbGQgRVNPUCBjb250cmFjdA0KICBmdW5jdGlvbiBtaWdyYXRlKGFkZHJlc3MgZW1wbG95ZWUsIHVpbnQgcG9vbE9wdGlvbnMsIHVpbnQgZXh0cmFPcHRpb25zKSBvbmx5T2xkRVNPUCBwdWJsaWM7DQp9DQoNCmNvbnRyYWN0IEVTT1AgaXMgRVNPUFR5cGVzLCBDb2RlVXBkYXRlYWJsZSwgVGltZVNvdXJjZSB7DQogIC8vIGVtcGxveWVlIGNoYW5nZWQgZXZlbnRzDQogIGV2ZW50IEVTT1BPZmZlcmVkKGFkZHJlc3MgaW5kZXhlZCBlbXBsb3llZSwgYWRkcmVzcyBjb21wYW55LCB1aW50MzIgcG9vbE9wdGlvbnMsIHVpbnQzMiBleHRyYU9wdGlvbnMpOw0KICBldmVudCBFbXBsb3llZVNpZ25lZFRvRVNPUChhZGRyZXNzIGluZGV4ZWQgZW1wbG95ZWUpOw0KICBldmVudCBTdXNwZW5kRW1wbG95ZWUoYWRkcmVzcyBpbmRleGVkIGVtcGxveWVlLCB1aW50MzIgc3VzcGVuZGVkQXQpOw0KICBldmVudCBDb250aW51ZVN1c3BlbmRlZEVtcGxveWVlKGFkZHJlc3MgaW5kZXhlZCBlbXBsb3llZSwgdWludDMyIGNvbnRpbnVlZEF0LCB1aW50MzIgc3VzcGVuZGVkUGVyaW9kKTsNCiAgZXZlbnQgVGVybWluYXRlRW1wbG95ZWUoYWRkcmVzcyBpbmRleGVkIGVtcGxveWVlLCBhZGRyZXNzIGNvbXBhbnksIHVpbnQzMiB0ZXJtaW5hdGVkQXQsIFRlcm1pbmF0aW9uVHlwZSB0ZXJtVHlwZSk7DQogIGV2ZW50IEVtcGxveWVlT3B0aW9uc0V4ZXJjaXNlZChhZGRyZXNzIGluZGV4ZWQgZW1wbG95ZWUsIGFkZHJlc3MgZXhlcmNpc2VkRm9yLCB1aW50MzIgcG9vbE9wdGlvbnMsIGJvb2wgZGlzYWJsZUFjY2VsZXJhdGVkVmVzdGluZyk7DQogIGV2ZW50IEVtcGxveWVlTWlncmF0ZWQoYWRkcmVzcyBpbmRleGVkIGVtcGxveWVlLCBhZGRyZXNzIG1pZ3JhdGlvbiwgdWludCBwb29sLCB1aW50IGV4dHJhKTsNCiAgLy8gZXNvcCBjaGFuZ2VkIGV2ZW50cw0KICBldmVudCBFU09QT3BlbmVkKGFkZHJlc3MgY29tcGFueSk7DQogIGV2ZW50IE9wdGlvbnNDb252ZXJzaW9uT2ZmZXJlZChhZGRyZXNzIGNvbXBhbnksIGFkZHJlc3MgY29udmVydGVyLCB1aW50MzIgY29udmVydGVkQXQsIHVpbnQzMiBleGVyY2lzZVBlcmlvZERlYWRsaW5lKTsNCiAgZW51bSBFU09QU3RhdGUgeyBOZXcsIE9wZW4sIENvbnZlcnNpb24gfQ0KICAvLyB1c2UgcmV0cnVuIGNvZGVzIHVudGlsIHJldmVydCBvcGNvZGUgaXMgaW1wbGVtZW50ZWQNCiAgZW51bSBSZXR1cm5Db2RlcyB7IE9LLCBJbnZhbGlkRW1wbG95ZWVTdGF0ZSwgVG9vTGF0ZSwgSW52YWxpZFBhcmFtZXRlcnMsIFRvb0Vhcmx5ICB9DQogIC8vIGV2ZW50IHJhaXNlZCB3aGVuIHJldHVybiBjb2RlIGZyb20gYSBmdW5jdGlvbiBpcyBub3QgT0ssIHdoZW4gT0sgaXMgcmV0dXJuZWQgb25lIG9mIGV2ZW50cyBhYm92ZSBpcyByYWlzZWQNCiAgZXZlbnQgUmV0dXJuQ29kZShSZXR1cm5Db2RlcyByYyk7DQogIGVudW0gVGVybWluYXRpb25UeXBlIHsgUmVndWxhciwgQmFkTGVhdmVyIH0NCg0KICAvL0NPTkZJRw0KICBPcHRpb25zQ2FsY3VsYXRvciBwdWJsaWMgb3B0aW9uc0NhbGN1bGF0b3I7DQogIC8vIHRvdGFsIHBvb2xPcHRpb25zIGluIFRoZSBQb29sDQogIHVpbnQgcHVibGljIHRvdGFsUG9vbE9wdGlvbnM7DQogIC8vIGlwZnMgaGFzaCBvZiBkb2N1bWVudCBlc3RhYmxpc2hpbmcgdGhpcyBFU09QDQogIGJ5dGVzIHB1YmxpYyBFU09QTGVnYWxXcmFwcGVySVBGU0hhc2g7DQogIC8vIGNvbXBhbnkgYWRkcmVzcw0KICBhZGRyZXNzIHB1YmxpYyBjb21wYW55QWRkcmVzczsNCiAgLy8gcm9vdCBvZiBpbW11dGFibGUgcm9vdCBvZiB0cnVzdCBwb2ludGluZyB0byBnaXZlbiBFU09QIGltcGxlbWVudGF0aW9uDQogIGFkZHJlc3MgcHVibGljIHJvb3RPZlRydXN0Ow0KICAvLyBkZWZhdWx0IHBlcmlvZCBmb3IgZW1wbG95ZWUgc2lnbmF0dXJlDQogIHVpbnQzMiBjb25zdGFudCBwdWJsaWMgTUlOSU1VTV9NQU5VQUxfU0lHTl9QRVJJT0QgPSAyIHdlZWtzOw0KDQogIC8vIFNUQVRFDQogIC8vIHBvb2xPcHRpb25zIHRoYXQgcmVtYWluIHRvIGJlIGFzc2lnbmVkDQogIHVpbnQgcHVibGljIHJlbWFpbmluZ1Bvb2xPcHRpb25zOw0KICAvLyBzdGF0ZSBvZiBFU09QDQogIEVTT1BTdGF0ZSBwdWJsaWMgZXNvcFN0YXRlOyAvLyBhdXRvbWF0aWNhbGx5IHNldHMgdG8gT3BlbiAoMCkNCiAgLy8gbGlzdCBvZiBlbXBsb3llZXMNCiAgRW1wbG95ZWVzTGlzdCBwdWJsaWMgZW1wbG95ZWVzOw0KICAvLyBob3cgbWFueSBleHRyYSBvcHRpb25zIGluc2VydGVkDQogIHVpbnQgcHVibGljIHRvdGFsRXh0cmFPcHRpb25zOw0KICAvLyB3aGVuIGNvbnZlcnNpb24gZXZlbnQgaGFwcGVuZWQNCiAgdWludDMyIHB1YmxpYyBjb252ZXJzaW9uT2ZmZXJlZEF0Ow0KICAvLyBlbXBsb3llZSBjb252ZXJzaW9uIGRlYWRsaW5lDQogIHVpbnQzMiBwdWJsaWMgZXhlcmNpc2VPcHRpb25zRGVhZGxpbmU7DQogIC8vIG9wdGlvbiBjb252ZXJzaW9uIHByb3h5DQogIEJhc2VPcHRpb25zQ29udmVydGVyIHB1YmxpYyBvcHRpb25zQ29udmVydGVyOw0KDQogIC8vIG1pZ3JhdGlvbiBkZXN0aW5hdGlvbnMgcGVyIGVtcGxveWVlDQogIG1hcHBpbmcgKGFkZHJlc3MgPT4gRVNPUE1pZ3JhdGlvbikgcHJpdmF0ZSBtaWdyYXRpb25zOw0KDQogIG1vZGlmaWVyIGhhc0VtcGxveWVlKGFkZHJlc3MgZSkgew0KICAgIC8vIHdpbGwgdGhyb3cgb24gdW5rbm93biBhZGRyZXNzDQogICAgaWYgKCFlbXBsb3llZXMuaGFzRW1wbG95ZWUoZSkpDQogICAgICB0aHJvdzsNCiAgICBfOw0KICB9DQoNCiAgbW9kaWZpZXIgb25seUVTT1BOZXcoKSB7DQogICAgaWYgKGVzb3BTdGF0ZSAhPSBFU09QU3RhdGUuTmV3KQ0KICAgICAgdGhyb3c7DQogICAgXzsNCiAgfQ0KDQogIG1vZGlmaWVyIG9ubHlFU09QT3BlbigpIHsNCiAgICBpZiAoZXNvcFN0YXRlICE9IEVTT1BTdGF0ZS5PcGVuKQ0KICAgICAgdGhyb3c7DQogICAgXzsNCiAgfQ0KDQogIG1vZGlmaWVyIG9ubHlFU09QQ29udmVyc2lvbigpIHsNCiAgICBpZiAoZXNvcFN0YXRlICE9IEVTT1BTdGF0ZS5Db252ZXJzaW9uKQ0KICAgICAgdGhyb3c7DQogICAgXzsNCiAgfQ0KDQogIG1vZGlmaWVyIG9ubHlDb21wYW55KCkgew0KICAgIGlmIChjb21wYW55QWRkcmVzcyAhPSBtc2cuc2VuZGVyKQ0KICAgICAgdGhyb3c7DQogICAgXzsNCiAgfQ0KDQogIGZ1bmN0aW9uIGRpc3RyaWJ1dGVBbmRSZXR1cm5Ub1Bvb2wodWludCBkaXN0cmlidXRlZE9wdGlvbnMsIHVpbnQgaWR4KQ0KICAgIGludGVybmFsDQogICAgcmV0dXJucyAodWludCkNCiAgew0KICAgIC8vIGVudW1lcmF0ZSBhbGwgZW1wbG95ZWVzIHRoYXQgd2VyZSBvZmZlcmVkIHBvb2xPcHRpb25zIGFmdGVyIHRoYW4gZnJvbUlkeCAtMSBlbXBsb3llZQ0KICAgIEVtcGxveWVlIG1lbW9yeSBlbXA7DQogICAgZm9yICh1aW50IGkgPSBpZHg7IGkgPCBlbXBsb3llZXMuc2l6ZSgpOyBpKyspIHsNCiAgICAgIGFkZHJlc3MgZWEgPSBlbXBsb3llZXMuYWRkcmVzc2VzKGkpOw0KICAgICAgaWYgKGVhICE9IDApIHsgLy8gYWRkcmVzcygwKSBpcyBkZWxldGVkIGVtcGxveWVlDQogICAgICAgIGVtcCA9IF9sb2FkZW1wKGVhKTsNCiAgICAgICAgLy8gc2tpcCBlbXBsb3llZXMgd2l0aCBubyBwb29sT3B0aW9ucyBhbmQgdGVybWluYXRlZCBlbXBsb3llZXMNCiAgICAgICAgaWYgKGVtcC5wb29sT3B0aW9ucyA+IDAgJiYgKCBlbXAuc3RhdGUgPT0gRW1wbG95ZWVTdGF0ZS5XYWl0aW5nRm9yU2lnbmF0dXJlIHx8IGVtcC5zdGF0ZSA9PSBFbXBsb3llZVN0YXRlLkVtcGxveWVkKSApIHsNCiAgICAgICAgICB1aW50IG5ld29wdGlvbnMgPSBvcHRpb25zQ2FsY3VsYXRvci5jYWxjTmV3RW1wbG95ZWVQb29sT3B0aW9ucyhkaXN0cmlidXRlZE9wdGlvbnMpOw0KICAgICAgICAgIGVtcC5wb29sT3B0aW9ucyArPSB1aW50MzIobmV3b3B0aW9ucyk7DQogICAgICAgICAgZGlzdHJpYnV0ZWRPcHRpb25zIC09IHVpbnQzMihuZXdvcHRpb25zKTsNCiAgICAgICAgICBfc2F2ZWVtcChlYSwgZW1wKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gZGlzdHJpYnV0ZWRPcHRpb25zOw0KICB9DQoNCiAgZnVuY3Rpb24gcmVtb3ZlRW1wbG95ZWVzV2l0aEV4cGlyZWRTaWduYXR1cmVzQW5kUmV0dXJuRmFkZW91dCgpDQogICAgb25seUVTT1BPcGVuDQogICAgaXNDdXJyZW50Q29kZQ0KICAgIHB1YmxpYw0KICB7DQogICAgLy8gcmVtb3ZlcyBlbXBsb3llZXMgdGhhdCBkaWRuJ3Qgc2lnbiBhbmQgc2VuZHMgdGhlaXIgcG9vbE9wdGlvbnMgYmFjayB0byB0aGUgcG9vbA0KICAgIC8vIGNvbXB1dGVzIGZhZGVvdXQgZm9yIHRlcm1pbmF0ZWQgZW1wbG95ZWVzIGFuZCByZXR1cm5zIGl0IHRvIHBvb2wNCiAgICAvLyB3ZSBsZXQgYW55b25lIHRvIGNhbGwgdGhhdCBtZXRob2QgYW5kIHNwZW5kIGdhcyBvbiBpdA0KICAgIEVtcGxveWVlIG1lbW9yeSBlbXA7DQogICAgdWludDMyIGN0ID0gY3VycmVudFRpbWUoKTsNCiAgICBmb3IgKHVpbnQgaSA9IDA7IGkgPCBlbXBsb3llZXMuc2l6ZSgpOyBpKyspIHsNCiAgICAgIGFkZHJlc3MgZWEgPSBlbXBsb3llZXMuYWRkcmVzc2VzKGkpOw0KICAgICAgaWYgKGVhICE9IDApIHsgLy8gYWRkcmVzcygwKSBpcyBkZWxldGVkIGVtcGxveWVlDQogICAgICAgIHZhciBzZXIgPSBlbXBsb3llZXMuZ2V0U2VyaWFsaXplZEVtcGxveWVlKGVhKTsNCiAgICAgICAgZW1wID0gZGVzZXJpYWxpemVFbXBsb3llZShzZXIpOw0KICAgICAgICAvLyByZW1vdmUgZW1wbG95ZWVzIHdpdGggZXhwaXJlZCBzaWduYXR1cmVzDQogICAgICAgIGlmIChlbXAuc3RhdGUgPT0gRW1wbG95ZWVTdGF0ZS5XYWl0aW5nRm9yU2lnbmF0dXJlICYmIGN0ID4gZW1wLnRpbWVUb1NpZ24pIHsNCiAgICAgICAgICByZW1haW5pbmdQb29sT3B0aW9ucyArPSBkaXN0cmlidXRlQW5kUmV0dXJuVG9Qb29sKGVtcC5wb29sT3B0aW9ucywgaSsxKTsNCiAgICAgICAgICB0b3RhbEV4dHJhT3B0aW9ucyAtPSBlbXAuZXh0cmFPcHRpb25zOw0KICAgICAgICAgIC8vIGFjdHVhbGx5IHRoaXMganVzdCBzZXRzIGFkZHJlc3MgdG8gMCBzbyBpdGVyYXRvciBjYW4gY29udGludWUNCiAgICAgICAgICBlbXBsb3llZXMucmVtb3ZlRW1wbG95ZWUoZWEpOw0KICAgICAgICB9DQogICAgICAgIC8vIHJldHVybiBmYWRlb3V0IHRvIHBvb2wNCiAgICAgICAgaWYgKGVtcC5zdGF0ZSA9PSBFbXBsb3llZVN0YXRlLlRlcm1pbmF0ZWQgJiYgY3QgPiBlbXAuZmFkZW91dFN0YXJ0cykgew0KICAgICAgICAgIHZhciAocmV0dXJuZWRQb29sT3B0aW9ucywgcmV0dXJuZWRFeHRyYU9wdGlvbnMpID0gb3B0aW9uc0NhbGN1bGF0b3IuY2FsY3VsYXRlRmFkZW91dFRvUG9vbChjdCwgc2VyKTsNCiAgICAgICAgICBpZiAocmV0dXJuZWRQb29sT3B0aW9ucyA+IDAgfHwgcmV0dXJuZWRFeHRyYU9wdGlvbnMgPiAwKSB7DQogICAgICAgICAgICBlbXBsb3llZXMuc2V0RmFkZW91dFN0YXJ0cyhlYSwgY3QpOw0KICAgICAgICAgICAgLy8gb3B0aW9ucyBmcm9tIGZhZGVvdXQgYXJlIG5vdCBkaXN0cmlidXRlZCB0byBvdGhlciBlbXBsb3llZXMgYnV0IHJldHVybmVkIHRvIHBvb2wNCiAgICAgICAgICAgIHJlbWFpbmluZ1Bvb2xPcHRpb25zICs9IHJldHVybmVkUG9vbE9wdGlvbnM7DQogICAgICAgICAgICAvLyB3ZSBtYWludGFpbiBleHRyYVBvb2wgZm9yIGVhc2llciBzdGF0aXN0aWNzDQogICAgICAgICAgICB0b3RhbEV4dHJhT3B0aW9ucyAtPSByZXR1cm5lZEV4dHJhT3B0aW9uczsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogIH0NCg0KICBmdW5jdGlvbiBvcGVuRVNPUCh1aW50MzIgcFRvdGFsUG9vbE9wdGlvbnMsIGJ5dGVzIHBFU09QTGVnYWxXcmFwcGVySVBGU0hhc2gpDQogICAgZXh0ZXJuYWwNCiAgICBvbmx5Q29tcGFueQ0KICAgIG9ubHlFU09QTmV3DQogICAgaXNDdXJyZW50Q29kZQ0KICAgIHJldHVybnMgKFJldHVybkNvZGVzKQ0KICB7DQogICAgLy8gb3B0aW9ucyBhcmUgc3RvcmVkIGluIHVuaXQzMg0KICAgIGlmIChwVG90YWxQb29sT3B0aW9ucyA+IDExMDAwMDAgfHwgcFRvdGFsUG9vbE9wdGlvbnMgPCAxMDAwMCkgew0KICAgICAgcmV0dXJuIF9sb2dlcnJvcihSZXR1cm5Db2Rlcy5JbnZhbGlkUGFyYW1ldGVycyk7DQogICAgfQ0KDQogICAgdG90YWxQb29sT3B0aW9ucyA9IHBUb3RhbFBvb2xPcHRpb25zOw0KICAgIHJlbWFpbmluZ1Bvb2xPcHRpb25zID0gdG90YWxQb29sT3B0aW9uczsNCiAgICBFU09QTGVnYWxXcmFwcGVySVBGU0hhc2ggPSBwRVNPUExlZ2FsV3JhcHBlcklQRlNIYXNoOw0KDQogICAgZXNvcFN0YXRlID0gRVNPUFN0YXRlLk9wZW47DQogICAgRVNPUE9wZW5lZChjb21wYW55QWRkcmVzcyk7DQogICAgcmV0dXJuIFJldHVybkNvZGVzLk9LOw0KICB9DQoNCiAgZnVuY3Rpb24gb2ZmZXJPcHRpb25zVG9FbXBsb3llZShhZGRyZXNzIGUsIHVpbnQzMiBpc3N1ZURhdGUsIHVpbnQzMiB0aW1lVG9TaWduLCB1aW50MzIgZXh0cmFPcHRpb25zLCBib29sIHBvb2xDbGVhbnVwKQ0KICAgIGV4dGVybmFsDQogICAgb25seUVTT1BPcGVuDQogICAgb25seUNvbXBhbnkNCiAgICBpc0N1cnJlbnRDb2RlDQogICAgcmV0dXJucyAoUmV0dXJuQ29kZXMpDQogIHsNCiAgICAvLyBkbyBub3QgYWRkIHR3aWNlDQogICAgaWYgKGVtcGxveWVlcy5oYXNFbXBsb3llZShlKSkgew0KICAgICAgcmV0dXJuIF9sb2dlcnJvcihSZXR1cm5Db2Rlcy5JbnZhbGlkRW1wbG95ZWVTdGF0ZSk7DQogICAgfQ0KICAgIGlmICh0aW1lVG9TaWduIDwgY3VycmVudFRpbWUoKSArIE1JTklNVU1fTUFOVUFMX1NJR05fUEVSSU9EKSB7DQogICAgICByZXR1cm4gX2xvZ2Vycm9yKFJldHVybkNvZGVzLlRvb0xhdGUpOw0KICAgIH0NCiAgICBpZiAocG9vbENsZWFudXApIHsNCiAgICAgIC8vIHJlY292ZXIgcG9vbE9wdGlvbnMgZm9yIGVtcGxveWVlcyB3aXRoIGV4cGlyZWQgc2lnbmF0dXJlcw0KICAgICAgLy8gcmV0dXJuIGZhZGUgb3V0IHRvIHBvb2wNCiAgICAgIHJlbW92ZUVtcGxveWVlc1dpdGhFeHBpcmVkU2lnbmF0dXJlc0FuZFJldHVybkZhZGVvdXQoKTsNCiAgICB9DQogICAgdWludCBwb29sT3B0aW9ucyA9IG9wdGlvbnNDYWxjdWxhdG9yLmNhbGNOZXdFbXBsb3llZVBvb2xPcHRpb25zKHJlbWFpbmluZ1Bvb2xPcHRpb25zKTsNCiAgICBpZiAocG9vbE9wdGlvbnMgPiAweEZGRkZGRkZGKQ0KICAgICAgdGhyb3c7DQogICAgRW1wbG95ZWUgbWVtb3J5IGVtcCA9IEVtcGxveWVlKHsNCiAgICAgIGlzc3VlRGF0ZTogaXNzdWVEYXRlLCB0aW1lVG9TaWduOiB0aW1lVG9TaWduLCB0ZXJtaW5hdGVkQXQ6IDAsIGZhZGVvdXRTdGFydHM6IDAsIHBvb2xPcHRpb25zOiB1aW50MzIocG9vbE9wdGlvbnMpLA0KICAgICAgZXh0cmFPcHRpb25zOiBleHRyYU9wdGlvbnMsIHN1c3BlbmRlZEF0OiAwLCBzdGF0ZTogRW1wbG95ZWVTdGF0ZS5XYWl0aW5nRm9yU2lnbmF0dXJlLCBpZHg6IDANCiAgICB9KTsNCiAgICBfc2F2ZWVtcChlLCBlbXApOw0KICAgIHJlbWFpbmluZ1Bvb2xPcHRpb25zIC09IHBvb2xPcHRpb25zOw0KICAgIHRvdGFsRXh0cmFPcHRpb25zICs9IGV4dHJhT3B0aW9uczsNCiAgICBFU09QT2ZmZXJlZChlLCBjb21wYW55QWRkcmVzcywgdWludDMyKHBvb2xPcHRpb25zKSwgZXh0cmFPcHRpb25zKTsNCiAgICByZXR1cm4gUmV0dXJuQ29kZXMuT0s7DQogIH0NCg0KICAvLyB0b2RvOiBpbXBsZW1lbnQgZ3JvdXAgYWRkIHNvbWVkYXksIGhvd2V2ZXIgZnVuYyBkaXN0cmlidXRlQW5kUmV0dXJuVG9Qb29sIGdldHMgdmVyeSBjb21wbGljYXRlZA0KICAvLyB0b2RvOiBmdW5jdGlvbiBjYWxjTmV3RW1wbG95ZWVQb29sT3B0aW9ucyh1aW50IHJlbWFpbmluZywgdWludDggZ3JvdXBTaXplKQ0KICAvLyB0b2RvOiBmdW5jdGlvbiBhZGROZXdFbXBsb3llZXNUb0VTT1AoYWRkcmVzc1tdIGVtcHMsIHVpbnQzMiBpc3N1ZURhdGUsIHVpbnQzMiB0aW1lVG9TaWduKQ0KDQogIGZ1bmN0aW9uIG9mZmVyT3B0aW9uc1RvRW1wbG95ZWVPbmx5RXh0cmEoYWRkcmVzcyBlLCB1aW50MzIgaXNzdWVEYXRlLCB1aW50MzIgdGltZVRvU2lnbiwgdWludDMyIGV4dHJhT3B0aW9ucykNCiAgICBleHRlcm5hbA0KICAgIG9ubHlFU09QT3Blbg0KICAgIG9ubHlDb21wYW55DQogICAgaXNDdXJyZW50Q29kZQ0KICAgIHJldHVybnMgKFJldHVybkNvZGVzKQ0KICB7DQogICAgLy8gZG8gbm90IGFkZCB0d2ljZQ0KICAgIGlmIChlbXBsb3llZXMuaGFzRW1wbG95ZWUoZSkpIHsNCiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuSW52YWxpZEVtcGxveWVlU3RhdGUpOw0KICAgIH0NCiAgICBpZiAodGltZVRvU2lnbiA8IGN1cnJlbnRUaW1lKCkgKyBNSU5JTVVNX01BTlVBTF9TSUdOX1BFUklPRCkgew0KICAgICAgcmV0dXJuIF9sb2dlcnJvcihSZXR1cm5Db2Rlcy5Ub29MYXRlKTsNCiAgICB9DQogICAgRW1wbG95ZWUgbWVtb3J5IGVtcCA9IEVtcGxveWVlKHsNCiAgICAgIGlzc3VlRGF0ZTogaXNzdWVEYXRlLCB0aW1lVG9TaWduOiB0aW1lVG9TaWduLCB0ZXJtaW5hdGVkQXQ6IDAsIGZhZGVvdXRTdGFydHM6IDAsIHBvb2xPcHRpb25zOiAwLA0KICAgICAgZXh0cmFPcHRpb25zOiBleHRyYU9wdGlvbnMsIHN1c3BlbmRlZEF0OiAwLCBzdGF0ZTogRW1wbG95ZWVTdGF0ZS5XYWl0aW5nRm9yU2lnbmF0dXJlLCBpZHg6IDANCiAgICB9KTsNCiAgICBfc2F2ZWVtcChlLCBlbXApOw0KICAgIHRvdGFsRXh0cmFPcHRpb25zICs9IGV4dHJhT3B0aW9uczsNCiAgICBFU09QT2ZmZXJlZChlLCBjb21wYW55QWRkcmVzcywgMCwgZXh0cmFPcHRpb25zKTsNCiAgICByZXR1cm4gUmV0dXJuQ29kZXMuT0s7DQogIH0NCg0KICBmdW5jdGlvbiBpbmNyZWFzZUVtcGxveWVlRXh0cmFPcHRpb25zKGFkZHJlc3MgZSwgdWludDMyIGV4dHJhT3B0aW9ucykNCiAgICBleHRlcm5hbA0KICAgIG9ubHlFU09QT3Blbg0KICAgIG9ubHlDb21wYW55DQogICAgaXNDdXJyZW50Q29kZQ0KICAgIGhhc0VtcGxveWVlKGUpDQogICAgcmV0dXJucyAoUmV0dXJuQ29kZXMpDQogIHsNCiAgICBFbXBsb3llZSBtZW1vcnkgZW1wID0gX2xvYWRlbXAoZSk7DQogICAgaWYgKGVtcC5zdGF0ZSAhPSBFbXBsb3llZVN0YXRlLkVtcGxveWVkICYmIGVtcC5zdGF0ZSAhPSBFbXBsb3llZVN0YXRlLldhaXRpbmdGb3JTaWduYXR1cmUpIHsNCiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuSW52YWxpZEVtcGxveWVlU3RhdGUpOw0KICAgIH0NCiAgICBlbXAuZXh0cmFPcHRpb25zICs9IGV4dHJhT3B0aW9uczsNCiAgICBfc2F2ZWVtcChlLCBlbXApOw0KICAgIHRvdGFsRXh0cmFPcHRpb25zICs9IGV4dHJhT3B0aW9uczsNCiAgICBFU09QT2ZmZXJlZChlLCBjb21wYW55QWRkcmVzcywgMCwgZXh0cmFPcHRpb25zKTsNCiAgICByZXR1cm4gUmV0dXJuQ29kZXMuT0s7DQogIH0NCg0KICBmdW5jdGlvbiBlbXBsb3llZVNpZ25zVG9FU09QKCkNCiAgICBleHRlcm5hbA0KICAgIGhhc0VtcGxveWVlKG1zZy5zZW5kZXIpDQogICAgb25seUVTT1BPcGVuDQogICAgaXNDdXJyZW50Q29kZQ0KICAgIHJldHVybnMgKFJldHVybkNvZGVzKQ0KICB7DQogICAgRW1wbG95ZWUgbWVtb3J5IGVtcCA9IF9sb2FkZW1wKG1zZy5zZW5kZXIpOw0KICAgIGlmIChlbXAuc3RhdGUgIT0gRW1wbG95ZWVTdGF0ZS5XYWl0aW5nRm9yU2lnbmF0dXJlKSB7DQogICAgICByZXR1cm4gX2xvZ2Vycm9yKFJldHVybkNvZGVzLkludmFsaWRFbXBsb3llZVN0YXRlKTsNCiAgICB9DQogICAgdWludDMyIHQgPSBjdXJyZW50VGltZSgpOw0KICAgIGlmICh0ID4gZW1wLnRpbWVUb1NpZ24pIHsNCiAgICAgIHJlbWFpbmluZ1Bvb2xPcHRpb25zICs9IGRpc3RyaWJ1dGVBbmRSZXR1cm5Ub1Bvb2woZW1wLnBvb2xPcHRpb25zLCBlbXAuaWR4KTsNCiAgICAgIHRvdGFsRXh0cmFPcHRpb25zIC09IGVtcC5leHRyYU9wdGlvbnM7DQogICAgICBlbXBsb3llZXMucmVtb3ZlRW1wbG95ZWUobXNnLnNlbmRlcik7DQogICAgICByZXR1cm4gX2xvZ2Vycm9yKFJldHVybkNvZGVzLlRvb0xhdGUpOw0KICAgIH0NCiAgICBlbXBsb3llZXMuY2hhbmdlU3RhdGUobXNnLnNlbmRlciwgRW1wbG95ZWVTdGF0ZS5FbXBsb3llZCk7DQogICAgRW1wbG95ZWVTaWduZWRUb0VTT1AobXNnLnNlbmRlcik7DQogICAgcmV0dXJuIFJldHVybkNvZGVzLk9LOw0KICB9DQoNCiAgZnVuY3Rpb24gdG9nZ2xlRW1wbG95ZWVTdXNwZW5zaW9uKGFkZHJlc3MgZSwgdWludDMyIHRvZ2dsZWRBdCkNCiAgICBleHRlcm5hbA0KICAgIG9ubHlFU09QT3Blbg0KICAgIG9ubHlDb21wYW55DQogICAgaGFzRW1wbG95ZWUoZSkNCiAgICBpc0N1cnJlbnRDb2RlDQogICAgcmV0dXJucyAoUmV0dXJuQ29kZXMpDQogIHsNCiAgICBFbXBsb3llZSBtZW1vcnkgZW1wID0gX2xvYWRlbXAoZSk7DQogICAgaWYgKGVtcC5zdGF0ZSAhPSBFbXBsb3llZVN0YXRlLkVtcGxveWVkKSB7DQogICAgICByZXR1cm4gX2xvZ2Vycm9yKFJldHVybkNvZGVzLkludmFsaWRFbXBsb3llZVN0YXRlKTsNCiAgICB9DQogICAgaWYgKGVtcC5zdXNwZW5kZWRBdCA9PSAwKSB7DQogICAgICAvL3N1c3BlbmQgYWN0aW9uDQogICAgICBlbXAuc3VzcGVuZGVkQXQgPSB0b2dnbGVkQXQ7DQogICAgICBTdXNwZW5kRW1wbG95ZWUoZSwgdG9nZ2xlZEF0KTsNCiAgICB9IGVsc2Ugew0KICAgICAgaWYgKGVtcC5zdXNwZW5kZWRBdCA+IHRvZ2dsZWRBdCkgew0KICAgICAgICByZXR1cm4gX2xvZ2Vycm9yKFJldHVybkNvZGVzLlRvb0xhdGUpOw0KICAgICAgfQ0KICAgICAgdWludDMyIHN1c3BlbmRlZFBlcmlvZCA9IHRvZ2dsZWRBdCAtIGVtcC5zdXNwZW5kZWRBdDsNCiAgICAgIC8vIG1vdmUgZXZlcnl0aGluZyBieSBzdXNwZW5zaW9uIHBlcmlvZCBieSBjaGFuZ2luZyBpc3N1ZURhdGUNCiAgICAgIGVtcC5pc3N1ZURhdGUgKz0gc3VzcGVuZGVkUGVyaW9kOw0KICAgICAgZW1wLnN1c3BlbmRlZEF0ID0gMDsNCiAgICAgIENvbnRpbnVlU3VzcGVuZGVkRW1wbG95ZWUoZSwgdG9nZ2xlZEF0LCBzdXNwZW5kZWRQZXJpb2QpOw0KICAgIH0NCiAgICBfc2F2ZWVtcChlLCBlbXApOw0KICAgIHJldHVybiBSZXR1cm5Db2Rlcy5PSzsNCiAgfQ0KDQogIGZ1bmN0aW9uIHRlcm1pbmF0ZUVtcGxveWVlKGFkZHJlc3MgZSwgdWludDMyIHRlcm1pbmF0ZWRBdCwgdWludDggdGVybWluYXRpb25UeXBlKQ0KICAgIGV4dGVybmFsDQogICAgb25seUVTT1BPcGVuDQogICAgb25seUNvbXBhbnkNCiAgICBoYXNFbXBsb3llZShlKQ0KICAgIGlzQ3VycmVudENvZGUNCiAgICByZXR1cm5zIChSZXR1cm5Db2RlcykNCiAgew0KICAgIC8vIHRlcm1pbmF0ZXMgYW4gZW1wbG95ZWUNCiAgICBUZXJtaW5hdGlvblR5cGUgdGVybVR5cGUgPSBUZXJtaW5hdGlvblR5cGUodGVybWluYXRpb25UeXBlKTsNCiAgICBFbXBsb3llZSBtZW1vcnkgZW1wID0gX2xvYWRlbXAoZSk7DQogICAgLy8gdG9kbzogY2hlY2sgdGVybWluYXRpb24gdGltZSBhZ2FpbnN0IGlzc3VlRGF0ZQ0KICAgIGlmICh0ZXJtaW5hdGVkQXQgPCBlbXAuaXNzdWVEYXRlKSB7DQogICAgICByZXR1cm4gX2xvZ2Vycm9yKFJldHVybkNvZGVzLkludmFsaWRQYXJhbWV0ZXJzKTsNCiAgICB9DQogICAgaWYgKGVtcC5zdGF0ZSA9PSBFbXBsb3llZVN0YXRlLldhaXRpbmdGb3JTaWduYXR1cmUpDQogICAgICB0ZXJtVHlwZSA9IFRlcm1pbmF0aW9uVHlwZS5CYWRMZWF2ZXI7DQogICAgZWxzZSBpZiAoZW1wLnN0YXRlICE9IEVtcGxveWVlU3RhdGUuRW1wbG95ZWQpIHsNCiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuSW52YWxpZEVtcGxveWVlU3RhdGUpOw0KICAgIH0NCiAgICAvLyBob3cgbWFueSBwb29sT3B0aW9ucyByZXR1cm5lZCB0byBwb29sDQogICAgdWludCByZXR1cm5lZE9wdGlvbnM7DQogICAgdWludCByZXR1cm5lZEV4dHJhT3B0aW9uczsNCiAgICBpZiAodGVybVR5cGUgPT0gVGVybWluYXRpb25UeXBlLlJlZ3VsYXIpIHsNCiAgICAgIC8vIHJlZ3VsYXIgdGVybWluYXRpb24sIGNvbXB1dGUgc3VzcGVuc2lvbg0KICAgICAgaWYgKGVtcC5zdXNwZW5kZWRBdCA+IDAgJiYgZW1wLnN1c3BlbmRlZEF0IDwgdGVybWluYXRlZEF0KQ0KICAgICAgICBlbXAuaXNzdWVEYXRlICs9IHRlcm1pbmF0ZWRBdCAtIGVtcC5zdXNwZW5kZWRBdDsNCiAgICAgIC8vIHZlc3RpbmcgYXBwbGllcw0KICAgICAgcmV0dXJuZWRPcHRpb25zID0gZW1wLnBvb2xPcHRpb25zIC0gb3B0aW9uc0NhbGN1bGF0b3IuY2FsY3VsYXRlVmVzdGVkT3B0aW9ucyh0ZXJtaW5hdGVkQXQsIGVtcC5pc3N1ZURhdGUsIGVtcC5wb29sT3B0aW9ucyk7DQogICAgICByZXR1cm5lZEV4dHJhT3B0aW9ucyA9IGVtcC5leHRyYU9wdGlvbnMgLSBvcHRpb25zQ2FsY3VsYXRvci5jYWxjdWxhdGVWZXN0ZWRPcHRpb25zKHRlcm1pbmF0ZWRBdCwgZW1wLmlzc3VlRGF0ZSwgZW1wLmV4dHJhT3B0aW9ucyk7DQogICAgICBlbXBsb3llZXMudGVybWluYXRlRW1wbG95ZWUoZSwgZW1wLmlzc3VlRGF0ZSwgdGVybWluYXRlZEF0LCB0ZXJtaW5hdGVkQXQsIEVtcGxveWVlU3RhdGUuVGVybWluYXRlZCk7DQogICAgfSBlbHNlIGlmICh0ZXJtVHlwZSA9PSBUZXJtaW5hdGlvblR5cGUuQmFkTGVhdmVyKSB7DQogICAgICAvLyBiYWQgbGVhdmVyIC0gZW1wbG95ZWUgaXMga2lja2VkIG91dCBmcm9tIEVTT1AsIHJldHVybiBhbGwgcG9vbE9wdGlvbnMNCiAgICAgIHJldHVybmVkT3B0aW9ucyA9IGVtcC5wb29sT3B0aW9uczsNCiAgICAgIHJldHVybmVkRXh0cmFPcHRpb25zID0gZW1wLmV4dHJhT3B0aW9uczsNCiAgICAgIGVtcGxveWVlcy5yZW1vdmVFbXBsb3llZShlKTsNCiAgICB9DQogICAgcmVtYWluaW5nUG9vbE9wdGlvbnMgKz0gZGlzdHJpYnV0ZUFuZFJldHVyblRvUG9vbChyZXR1cm5lZE9wdGlvbnMsIGVtcC5pZHgpOw0KICAgIHRvdGFsRXh0cmFPcHRpb25zIC09IHJldHVybmVkRXh0cmFPcHRpb25zOw0KICAgIFRlcm1pbmF0ZUVtcGxveWVlKGUsIGNvbXBhbnlBZGRyZXNzLCB0ZXJtaW5hdGVkQXQsIHRlcm1UeXBlKTsNCiAgICByZXR1cm4gUmV0dXJuQ29kZXMuT0s7DQogIH0NCg0KICBmdW5jdGlvbiBvZmZlck9wdGlvbnNDb252ZXJzaW9uKEJhc2VPcHRpb25zQ29udmVydGVyIGNvbnZlcnRlcikNCiAgICBleHRlcm5hbA0KICAgIG9ubHlFU09QT3Blbg0KICAgIG9ubHlDb21wYW55DQogICAgaXNDdXJyZW50Q29kZQ0KICAgIHJldHVybnMgKFJldHVybkNvZGVzKQ0KICB7DQogICAgdWludDMyIG9mZmVyTWFkZUF0ID0gY3VycmVudFRpbWUoKTsNCiAgICBpZiAoY29udmVydGVyLmdldEV4ZXJjaXNlUGVyaW9kRGVhZGxpbmUoKSAtIG9mZmVyTWFkZUF0IDwgTUlOSU1VTV9NQU5VQUxfU0lHTl9QRVJJT0QpIHsNCiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuVG9vTGF0ZSk7DQogICAgfQ0KICAgIC8vIGV4ZXJjaXNlT3B0aW9ucyBtdXN0IGJlIGNhbGxhYmxlIGJ5IHVzDQogICAgaWYgKGNvbnZlcnRlci5nZXRFU09QKCkgIT0gYWRkcmVzcyh0aGlzKSkgew0KICAgICAgcmV0dXJuIF9sb2dlcnJvcihSZXR1cm5Db2Rlcy5JbnZhbGlkUGFyYW1ldGVycyk7DQogICAgfQ0KICAgIC8vIHJldHVybiB0byBwb29sIGV2ZXJ5dGhpbmcgd2UgY2FuDQogICAgcmVtb3ZlRW1wbG95ZWVzV2l0aEV4cGlyZWRTaWduYXR1cmVzQW5kUmV0dXJuRmFkZW91dCgpOw0KICAgIC8vIGZyb20gbm93IHZlc3RpbmcgYW5kIGZhZGVvdXQgc3RvcHMsIG5vIG5ldyBlbXBsb3llZXMgbWF5IGJlIGFkZGVkDQogICAgY29udmVyc2lvbk9mZmVyZWRBdCA9IG9mZmVyTWFkZUF0Ow0KICAgIGV4ZXJjaXNlT3B0aW9uc0RlYWRsaW5lID0gY29udmVydGVyLmdldEV4ZXJjaXNlUGVyaW9kRGVhZGxpbmUoKTsNCiAgICBvcHRpb25zQ29udmVydGVyID0gY29udmVydGVyOw0KICAgIC8vIHRoaXMgaXMgdmVyeSBpcnJldmVyc2libGUNCiAgICBlc29wU3RhdGUgPSBFU09QU3RhdGUuQ29udmVyc2lvbjsNCiAgICBPcHRpb25zQ29udmVyc2lvbk9mZmVyZWQoY29tcGFueUFkZHJlc3MsIGFkZHJlc3MoY29udmVydGVyKSwgb2ZmZXJNYWRlQXQsIGV4ZXJjaXNlT3B0aW9uc0RlYWRsaW5lKTsNCiAgICByZXR1cm4gUmV0dXJuQ29kZXMuT0s7DQogIH0NCg0KICBmdW5jdGlvbiBleGVyY2lzZU9wdGlvbnNJbnRlcm5hbCh1aW50MzIgY2FsY0F0VGltZSwgYWRkcmVzcyBlbXBsb3llZSwgYWRkcmVzcyBleGVyY2lzZUZvciwNCiAgICBib29sIGRpc2FibGVBY2NlbGVyYXRlZFZlc3RpbmcpDQogICAgaW50ZXJuYWwNCiAgICByZXR1cm5zIChSZXR1cm5Db2RlcykNCiAgew0KICAgIEVtcGxveWVlIG1lbW9yeSBlbXAgPSBfbG9hZGVtcChlbXBsb3llZSk7DQogICAgaWYgKGVtcC5zdGF0ZSA9PSBFbXBsb3llZVN0YXRlLk9wdGlvbnNFeGVyY2lzZWQpIHsNCiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuSW52YWxpZEVtcGxveWVlU3RhdGUpOw0KICAgIH0NCiAgICAvLyBpZiB3ZSBhcmUgYnVybmluZyBvcHRpb25zIHRoZW4gc2VuZCAwDQogICAgaWYgKGV4ZXJjaXNlRm9yICE9IGFkZHJlc3MoMCkpIHsNCiAgICAgIHZhciAocG9vbCwgZXh0cmEsIGJvbnVzKSA9IG9wdGlvbnNDYWxjdWxhdG9yLmNhbGN1bGF0ZU9wdGlvbnNDb21wb25lbnRzKHNlcmlhbGl6ZUVtcGxveWVlKGVtcCksDQogICAgICAgIGNhbGNBdFRpbWUsIGNvbnZlcnNpb25PZmZlcmVkQXQsIGRpc2FibGVBY2NlbGVyYXRlZFZlc3RpbmcpOw0KICAgICAgfQ0KICAgIC8vIGNhbGwgYmVmb3JlIG9wdGlvbnMgY29udmVyc2lvbiBjb250cmFjdCB0byBwcmV2ZW50IHJlLWVudHJ5DQogICAgZW1wbG95ZWVzLmNoYW5nZVN0YXRlKGVtcGxveWVlLCBFbXBsb3llZVN0YXRlLk9wdGlvbnNFeGVyY2lzZWQpOw0KICAgIC8vIGV4ZXJjaXNlIG9wdGlvbnMgaW4gdGhlIG5hbWUgb2YgZW1wbG95ZWUgYW5kIGFzc2lnbiB0aG9zZSB0byBleGVyY2lzZUZvcg0KICAgIG9wdGlvbnNDb252ZXJ0ZXIuZXhlcmNpc2VPcHRpb25zKGV4ZXJjaXNlRm9yLCBwb29sLCBleHRyYSwgYm9udXMsICFkaXNhYmxlQWNjZWxlcmF0ZWRWZXN0aW5nKTsNCiAgICBFbXBsb3llZU9wdGlvbnNFeGVyY2lzZWQoZW1wbG95ZWUsIGV4ZXJjaXNlRm9yLCB1aW50MzIocG9vbCArIGV4dHJhICsgYm9udXMpLCAhZGlzYWJsZUFjY2VsZXJhdGVkVmVzdGluZyk7DQogICAgcmV0dXJuIFJldHVybkNvZGVzLk9LOw0KICB9DQoNCiAgZnVuY3Rpb24gZW1wbG95ZWVFeGVyY2lzZU9wdGlvbnMoYm9vbCBhZ3JlZVRvQWNjZWxlcmF0ZWRWZXN0aW5nQm9udXNDb25kaXRpb25zKQ0KICAgIGV4dGVybmFsDQogICAgb25seUVTT1BDb252ZXJzaW9uDQogICAgaGFzRW1wbG95ZWUobXNnLnNlbmRlcikNCiAgICBpc0N1cnJlbnRDb2RlDQogICAgcmV0dXJucyAoUmV0dXJuQ29kZXMpDQogIHsNCiAgICB1aW50MzIgY3QgPSBjdXJyZW50VGltZSgpOw0KICAgIGlmIChjdCA+IGV4ZXJjaXNlT3B0aW9uc0RlYWRsaW5lKSB7DQogICAgICByZXR1cm4gX2xvZ2Vycm9yKFJldHVybkNvZGVzLlRvb0xhdGUpOw0KICAgIH0NCiAgICByZXR1cm4gZXhlcmNpc2VPcHRpb25zSW50ZXJuYWwoY3QsIG1zZy5zZW5kZXIsIG1zZy5zZW5kZXIsICFhZ3JlZVRvQWNjZWxlcmF0ZWRWZXN0aW5nQm9udXNDb25kaXRpb25zKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGVtcGxveWVlRGVueUV4ZXJjaXNlT3B0aW9ucygpDQogICAgZXh0ZXJuYWwNCiAgICBvbmx5RVNPUENvbnZlcnNpb24NCiAgICBoYXNFbXBsb3llZShtc2cuc2VuZGVyKQ0KICAgIGlzQ3VycmVudENvZGUNCiAgICByZXR1cm5zIChSZXR1cm5Db2RlcykNCiAgew0KICAgIHVpbnQzMiBjdCA9IGN1cnJlbnRUaW1lKCk7DQogICAgaWYgKGN0ID4gZXhlcmNpc2VPcHRpb25zRGVhZGxpbmUpIHsNCiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuVG9vTGF0ZSk7DQogICAgfQ0KICAgIC8vIGJ1cm4gdGhlIG9wdGlvbnMgYnkgc2VuZGluZyB0byAwDQogICAgcmV0dXJuIGV4ZXJjaXNlT3B0aW9uc0ludGVybmFsKGN0LCBtc2cuc2VuZGVyLCBhZGRyZXNzKDApLCB0cnVlKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGV4ZXJjaXNlRXhwaXJlZEVtcGxveWVlT3B0aW9ucyhhZGRyZXNzIGUsIGJvb2wgZGlzYWJsZUFjY2VsZXJhdGVkVmVzdGluZykNCiAgICBleHRlcm5hbA0KICAgIG9ubHlFU09QQ29udmVyc2lvbg0KICAgIG9ubHlDb21wYW55DQogICAgaGFzRW1wbG95ZWUoZSkNCiAgICBpc0N1cnJlbnRDb2RlDQogIHJldHVybnMgKFJldHVybkNvZGVzKQ0KICB7DQogICAgLy8gY29tcGFueSBjYW4gY29udmVydCBvcHRpb25zIGZvciBhbnkgZW1wbG95ZWUgdGhhdCBkaWQgbm90IGNvbnZlcnRlZCAoYWZ0ZXIgZGVhZGxpbmUpDQogICAgdWludDMyIGN0ID0gY3VycmVudFRpbWUoKTsNCiAgICBpZiAoY3QgPD0gZXhlcmNpc2VPcHRpb25zRGVhZGxpbmUpIHsNCiAgICAgIHJldHVybiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMuVG9vRWFybHkpOw0KICAgIH0NCiAgICByZXR1cm4gZXhlcmNpc2VPcHRpb25zSW50ZXJuYWwoY3QsIGUsIGNvbXBhbnlBZGRyZXNzLCBkaXNhYmxlQWNjZWxlcmF0ZWRWZXN0aW5nKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGFsbG93RW1wbG95ZWVNaWdyYXRpb24oYWRkcmVzcyBlbXBsb3llZSwgRVNPUE1pZ3JhdGlvbiBtaWdyYXRpb24pDQogICAgZXh0ZXJuYWwNCiAgICBvbmx5RVNPUE9wZW4NCiAgICBoYXNFbXBsb3llZShlbXBsb3llZSkNCiAgICBvbmx5Q29tcGFueQ0KICAgIGlzQ3VycmVudENvZGUNCiAgICByZXR1cm5zIChSZXR1cm5Db2RlcykNCiAgew0KICAgIGlmIChhZGRyZXNzKG1pZ3JhdGlvbikgPT0gMCkNCiAgICAgIHRocm93Ow0KICAgIC8vIG9ubHkgZW1wbG95ZWQgYW5kIHRlcm1pbmF0ZWQgdXNlcnMgbWF5IG1pZ3JhdGUNCiAgICBFbXBsb3llZSBtZW1vcnkgZW1wID0gX2xvYWRlbXAoZW1wbG95ZWUpOw0KICAgIGlmIChlbXAuc3RhdGUgIT0gRW1wbG95ZWVTdGF0ZS5FbXBsb3llZCAmJiBlbXAuc3RhdGUgIT0gRW1wbG95ZWVTdGF0ZS5UZXJtaW5hdGVkKSB7DQogICAgICByZXR1cm4gX2xvZ2Vycm9yKFJldHVybkNvZGVzLkludmFsaWRFbXBsb3llZVN0YXRlKTsNCiAgICB9DQogICAgbWlncmF0aW9uc1tlbXBsb3llZV0gPSBtaWdyYXRpb247IC8vIGNhbiBiZSBjbGVhcmVkIHdpdGggMCBhZGRyZXNzDQogICAgcmV0dXJuIFJldHVybkNvZGVzLk9LOw0KICB9DQoNCiAgZnVuY3Rpb24gZW1wbG95ZWVNaWdyYXRlc1RvTmV3RVNPUChFU09QTWlncmF0aW9uIG1pZ3JhdGlvbikNCiAgICBleHRlcm5hbA0KICAgIG9ubHlFU09QT3Blbg0KICAgIGhhc0VtcGxveWVlKG1zZy5zZW5kZXIpDQogICAgaXNDdXJyZW50Q29kZQ0KICAgIHJldHVybnMgKFJldHVybkNvZGVzKQ0KICB7DQogICAgLy8gZW1wbG95ZWUgbWF5IG1pZ3JhdGUgdG8gbmV3IEVTT1AgY29udHJhY3Qgd2l0aCBkaWZmZXJlbnQgcnVsZXMNCiAgICAvLyBpZiBtaWdyYXRpb24gbm90IHNldCB1cCBieSBjb21wYW55IHRoZW4gdGhyb3cNCiAgICBpZiAoYWRkcmVzcyhtaWdyYXRpb24pID09IDAgfHwgbWlncmF0aW9uc1ttc2cuc2VuZGVyXSAhPSBtaWdyYXRpb24pDQogICAgICB0aHJvdzsNCiAgICAvLyBmaXJzdCBnaXZlIGJhY2sgd2hhdCB5b3UgYWxyZWFkeSBvd24NCiAgICByZW1vdmVFbXBsb3llZXNXaXRoRXhwaXJlZFNpZ25hdHVyZXNBbmRSZXR1cm5GYWRlb3V0KCk7DQogICAgLy8gb25seSBlbXBsb3llZCBhbmQgdGVybWluYXRlZCB1c2VycyBtYXkgbWlncmF0ZQ0KICAgIEVtcGxveWVlIG1lbW9yeSBlbXAgPSBfbG9hZGVtcChtc2cuc2VuZGVyKTsNCiAgICBpZiAoZW1wLnN0YXRlICE9IEVtcGxveWVlU3RhdGUuRW1wbG95ZWQgJiYgZW1wLnN0YXRlICE9IEVtcGxveWVlU3RhdGUuVGVybWluYXRlZCkgew0KICAgICAgcmV0dXJuIF9sb2dlcnJvcihSZXR1cm5Db2Rlcy5JbnZhbGlkRW1wbG95ZWVTdGF0ZSk7DQogICAgfQ0KICAgIC8vIHdpdGggYWNjZWxlcmF0ZWQgdmVzdGluZyBpZiBwb3NzaWJsZSAtIHRha2Ugb3V0IGFsbCBwb3NzaWJsZSBvcHRpb25zDQogICAgdmFyIChwb29sLCBleHRyYSwgXykgPSBvcHRpb25zQ2FsY3VsYXRvci5jYWxjdWxhdGVPcHRpb25zQ29tcG9uZW50cyhzZXJpYWxpemVFbXBsb3llZShlbXApLCBjdXJyZW50VGltZSgpLCAwLCBmYWxzZSk7DQogICAgZGVsZXRlIG1pZ3JhdGlvbnNbbXNnLnNlbmRlcl07DQogICAgLy8gZXhlY3V0ZSBtaWdyYXRpb24gcHJvY2VkdXJlDQogICAgbWlncmF0aW9uLm1pZ3JhdGUobXNnLnNlbmRlciwgcG9vbCwgZXh0cmEpOw0KICAgIC8vIGV4dHJhIG9wdGlvbnMgYXJlIG1vdmVkIHRvIG5ldyBjb250cmFjdA0KICAgIHRvdGFsRXh0cmFPcHRpb25zIC09IGVtcC5zdGF0ZSA9PSBFbXBsb3llZVN0YXRlLkVtcGxveWVkID8gZW1wLmV4dHJhT3B0aW9ucyA6IGV4dHJhOw0KICAgIC8vIHBvb2wgb3B0aW9ucyBhcmUgbW92ZWQgdG8gbmV3IGNvbnRyYWN0IGFuZCByZW1vdmVkIGZyb20gVGhlIFBvb2wNCiAgICAvLyBwbGVhc2Ugbm90ZSB0aGF0IHNlcGFyYXRlIFBvb2wgd2lsbCBtYW5hZ2UgbWlncmF0ZWQgb3B0aW9ucyBhbmQNCiAgICAvLyBhbGdvcml0aG0gdGhhdCByZXR1cm5zIHRvIHBvb2wgYW5kIGRpc3RyaWJ1dGVzIHdpbGwgbm90IGJlIHVzZWQNCiAgICB0b3RhbFBvb2xPcHRpb25zIC09IGVtcC5zdGF0ZSA9PSBFbXBsb3llZVN0YXRlLkVtcGxveWVkID8gZW1wLnBvb2xPcHRpb25zIDogcG9vbDsNCiAgICAvLyBnb25lIGZyb20gY3VycmVudCBjb250cmFjdA0KICAgIGVtcGxveWVlcy5yZW1vdmVFbXBsb3llZShtc2cuc2VuZGVyKTsNCiAgICBFbXBsb3llZU1pZ3JhdGVkKG1zZy5zZW5kZXIsIG1pZ3JhdGlvbiwgcG9vbCwgZXh0cmEpOw0KICAgIHJldHVybiBSZXR1cm5Db2Rlcy5PSzsNCiAgfQ0KDQogIGZ1bmN0aW9uIGNhbGNFZmZlY3RpdmVPcHRpb25zRm9yRW1wbG95ZWUoYWRkcmVzcyBlLCB1aW50MzIgY2FsY0F0VGltZSkNCiAgICBwdWJsaWMNCiAgICBjb25zdGFudA0KICAgIGhhc0VtcGxveWVlKGUpDQogICAgaXNDdXJyZW50Q29kZQ0KICAgIHJldHVybnMgKHVpbnQpDQogIHsNCiAgICByZXR1cm4gb3B0aW9uc0NhbGN1bGF0b3IuY2FsY3VsYXRlT3B0aW9ucyhlbXBsb3llZXMuZ2V0U2VyaWFsaXplZEVtcGxveWVlKGUpLCBjYWxjQXRUaW1lLCBjb252ZXJzaW9uT2ZmZXJlZEF0LCBmYWxzZSk7DQogIH0NCg0KICBmdW5jdGlvbiBfbG9nZXJyb3IoUmV0dXJuQ29kZXMgYykgcHJpdmF0ZSByZXR1cm5zIChSZXR1cm5Db2Rlcykgew0KICAgIFJldHVybkNvZGUoYyk7DQogICAgcmV0dXJuIGM7DQogIH0NCg0KICBmdW5jdGlvbiBfbG9hZGVtcChhZGRyZXNzIGUpIHByaXZhdGUgY29uc3RhbnQgcmV0dXJucyAoRW1wbG95ZWUgbWVtb3J5KSB7DQogICAgcmV0dXJuIGRlc2VyaWFsaXplRW1wbG95ZWUoZW1wbG95ZWVzLmdldFNlcmlhbGl6ZWRFbXBsb3llZShlKSk7DQogIH0NCg0KICBmdW5jdGlvbiBfc2F2ZWVtcChhZGRyZXNzIGUsIEVtcGxveWVlIG1lbW9yeSBlbXApIHByaXZhdGUgew0KICAgIGVtcGxveWVlcy5zZXRFbXBsb3llZShlLCBlbXAuaXNzdWVEYXRlLCBlbXAudGltZVRvU2lnbiwgZW1wLnRlcm1pbmF0ZWRBdCwgZW1wLmZhZGVvdXRTdGFydHMsIGVtcC5wb29sT3B0aW9ucywNCiAgICAgIGVtcC5leHRyYU9wdGlvbnMsIGVtcC5zdXNwZW5kZWRBdCwgZW1wLnN0YXRlKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGNvbXBsZXRlQ29kZVVwZGF0ZSgpIHB1YmxpYyBvbmx5T3duZXIgaW5Db2RlVXBkYXRlIHsNCiAgICBlbXBsb3llZXMudHJhbnNmZXJPd25lcnNoaXAobXNnLnNlbmRlcik7DQogICAgQ29kZVVwZGF0ZWFibGUuY29tcGxldGVDb2RlVXBkYXRlKCk7DQogIH0NCg0KICBmdW5jdGlvbigpDQogICAgICBwYXlhYmxlDQogIHsNCiAgICAgIHRocm93Ow0KICB9DQoNCiAgZnVuY3Rpb24gRVNPUChhZGRyZXNzIGNvbXBhbnksIGFkZHJlc3MgcFJvb3RPZlRydXN0LCBPcHRpb25zQ2FsY3VsYXRvciBwT3B0aW9uc0NhbGN1bGF0b3IsIEVtcGxveWVlc0xpc3QgcEVtcGxveWVlc0xpc3QpIHsNCiAgICAvL2Vzb3BTdGF0ZSA9IEVTT1BTdGF0ZS5OZXc7IC8vIHRoYXRzIGluaXRpYWwgdmFsdWUNCiAgICBjb21wYW55QWRkcmVzcyA9IGNvbXBhbnk7DQogICAgcm9vdE9mVHJ1c3QgPSBwUm9vdE9mVHJ1c3Q7DQogICAgZW1wbG95ZWVzID0gcEVtcGxveWVlc0xpc3Q7DQogICAgb3B0aW9uc0NhbGN1bGF0b3IgPSBwT3B0aW9uc0NhbGN1bGF0b3I7DQogIH0NCn0NCg0KDQpjb250cmFjdCBNaWdyYXRpb25zIGlzIERlc3RydWN0YWJsZSB7DQogIGFkZHJlc3MgcHVibGljIG93bmVyOw0KICB1aW50IHB1YmxpYyBsYXN0X2NvbXBsZXRlZF9taWdyYXRpb247DQoNCiAgbW9kaWZpZXIgcmVzdHJpY3RlZCgpIHsNCiAgICBpZiAobXNnLnNlbmRlciA9PSBvd25lcikgXzsNCiAgfQ0KDQogIGZ1bmN0aW9uIE1pZ3JhdGlvbnMoKSB7DQogICAgb3duZXIgPSBtc2cuc2VuZGVyOw0KICB9DQoNCiAgZnVuY3Rpb24gc2V0Q29tcGxldGVkKHVpbnQgY29tcGxldGVkKSByZXN0cmljdGVkIHsNCiAgICBsYXN0X2NvbXBsZXRlZF9taWdyYXRpb24gPSBjb21wbGV0ZWQ7DQogIH0NCg0KICBmdW5jdGlvbiB1cGdyYWRlKGFkZHJlc3MgbmV3X2FkZHJlc3MpIHJlc3RyaWN0ZWQgew0KICAgIE1pZ3JhdGlvbnMgdXBncmFkZWQgPSBNaWdyYXRpb25zKG5ld19hZGRyZXNzKTsNCiAgICB1cGdyYWRlZC5zZXRDb21wbGV0ZWQobGFzdF9jb21wbGV0ZWRfbWlncmF0aW9uKTsNCiAgfQ0KfQ0KDQpjb250cmFjdCBPcHRpb25zQ2FsY3VsYXRvciBpcyBPd25hYmxlLCBEZXN0cnVjdGFibGUsIE1hdGgsIEVTT1BUeXBlcyB7DQogIC8vIGNsaWZmIGR1cmF0aW9uIGluIHNlY29uZHMNCiAgdWludCBwdWJsaWMgY2xpZmZQZXJpb2Q7DQogIC8vIHZlc3RpbmcgZHVyYXRpb24gaW4gc2Vjb25kcw0KICB1aW50IHB1YmxpYyB2ZXN0aW5nUGVyaW9kOw0KICAvLyBtYXhpbXVtIHByb21pbGxlIHRoYXQgY2FuIGZhZGUgb3V0DQogIHVpbnQgcHVibGljIG1heEZhZGVvdXRQcm9taWxsZTsNCiAgLy8gbWluaW1hbCBvcHRpb25zIGFmdGVyIGZhZGVvdXQNCiAgZnVuY3Rpb24gcmVzaWR1YWxBbW91bnRQcm9taWxsZSgpIHB1YmxpYyBjb25zdGFudCByZXR1cm5zKHVpbnQpIHsgcmV0dXJuIEZQX1NDQUxFIC0gbWF4RmFkZW91dFByb21pbGxlOyB9DQogIC8vIGV4aXQgYm9udXMgcHJvbWlsbGUNCiAgdWludCBwdWJsaWMgYm9udXNPcHRpb25zUHJvbWlsbGU7DQogIC8vIHBlciBtaWxsZSBvZiB1bmFzc2lnbmVkIHBvb2xPcHRpb25zIHRoYXQgbmV3IGVtcGxveWVlIGdldHMNCiAgdWludCBwdWJsaWMgbmV3RW1wbG95ZWVQb29sUHJvbWlsbGU7DQogIC8vIG9wdGlvbnMgcGVyIHNoYXJlDQogIHVpbnQgcHVibGljIG9wdGlvbnNQZXJTaGFyZTsNCiAgLy8gb3B0aW9ucyBzdHJpa2UgcHJpY2UNCiAgdWludCBjb25zdGFudCBwdWJsaWMgU1RSSUtFX1BSSUNFID0gMTsNCiAgLy8gY29tcGFueSBhZGRyZXNzDQogIGFkZHJlc3MgcHVibGljIGNvbXBhbnlBZGRyZXNzOw0KICAvLyBjaGVja3MgaWYgY2FsY3VsYXRvciBpIGluaXRpYWxpemVkDQogIGZ1bmN0aW9uIGhhc1BhcmFtZXRlcnMoKSBwdWJsaWMgY29uc3RhbnQgcmV0dXJucyhib29sKSB7IHJldHVybiBvcHRpb25zUGVyU2hhcmUgPiAwOyB9DQoNCiAgbW9kaWZpZXIgb25seUNvbXBhbnkoKSB7DQogICAgaWYgKGNvbXBhbnlBZGRyZXNzICE9IG1zZy5zZW5kZXIpDQogICAgICB0aHJvdzsNCiAgICBfOw0KICB9DQoNCiAgZnVuY3Rpb24gY2FsY05ld0VtcGxveWVlUG9vbE9wdGlvbnModWludCByZW1haW5pbmdQb29sT3B0aW9ucykNCiAgICBwdWJsaWMNCiAgICBjb25zdGFudA0KICAgIHJldHVybnMgKHVpbnQpDQogIHsNCiAgICByZXR1cm4gZGl2Um91bmQocmVtYWluaW5nUG9vbE9wdGlvbnMgKiBuZXdFbXBsb3llZVBvb2xQcm9taWxsZSwgRlBfU0NBTEUpOw0KICB9DQoNCiAgZnVuY3Rpb24gY2FsY3VsYXRlVmVzdGVkT3B0aW9ucyh1aW50IHQsIHVpbnQgdmVzdGluZ1N0YXJ0cywgdWludCBvcHRpb25zKQ0KICAgIHB1YmxpYw0KICAgIGNvbnN0YW50DQogICAgcmV0dXJucyAodWludCkNCiAgew0KICAgIGlmICh0IDw9IHZlc3RpbmdTdGFydHMpDQogICAgICByZXR1cm4gMDsNCiAgICAvLyBhcHBseSB2ZXN0aW5nDQogICAgdWludCBlZmZlY3RpdmVUaW1lID0gdCAtIHZlc3RpbmdTdGFydHM7DQogICAgLy8gaWYgd2l0aGluIGNsaWZmIG5vdGhpbmcgaXMgZHVlDQogICAgaWYgKGVmZmVjdGl2ZVRpbWUgPCBjbGlmZlBlcmlvZCkNCiAgICAgIHJldHVybiAwOw0KICAgIGVsc2UNCiAgICAgIHJldHVybiAgZWZmZWN0aXZlVGltZSA8IHZlc3RpbmdQZXJpb2QgPyBkaXZSb3VuZChvcHRpb25zICogZWZmZWN0aXZlVGltZSwgdmVzdGluZ1BlcmlvZCkgOiBvcHRpb25zOw0KICB9DQoNCiAgZnVuY3Rpb24gYXBwbHlGYWRlb3V0VG9PcHRpb25zKHVpbnQzMiB0LCB1aW50MzIgaXNzdWVEYXRlLCB1aW50MzIgdGVybWluYXRlZEF0LCB1aW50IG9wdGlvbnMsIHVpbnQgdmVzdGVkT3B0aW9ucykNCiAgICBwdWJsaWMNCiAgICBjb25zdGFudA0KICAgIHJldHVybnMgKHVpbnQpDQogIHsNCiAgICBpZiAodCA8IHRlcm1pbmF0ZWRBdCkNCiAgICAgIHJldHVybiB2ZXN0ZWRPcHRpb25zOw0KICAgIHVpbnQgdGltZWZyb21UZXJtaW5hdGlvbiA9IHQgLSB0ZXJtaW5hdGVkQXQ7DQogICAgLy8gZmFkZW91dCBkdXJhdGlvbiBlcXVhbHMgdG8gZW1wbG95bWVudCBkdXJhdGlvbg0KICAgIHVpbnQgZW1wbG95bWVudFBlcmlvZCA9IHRlcm1pbmF0ZWRBdCAtIGlzc3VlRGF0ZTsNCiAgICAvLyBtaW5pbXVtIHZhbHVlIG9mIG9wdGlvbnMgYXQgdGhlIGVuZCBvZiBmYWRlb3V0LCBpdCBpcyBhICUgb2YgYWxsIGVtcGxveWVlJ3Mgb3B0aW9ucw0KICAgIHVpbnQgbWluRmFkZVZhbHVlID0gZGl2Um91bmQob3B0aW9ucyAqIChGUF9TQ0FMRSAtIG1heEZhZGVvdXRQcm9taWxsZSksIEZQX1NDQUxFKTsNCiAgICAvLyBob3dldmVyIGVtcGxveWVlIGNhbm5vdCBoYXZlIG1vcmUgdGhhbiBvcHRpb25zIGFmdGVyIGZhZGVvdXQgdGhhbiBoZSB3YXMgdmVzdGVkIGF0IHRlcm1pbmF0aW9uDQogICAgaWYgKG1pbkZhZGVWYWx1ZSA+PSB2ZXN0ZWRPcHRpb25zKQ0KICAgICAgcmV0dXJuIHZlc3RlZE9wdGlvbnM7DQogICAgcmV0dXJuIHRpbWVmcm9tVGVybWluYXRpb24gPiBlbXBsb3ltZW50UGVyaW9kID8NCiAgICAgIG1pbkZhZGVWYWx1ZSAgOg0KICAgICAgKG1pbkZhZGVWYWx1ZSArIGRpdlJvdW5kKCh2ZXN0ZWRPcHRpb25zIC0gbWluRmFkZVZhbHVlKSAqIChlbXBsb3ltZW50UGVyaW9kIC0gdGltZWZyb21UZXJtaW5hdGlvbiksIGVtcGxveW1lbnRQZXJpb2QpKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIGNhbGN1bGF0ZU9wdGlvbnNDb21wb25lbnRzKHVpbnRbOV0gZW1wbG95ZWUsIHVpbnQzMiBjYWxjQXRUaW1lLCB1aW50MzIgY29udmVyc2lvbk9mZmVyZWRBdCwNCiAgICBib29sIGRpc2FibGVBY2NlbGVyYXRlZFZlc3RpbmcpDQogICAgcHVibGljDQogICAgY29uc3RhbnQNCiAgICByZXR1cm5zICh1aW50LCB1aW50LCB1aW50KQ0KICB7DQogICAgLy8gcmV0dXJucyB0dXBsZSBvZiAodmVzdGVkIHBvb2wgb3B0aW9ucywgdmVzdGVkIGV4dHJhIG9wdGlvbnMsIGJvbnVzKQ0KICAgIEVtcGxveWVlIG1lbW9yeSBlbXAgPSBkZXNlcmlhbGl6ZUVtcGxveWVlKGVtcGxveWVlKTsNCiAgICAvLyBubyBvcHRpb25zIGZvciBjb252ZXJ0ZWQgb3B0aW9ucyBvciB3aGVuIGVzb3AgaXMgbm90IHNpbmdlZA0KICAgIGlmIChlbXAuc3RhdGUgPT0gRW1wbG95ZWVTdGF0ZS5PcHRpb25zRXhlcmNpc2VkIHx8IGVtcC5zdGF0ZSA9PSBFbXBsb3llZVN0YXRlLldhaXRpbmdGb3JTaWduYXR1cmUpDQogICAgICByZXR1cm4gKDAsMCwwKTsNCiAgICAvLyBubyBvcHRpb25zIHdoZW4gZXNvcCBpcyBiZWluZyBjb252ZXJ0ZWQgYW5kIGNvbnZlcnNpb24gZGVhZGxpbmUgZXhwaXJlZA0KICAgIGJvb2wgaXNFU09QQ29udmVydGVkID0gY29udmVyc2lvbk9mZmVyZWRBdCA+IDAgJiYgY2FsY0F0VGltZSA+PSBjb252ZXJzaW9uT2ZmZXJlZEF0OyAvLyB0aGlzIGZ1bmN0aW9uIHRpbWUtdHJhdmVscw0KICAgIHVpbnQgaXNzdWVkT3B0aW9ucyA9IGVtcC5wb29sT3B0aW9ucyArIGVtcC5leHRyYU9wdGlvbnM7DQogICAgLy8gZW1wbG95ZWUgd2l0aCBubyBvcHRpb25zDQogICAgaWYgKGlzc3VlZE9wdGlvbnMgPT0gMCkNCiAgICAgIHJldHVybiAoMCwwLDApOw0KICAgIC8vIGlmIGVtcCBpcyB0ZXJtaW5hdGVkIGJ1dCB3ZSBjYWxjIG9wdGlvbnMgYmVmb3JlIHRlcm0sIHNpbXVsYXRlIGVtcGxveWVkIGFnYWluDQogICAgaWYgKGNhbGNBdFRpbWUgPCBlbXAudGVybWluYXRlZEF0ICYmIGVtcC50ZXJtaW5hdGVkQXQgPiAwKQ0KICAgICAgZW1wLnN0YXRlID0gRW1wbG95ZWVTdGF0ZS5FbXBsb3llZDsNCiAgICB1aW50IHZlc3RlZE9wdGlvbnMgPSBpc3N1ZWRPcHRpb25zOw0KICAgIGJvb2wgYWNjZWxlcmF0ZVZlc3RpbmcgPSBpc0VTT1BDb252ZXJ0ZWQgJiYgZW1wLnN0YXRlID09IEVtcGxveWVlU3RhdGUuRW1wbG95ZWQgJiYgIWRpc2FibGVBY2NlbGVyYXRlZFZlc3Rpbmc7DQogICAgaWYgKCFhY2NlbGVyYXRlVmVzdGluZykgew0KICAgICAgLy8gY2hvb3NlIHZlc3RpbmcgdGltZQ0KICAgICAgdWludDMyIGNhbGNWZXN0aW5nQXQgPSBlbXAuc3RhdGUgPT0NCiAgICAgICAgLy8gaWYgdGVybWluYXRlZCB0aGVuIHZlc3RpbmcgY2FsY3VsYXRlZCBhdCB0ZXJtaW5hdGlvbg0KICAgICAgICBFbXBsb3llZVN0YXRlLlRlcm1pbmF0ZWQgPyBlbXAudGVybWluYXRlZEF0IDoNCiAgICAgICAgLy8gaWYgZW1wbG95ZWUgaXMgc3VwZW5kZWQgdGhlbiBjb21wdXRlIHZlc3RpbmcgYXQgc3VzcGVuc2lvbiB0aW1lDQogICAgICAgIChlbXAuc3VzcGVuZGVkQXQgPiAwICYmIGVtcC5zdXNwZW5kZWRBdCA8IGNhbGNBdFRpbWUgPyBlbXAuc3VzcGVuZGVkQXQgOg0KICAgICAgICAvLyBpZiBjb252ZXJzaW9uIG9mZmVyIHRoZW4gdmVzdGluZyBjYWx1Y2F0ZWQgYXQgdGltZSB0aGUgb2ZmZXIgd2FzIG1hZGUNCiAgICAgICAgY29udmVyc2lvbk9mZmVyZWRBdCA+IDAgPyBjb252ZXJzaW9uT2ZmZXJlZEF0IDoNCiAgICAgICAgLy8gb3RoZXJ3aXNlIHVzZSBjdXJyZW50IHRpbWUNCiAgICAgICAgY2FsY0F0VGltZSk7DQogICAgICB2ZXN0ZWRPcHRpb25zID0gY2FsY3VsYXRlVmVzdGVkT3B0aW9ucyhjYWxjVmVzdGluZ0F0LCBlbXAuaXNzdWVEYXRlLCBpc3N1ZWRPcHRpb25zKTsNCiAgICB9DQogICAgLy8gY2FsYyBmYWRlb3V0IGZvciB0ZXJtaW5hdGVkIGVtcGxveWVlcw0KICAgIGlmIChlbXAuc3RhdGUgPT0gRW1wbG95ZWVTdGF0ZS5UZXJtaW5hdGVkKSB7DQogICAgICAvLyB1c2UgY29udmVyc2lvbiBldmVudCB0aW1lIHRvIGNvbXB1dGUgZmFkZW91dCB0byBzdG9wIGZhZGVvdXQgb24gY29udmVyc2lvbiBJRiBub3QgYWZ0ZXIgY29udmVyc2lvbiBkYXRlDQogICAgICB2ZXN0ZWRPcHRpb25zID0gYXBwbHlGYWRlb3V0VG9PcHRpb25zKGlzRVNPUENvbnZlcnRlZCA/IGNvbnZlcnNpb25PZmZlcmVkQXQgOiBjYWxjQXRUaW1lLA0KICAgICAgICBlbXAuaXNzdWVEYXRlLCBlbXAudGVybWluYXRlZEF0LCBpc3N1ZWRPcHRpb25zLCB2ZXN0ZWRPcHRpb25zKTsNCiAgICB9DQogICAgdmFyICh2ZXN0ZWRQb29sT3B0aW9ucywgdmVzdGVkRXh0cmFPcHRpb25zKSA9IGV4dHJhY3RWZXN0ZWRPcHRpb25zQ29tcG9uZW50cyhlbXAucG9vbE9wdGlvbnMsIGVtcC5leHRyYU9wdGlvbnMsIHZlc3RlZE9wdGlvbnMpOw0KICAgIC8vIGlmICh2ZXN0ZWRQb29sT3B0aW9ucyArIHZlc3RlZEV4dHJhT3B0aW9ucyAhPSB2ZXN0ZWRPcHRpb25zKSB0aHJvdzsNCiAgICByZXR1cm4gICh2ZXN0ZWRQb29sT3B0aW9ucywgdmVzdGVkRXh0cmFPcHRpb25zLA0KICAgICAgYWNjZWxlcmF0ZVZlc3RpbmcgPyBkaXZSb3VuZCh2ZXN0ZWRQb29sT3B0aW9ucypib251c09wdGlvbnNQcm9taWxsZSwgRlBfU0NBTEUpIDogMCApOw0KICB9DQoNCiAgZnVuY3Rpb24gY2FsY3VsYXRlT3B0aW9ucyh1aW50WzldIGVtcGxveWVlLCB1aW50MzIgY2FsY0F0VGltZSwgdWludDMyIGNvbnZlcnNpb25PZmZlcmVkQXQsIGJvb2wgZGlzYWJsZUFjY2VsZXJhdGVkVmVzdGluZykNCiAgICBwdWJsaWMNCiAgICBjb25zdGFudA0KICAgIHJldHVybnMgKHVpbnQpDQogIHsNCiAgICB2YXIgKHZlc3RlZFBvb2xPcHRpb25zLCB2ZXN0ZWRFeHRyYU9wdGlvbnMsIGJvbnVzKSA9IGNhbGN1bGF0ZU9wdGlvbnNDb21wb25lbnRzKGVtcGxveWVlLCBjYWxjQXRUaW1lLA0KICAgICAgY29udmVyc2lvbk9mZmVyZWRBdCwgZGlzYWJsZUFjY2VsZXJhdGVkVmVzdGluZyk7DQogICAgcmV0dXJuIHZlc3RlZFBvb2xPcHRpb25zICsgdmVzdGVkRXh0cmFPcHRpb25zICsgYm9udXM7DQogIH0NCg0KICBmdW5jdGlvbiBleHRyYWN0VmVzdGVkT3B0aW9uc0NvbXBvbmVudHModWludCBpc3N1ZWRQb29sT3B0aW9ucywgdWludCBpc3N1ZWRFeHRyYU9wdGlvbnMsIHVpbnQgdmVzdGVkT3B0aW9ucykNCiAgICBwdWJsaWMNCiAgICBjb25zdGFudA0KICAgIHJldHVybnMgKHVpbnQsIHVpbnQpDQogIHsNCiAgICAvLyBicmVha3MgZG93biB2ZXN0ZWQgb3B0aW9ucyBpbnRvIHBvb2wgb3B0aW9ucyBhbmQgZXh0cmEgb3B0aW9ucyBjb21wb25lbnRzDQogICAgaWYgKGlzc3VlZEV4dHJhT3B0aW9ucyA9PSAwKQ0KICAgICAgcmV0dXJuICh2ZXN0ZWRPcHRpb25zLCAwKTsNCiAgICB1aW50IHBvb2xPcHRpb25zID0gZGl2Um91bmQoaXNzdWVkUG9vbE9wdGlvbnMqdmVzdGVkT3B0aW9ucywgaXNzdWVkUG9vbE9wdGlvbnMgKyBpc3N1ZWRFeHRyYU9wdGlvbnMpOw0KICAgIHJldHVybiAocG9vbE9wdGlvbnMsIHZlc3RlZE9wdGlvbnMgLSBwb29sT3B0aW9ucyk7DQogIH0NCg0KICBmdW5jdGlvbiBjYWxjdWxhdGVGYWRlb3V0VG9Qb29sKHVpbnQzMiB0LCB1aW50WzldIGVtcGxveWVlKQ0KICAgIHB1YmxpYw0KICAgIGNvbnN0YW50DQogICAgcmV0dXJucyAodWludCwgdWludCkNCiAgew0KICAgIEVtcGxveWVlIG1lbW9yeSBlbXAgPSBkZXNlcmlhbGl6ZUVtcGxveWVlKGVtcGxveWVlKTsNCg0KICAgIHVpbnQgdmVzdGVkT3B0aW9ucyA9IGNhbGN1bGF0ZVZlc3RlZE9wdGlvbnMoZW1wLnRlcm1pbmF0ZWRBdCwgZW1wLmlzc3VlRGF0ZSwgZW1wLnBvb2xPcHRpb25zKTsNCiAgICB1aW50IHJldHVybmVkUG9vbE9wdGlvbnMgPSBhcHBseUZhZGVvdXRUb09wdGlvbnMoZW1wLmZhZGVvdXRTdGFydHMsIGVtcC5pc3N1ZURhdGUsIGVtcC50ZXJtaW5hdGVkQXQsIGVtcC5wb29sT3B0aW9ucywgdmVzdGVkT3B0aW9ucykgLQ0KICAgICAgYXBwbHlGYWRlb3V0VG9PcHRpb25zKHQsIGVtcC5pc3N1ZURhdGUsIGVtcC50ZXJtaW5hdGVkQXQsIGVtcC5wb29sT3B0aW9ucywgdmVzdGVkT3B0aW9ucyk7DQogICAgdWludCB2ZXN0ZWRFeHRyYU9wdGlvbnMgPSBjYWxjdWxhdGVWZXN0ZWRPcHRpb25zKGVtcC50ZXJtaW5hdGVkQXQsIGVtcC5pc3N1ZURhdGUsIGVtcC5leHRyYU9wdGlvbnMpOw0KICAgIHVpbnQgcmV0dXJuZWRFeHRyYU9wdGlvbnMgPSBhcHBseUZhZGVvdXRUb09wdGlvbnMoZW1wLmZhZGVvdXRTdGFydHMsIGVtcC5pc3N1ZURhdGUsIGVtcC50ZXJtaW5hdGVkQXQsIGVtcC5leHRyYU9wdGlvbnMsIHZlc3RlZEV4dHJhT3B0aW9ucykgLQ0KICAgICAgYXBwbHlGYWRlb3V0VG9PcHRpb25zKHQsIGVtcC5pc3N1ZURhdGUsIGVtcC50ZXJtaW5hdGVkQXQsIGVtcC5leHRyYU9wdGlvbnMsIHZlc3RlZEV4dHJhT3B0aW9ucyk7DQoNCiAgICByZXR1cm4gKHJldHVybmVkUG9vbE9wdGlvbnMsIHJldHVybmVkRXh0cmFPcHRpb25zKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHNpbXVsYXRlT3B0aW9ucyh1aW50MzIgaXNzdWVEYXRlLCB1aW50MzIgdGVybWluYXRlZEF0LCB1aW50MzIgcG9vbE9wdGlvbnMsDQogICAgdWludDMyIGV4dHJhT3B0aW9ucywgdWludDMyIHN1c3BlbmRlZEF0LCB1aW50OCBlbXBsb3llZVN0YXRlLCB1aW50MzIgY2FsY0F0VGltZSkNCiAgICBwdWJsaWMNCiAgICBjb25zdGFudA0KICAgIHJldHVybnMgKHVpbnQpDQogIHsNCiAgICBFbXBsb3llZSBtZW1vcnkgZW1wID0gRW1wbG95ZWUoe2lzc3VlRGF0ZTogaXNzdWVEYXRlLCB0ZXJtaW5hdGVkQXQ6IHRlcm1pbmF0ZWRBdCwNCiAgICAgIHBvb2xPcHRpb25zOiBwb29sT3B0aW9ucywgZXh0cmFPcHRpb25zOiBleHRyYU9wdGlvbnMsIHN0YXRlOiBFbXBsb3llZVN0YXRlKGVtcGxveWVlU3RhdGUpLA0KICAgICAgdGltZVRvU2lnbjogaXNzdWVEYXRlKzIgd2Vla3MsIGZhZGVvdXRTdGFydHM6IHRlcm1pbmF0ZWRBdCwgc3VzcGVuZGVkQXQ6IHN1c3BlbmRlZEF0LA0KICAgICAgaWR4OjF9KTsNCiAgICByZXR1cm4gY2FsY3VsYXRlT3B0aW9ucyhzZXJpYWxpemVFbXBsb3llZShlbXApLCBjYWxjQXRUaW1lLCAwLCBmYWxzZSk7DQogIH0NCg0KICBmdW5jdGlvbiBzZXRQYXJhbWV0ZXJzKHVpbnQzMiBwQ2xpZmZQZXJpb2QsIHVpbnQzMiBwVmVzdGluZ1BlcmlvZCwgdWludDMyIHBSZXNpZHVhbEFtb3VudFByb21pbGxlLA0KICAgIHVpbnQzMiBwQm9udXNPcHRpb25zUHJvbWlsbGUsIHVpbnQzMiBwTmV3RW1wbG95ZWVQb29sUHJvbWlsbGUsIHVpbnQzMiBwT3B0aW9uc1BlclNoYXJlKQ0KICAgIGV4dGVybmFsDQogICAgb25seUNvbXBhbnkNCiAgew0KICAgIGlmIChwUmVzaWR1YWxBbW91bnRQcm9taWxsZSA+IEZQX1NDQUxFIHx8IHBCb251c09wdGlvbnNQcm9taWxsZSA+IEZQX1NDQUxFIHx8IHBOZXdFbXBsb3llZVBvb2xQcm9taWxsZSA+IEZQX1NDQUxFDQogICAgIHx8IHBPcHRpb25zUGVyU2hhcmUgPT0gMCkNCiAgICAgIHRocm93Ow0KICAgIGlmIChwQ2xpZmZQZXJpb2QgPiBwVmVzdGluZ1BlcmlvZCkNCiAgICAgIHRocm93Ow0KICAgIC8vIGluaXRpYWxpemF0aW9uIGNhbm5vdCBiZSBjYWxsZWQgZm9yIGEgc2Vjb25kIHRpbWUNCiAgICBpZiAoaGFzUGFyYW1ldGVycygpKQ0KICAgICAgdGhyb3c7DQogICAgY2xpZmZQZXJpb2QgPSBwQ2xpZmZQZXJpb2Q7DQogICAgdmVzdGluZ1BlcmlvZCA9IHBWZXN0aW5nUGVyaW9kOw0KICAgIG1heEZhZGVvdXRQcm9taWxsZSA9IEZQX1NDQUxFIC0gcFJlc2lkdWFsQW1vdW50UHJvbWlsbGU7DQogICAgYm9udXNPcHRpb25zUHJvbWlsbGUgPSBwQm9udXNPcHRpb25zUHJvbWlsbGU7DQogICAgbmV3RW1wbG95ZWVQb29sUHJvbWlsbGUgPSBwTmV3RW1wbG95ZWVQb29sUHJvbWlsbGU7DQogICAgb3B0aW9uc1BlclNoYXJlID0gcE9wdGlvbnNQZXJTaGFyZTsNCiAgfQ0KDQogIGZ1bmN0aW9uIE9wdGlvbnNDYWxjdWxhdG9yKGFkZHJlc3MgcENvbXBhbnlBZGRyZXNzKSB7DQogICAgY29tcGFueUFkZHJlc3MgPSBwQ29tcGFueUFkZHJlc3M7DQogIH0NCn0NCg0KY29udHJhY3QgUHJvY2VlZHNPcHRpb25zQ29udmVydGVyIGlzIE93bmFibGUsIEVSQzIwT3B0aW9uc0NvbnZlcnRlciB7DQogIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludCkgaW50ZXJuYWwgd2l0aGRyYXdhbHM7DQogIHVpbnRbXSBpbnRlcm5hbCBwYXlvdXRzOw0KDQogIGZ1bmN0aW9uIG1ha2VQYXlvdXQoKSBjb252ZXJ0ZWQgcGF5YWJsZSBvbmx5T3duZXIgcHVibGljIHsNCiAgICAvLyBpdCBkb2VzIG5vdCBtYWtlIHNlbnNlIHRvIGRpc3RyaWJ1dGUgbGVzcyB0aGFuIGV0aGVyDQogICAgaWYgKG1zZy52YWx1ZSA8IDEgZXRoZXIpDQogICAgICB0aHJvdzsNCiAgICBwYXlvdXRzLnB1c2gobXNnLnZhbHVlKTsNCiAgfQ0KDQogIGZ1bmN0aW9uIHdpdGhkcmF3KCkgY29udmVydGVkIHB1YmxpYyByZXR1cm5zICh1aW50KSB7DQogICAgLy8gd2l0aGRyYXcgZm9yIG1zZy5zZW5kZXINCiAgICB1aW50IGJhbGFuY2UgPSBiYWxhbmNlT2YobXNnLnNlbmRlcik7DQogICAgaWYgKGJhbGFuY2UgPT0gMCkNCiAgICAgIHJldHVybiAwOw0KICAgIHVpbnQgcGF5bWVudElkID0gd2l0aGRyYXdhbHNbbXNnLnNlbmRlcl07DQogICAgLy8gaWYgYWxsIHBheW91dHMgZm9yIGdpdmVuIHRva2VuIGhvbGRlciBleGVjdXRlZCB0aGVuIGV4aXQNCiAgICBpZiAocGF5bWVudElkID09IHBheW91dHMubGVuZ3RoKQ0KICAgICAgcmV0dXJuIDA7DQogICAgdWludCBwYXlvdXQgPSAwOw0KICAgIGZvciAodWludCBpID0gcGF5bWVudElkOyBpPHBheW91dHMubGVuZ3RoOyBpKyspIHsNCiAgICAgIC8vIGl0IGlzIHNhZmUgdG8gbWFrZSBwYXlvdXRzIHByby1yYXRhOiAoMSkgdG9rZW4gc3VwcGx5IHdpbGwgbm90IGNoYW5nZSAtIGNoZWNrIGNvbnZlcnRlZC9jb252ZXJzaW9uIG1vZGlmaWVycw0KICAgICAgLy8gLS0gKDIpIGJhbGFuY2VzIHdpbGwgbm90IGNoYW5nZTogY2hlY2sgdHJhbnNmZXIgb3ZlcnJpZGUgd2hpY2ggbGltaXRzIHRyYW5zZmVyIGJldHdlZW4gYWNjb3VudHMNCiAgICAgIC8vIE5PVEU6IHNhZmVNdWwgdGhyb3dzIG9uIG92ZXJmbG93LCBjYW4gbG9jayB1c2VycyBvdXQgb2YgdGhlaXIgd2l0aGRyYXdhbHMgaWYgYmFsYW5jZSBpcyB2ZXJ5IGhpZ2gNCiAgICAgIC8vIEByZW1jbyBJIGtub3cuIGFueSBzdWdnZXN0aW9ucz8gZXhwcmVzc2lvbiBiZWxvdyBnaXZlcyBtb3N0IHByZWNpc2lvbg0KICAgICAgdWludCB0aGlzUGF5b3V0ID0gZGl2Um91bmQoc2FmZU11bChwYXlvdXRzW2ldLCBiYWxhbmNlKSwgdG90YWxTdXBwbHkpOw0KICAgICAgcGF5b3V0ICs9IHRoaXNQYXlvdXQ7DQogICAgfQ0KICAgIC8vIGNoYW5nZSBub3cgdG8gcHJldmVudCByZS1lbnRyeSAobm90IG5lY2Vzc2FyeSBkdWUgdG8gbG93IHNlbmQoKSBnYXMgbGltaXQpDQogICAgd2l0aGRyYXdhbHNbbXNnLnNlbmRlcl0gPSBwYXlvdXRzLmxlbmd0aDsNCiAgICBpZiAocGF5b3V0ID4gMCkgew0KICAgICAgLy8gbm93IG1vZGlmeSBwYXlvdXQgd2l0aGluIDEwMDAgd2VpcyBhcyB3ZSBoYWQgcm91bmRpbmcgZXJyb3JzIGNvbWluZyBmcm9tIHByby1yYXRhIGFtb3VudHMNCiAgICAgIC8vIEByZW1jbyBtYXhpbXVtIHJvdW5kaW5nIGVycm9yIGlzIChudW1fZW1wbG95ZWVzICogbnVtX3BheW1lbnRzKSAvIDIgd2l0aCB0aGUgbWVhbiAwDQogICAgICAvLyAtLS0gMTAwMCB3ZWkgaXMgc3RpbGwgbm90aGluZywgcGxlYXNlIGV4cGxhaW4gbWUgd2hhdCBwcm9ibGVtIHlvdSBzZWUgaGVyZQ0KICAgICAgaWYgKCBhYnNEaWZmKHRoaXMuYmFsYW5jZSwgcGF5b3V0KSA8IDEwMDAgd2VpICkNCiAgICAgICAgcGF5b3V0ID0gdGhpcy5iYWxhbmNlOyAvLyBzZW5kIGFsbA0KICAgICAgLy9pZighbXNnLnNlbmRlci5jYWxsLnZhbHVlKHBheW91dCkoKSkgLy8gcmUgZW50cnkgdGVzdA0KICAgICAgLy8gIHRocm93Ow0KICAgICAgaWYgKCFtc2cuc2VuZGVyLnNlbmQocGF5b3V0KSkNCiAgICAgICAgdGhyb3c7DQogICAgfQ0KICAgIHJldHVybiBwYXlvdXQ7DQogIH0NCg0KICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIF90bywgdWludCBfdmFsdWUpIHB1YmxpYyBjb252ZXJ0ZWQgew0KICAgIC8vIGlmIGFueXRoaW5nIHdhcyB3aXRoZHJhd24gdGhlbiBibG9jayB0cmFuc2ZlciB0byBwcmV2ZW50IG11bHRpcGxlIHdpdGhkcmF3YWxzDQogICAgLy8gdG9kbzogd2UgY291bGQgYWxsb3cgdHJhbnNmZXIgdG8gbmV3IGFjY291bnQgKG5vIHRva2VuIGJhbGFuY2UpDQogICAgLy8gdG9kbzogd2UgY291bGQgYWxsb3cgdHJhbnNmZXIgYmV0d2VlbiBhY2NvdW50IHRoYXQgZnVsbHkgd2l0aGRyYXduIChidXQgd2hhdCdzIHRoZSBwb2ludD8gLXRva2VuIGhhcyAwIHZhbHVlIHRoZW4pDQogICAgLy8gdG9kbzogdGhlcmUgYXJlIGEgZmV3IG90aGVyIGVkZ2UgY2FzZXMgd2hlcmUgdGhlcmUncyB0cmFuc2ZlciBhbmQgbm8gZG91YmxlIHNwZW5kaW5nDQogICAgaWYgKHdpdGhkcmF3YWxzW190b10gPiAwIHx8IHdpdGhkcmF3YWxzW21zZy5zZW5kZXJdID4gMCkNCiAgICAgIHRocm93Ow0KICAgIEVSQzIwT3B0aW9uc0NvbnZlcnRlci50cmFuc2ZlcihfdG8sIF92YWx1ZSk7DQogIH0NCg0KICBmdW5jdGlvbiBQcm9jZWVkc09wdGlvbnNDb252ZXJ0ZXIoYWRkcmVzcyBlc29wLCB1aW50MzIgZXhlcmNpc2VEZWFkbGluZSwgdWludDMyIGNvbnZlcnNpb25EZWFkbGluZSkNCiAgICBFUkMyME9wdGlvbnNDb252ZXJ0ZXIoZXNvcCwgZXhlcmNpc2VEZWFkbGluZSwgY29udmVyc2lvbkRlYWRsaW5lKQ0KICB7DQogIH0NCn0NCg0KY29udHJhY3QgUm9UIGlzIE93bmFibGUgew0KICAgIGFkZHJlc3MgcHVibGljIEVTT1BBZGRyZXNzOw0KICAgIGV2ZW50IEVTT1BBbmRDb21wYW55U2V0KGFkZHJlc3MgRVNPUEFkZHJlc3MsIGFkZHJlc3MgY29tcGFueUFkZHJlc3MpOw0KDQogICAgZnVuY3Rpb24gc2V0RVNPUChhZGRyZXNzIEVTT1AsIGFkZHJlc3MgY29tcGFueSkgcHVibGljIG9ubHlPd25lciB7DQogICAgICAvLyBvd25lciBzZXRzIEVTT1AgYW5kIGNvbXBhbnkgb25seSBvbmNlIHRoZW4gcGFzc2VzIG93bmVyc2hpcCB0byBjb21wYW55DQogICAgICAvLyBpbml0aWFsbHkgb3duZXIgaXMgYSBkZXZlbG9wZXIvYWRtaW4NCiAgICAgIEVTT1BBZGRyZXNzID0gRVNPUDsNCiAgICAgIHRyYW5zZmVyT3duZXJzaGlwKGNvbXBhbnkpOw0KICAgICAgRVNPUEFuZENvbXBhbnlTZXQoRVNPUCwgY29tcGFueSk7DQogICAgfQ0KDQogICAgZnVuY3Rpb24ga2lsbE9uVW5zdXBwb3J0ZWRGb3JrKCkgcHVibGljIG9ubHlPd25lciB7DQogICAgICAvLyB0aGlzIG1ldGhvZCBtYXkgb25seSBiZSBjYWxsZWQgYnkgY29tcGFueSBvbiB1bnN1cHBvcnRlZCBmb3Jrcw0KICAgICAgZGVsZXRlIEVTT1BBZGRyZXNzOw0KICAgICAgc2VsZmRlc3RydWN0KG93bmVyKTsNCiAgICB9DQp9'