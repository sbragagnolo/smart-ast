base 64 content
base64virtualExchange
	^'cHJhZ21hIHNvbGlkaXR5XjAuNC4wOw0KDQovKg0KICogVG9rZW4gLSBpcyBhIHNtYXJ0IGNvbnRyYWN0IGludGVyZmFjZSANCiAqIGZvciBtYW5hZ2luZyBjb21tb24gZnVuY3Rpb25hbGl0eSBvZiANCiAqIGEgdG9rZW4uDQogKg0KICogRVJDLjIwIFRva2VuIHN0YW5kYXJkOiBodHRwczovL2dpdGh1Yi5jb20vZXRoIGVyZXVtL0VJUHMvaXNzdWVzLzIwDQogKi8NCmNvbnRyYWN0IFRva2VuSW50ZXJmYWNlIHsNCg0KICAgICAgICANCiAgICAvLyB0b3RhbCBhbW91bnQgb2YgdG9rZW5zDQogICAgdWludCB0b3RhbFN1cHBseTsNCg0KICAgIA0KICAgIC8qKg0KICAgICAqDQogICAgICogYmFsYW5jZU9mKCkgLSBjb25zdGFudCBmdW5jdGlvbiBjaGVjayBjb25jcmV0ZSB0b2tlbnMgYmFsYW5jZSAgDQogICAgICoNCiAgICAgKiAgQHBhcmFtIG93bmVyIC0gYWNjb3VudCBvd25lcg0KICAgICAqICANCiAgICAgKiAgQHJldHVybiB0aGUgdmFsdWUgb2YgYmFsYW5jZSANCiAgICAgKi8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgDQogICAgZnVuY3Rpb24gYmFsYW5jZU9mKGFkZHJlc3Mgb3duZXIpIGNvbnN0YW50IHJldHVybnMgKHVpbnQyNTYgYmFsYW5jZSk7DQogICAgDQogICAgZnVuY3Rpb24gdHJhbnNmZXIoYWRkcmVzcyB0bywgdWludDI1NiB2YWx1ZSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsNCg0KICAgIGZ1bmN0aW9uIHRyYW5zZmVyRnJvbShhZGRyZXNzIGZyb20sIGFkZHJlc3MgdG8sIHVpbnQyNTYgdmFsdWUpIHJldHVybnMgKGJvb2wgc3VjY2Vzcyk7DQoNCiAgICAvKioNCiAgICAgKg0KICAgICAqIGFwcHJvdmUoKSAtIGZ1bmN0aW9uIGFwcHJvdmVzIHRvIGEgcGVyc29uIHRvIHNwZW5kIHNvbWUgdG9rZW5zIGZyb20gDQogICAgICogICAgICAgICAgIG93bmVyIGJhbGFuY2UuIA0KICAgICAqDQogICAgICogIEBwYXJhbSBzcGVuZGVyIC0gcGVyc29uIHdob20gdGhpcyByaWdodCBiZWVuIGdyYW50ZWQuDQogICAgICogIEBwYXJhbSB2YWx1ZSAgIC0gdmFsdWUgdG8gc3BlbmQuDQogICAgICogDQogICAgICogIEByZXR1cm4gdHJ1ZSBpbiBjYXNlIG9mIHN1Y2Nlcywgb3RoZXJ3aXNlIGZhaWx1cmUNCiAgICAgKiANCiAgICAgKi8NCiAgICBmdW5jdGlvbiBhcHByb3ZlKGFkZHJlc3Mgc3BlbmRlciwgdWludDI1NiB2YWx1ZSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKTsNCg0KICAgIC8qKg0KICAgICAqDQogICAgICogYWxsb3dhbmNlKCkgLSBjb25zdGFudCBmdW5jdGlvbiB0byBjaGVjayBob3cgbXVjaCBpcyANCiAgICAgKiAgICAgICAgICAgICAgIHBlcm1pdHRlZCB0byBzcGVuZCB0byAzcmQgcGVyc29uIGZyb20gb3duZXIgYmFsYW5jZQ0KICAgICAqDQogICAgICogIEBwYXJhbSBvd25lciAgIC0gb3duZXIgb2YgdGhlIGJhbGFuY2UNCiAgICAgKiAgQHBhcmFtIHNwZW5kZXIgLSBwZXJtaXR0ZWQgdG8gc3BlbmQgZnJvbSB0aGlzIGJhbGFuY2UgcGVyc29uIA0KICAgICAqICANCiAgICAgKiAgQHJldHVybiAtIHJlbWFpbmluZyByaWdodCB0byBzcGVuZCANCiAgICAgKiANCiAgICAgKi8NCiAgICBmdW5jdGlvbiBhbGxvd2FuY2UoYWRkcmVzcyBvd25lciwgYWRkcmVzcyBzcGVuZGVyKSBjb25zdGFudCByZXR1cm5zICh1aW50MjU2IHJlbWFpbmluZyk7DQoNCiAgICAvLyBldmVudHMgbm90aWZpY2F0aW9ucw0KICAgIGV2ZW50IFRyYW5zZmVyKGFkZHJlc3MgaW5kZXhlZCBmcm9tLCBhZGRyZXNzIGluZGV4ZWQgdG8sIHVpbnQyNTYgdmFsdWUpOw0KICAgIGV2ZW50IEFwcHJvdmFsKGFkZHJlc3MgaW5kZXhlZCBvd25lciwgYWRkcmVzcyBpbmRleGVkIHNwZW5kZXIsIHVpbnQyNTYgdmFsdWUpOw0KfQ0KDQoNCi8qDQogKiBTdGFuZGFyZFRva2VuIC0gaXMgYSBzbWFydCBjb250cmFjdCAgDQogKiBmb3IgbWFuYWdpbmcgY29tbW9uIGZ1bmN0aW9uYWxpdHkgb2YgDQogKiBhIHRva2VuLg0KICoNCiAqIEVSQy4yMCBUb2tlbiBzdGFuZGFyZDogDQogKiAgICAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9ldGggZXJldW0vRUlQcy9pc3N1ZXMvMjANCiAqLw0KY29udHJhY3QgU3RhbmRhcmRUb2tlbiBpcyBUb2tlbkludGVyZmFjZSB7DQoNCg0KICAgIC8vIHRva2VuIG93bmVyc2hpcA0KICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gdWludDI1NikgYmFsYW5jZXM7DQoNCiAgICAvLyBzcGVuZGluZyBwZXJtaXNpb24gbWFuYWdlbWVudA0KICAgIG1hcHBpbmcgKGFkZHJlc3MgPT4gbWFwcGluZyAoYWRkcmVzcyA9PiB1aW50MjU2KSkgYWxsb3dlZDsNCiAgICANCiAgICANCiAgICANCiAgICBmdW5jdGlvbiBTdGFuZGFyZFRva2VuKCl7DQogICAgfQ0KICAgIA0KICAgIA0KICAgIC8qKg0KICAgICAqIHRyYW5zZmVyKCkgLSB0cmFuc2ZlciB0b2tlbnMgZnJvbSBtc2cuc2VuZGVyIGJhbGFuY2UgDQogICAgICogICAgICAgICAgICAgIHRvIHJlcXVlc3RlZCBhY2NvdW50DQogICAgICoNCiAgICAgKiAgQHBhcmFtIHRvICAgIC0gdGFyZ2V0IGFkZHJlc3MgdG8gdHJhbnNmZXIgdG9rZW5zDQogICAgICogIEBwYXJhbSB2YWx1ZSAtIGFtbW91bnQgb2YgdG9rZW5zIHRvIHRyYW5zZmVyDQogICAgICoNCiAgICAgKiAgQHJldHVybiAtIHN1Y2Nlc3MgLyBmYWlsdXJlIG9mIHRoZSB0cmFuc2FjdGlvbg0KICAgICAqLyAgICANCiAgICBmdW5jdGlvbiB0cmFuc2ZlcihhZGRyZXNzIHRvLCB1aW50MjU2IHZhbHVlKSByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsNCiAgICAgICAgDQogICAgICAgIA0KICAgICAgICBpZiAoYmFsYW5jZXNbbXNnLnNlbmRlcl0gPj0gdmFsdWUgJiYgdmFsdWUgPiAwKSB7DQoNCiAgICAgICAgICAgIC8vIGRvIGFjdHVhbCB0b2tlbnMgdHJhbnNmZXIgICAgICAgDQogICAgICAgICAgICBiYWxhbmNlc1ttc2cuc2VuZGVyXSAtPSB2YWx1ZTsNCiAgICAgICAgICAgIGJhbGFuY2VzW3RvXSAgICAgICAgICs9IHZhbHVlOw0KICAgICAgICAgICAgDQogICAgICAgICAgICAvLyByaXNlIHRoZSBUcmFuc2ZlciBldmVudA0KICAgICAgICAgICAgVHJhbnNmZXIobXNnLnNlbmRlciwgdG8sIHZhbHVlKTsNCiAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gZmFsc2U7IA0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIA0KDQogICAgDQogICAgLyoqDQogICAgICogdHJhbnNmZXJGcm9tKCkgLSANCiAgICAgKg0KICAgICAqICBAcGFyYW0gZnJvbSAgLSANCiAgICAgKiAgQHBhcmFtIHRvICAgIC0gDQogICAgICogIEBwYXJhbSB2YWx1ZSAtIA0KICAgICAqDQogICAgICogIEByZXR1cm4gDQogICAgICovDQogICAgZnVuY3Rpb24gdHJhbnNmZXJGcm9tKGFkZHJlc3MgZnJvbSwgYWRkcmVzcyB0bywgdWludDI1NiB2YWx1ZSkgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7DQogICAgDQogICAgICAgIGlmICggYmFsYW5jZXNbZnJvbV0gPj0gdmFsdWUgJiYgDQogICAgICAgICAgICAgYWxsb3dlZFtmcm9tXVttc2cuc2VuZGVyXSA+PSB2YWx1ZSAmJiANCiAgICAgICAgICAgICB2YWx1ZSA+IDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIA0KICAgIA0KICAgICAgICAgICAgLy8gZG8gdGhlIGFjdHVhbCB0cmFuc2Zlcg0KICAgICAgICAgICAgYmFsYW5jZXNbZnJvbV0gLT0gdmFsdWU7ICAgIA0KICAgICAgICAgICAgYmFsYW5jZXNbdG9dID0rIHZhbHVlOyAgICAgICAgICAgIA0KICAgICAgICAgICAgDQoNCiAgICAgICAgICAgIC8vIGFkZGp1c3QgdGhlIHBlcm1pc2lvbiwgYWZ0ZXIgcGFydCBvZiANCiAgICAgICAgICAgIC8vIHBlcm1pdGVkIHRvIHNwZW5kIHZhbHVlIHdhcyB1c2VkDQogICAgICAgICAgICBhbGxvd2VkW2Zyb21dW21zZy5zZW5kZXJdIC09IHZhbHVlOw0KICAgICAgICAgICAgDQogICAgICAgICAgICAvLyByaXNlIHRoZSBUcmFuc2ZlciBldmVudA0KICAgICAgICAgICAgVHJhbnNmZXIoZnJvbSwgdG8sIHZhbHVlKTsNCiAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9IGVsc2UgeyANCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyANCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIA0KDQogICAgDQogICAgLyoqDQogICAgICoNCiAgICAgKiBiYWxhbmNlT2YoKSAtIGNvbnN0YW50IGZ1bmN0aW9uIGNoZWNrIGNvbmNyZXRlIHRva2VucyBiYWxhbmNlICANCiAgICAgKg0KICAgICAqICBAcGFyYW0gb3duZXIgLSBhY2NvdW50IG93bmVyDQogICAgICogIA0KICAgICAqICBAcmV0dXJuIHRoZSB2YWx1ZSBvZiBiYWxhbmNlIA0KICAgICAqLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICANCiAgICBmdW5jdGlvbiBiYWxhbmNlT2YoYWRkcmVzcyBvd25lcikgY29uc3RhbnQgcmV0dXJucyAodWludDI1NiBiYWxhbmNlKSB7DQogICAgICAgIHJldHVybiBiYWxhbmNlc1tvd25lcl07DQogICAgfQ0KDQogICAgDQogICAgDQogICAgLyoqDQogICAgICoNCiAgICAgKiBhcHByb3ZlKCkgLSBmdW5jdGlvbiBhcHByb3ZlcyB0byBhIHBlcnNvbiB0byBzcGVuZCBzb21lIHRva2VucyBmcm9tIA0KICAgICAqICAgICAgICAgICBvd25lciBiYWxhbmNlLiANCiAgICAgKg0KICAgICAqICBAcGFyYW0gc3BlbmRlciAtIHBlcnNvbiB3aG9tIHRoaXMgcmlnaHQgYmVlbiBncmFudGVkLg0KICAgICAqICBAcGFyYW0gdmFsdWUgICAtIHZhbHVlIHRvIHNwZW5kLg0KICAgICAqIA0KICAgICAqICBAcmV0dXJuIHRydWUgaW4gY2FzZSBvZiBzdWNjZXMsIG90aGVyd2lzZSBmYWlsdXJlDQogICAgICogDQogICAgICovDQogICAgZnVuY3Rpb24gYXBwcm92ZShhZGRyZXNzIHNwZW5kZXIsIHVpbnQyNTYgdmFsdWUpIHJldHVybnMgKGJvb2wgc3VjY2Vzcykgew0KICAgICAgICANCiAgICAgICAgLy8gbm93IHNwZW5kZXIgY2FuIHVzZSBiYWxhbmNlIGluIA0KICAgICAgICAvLyBhbW1vdW50IG9mIHZhbHVlIGZyb20gb3duZXIgYmFsYW5jZQ0KICAgICAgICBhbGxvd2VkW21zZy5zZW5kZXJdW3NwZW5kZXJdID0gdmFsdWU7DQogICAgICAgIA0KICAgICAgICAvLyByaXNlIGV2ZW50IGFib3V0IHRoZSB0cmFuc2FjdGlvbg0KICAgICAgICBBcHByb3ZhbChtc2cuc2VuZGVyLCBzcGVuZGVyLCB2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQoNCiAgICAvKioNCiAgICAgKg0KICAgICAqIGFsbG93YW5jZSgpIC0gY29uc3RhbnQgZnVuY3Rpb24gdG8gY2hlY2sgaG93IG1vdWNoIGlzIA0KICAgICAqICAgICAgICAgICAgICAgcGVybWl0ZWQgdG8gc3BlbmQgdG8gM3JkIHBlcnNvbiBmcm9tIG93bmVyIGJhbGFuY2UNCiAgICAgKg0KICAgICAqICBAcGFyYW0gb3duZXIgICAtIG93bmVyIG9mIHRoZSBiYWxhbmNlDQogICAgICogIEBwYXJhbSBzcGVuZGVyIC0gcGVybWl0ZWQgdG8gc3BlbmQgZnJvbSB0aGlzIGJhbGFuY2UgcGVyc29uIA0KICAgICAqICANCiAgICAgKiAgQHJldHVybiAtIHJlbWFpbmluZyByaWdodCB0byBzcGVuZCANCiAgICAgKiANCiAgICAgKi8NCiAgICBmdW5jdGlvbiBhbGxvd2FuY2UoYWRkcmVzcyBvd25lciwgYWRkcmVzcyBzcGVuZGVyKSBjb25zdGFudCByZXR1cm5zICh1aW50MjU2IHJlbWFpbmluZykgew0KICAgICAgcmV0dXJuIGFsbG93ZWRbb3duZXJdW3NwZW5kZXJdOw0KICAgIH0NCg0KfQ0KDQovKioNCiAqDQogKiBAdGl0bGUgSGFja2VyIEdvbGQNCiAqIA0KICogVGhlIG9mZmljaWFsIHRva2VuIHBvd2VyaW5nIHRoZSBoYWNrLmV0aGVyLmNhbXAgdmlydHVhbCBhY2NlbGVyYXRvci4NCiAqIFRoaXMgaXMgdGhlIG9ubHkgd2F5IHRvIGFjcXVpcmUgdG9rZW5zIGZyb20gc3RhcnR1cHMgZHVyaW5nIHRoZSBldmVudC4NCiAqDQogKiBXaGl0ZXBhcGVyIGh0dHBzOi8vaGFjay5ldGhlci5jYW1wL3doaXRlcGFwZXINCiAqDQogKi8NCmNvbnRyYWN0IEhhY2tlckdvbGQgaXMgU3RhbmRhcmRUb2tlbiB7DQoNCiAgICAvLyBOYW1lIG9mIHRoZSB0b2tlbiAgICANCiAgICBzdHJpbmcgcHVibGljIG5hbWUgPSAiSGFja2VyR29sZCI7DQoNCiAgICAvLyBEZWNpbWFsIHBsYWNlcw0KICAgIHVpbnQ4ICBwdWJsaWMgZGVjaW1hbHMgPSAzOw0KICAgIC8vIFRva2VuIGFiYnJldmlhdGlvbiAgICAgICAgDQogICAgc3RyaW5nIHB1YmxpYyBzeW1ib2wgPSAiSEtHIjsNCiAgICANCiAgICAvLyAxIGV0aGVyID0gMjAwIGhrZw0KICAgIHVpbnQgQkFTRV9QUklDRSA9IDIwMDsNCiAgICAvLyAxIGV0aGVyID0gMTUwIGhrZw0KICAgIHVpbnQgTUlEX1BSSUNFID0gMTUwOw0KICAgIC8vIDEgZXRoZXIgPSAxMDAgaGtnDQogICAgdWludCBGSU5fUFJJQ0UgPSAxMDA7DQogICAgLy8gU2FmZXR5IGNhcA0KICAgIHVpbnQgU0FGRVRZX0xJTUlUID0gNDAwMDAwMCBldGhlcjsNCiAgICAvLyBaZXJvcyBhZnRlciB0aGUgcG9pbnQNCiAgICB1aW50IERFQ0lNQUxfWkVST1MgPSAxMDAwOw0KICAgIA0KICAgIC8vIFRvdGFsIHZhbHVlIGluIHdlaQ0KICAgIHVpbnQgdG90YWxWYWx1ZTsNCiAgICANCiAgICAvLyBBZGRyZXNzIG9mIG11bHRpc2lnIHdhbGxldCBob2xkaW5nIGV0aGVyIGZyb20gc2FsZQ0KICAgIGFkZHJlc3Mgd2FsbGV0Ow0KDQogICAgLy8gU3RydWN0dXJlIG9mIHNhbGUgaW5jcmVhc2UgbWlsZXN0b25lcw0KICAgIHN0cnVjdCBtaWxlc3RvbmVzX3N0cnVjdCB7DQogICAgICB1aW50IHAxOw0KICAgICAgdWludCBwMjsgDQogICAgICB1aW50IHAzOw0KICAgICAgdWludCBwNDsNCiAgICAgIHVpbnQgcDU7DQogICAgICB1aW50IHA2Ow0KICAgIH0NCiAgICAvLyBNaWxlc3RvbmVzIGluc3RhbmNlDQogICAgbWlsZXN0b25lc19zdHJ1Y3QgbWlsZXN0b25lczsNCiAgICANCiAgICAvKioNCiAgICAgKiBDb25zdHJ1Y3RvciBvZiB0aGUgY29udHJhY3QuDQogICAgICogDQogICAgICogUGFzc2VzIGFkZHJlc3Mgb2YgdGhlIGFjY291bnQgaG9sZGluZyB0aGUgdmFsdWUuDQogICAgICogSGFja2VyR29sZCBjb250cmFjdCBpdHNlbGYgZG9lcyBub3QgaG9sZCBhbnkgdmFsdWUNCiAgICAgKiANCiAgICAgKiBAcGFyYW0gbXVsdGlzaWcgYWRkcmVzcyBvZiBNdWx0aVNpZyB3YWxsZXQgd2hpY2ggd2lsbCBob2xkIHRoZSB2YWx1ZQ0KICAgICAqLw0KICAgIGZ1bmN0aW9uIEhhY2tlckdvbGQoYWRkcmVzcyBtdWx0aXNpZykgew0KICAgICAgICANCiAgICAgICAgd2FsbGV0ID0gbXVsdGlzaWc7DQoNCiAgICAgICAgLy8gc2V0IHRpbWUgcGVyaW9kcyBmb3Igc2FsZQ0KICAgICAgICBtaWxlc3RvbmVzID0gbWlsZXN0b25lc19zdHJ1Y3QoDQogICAgICAgIA0KICAgICAgICAgIDE0NzY5NzIwMDAsICAvLyBQMTogR01UOiAyMC1PY3QtMjAxNiAxNDowMCAgPT4gVGhlIFNhbGUgU3RhcnRzDQogICAgICAgICAgMTQ3ODE4MTYwMCwgIC8vIFAyOiBHTVQ6IDAzLU5vdi0yMDE2IDE0OjAwICA9PiAxc3QgUHJpY2UgTGFkZGVyIA0KICAgICAgICAgIDE0NzkzOTEyMDAsICAvLyBQMzogR01UOiAxNy1Ob3YtMjAxNiAxNDowMCAgPT4gUHJpY2UgU3RhYmxlLCANCiAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEhhY2thdGhvbiBTdGFydHMNCiAgICAgICAgICAxNDgwNjAwODAwLCAgLy8gUDQ6IEdNVDogMDEtRGVjLTIwMTYgMTQ6MDAgID0+IDJuZCBQcmljZSBMYWRkZXINCiAgICAgICAgICAxNDgxODEwNDAwLCAgLy8gUDU6IEdNVDogMTUtRGVjLTIwMTYgMTQ6MDAgID0+IFByaWNlIFN0YWJsZQ0KICAgICAgICAgIDE0ODI0MTUyMDAgICAvLyBQNjogR01UOiAyMi1EZWMtMjAxNiAxNDowMCAgPT4gU2FsZSBFbmRzLCBIYWNrYXRob24gRW5kcw0KICAgICAgICApOw0KICAgICAgICAgICAgICAgIA0KICAgIH0NCiAgICANCiAgICANCiAgICAvKioNCiAgICAgKiBGYWxsYmFjayBmdW5jdGlvbjogY2FsbGVkIG9uIGV0aGVyIHNlbnQuDQogICAgICogDQogICAgICogSXQgY2FsbHMgdG8gY3JlYXRlSEtHIGZ1bmN0aW9uIHdpdGggbXNnLnNlbmRlciANCiAgICAgKiBhcyBhIHZhbHVlIGZvciBob2xkZXIgYXJndW1lbnQNCiAgICAgKi8NCiAgICBmdW5jdGlvbiAoKSBwYXlhYmxlIHsNCiAgICAgICAgY3JlYXRlSEtHKG1zZy5zZW5kZXIpOw0KICAgIH0NCiAgICANCiAgICAvKioNCiAgICAgKiBDcmVhdGVzIEhLRyB0b2tlbnMuDQogICAgICogDQogICAgICogUnVucyBzYW5pdHkgY2hlY2tzIGluY2x1ZGluZyBzYWZldHkgY2FwDQogICAgICogVGhlbiBjYWxjdWxhdGVzIGN1cnJlbnQgcHJpY2UgYnkgZ2V0UHJpY2UoKSBmdW5jdGlvbiwgY3JlYXRlcyBIS0cgdG9rZW5zDQogICAgICogRmluYWxseSBzZW5kcyBhIHZhbHVlIG9mIHRyYW5zYWN0aW9uIHRvIHRoZSB3YWxsZXQNCiAgICAgKiANCiAgICAgKiBOb3RlOiBkdWUgdG8gbGFjayBvZiBmbG9hdGluZyBwb2ludCB0eXBlcyBpbiBTb2xpZGl0eSwNCiAgICAgKiBjb250cmFjdCBhc3N1bWVzIHRoYXQgbGFzdCAzIGRpZ2l0cyBpbiB0b2tlbnMgYW1vdW50IGFyZSBzdG9vZCBhZnRlciB0aGUgcG9pbnQuDQogICAgICogSXQgbWVhbnMgdGhhdCBpZiBzdG9yZWQgSEtHIGJhbGFuY2UgaXMgMTAwMDAwLCB0aGVuIGl0cyByZWFsIHZhbHVlIGlzIDEwMCBIS0cNCiAgICAgKiANCiAgICAgKiBAcGFyYW0gaG9sZGVyIHRva2VuIGhvbGRlcg0KICAgICAqLw0KICAgIGZ1bmN0aW9uIGNyZWF0ZUhLRyhhZGRyZXNzIGhvbGRlcikgcGF5YWJsZSB7DQogICAgICAgIA0KICAgICAgICBpZiAobm93IDwgbWlsZXN0b25lcy5wMSkgdGhyb3c7DQogICAgICAgIGlmIChub3cgPj0gbWlsZXN0b25lcy5wNikgdGhyb3c7DQogICAgICAgIGlmIChtc2cudmFsdWUgPT0gMCkgdGhyb3c7DQogICAgDQogICAgICAgIC8vIHNhZmV0eSBjYXANCiAgICAgICAgaWYgKGdldFRvdGFsVmFsdWUoKSArIG1zZy52YWx1ZSA+IFNBRkVUWV9MSU1JVCkgdGhyb3c7IA0KICAgIA0KICAgICAgICB1aW50IHRva2VucyA9IG1zZy52YWx1ZSAqIGdldFByaWNlKCkgKiBERUNJTUFMX1pFUk9TIC8gMSBldGhlcjsNCg0KICAgICAgICB0b3RhbFN1cHBseSArPSB0b2tlbnM7DQogICAgICAgIGJhbGFuY2VzW2hvbGRlcl0gKz0gdG9rZW5zOw0KICAgICAgICB0b3RhbFZhbHVlICs9IG1zZy52YWx1ZTsNCiAgICAgICAgDQogICAgICAgIGlmICghd2FsbGV0LnNlbmQobXNnLnZhbHVlKSkgdGhyb3c7DQogICAgfQ0KICAgIA0KICAgIC8qKg0KICAgICAqIERlbm90ZXMgY29tcGxldGUgcHJpY2Ugc3RydWN0dXJlIGR1cmluZyB0aGUgc2FsZS4NCiAgICAgKg0KICAgICAqIEByZXR1cm4gSEtHIGFtb3VudCBwZXIgMSBFVEggZm9yIHRoZSBjdXJyZW50IG1vbWVudCBpbiB0aW1lDQogICAgICovDQogICAgZnVuY3Rpb24gZ2V0UHJpY2UoKSBjb25zdGFudCByZXR1cm5zICh1aW50IHJlc3VsdCkgew0KICAgICAgICANCiAgICAgICAgaWYgKG5vdyA8IG1pbGVzdG9uZXMucDEpIHJldHVybiAwOw0KICAgICAgICANCiAgICAgICAgaWYgKG5vdyA+PSBtaWxlc3RvbmVzLnAxICYmIG5vdyA8IG1pbGVzdG9uZXMucDIpIHsNCiAgICAgICAgDQogICAgICAgICAgICByZXR1cm4gQkFTRV9QUklDRTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYgKG5vdyA+PSBtaWxlc3RvbmVzLnAyICYmIG5vdyA8IG1pbGVzdG9uZXMucDMpIHsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgdWludCBkYXlzX2luID0gMSArIChub3cgLSBtaWxlc3RvbmVzLnAyKSAvIDEgZGF5czsgDQogICAgICAgICAgICByZXR1cm4gQkFTRV9QUklDRSAtIGRheXNfaW4gKiAyNSAvIDc7ICAvLyBkYWlseSBkZWNyZWFzZSAzLjUNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChub3cgPj0gbWlsZXN0b25lcy5wMyAmJiBub3cgPCBtaWxlc3RvbmVzLnA0KSB7DQogICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIE1JRF9QUklDRTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYgKG5vdyA+PSBtaWxlc3RvbmVzLnA0ICYmIG5vdyA8IG1pbGVzdG9uZXMucDUpIHsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgZGF5c19pbiA9IDEgKyAobm93IC0gbWlsZXN0b25lcy5wNCkgLyAxIGRheXM7IA0KICAgICAgICAgICAgcmV0dXJuIE1JRF9QUklDRSAtIGRheXNfaW4gKiAyNSAvIDc7ICAvLyBkYWlseSBkZWNyZWFzZSAzLjUNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChub3cgPj0gbWlsZXN0b25lcy5wNSAmJiBub3cgPCBtaWxlc3RvbmVzLnA2KSB7DQogICAgICAgIA0KICAgICAgICAgICAgcmV0dXJuIEZJTl9QUklDRTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYgKG5vdyA+PSBtaWxlc3RvbmVzLnA2KXsNCg0KICAgICAgICAgICAgcmV0dXJuIDA7DQogICAgICAgIH0NCg0KICAgICB9DQogICAgDQogICAgLyoqDQogICAgICogUmV0dXJucyB0b3RhbCBzdG9yZWQgSEtHIGFtb3VudC4NCiAgICAgKiANCiAgICAgKiBDb250cmFjdCBhc3N1bWVzIHRoYXQgbGFzdCAzIGRpZ2l0cyBvZiB0aGlzIHZhbHVlIGFyZSBiZWhpbmQgdGhlIGRlY2ltYWwgcGxhY2UuIGkuZS4gMTAwMDEgaXMgMTAuMDAxDQogICAgICogVGh1cywgcmVzdWx0IG9mIHRoaXMgZnVuY3Rpb24gc2hvdWxkIGJlIGRpdmlkZWQgYnkgMTAwMCB0byBnZXQgSEtHIHZhbHVlDQogICAgICogDQogICAgICogQHJldHVybiByZXN1bHQgc3RvcmVkIEhLRyBhbW91bnQNCiAgICAgKi8NCiAgICBmdW5jdGlvbiBnZXRUb3RhbFN1cHBseSgpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgcmVzdWx0KSB7DQogICAgICAgIHJldHVybiB0b3RhbFN1cHBseTsNCiAgICB9IA0KDQogICAgLyoqDQogICAgICogSXQgaXMgdXNlZCBmb3IgdGVzdCBwdXJwb3Nlcy4NCiAgICAgKiANCiAgICAgKiBSZXR1cm5zIHRoZSByZXN1bHQgb2YgJ25vdycgc3RhdGVtZW50IG9mIFNvbGlkaXR5IGxhbmd1YWdlDQogICAgICogDQogICAgICogQHJldHVybiB1bml4IHRpbWVzdGFtcCBmb3IgY3VycmVudCBtb21lbnQgaW4gdGltZQ0KICAgICAqLw0KICAgIGZ1bmN0aW9uIGdldE5vdygpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgcmVzdWx0KSB7DQogICAgICAgIHJldHVybiBub3c7DQogICAgfQ0KDQogICAgLyoqDQogICAgICogUmV0dXJucyB0b3RhbCB2YWx1ZSBwYXNzZWQgdGhyb3VnaCB0aGUgY29udHJhY3QNCiAgICAgKiANCiAgICAgKiBAcmV0dXJuIHJlc3VsdCB0b3RhbCB2YWx1ZSBpbiB3ZWkNCiAgICAgKi8NCiAgICBmdW5jdGlvbiBnZXRUb3RhbFZhbHVlKCkgY29uc3RhbnQgcmV0dXJucyAodWludCByZXN1bHQpIHsNCiAgICAgICAgcmV0dXJuIHRvdGFsVmFsdWU7ICANCiAgICB9DQp9DQoNCi8qKg0KICogDQogKiBFdmVudEluZm8gLSBpbXV0YWJsZSBjbGFzcyB0aGF0IGRlbm90ZXMNCiAqIHRoZSB0aW1lIG9mIHRoZSB2aXJ0dWFsIGFjY2VsZXJhdG9yIGhhY2sNCiAqIGV2ZW50DQogKiANCiAqLw0KY29udHJhY3QgRXZlbnRJbmZvew0KICAgIA0KICAgIA0KICAgIHVpbnQgY29uc3RhbnQgSEFDS0FUSE9OXzVfV0VFS1MgPSA2MCAqIDYwICogMjQgKiA3ICogNTsNCiAgICB1aW50IGNvbnN0YW50IFRfMV9XRUVLID0gNjAgKiA2MCAqIDI0ICogNzsNCg0KICAgIHVpbnQgZXZlbnRTdGFydCA9IDE0NzkzOTEyMDA7IC8vIFRodSwgMTcgTm92IDIwMTYgMTQ6MDA6MDAgR01UDQogICAgdWludCBldmVudEVuZCA9IGV2ZW50U3RhcnQgKyBIQUNLQVRIT05fNV9XRUVLUzsNCiAgICANCiAgICANCiAgICAvKioNCiAgICAgKiBnZXRFdmVudFN0YXJ0IC0gcmV0dXJuIHRoZSBzdGFydCBvZiB0aGUgZXZlbnQgdGltZQ0KICAgICAqLyANCiAgICBmdW5jdGlvbiBnZXRFdmVudFN0YXJ0KCkgY29uc3RhbnQgcmV0dXJucyAodWludCByZXN1bHQpeyAgICAgICAgDQogICAgICAgcmV0dXJuIGV2ZW50U3RhcnQ7DQogICAgfSANCiAgICANCiAgICAvKioNCiAgICAgKiBnZXRFdmVudEVuZCAtIHJldHVybiB0aGUgZW5kIG9mIHRoZSBldmVudCB0aW1lDQogICAgICovIA0KICAgIGZ1bmN0aW9uIGdldEV2ZW50RW5kKCkgY29uc3RhbnQgcmV0dXJucyAodWludCByZXN1bHQpeyAgICAgICAgDQogICAgICAgcmV0dXJuIGV2ZW50RW5kOw0KICAgIH0gDQogICAgDQogICAgDQogICAgLyoqDQogICAgICogZ2V0Vm90aW5nU3RhcnQgLSB0aGUgdm90aW5nIHN0YXJ0cyAxIHdlZWsgYWZ0ZXIgdGhlIA0KICAgICAqICAgICAgICAgICAgICAgICAgZXZlbnQgc3RhcnRzDQogICAgICovIA0KICAgIGZ1bmN0aW9uIGdldFZvdGluZ1N0YXJ0KCkgY29uc3RhbnQgcmV0dXJucyAodWludCByZXN1bHQpew0KICAgICAgICByZXR1cm4gZXZlbnRTdGFydCsgVF8xX1dFRUs7DQogICAgfQ0KDQogICAgLyoqDQogICAgICogZ2V0VHJhZGluZ1N0YXJ0IC0gdGhlIERTVCB0b2tlbnMgdHJhZGluZyBzdGFydHMgMSB3ZWVrIA0KICAgICAqICAgICAgICAgICAgICAgICAgIGFmdGVyIHRoZSBldmVudCBzdGFydHMNCiAgICAgKi8gDQogICAgZnVuY3Rpb24gZ2V0VHJhZGluZ1N0YXJ0KCkgY29uc3RhbnQgcmV0dXJucyAodWludCByZXN1bHQpew0KICAgICAgICByZXR1cm4gZXZlbnRTdGFydCsgVF8xX1dFRUs7DQogICAgfQ0KDQogICAgLyoqDQogICAgICogZ2V0Tm93IC0gaGVscGVyIGNsYXNzIHRvIGNoZWNrIHdoYXQgdGltZSB0aGUgY29udHJhY3Qgc2VlDQogICAgICovDQogICAgZnVuY3Rpb24gZ2V0Tm93KCkgY29uc3RhbnQgcmV0dXJucyAodWludCByZXN1bHQpeyAgICAgICAgDQogICAgICAgcmV0dXJuIG5vdzsNCiAgICB9IA0KICAgIA0KfQ0KDQovKg0KICogRFNUQ29udHJhY3QgLSBEU1Qgc3RhbmRzIGZvciBkZWNlbnRyYWxpemVkIHN0YXJ0dXAgdGVhbS4NCiAqICAgICAgICAgICAgICAgdGhlIGNvbnRyYWN0IGVuc3VyZXMgZnVuZGluZyBmb3IgYSBkZWNlbnRyYWxpemVkDQogKiAgICAgICAgICAgICAgIHRlYW0gaW4gMiBwaGFzZXM6IA0KICoNCiAqICAgICAgICAgICAgICAgICsuIEZ1bmRpbmcgYnkgSEtHIGR1cmluZyB0aGUgaGFja2F0aG9uIGV2ZW50LiANCiAqICAgICAgICAgICAgICAgICsuIEZ1bmRpbmcgYnkgRXRoZXIgYWZ0ZXIgdGhlIGV2ZW50IGlzIG92ZXIuIA0KICoNCiAqICAgICAgICAgICAgICAgQWZ0ZXIgdGhlIGZ1bmRzIGJlZW4gY29sbGVjdGVkIHRoZXJlIGlzIGEgZ292ZXJuZW5jZQ0KICogICAgICAgICAgICAgICBtZWNoYW5pc20gbWFuYWdlZCBieSBwcm9wb3NpdGlvbiB0byB3aXRoZHJhdyBmdW5kcw0KICogICAgICAgICAgICAgICBmb3IgZGV2ZWxvcG1lbnQgdXNhZ2UuIA0KICoNCiAqICAgICAgICAgICAgICAgVGhlIERTVCBlbnN1cmVzIHRoYXQgYmFja2VycyBvZiB0aGUgcHJvamVjdHMga2VlcHMNCiAqICAgICAgICAgICAgICAgc29tZSBpbmZsdWVuY2Ugb24gdGhlIHByb2plY3QgYnkgYWJpbGl0eSB0byByZWplY3QNCiAqICAgICAgICAgICAgICAgcHJvcG9zaXRpb25zIHRoZXkgZmluZCBhcyBub24gZWZmZWN0aXZlLiANCiAqDQogKiAgICAgICAgICAgICAgIEluIHZlcnkgcmFkaWNhbCBvY2Nhc2lvbnMgdGhlIGJhY2tlcnMgbWF5IGxvb3NlIA0KICogICAgICAgICAgICAgICB0aGUgdHJ1c3QgaW4gdGhlIHRlYW0gY29tcGxldGVsbHksIGluIHRoYXQgY2FzZSANCiAqICAgICAgICAgICAgICAgdGhlcmUgaXMgYW4gb3B0aW9uIHRvIHByb3Bvc2UgaW1wZWFjaG1lbnQgcHJvY2Vzcw0KICogICAgICAgICAgICAgICBjb21wbGV0ZWxseSByZW1vdmluZyB0aGUgZXhlY3V0ZSBhbmQgYXNzaWduaW5nIG5ldw0KICogICAgICAgICAgICAgICBwZXJzb24gdG8gbWFuYWdlIHRoZSBmdW5kcy4gDQogKg0KICovDQpjb250cmFjdCBEU1RDb250cmFjdCBpcyBTdGFuZGFyZFRva2Vuew0KDQogICAgLy8gWmVyb3MgYWZ0ZXIgdGhlIHBvaW50DQogICAgdWludCBERUNJTUFMX1pFUk9TID0gMTAwMDsNCiAgICAvLyBQcm9wb3NhbCBsaWZldGltZQ0KICAgIHVpbnQgUFJPUE9TQUxfTElGRVRJTUUgPSAxMCBkYXlzOw0KICAgIC8vIFByb3Bvc2FsIGZ1bmRzIHRocmVzaG9sZCwgaW4gcGVyY2VudHMNCiAgICB1aW50IFBST1BPU0FMX0ZVTkRTX1RIID0gMjA7DQoNCiAgICBhZGRyZXNzICAgZXhlY3V0aXZlOyANCiAgICAgICAgDQogICAgRXZlbnRJbmZvIGV2ZW50SW5mbzsNCiAgICANCiAgICAvLyBJbmRpY2F0ZWQgd2hlcmUgdGhlIERTVCBpcyB0cmFkZWQNCiAgICBhZGRyZXNzIHZpcnR1YWxFeGNoYW5nZUFkZHJlc3M7DQogICAgDQogICAgSGFja2VyR29sZCBoYWNrZXJHb2xkOw0KICAgICAgICANCiAgICBtYXBwaW5nIChhZGRyZXNzID0+IHVpbnQyNTYpIHZvdGluZ1JpZ2h0czsNCg0KDQogICAgLy8gMSAtIEhLRyA9PiBEU1QgcXR5OyB0b2tlbnMgZm9yIDEgSEtHDQogICAgdWludCBoa2dQcmljZTsNCiAgICANCiAgICAvLyAxIC0gRXRoZXIgPT4gRFNUIHF0eTsgdG9rZW5zIGZvciAxIEV0aGVyDQogICAgdWludCBldGhlclByaWNlOw0KICAgIA0KICAgIHN0cmluZyBwdWJsaWMgbmFtZSA9ICIuLi4iOyAgICAgICAgICAgICAgICAgICANCiAgICB1aW50OCAgcHVibGljIGRlY2ltYWxzID0gMzsgICAgICAgICAgICAgICAgIA0KICAgIHN0cmluZyBwdWJsaWMgc3ltYm9sID0gIi4uLiI7DQogICAgDQogICAgYm9vbCBhYmxlVG9Jc3N1ZVRva2VucyA9IHRydWU7IA0KICAgIA0KICAgIHVpbnQgcHJlZmVyZWRRdHlTb2xkOw0KDQogICAgdWludCBjb2xsZWN0ZWRIS0c7IA0KICAgIHVpbnQgY29sbGVjdGVkRXRoZXI7ICAgIA0KICAgIA0KICAgIC8vIFByb3Bvc2FsIG9mIHRoZSBmdW5kcyBzcGVuZGluZw0KICAgIG1hcHBpbmcgKGJ5dGVzMzIgPT4gUHJvcG9zYWwpIHByb3Bvc2FsczsNCg0KICAgIGVudW0gUHJvcG9zYWxDdXJyZW5jeSB7IEhLRywgRVRIRVIgfQ0KICAgIFByb3Bvc2FsQ3VycmVuY3kgZW51bURlY2xhcmF0aW9uOw0KICAgICAgICAgICAgICAgICAgDQogICAgICAgDQogICAgc3RydWN0IFByb3Bvc2Fsew0KICAgICAgICANCiAgICAgICAgYnl0ZXMzMiBpZDsNCiAgICAgICAgdWludCB2YWx1ZTsNCg0KICAgICAgICBzdHJpbmcgdXJsRGV0YWlsczsNCg0KICAgICAgICB1aW50IHZvdGluZEVuZFRTOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICB1aW50IHZvdGVzT2JqZWN0aW5nOw0KICAgICAgICANCiAgICAgICAgYWRkcmVzcyBzdWJtaXR0ZXI7DQogICAgICAgIGJvb2wgcmVkZWVtZWQ7DQoNCiAgICAgICAgUHJvcG9zYWxDdXJyZW5jeSBwcm9wb3NhbEN1cnJlbmN5Ow0KICAgICAgICANCiAgICAgICAgbWFwcGluZyAoYWRkcmVzcyA9PiBib29sKSB2b3RlZDsNCiAgICB9DQogICAgdWludCBjb3VudGVyUHJvcG9zYWxzOw0KICAgIHVpbnQgdGltZU9mTGFzdFByb3Bvc2FsOw0KICAgIA0KICAgIFByb3Bvc2FsW10gbGlzdFByb3Bvc2FsczsNCiAgICANCg0KICAgIC8qKg0KICAgICAqIEltcGVhY2htZW50IHByb2Nlc3MgcHJvcG9zYWxzDQogICAgICovICAgIA0KICAgIHN0cnVjdCBJbXBlYWNobWVudFByb3Bvc2Fsew0KICAgICAgICANCiAgICAgICAgc3RyaW5nIHVybERldGFpbHM7DQogICAgICAgIA0KICAgICAgICBhZGRyZXNzIG5ld0V4ZWN1dGl2ZTsNCg0KICAgICAgICB1aW50IHZvdGluZEVuZFRTOyAgICAgICAgDQogICAgICAgIHVpbnQgdm90ZXNTdXBwb3J0aW5nOw0KICAgICAgICANCiAgICAgICAgbWFwcGluZyAoYWRkcmVzcyA9PiBib29sKSB2b3RlZDsgICAgICAgIA0KICAgIH0NCiAgICBJbXBlYWNobWVudFByb3Bvc2FsIGxhc3RJbXBlYWNobWVudFByb3Bvc2FsOw0KDQogICAgICAgIA0KICAgIC8qKg0KICAgICAqIA0KICAgICAqICBEU1RDb250cmFjdDogY3RvciBmb3IgRFNUIHRva2VuIGFuZCBnb3Zlcm5lbmNlIGNvbnRyYWN0DQogICAgICoNCiAgICAgKiAgQHBhcmFtIGV2ZW50SW5mb0FkZHIgRXZlbnRJbmZvOiBhZGRyZXNzIG9mIG9iamVjdCBkZW5vdGVzIGV2ZW50cyANCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaWxlc3RvbmVzICAgICAgDQogICAgICogIEBwYXJhbSBoYWNrZXJHb2xkQWRkciBIYWNrZXJHb2xkOiBhZGRyZXNzIG9mIEhhY2tlckdvbGQgdG9rZW4NCiAgICAgKg0KICAgICAqICBAcGFyYW0gZHN0TmFtZSBzdHJpbmc6IGRzdE5hbWU6IHJlYWwgbmFtZSBvZiB0aGUgdGVhbQ0KICAgICAqDQogICAgICogIEBwYXJhbSBkc3RTeW1ib2wgc3RyaW5nOiAzIGxldHRlciBzeW1ib2xkIG9mIHRoZSB0ZWFtDQogICAgICoNCiAgICAgKi8gDQogICAgZnVuY3Rpb24gRFNUQ29udHJhY3QoRXZlbnRJbmZvIGV2ZW50SW5mb0FkZHIsIEhhY2tlckdvbGQgaGFja2VyR29sZEFkZHIsIHN0cmluZyBkc3ROYW1lLCBzdHJpbmcgZHN0U3ltYm9sKXsNCiAgICANCiAgICAgIGV4ZWN1dGl2ZSAgID0gbXNnLnNlbmRlcjsgIA0KICAgICAgbmFtZSAgICAgICAgPSBkc3ROYW1lOw0KICAgICAgc3ltYm9sICAgICAgPSBkc3RTeW1ib2w7DQoNCiAgICAgIGhhY2tlckdvbGQgPSBIYWNrZXJHb2xkKGhhY2tlckdvbGRBZGRyKTsNCiAgICAgIGV2ZW50SW5mbyAgPSBFdmVudEluZm8oZXZlbnRJbmZvQWRkcik7DQogICAgfQ0KICAgIA0KDQogICAgZnVuY3Rpb24oKSBwYXlhYmxlDQogICAgICAgICAgICAgICBvbmx5QWZ0ZXJFbmQgew0KICAgICAgICANCiAgICAgICAgLy8gdGhlcmUgaXMgdG9rZW5zIGxlZnQgZnJvbSBoYWNrYXRob24gDQogICAgICAgIGlmIChldGhlclByaWNlID09IDApIHRocm93Ow0KICAgICAgICANCiAgICAgICAgdWludCB0b2tlbnMgPSBtc2cudmFsdWUgKiBldGhlclByaWNlICogREVDSU1BTF9aRVJPUyAvICgxIGV0aGVyKTsNCiAgICAgICAgDQogICAgICAgIC8vIGNoZWNrIGlmIGRlbWFuZCBvZiB0b2tlbnMgaXMgDQogICAgICAgIC8vIG92ZXJmbG93IHRoZSBzdXBwbHkgDQogICAgICAgIHVpbnQgcmV0RXRoZXIgPSAwOw0KICAgICAgICBpZiAoYmFsYW5jZXNbdGhpc10gPCB0b2tlbnMpIHsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgdG9rZW5zID0gYmFsYW5jZXNbdGhpc107DQogICAgICAgICAgICByZXRFdGhlciA9IG1zZy52YWx1ZSAtIHRva2VucyAvIGV0aGVyUHJpY2UgKiAoMSBmaW5uZXkpOw0KICAgICAgICANCiAgICAgICAgICAgIC8vIHJldHVybiBsZWZ0IGV0aGVyIA0KICAgICAgICAgICAgaWYgKCFtc2cuc2VuZGVyLnNlbmQocmV0RXRoZXIpKSB0aHJvdzsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgDQogICAgICAgIC8vIGRvIHRyYW5zZmVyDQogICAgICAgIGJhbGFuY2VzW21zZy5zZW5kZXJdICs9IHRva2VuczsNCiAgICAgICAgYmFsYW5jZXNbdGhpc10gLT0gdG9rZW5zOw0KICAgICAgICANCiAgICAgICAgLy8gY291bnQgY29sbGVjdGVkIGV0aGVyIA0KICAgICAgICBjb2xsZWN0ZWRFdGhlciArPSBtc2cudmFsdWUgLSByZXRFdGhlcjsgDQogICAgICAgIA0KICAgICAgICAvLyByaXNlIGV2ZW50DQogICAgICAgIEJ1eUZvckV0aGVyVHJhbnNhY3Rpb24obXNnLnNlbmRlciwgY29sbGVjdGVkRXRoZXIsIHRvdGFsU3VwcGx5LCBldGhlclByaWNlLCB0b2tlbnMpOw0KICAgICAgICANCiAgICB9DQoNCiAgICANCiAgICANCiAgICAvKioNCiAgICAgKiBzZXRIS0dQcmljZSAtIHNldCBwcmljZTogMUhLRyA9PiBEU1QgdG9rZW5zIHF0eQ0KICAgICAqDQogICAgICogIEBwYXJhbSBxdHlGb3JPbmVIS0cgdWludDogRFNUIHRva2VucyBmb3IgMSBIS0cNCiAgICAgKiANCiAgICAgKi8gICAgDQogICAgIGZ1bmN0aW9uIHNldEhLR1ByaWNlKHVpbnQgcXR5Rm9yT25lSEtHKSBvbmx5RXhlY3V0aXZlICB7DQogICAgICAgICANCiAgICAgICAgIGhrZ1ByaWNlID0gcXR5Rm9yT25lSEtHOw0KICAgICAgICAgUHJpY2VIS0dDaGFuZ2UocXR5Rm9yT25lSEtHLCBwcmVmZXJlZFF0eVNvbGQsIHRvdGFsU3VwcGx5KTsNCiAgICAgfQ0KICAgICANCiAgICAgDQogICAgDQogICAgLyoqDQogICAgICogDQogICAgICogaXNzdWVQcmVmZXJlZFRva2VucyAtIHByZWZlcmVkIHRva2VucyBpc3N1ZWQgb24gdGhlIGhhY2thdGhvbiBldmVudA0KICAgICAqICAgICAgICAgICAgICAgICAgICAgICBncmFudCBzcGVjaWFsIHJpZ2h0cw0KICAgICAqDQogICAgICogIEBwYXJhbSBxdHlGb3JPbmVIS0cgdWludDogcHJpY2UgRFNUIHRva2VucyBmb3Igb25lIDEgSEtHDQogICAgICogIEBwYXJhbSBxdHlUb0VtaXQgdWludDogbmV3IHN1cHBseSBvZiB0b2tlbnMgDQogICAgICogDQogICAgICovDQogICAgZnVuY3Rpb24gaXNzdWVQcmVmZXJlZFRva2Vucyh1aW50IHF0eUZvck9uZUhLRywgDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50IHF0eVRvRW1pdCkgb25seUV4ZWN1dGl2ZSANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbmx5SWZBYmxlVG9Jc3N1ZVRva2Vucw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ubHlCZWZvcmVFbmQNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbmx5QWZ0ZXJUcmFkaW5nU3RhcnQgew0KICAgICAgICAgICAgICAgIA0KICAgICAgICAvLyBubyBpc3N1ZW5jZSBpcyBhbGxvd2VkIGJlZm9yZSBlbmxpc3RlZCBvbiB0aGUNCiAgICAgICAgLy8gZXhjaGFuZ2UgDQogICAgICAgIGlmICh2aXJ0dWFsRXhjaGFuZ2VBZGRyZXNzID09IDB4MCkgdGhyb3c7DQogICAgICAgICAgICANCiAgICAgICAgdG90YWxTdXBwbHkgICAgKz0gcXR5VG9FbWl0Ow0KICAgICAgICBiYWxhbmNlc1t0aGlzXSArPSBxdHlUb0VtaXQ7DQogICAgICAgIGhrZ1ByaWNlID0gcXR5Rm9yT25lSEtHOw0KICAgICAgICANCiAgICAgICAgDQogICAgICAgIC8vIG5vdyBzcGVuZGVyIGNhbiB1c2UgYmFsYW5jZSBpbiANCiAgICAgICAgLy8gYW1vdW50IG9mIHZhbHVlIGZyb20gb3duZXIgYmFsYW5jZQ0KICAgICAgICBhbGxvd2VkW3RoaXNdW3ZpcnR1YWxFeGNoYW5nZUFkZHJlc3NdICs9IHF0eVRvRW1pdDsNCiAgICAgICAgDQogICAgICAgIC8vIHJpc2UgZXZlbnQgYWJvdXQgdGhlIHRyYW5zYWN0aW9uDQogICAgICAgIEFwcHJvdmFsKHRoaXMsIHZpcnR1YWxFeGNoYW5nZUFkZHJlc3MsIHF0eVRvRW1pdCk7DQogICAgICAgIA0KICAgICAgICAvLyByaXNlIGV2ZW50IA0KICAgICAgICBEc3RUb2tlbnNJc3N1ZWQoaGtnUHJpY2UsIHByZWZlcmVkUXR5U29sZCwgdG90YWxTdXBwbHksIHF0eVRvRW1pdCk7DQogICAgfQ0KDQogICAgDQogICAgDQogICAgDQogICAgLyoqDQogICAgICogDQogICAgICogYnV5Rm9ySGFja2VyR29sZCAtIG9uIHRoZSBoYWNrIGV2ZW50IHRoaXMgZnVuY3Rpb24gaXMgYXZhaWxhYmxlIA0KICAgICAqICAgICAgICAgICAgICAgICAgICB0aGUgYnV5ZXIgZm9yIGhhY2tlciBnb2xkIHdpbGwgZ2FpbiB2b3RlcyB0byANCiAgICAgKiAgICAgICAgICAgICAgICAgICAgaW5mbHVlbmNlIGZ1dHVyZSBwcm9wb3NhbHMgb24gdGhlIERTVA0KICAgICAqICAgIA0KICAgICAqICBAcGFyYW0gaGtnVmFsdWUgLSBxdHkgb2YgdGhpcyBEU1QgdG9rZW5zIGZvciAxIEhLRyAgICAgDQogICAgICogDQogICAgICovDQogICAgZnVuY3Rpb24gYnV5Rm9ySGFja2VyR29sZCh1aW50IGhrZ1ZhbHVlKSBvbmx5QmVmb3JlRW5kIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJucyAoYm9vbCBzdWNjZXNzKSB7DQogICAgDQogICAgICAvLyB2YWxpZGF0ZSB0aGF0IHRoZSBjYWxsZXIgaXMgb2ZmaWNpYWwgYWNjZWxlcmF0b3IgSEtHIEV4Y2hhbmdlDQogICAgICBpZiAobXNnLnNlbmRlciAhPSB2aXJ0dWFsRXhjaGFuZ2VBZGRyZXNzKSB0aHJvdzsNCiAgICAgIA0KICAgICAgDQogICAgICAvLyB0cmFuc2ZlciB0b2tlbiANCiAgICAgIGFkZHJlc3Mgc2VuZGVyID0gdHgub3JpZ2luOw0KICAgICAgdWludCB0b2tlbnNRdHkgPSBoa2dWYWx1ZSAqIGhrZ1ByaWNlOw0KDQogICAgICAvLyBnYWluIHZvdGluZyByaWdodHMNCiAgICAgIHZvdGluZ1JpZ2h0c1tzZW5kZXJdICs9dG9rZW5zUXR5Ow0KICAgICAgcHJlZmVyZWRRdHlTb2xkICs9IHRva2Vuc1F0eTsNCiAgICAgIGNvbGxlY3RlZEhLRyArPSBoa2dWYWx1ZTsNCg0KICAgICAgLy8gZG8gYWN0dWFsIHRyYW5zZmVyDQogICAgICB0cmFuc2ZlckZyb20odGhpcywgDQogICAgICAgICAgICAgICAgICAgdmlydHVhbEV4Y2hhbmdlQWRkcmVzcywgdG9rZW5zUXR5KTsNCiAgICAgIHRyYW5zZmVyKHNlbmRlciwgdG9rZW5zUXR5KTsgICAgICAgIA0KICAgICAgICAgICAgDQogICAgICAvLyByaXNlIGV2ZW50ICAgICAgIA0KICAgICAgQnV5Rm9ySEtHVHJhbnNhY3Rpb24oc2VuZGVyLCBwcmVmZXJlZFF0eVNvbGQsIHRvdGFsU3VwcGx5LCBoa2dQcmljZSwgdG9rZW5zUXR5KTsNCiAgICAgICAgDQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogICAgICAgIA0KICAgIA0KICAgIC8qKg0KICAgICAqIA0KICAgICAqIGlzc3VlVG9rZW5zIC0gZnVuY3Rpb24gd2lsbCBpc3N1ZSB0b2tlbnMgYWZ0ZXIgdGhlIA0KICAgICAqICAgICAgICAgICAgICAgZXZlbnQsIGFibGUgdG8gc2VsbCBmb3IgMSBldGhlciANCiAgICAgKiANCiAgICAgKiAgQHBhcmFtIHF0eUZvck9uZUV0aGVyIHVpbnQ6IERTVCB0b2tlbnMgZm9yIDEgRVRIDQogICAgICogIEBwYXJhbSBxdHlUb0VtaXQgdWludDogbmV3IHRva2VucyBzdXBwbHkNCiAgICAgKg0KICAgICAqLw0KICAgIGZ1bmN0aW9uIGlzc3VlVG9rZW5zKHVpbnQgcXR5Rm9yT25lRXRoZXIsIA0KICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQgcXR5VG9FbWl0KSBvbmx5QWZ0ZXJFbmQgDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ubHlFeGVjdXRpdmUNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25seUlmQWJsZVRvSXNzdWVUb2tlbnMgew0KICAgICAgICAgDQogICAgICAgICBiYWxhbmNlc1t0aGlzXSArPSBxdHlUb0VtaXQ7DQogICAgICAgICBldGhlclByaWNlID0gcXR5Rm9yT25lRXRoZXI7DQogICAgICAgICB0b3RhbFN1cHBseSAgICArPSBxdHlUb0VtaXQ7DQogICAgICAgICANCiAgICAgICAgIC8vIHJpc2UgZXZlbnQgIA0KICAgICAgICAgRHN0VG9rZW5zSXNzdWVkKHF0eUZvck9uZUV0aGVyLCB0b3RhbFN1cHBseSwgdG90YWxTdXBwbHksIHF0eVRvRW1pdCk7DQogICAgfQ0KICAgICANCiAgICANCiAgICAvKioNCiAgICAgKiBzZXRFdGhlclByaWNlIC0gY2hhbmdlIHRoZSB0b2tlbiBwcmljZQ0KICAgICAqDQogICAgICogIEBwYXJhbSBxdHlGb3JPbmVFdGhlciB1aW50OiBuZXcgcHJpY2UgLSBEU1QgdG9rZW5zIGZvciAxIEVUSA0KICAgICAqLyAgICAgDQogICAgZnVuY3Rpb24gc2V0RXRoZXJQcmljZSh1aW50IHF0eUZvck9uZUV0aGVyKSBvbmx5QWZ0ZXJFbmQNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ubHlFeGVjdXRpdmUgew0KICAgICAgICAgZXRoZXJQcmljZSA9IHF0eUZvck9uZUV0aGVyOyANCg0KICAgICAgICAgLy8gcmlzZSBldmVudCBmb3IgdGhpcw0KICAgICAgICAgTmV3RXRoZXJQcmljZShxdHlGb3JPbmVFdGhlcik7DQogICAgfSAgICANCiAgICANCg0KICAgIC8qKg0KICAgICAqICBkaXNhYmxlVG9rZW5Jc3N1YW5jZSAtIGZ1bmN0aW9uIHdpbGwgZGlzYWJsZSBhbnkgDQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uIGZvciBmdXR1cmUgdG9rZW4gDQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgaXNzdWVuY2UNCiAgICAgKi8NCiAgICBmdW5jdGlvbiBkaXNhYmxlVG9rZW5Jc3N1YW5jZSgpIG9ubHlFeGVjdXRpdmUgew0KICAgICAgICBhYmxlVG9Jc3N1ZVRva2VucyA9IGZhbHNlOw0KICAgICAgICANCiAgICAgICAgRGlzYWJsZVRva2VuSXNzdWFuY2UoKTsNCiAgICB9DQoNCiAgICANCiAgICAvKioNCiAgICAgKiAgYnVyblJlbWFpblRva2VuIC0gIGVsaW1pbmF0ZWQgYWxsIGF2YWlsYWJsZSBmb3Igc2FsZQ0KICAgICAqICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLiANCiAgICAgKi8NCiAgICBmdW5jdGlvbiBidXJuUmVtYWluVG9rZW4oKSBvbmx5RXhlY3V0aXZlIHsNCiAgICANCiAgICAgICAgdG90YWxTdXBwbHkgLT0gYmFsYW5jZXNbdGhpc107DQogICAgICAgIGJhbGFuY2VzW3RoaXNdID0gMDsNCiAgICAgICAgDQogICAgICAgIC8vIHJpc2UgZXZlbnQgZm9yIHRoaXMNCiAgICAgICAgQnVybmVkQWxsUmVtYWluZWRUb2tlbnMoKTsNCiAgICB9DQogICAgDQogICAgLyoqDQogICAgICogIHN1Ym1pdEV0aGVyUHJvcG9zYWw6IHN1Ym1pdCBwcm9wb3NhbCB0byB1c2UgcGFydCBvZiB0aGUgDQogICAgICogICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZCBldGhlciBmdW5kcw0KICAgICAqDQogICAgICogICBAcGFyYW0gcmVxdWVzdFZhbHVlIHVpbnQ6IHZhbHVlIGluIHdlaSANCiAgICAgKiAgIEBwYXJhbSB1cmwgc3RyaW5nOiBkZXRhaWxzIG9mIHRoZSBwcm9wb3NhbCANCiAgICAgKi8gDQogICAgZnVuY3Rpb24gc3VibWl0RXRoZXJQcm9wb3NhbCh1aW50IHJlcXVlc3RWYWx1ZSwgc3RyaW5nIHVybCkgb25seUFmdGVyRW5kIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ubHlFeGVjdXRpdmUgcmV0dXJucyAoYnl0ZXMzMiByZXN1bHRJZCwgYm9vbCByZXN1bHRTdWNjZXMpIHsgICAgICAgDQogICAgDQogICAgICAgIC8vIGVuc3VyZSB0aGVyZSBpcyBubyBtb3JlIGlzc3VlbmNlIGF2YWlsYWJsZSANCiAgICAgICAgaWYgKGFibGVUb0lzc3VlVG9rZW5zKSB0aHJvdzsNCiAgICAgICAgICAgIA0KICAgICAgICAvLyBlbnN1cmUgdGhlcmUgaXMgbm8gbW9yZSB0b2tlbnMgYXZhaWxhYmxlIA0KICAgICAgICBpZiAoYmFsYW5jZU9mKHRoaXMpID4gMCkgdGhyb3c7DQoNCiAgICAgICAgLy8gUG9zc2libGUgdG8gc3VibWl0IGEgcHJvcG9zYWwgb25jZSAyIHdlZWtzIA0KICAgICAgICBpZiAobm93IDwgKHRpbWVPZkxhc3RQcm9wb3NhbCArIDIgd2Vla3MpKSB0aHJvdzsNCiAgICAgICAgICAgIA0KICAgICAgICB1aW50IHBlcmNlbnQgPSBjb2xsZWN0ZWRFdGhlciAvIDEwMDsNCiAgICAgICAgICAgIA0KICAgICAgICBpZiAocmVxdWVzdFZhbHVlID4gUFJPUE9TQUxfRlVORFNfVEggKiBwZXJjZW50KSB0aHJvdzsNCg0KICAgICAgICAvLyBpZiByZW1haW5lZCB2YWx1ZSBpcyBsZXNzIHRoYW4gcmVxdWVzdGVkIGdhaW4gYWxsLg0KICAgICAgICBpZiAocmVxdWVzdFZhbHVlID4gdGhpcy5iYWxhbmNlKSANCiAgICAgICAgICAgIHJlcXVlc3RWYWx1ZSA9IHRoaXMuYmFsYW5jZTsgICAgDQogICAgICAgICAgICANCiAgICAgICAgLy8gc2V0IGlkIG9mIHRoZSBwcm9wb3NhbA0KICAgICAgICAvLyBzdWJtaXQgcHJvcG9zYWwgdG8gdGhlIG1hcA0KICAgICAgICBieXRlczMyIGlkID0gc2hhMyhtc2cuZGF0YSwgbm93KTsNCiAgICAgICAgdWludCB0aW1lRW5kcyA9IG5vdyArIFBST1BPU0FMX0xJRkVUSU1FOyANCiAgICAgICAgICAgIA0KICAgICAgICBQcm9wb3NhbCBtZW1vcnkgbmV3UHJvcG9zYWwgPSBQcm9wb3NhbChpZCwgcmVxdWVzdFZhbHVlLCB1cmwsIHRpbWVFbmRzLCAwLCBtc2cuc2VuZGVyLCBmYWxzZSwgUHJvcG9zYWxDdXJyZW5jeS5FVEhFUik7DQogICAgICAgIHByb3Bvc2Fsc1tpZF0gPSBuZXdQcm9wb3NhbDsNCiAgICAgICAgbGlzdFByb3Bvc2Fscy5wdXNoKG5ld1Byb3Bvc2FsKTsNCiAgICAgICAgICAgIA0KICAgICAgICB0aW1lT2ZMYXN0UHJvcG9zYWwgPSBub3c7ICAgICAgICAgICAgICAgICAgICAgICAgDQogICAgICAgIFByb3Bvc2FsUmVxdWVzdFN1Ym1pdHRlZChpZCwgcmVxdWVzdFZhbHVlLCB0aW1lRW5kcywgdXJsLCBtc2cuc2VuZGVyKTsNCiAgICAgICAgDQogICAgICAgIHJldHVybiAoaWQsIHRydWUpOw0KICAgIH0NCiAgICANCiAgICANCiAgICAgDQogICAgLyoqDQogICAgICogDQogICAgICogc3VibWl0SEtHUHJvcG9zYWwgLSBzdWJtaXQgcHJvcG9zYWwgdG8gcmVxdWVzdCBmb3IgDQogICAgICogICAgICAgICAgICAgICAgICAgICBwYXJ0aWFsIEhLRyBmdW5kcyBjb2xsZWN0ZWQgDQogICAgICogDQogICAgICogIEBwYXJhbSByZXF1ZXN0VmFsdWUgdWludDogdmFsdWUgaW4gSEtHIHRvIHJlcXVlc3QuIA0KICAgICAqICBAcGFyYW0gdXJsIHN0cmluZzogdXJsIHdpdGggZGV0YWlscyBvbiB0aGUgcHJvcG9zaXRpb24gDQogICAgICovDQogICAgZnVuY3Rpb24gc3VibWl0SEtHUHJvcG9zYWwodWludCByZXF1ZXN0VmFsdWUsIHN0cmluZyB1cmwpIG9ubHlBZnRlckVuZA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbmx5RXhlY3V0aXZlIHJldHVybnMgKGJ5dGVzMzIgcmVzdWx0SWQsIGJvb2wgcmVzdWx0U3VjY2VzKXsNCiAgICAgICAgDQoNCiAgICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gMiBtb250aHMgb3ZlciBzaW5jZSB0aGUgbGFzdCBldmVudC4NCiAgICAgICAgLy8gVGhlcmUgaXMgbm8gcG9zaWJsZSB0byBnZXQgYW55IEhLRy4gQWZ0ZXIgMiBtb250aHMNCiAgICAgICAgLy8gYWxsIHRoZSBIS0cgaXMgYXZhaWxhYmxlLiANCiAgICAgICAgaWYgKG5vdyA8IChldmVudEluZm8uZ2V0RXZlbnRFbmQoKSArIDggd2Vla3MpKSB7DQogICAgICAgICAgICB0aHJvdzsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vIFBvc3NpYmxlIHRvIHN1Ym1pdCBhIHByb3Bvc2FsIG9uY2UgMiB3ZWVrcyANCiAgICAgICAgaWYgKG5vdyA8ICh0aW1lT2ZMYXN0UHJvcG9zYWwgKyAyIHdlZWtzKSkgdGhyb3c7DQoNCiAgICAgICAgdWludCBwZXJjZW50ID0gcHJlZmVyZWRRdHlTb2xkIC8gMTAwOw0KICAgICAgICANCiAgICAgICAgLy8gdmFsaWRhdGUgdGhlIGFtb3VudCBpcyBsZWdpdA0KICAgICAgICAvLyBmaXJzdCA1IHByb3Bvc2FscyBzaG91bGQgYmUgbGVzcyB0aGFuIDIwJSANCiAgICAgICAgaWYgKGNvdW50ZXJQcm9wb3NhbHMgPD0gNSAmJiANCiAgICAgICAgICAgIHJlcXVlc3RWYWx1ZSAgICAgPiAgUFJPUE9TQUxfRlVORFNfVEggKiBwZXJjZW50KSB0aHJvdzsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgLy8gaWYgcmVtYWluZWQgdmFsdWUgaXMgbGVzcyB0aGFuIHJlcXVlc3RlZCANCiAgICAgICAgLy8gZ2FpbiBhbGwuDQogICAgICAgIGlmIChyZXF1ZXN0VmFsdWUgPiBnZXRIS0dPd25lZCgpKSANCiAgICAgICAgICAgIHJlcXVlc3RWYWx1ZSA9IGdldEhLR093bmVkKCk7DQogICAgICAgIA0KICAgICAgICANCiAgICAgICAgLy8gc2V0IGlkIG9mIHRoZSBwcm9wb3NhbA0KICAgICAgICAvLyBzdWJtaXQgcHJvcG9zYWwgdG8gdGhlIG1hcA0KICAgICAgICBieXRlczMyIGlkID0gc2hhMyhtc2cuZGF0YSwgbm93KTsNCiAgICAgICAgdWludCB0aW1lRW5kcyA9IG5vdyArIFBST1BPU0FMX0xJRkVUSU1FOyANCiAgICAgICAgDQogICAgICAgIFByb3Bvc2FsIG1lbW9yeSBuZXdQcm9wb3NhbCA9IFByb3Bvc2FsKGlkLCByZXF1ZXN0VmFsdWUsIHVybCwgdGltZUVuZHMsIDAsIG1zZy5zZW5kZXIsIGZhbHNlLCBQcm9wb3NhbEN1cnJlbmN5LkhLRyk7DQogICAgICAgIHByb3Bvc2Fsc1tpZF0gPSBuZXdQcm9wb3NhbDsNCiAgICAgICAgbGlzdFByb3Bvc2Fscy5wdXNoKG5ld1Byb3Bvc2FsKTsNCiAgICAgICAgDQogICAgICAgICsrY291bnRlclByb3Bvc2FsczsNCiAgICAgICAgdGltZU9mTGFzdFByb3Bvc2FsID0gbm93OyAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICANCiAgICAgICAgUHJvcG9zYWxSZXF1ZXN0U3VibWl0dGVkKGlkLCByZXF1ZXN0VmFsdWUsIHRpbWVFbmRzLCB1cmwsIG1zZy5zZW5kZXIpOw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIChpZCwgdHJ1ZSk7ICAgICAgICANCiAgICB9ICANCiAgICANCiAgICANCiAgICANCiAgICAvKioNCiAgICAgKiBvYmplY3RQcm9wb3NhbCAtIG9iamVjdCBwcmV2aW91c2x5IHN1Ym1pdHRlZCBwcm9wb3NhbCwgDQogICAgICogICAgICAgICAgICAgICAgICB0aGUgb2JqZWN0aW9uIHJpZ2h0IGlzIG9idGFpbmVkIGJ5IA0KICAgICAqICAgICAgICAgICAgICAgICAgcHVyY2hhc2luZyBwcmVmZXJlZCB0b2tlbnMgb24gdGltZSBvZiANCiAgICAgKiAgICAgICAgICAgICAgICAgIHRoZSBoYWNrYXRob24uDQogICAgICogDQogICAgICogIEBwYXJhbSBpZCBieXRlczMyIDogdGhlIGlkIG9mIHRoZSBwcm9wb3NsYSB0byByZWRlZW0NCiAgICAgKi8NCiAgICAgZnVuY3Rpb24gb2JqZWN0UHJvcG9zYWwoYnl0ZXMzMiBpZCl7DQogICAgICAgICANCiAgICAgICAgUHJvcG9zYWwgbWVtb3J5IHByb3Bvc2FsID0gcHJvcG9zYWxzW2lkXTsNCiAgICAgICAgIA0KICAgICAgICAvLyBjaGVjayBwcm9wb3NhbCBleGlzdCANCiAgICAgICAgaWYgKHByb3Bvc2Fsc1tpZF0uaWQgPT0gMCkgdGhyb3c7DQoNCiAgICAgICAgLy8gY2hlY2sgYWxyZWFkeSByZWRlZW1lZA0KICAgICAgICBpZiAocHJvcG9zYWxzW2lkXS5yZWRlZW1lZCkgdGhyb3c7DQogICAgICAgICANCiAgICAgICAgLy8gZW5zdXJlIG9iamVjdGlvbiB0aW1lDQogICAgICAgIGlmIChub3cgPj0gcHJvcG9zYWxzW2lkXS52b3RpbmRFbmRUUykgdGhyb3c7DQogICAgICAgICANCiAgICAgICAgLy8gZW5zdXJlIG5vdCB2b3RlZCAgDQogICAgICAgIGlmIChwcm9wb3NhbHNbaWRdLnZvdGVkW21zZy5zZW5kZXJdKSB0aHJvdzsNCiAgICAgICAgIA0KICAgICAgICAgLy8gc3VibWl0IHZvdGVzDQogICAgICAgICB1aW50IHZvdGVzID0gdm90aW5nUmlnaHRzW21zZy5zZW5kZXJdOw0KICAgICAgICAgcHJvcG9zYWxzW2lkXS52b3Rlc09iamVjdGluZyArPSB2b3RlczsNCiAgICAgICAgIA0KICAgICAgICAgLy8gbWFyayB2b3RlZCANCiAgICAgICAgIHByb3Bvc2Fsc1tpZF0udm90ZWRbbXNnLnNlbmRlcl0gPSB0cnVlOyANCiAgICAgICAgIA0KICAgICAgICAgdWludCBpZHggPSBnZXRJbmRleEJ5UHJvcG9zYWxJZChpZCk7DQogICAgICAgICBsaXN0UHJvcG9zYWxzW2lkeF0gPSBwcm9wb3NhbHNbaWRdOyAgIA0KDQogICAgICAgICBPYmplY3RlZFZvdGUoaWQsIG1zZy5zZW5kZXIsIHZvdGVzKTsgICAgICAgICANCiAgICAgfQ0KICAgICANCiAgICAgDQogICAgIGZ1bmN0aW9uIGdldEluZGV4QnlQcm9wb3NhbElkKGJ5dGVzMzIgaWQpIHJldHVybnMgKHVpbnQgcmVzdWx0KXsNCiAgICAgICAgIA0KICAgICAgICAgZm9yICh1aW50IGkgPSAwOyBpIDwgbGlzdFByb3Bvc2Fscy5sZW5ndGg7ICsraSl7DQogICAgICAgICAgICAgaWYgKGlkID09IGxpc3RQcm9wb3NhbHNbaV0uaWQpIHJldHVybiBpOw0KICAgICAgICAgfQ0KICAgICB9DQogICAgDQogICAgDQogICANCiAgICAvKioNCiAgICAgKiByZWRlZW1Qcm9wb3NhbEZ1bmRzIC0gcmVkZWVtIGZ1bmRzIHJlcXVlc3RlZCBieSBwcmlvciANCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgc3VibWl0dGVkIHByb3Bvc2FsICAgICANCiAgICAgKiANCiAgICAgKiBAcGFyYW0gaWQgYnl0ZXMzMjogdGhlIGlkIG9mIHRoZSBwcm9wb3NhbCB0byByZWRlZW0NCiAgICAgKi8NCiAgICBmdW5jdGlvbiByZWRlZW1Qcm9wb3NhbEZ1bmRzKGJ5dGVzMzIgaWQpIG9ubHlFeGVjdXRpdmUgew0KDQogICAgICAgIGlmIChwcm9wb3NhbHNbaWRdLmlkID09IDApIHRocm93Ow0KICAgICAgICBpZiAocHJvcG9zYWxzW2lkXS5zdWJtaXR0ZXIgIT0gbXNnLnNlbmRlcikgdGhyb3c7DQoNCiAgICAgICAgLy8gZW5zdXJlIG9iamVjdGlvbiB0aW1lDQogICAgICAgIGlmIChub3cgPCBwcm9wb3NhbHNbaWRdLnZvdGluZEVuZFRTKSB0aHJvdzsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIA0KICAgIA0KICAgICAgICAgICAgLy8gY2hlY2sgYWxyZWFkeSByZWRlZW1lZA0KICAgICAgICBpZiAocHJvcG9zYWxzW2lkXS5yZWRlZW1lZCkgdGhyb3c7DQoNCiAgICAgICAgLy8gY2hlY2sgdm90ZXMgb2JqZWN0aW9uID0+IDU1JSBvZiB0b3RhbCB2b3Rlcw0KICAgICAgICB1aW50IG9iamVjdGlvblRocmVzaG9sZCA9IHByZWZlcmVkUXR5U29sZCAvIDEwMCAqIDU1Ow0KICAgICAgICBpZiAocHJvcG9zYWxzW2lkXS52b3Rlc09iamVjdGluZyAgPiBvYmplY3Rpb25UaHJlc2hvbGQpIHRocm93Ow0KICAgIA0KICAgIA0KICAgICAgICBpZiAocHJvcG9zYWxzW2lkXS5wcm9wb3NhbEN1cnJlbmN5ID09IFByb3Bvc2FsQ3VycmVuY3kuSEtHKXsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLy8gc2VuZCBoYWNrZXIgZ29sZCANCiAgICAgICAgICAgIGhhY2tlckdvbGQudHJhbnNmZXIocHJvcG9zYWxzW2lkXS5zdWJtaXR0ZXIsIHByb3Bvc2Fsc1tpZF0udmFsdWUpOyAgICAgIA0KICAgICAgICAgICAgICAgICAgICAgICAgDQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgLy8gc2VuZCBldGhlciAgICAgICAgICAgICAgDQogICAgICAgICAgIGJvb2wgc3VjY2VzcyA9IHByb3Bvc2Fsc1tpZF0uc3VibWl0dGVyLnNlbmQocHJvcG9zYWxzW2lkXS52YWx1ZSk7IA0KDQogICAgICAgICAgIC8vIHJpc2UgZXZlbnQNCiAgICAgICAgICAgRXRoZXJSZWRlZW1BY2NlcHRlZChwcm9wb3NhbHNbaWRdLnN1Ym1pdHRlciwgcHJvcG9zYWxzW2lkXS52YWx1ZSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgDQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIC8vIGV4ZWN1dGUgdGhlIHByb3Bvc2FsIA0KICAgICAgICBwcm9wb3NhbHNbaWRdLnJlZGVlbWVkID0gdHJ1ZTsgDQogICAgfQ0KICAgIA0KICAgIA0KICAgIC8qKg0KICAgICAqICBnZXRBbGxUaGVGdW5kcyAtIHRvIGVuc3VyZSB0aGVyZSBpcyBubyBkZWFkbG9jayBjYW4gDQogICAgICogICAgICAgICAgICAgICAgICAgY2FuIGhhcHBlbiwgYW5kIG5vIGNhc2UgdGhhdCB2b3RpbmcgDQogICAgICogICAgICAgICAgICAgICAgICAgc3RydWN0dXJlIHdpbGwgZnJlZXplIHRoZSBmdW5kcyBmb3JldmVyDQogICAgICogICAgICAgICAgICAgICAgICAgdGhlIHN0YXJ0dXAgd2lsbCBiZSBhYmxlIHRvIGdldCBhbGwgdGhlDQogICAgICogICAgICAgICAgICAgICAgICAgZnVuZHMgd2l0aG91dCBhIHByb3Bvc2FsIHJlcXVpcmVkIGFmdGVyDQogICAgICogICAgICAgICAgICAgICAgICAgNiBtb250aHMuDQogICAgICogDQogICAgICogDQogICAgICovICAgICAgICAgICAgIA0KICAgIGZ1bmN0aW9uIGdldEFsbFRoZUZ1bmRzKCkgb25seUV4ZWN1dGl2ZSB7DQogICAgICAgIA0KICAgICAgICAvLyBJZiB0aGVyZSBpcyBhIGRlYWRsb2NrIGluIHZvdGluZyBwYXJ0aWNpcGF0ZXMNCiAgICAgICAgLy8gdGhlIGZ1bmRzIGNhbiBiZSByZWRlZW1lZCBjb21wbGV0ZWxseSBpbiA2IG1vbnRocw0KICAgICAgICBpZiAobm93IDwgKGV2ZW50SW5mby5nZXRFdmVudEVuZCgpICsgMjQgd2Vla3MpKSB7DQogICAgICAgICAgICB0aHJvdzsNCiAgICAgICAgfSAgDQogICAgICAgIA0KICAgICAgICAvLyBhbGwgdGhlIEV0aGVyDQogICAgICAgIGJvb2wgc3VjY2VzcyA9IG1zZy5zZW5kZXIuc2VuZCh0aGlzLmJhbGFuY2UpOyAgICAgICAgDQogICAgICAgIA0KICAgICAgICAvLyBhbGwgdGhlIEhLRw0KICAgICAgICBoYWNrZXJHb2xkLnRyYW5zZmVyKG1zZy5zZW5kZXIsIGdldEhLR093bmVkKCkpOyAgICAgICAgICAgICAgDQogICAgfQ0KICAgIA0KICAgIA0KICAgIC8qKg0KICAgICAqIHN1Ym1pdEltcGVhY2htZW50UHJvcG9zYWwgLSBzdWJtaXQgcmVxdWVzdCB0byBzd2l0Y2ggDQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWN1dGl2ZS4NCiAgICAgKiANCiAgICAgKiAgQHBhcmFtIHVybERldGFpbHMgIC0gZGV0YWlscyBvZiB0aGUgaW1wZWFjaG1lbnQgcHJvcG9zYWwgDQogICAgICogIEBwYXJhbSBuZXdFeGVjdXRpdmUgLSBhZGRyZXNzIG9mIHRoZSBuZXcgZXhlY3V0aXZlIA0KICAgICAqIA0KICAgICAqLyAgICAgICAgICAgICANCiAgICAgZnVuY3Rpb24gc3VibWl0SW1wZWFjaG1lbnRQcm9wb3NhbChzdHJpbmcgdXJsRGV0YWlscywgYWRkcmVzcyBuZXdFeGVjdXRpdmUpew0KICAgICAgICAgDQogICAgICAgIC8vIHRvIG9mZmVyIGltcGVhY2htZW50IHlvdSBzaG91bGQgaGF2ZSANCiAgICAgICAgLy8gdm90aW5nIHJpZ2h0cw0KICAgICAgICBpZiAodm90aW5nUmlnaHRzW21zZy5zZW5kZXJdID09IDApIHRocm93Ow0KICAgICAgICAgDQogICAgICAgIC8vIHRoZSBzdWJtaXNzaW9uIG9mIHRoZSBmaXJzdCBpbXBlYWNobWVudCANCiAgICAgICAgLy8gcHJvcG9zYWwgaXMgcG9zc2libGUgb25seSBhZnRlciAzIG1vbnRocw0KICAgICAgICAvLyBzaW5jZSB0aGUgaGFja2F0aG9uIGlzIG92ZXINCiAgICAgICAgaWYgKG5vdyA8IChldmVudEluZm8uZ2V0RXZlbnRFbmQoKSArIDEyIHdlZWtzKSkgdGhyb3c7DQogICAgICAgIA0KICAgICAgICAgICAgICAgIA0KICAgICAgICAvLyBjaGVjayB0aGVyZSBpcyAxIG1vbnRocyBvdmVyIHNpbmNlIGxhc3Qgb25lDQogICAgICAgIGlmIChsYXN0SW1wZWFjaG1lbnRQcm9wb3NhbC52b3RpbmRFbmRUUyAhPSAwICYmIA0KICAgICAgICAgICAgbGFzdEltcGVhY2htZW50UHJvcG9zYWwudm90aW5kRW5kVFMgKyAgMiB3ZWVrcyA+IG5vdykgdGhyb3c7DQoNCg0KICAgICAgICAvLyBzdWJtaXQgaW1wZWFjaG1lbnQgcHJvcG9zYWwNCiAgICAgICAgLy8gYWRkIHRoZSB2b3RlcyBvZiB0aGUgc3VibWl0dGVyIA0KICAgICAgICAvLyB0byB0aGUgcHJvcG9zYWwgcmlnaHQgYXdheQ0KICAgICAgICBsYXN0SW1wZWFjaG1lbnRQcm9wb3NhbCA9IEltcGVhY2htZW50UHJvcG9zYWwodXJsRGV0YWlscywgbmV3RXhlY3V0aXZlLCBub3cgKyAyIHdlZWtzLCB2b3RpbmdSaWdodHNbbXNnLnNlbmRlcl0pOw0KICAgICAgICBsYXN0SW1wZWFjaG1lbnRQcm9wb3NhbC52b3RlZFttc2cuc2VuZGVyXSA9IHRydWU7DQogICAgICAgICANCiAgICAgICAgLy8gcmlzZSBldmVudA0KICAgICAgICBJbXBlYWNobWVudFByb3Bvc2VkKG1zZy5zZW5kZXIsIHVybERldGFpbHMsIG5vdyArIDIgd2Vla3MsIG5ld0V4ZWN1dGl2ZSk7DQogICAgIH0NCiAgICANCiAgICANCiAgICAvKioNCiAgICAgKiBzdXBwb3J0SW1wZWFjaG1lbnQgLSB2b3RlIGZvciBpbXBlYWNobWVudCBwcm9wb3NhbCANCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICB0aGF0IGlzIGN1cnJlbnRseSBpbiBwcm9ncmVzcw0KICAgICAqDQogICAgICovDQogICAgZnVuY3Rpb24gc3VwcG9ydEltcGVhY2htZW50KCl7DQoNCiAgICAgICAgLy8gZW5zdXJlIHRoYXQgc3VwcG9ydCBpcyBmb3IgZXhpc3QgcHJvcG9zYWwgDQogICAgICAgIGlmIChsYXN0SW1wZWFjaG1lbnRQcm9wb3NhbC5uZXdFeGVjdXRpdmUgPT0gMHgwKSB0aHJvdzsNCiAgICANCiAgICAgICAgLy8gdG8gb2ZmZXIgaW1wZWFjaG1lbnQgeW91IHNob3VsZCBoYXZlIA0KICAgICAgICAvLyB2b3RpbmcgcmlnaHRzDQogICAgICAgIGlmICh2b3RpbmdSaWdodHNbbXNnLnNlbmRlcl0gPT0gMCkgdGhyb3c7DQogICAgICAgIA0KICAgICAgICAvLyBjaGVjayBpZiBub3Qgdm90ZWQgYWxyZWFkeSANCiAgICAgICAgaWYgKGxhc3RJbXBlYWNobWVudFByb3Bvc2FsLnZvdGVkW21zZy5zZW5kZXJdKSB0aHJvdzsNCiAgICAgICAgDQogICAgICAgIC8vIGNoZWNrIGlmIG5vdCBmaW5pc2hlZCB0aGUgMiB3ZWVrcyBvZiB2b3RpbmcgDQogICAgICAgIGlmIChsYXN0SW1wZWFjaG1lbnRQcm9wb3NhbC52b3RpbmRFbmRUUyArIDIgd2Vla3MgPD0gbm93KSB0aHJvdzsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgLy8gc3VwcG9ydCB0aGUgaW1wZWFjaG1lbnQNCiAgICAgICAgbGFzdEltcGVhY2htZW50UHJvcG9zYWwudm90ZWRbbXNnLnNlbmRlcl0gPSB0cnVlOw0KICAgICAgICBsYXN0SW1wZWFjaG1lbnRQcm9wb3NhbC52b3Rlc1N1cHBvcnRpbmcgKz0gdm90aW5nUmlnaHRzW21zZy5zZW5kZXJdOw0KDQogICAgICAgIC8vIHJpc2UgaW1wZWFjaG1lbnQgc3VwcHBvcnRpbmcgZXZlbnQNCiAgICAgICAgSW1wZWFjaG1lbnRTdXBwb3J0KG1zZy5zZW5kZXIsIHZvdGluZ1JpZ2h0c1ttc2cuc2VuZGVyXSk7DQogICAgICAgIA0KICAgICAgICAvLyBpZiB0aGUgdm90ZSBpcyBvdmVyIDcwJSBleGVjdXRlIHRoZSBzd2l0Y2ggDQogICAgICAgIHVpbnQgcGVyY2VudCA9IHByZWZlcmVkUXR5U29sZCAvIDEwMDsgDQogICAgICAgIA0KICAgICAgICBpZiAobGFzdEltcGVhY2htZW50UHJvcG9zYWwudm90ZXNTdXBwb3J0aW5nID49IDcwICogcGVyY2VudCl7DQogICAgICAgICAgICBleGVjdXRpdmUgPSBsYXN0SW1wZWFjaG1lbnRQcm9wb3NhbC5uZXdFeGVjdXRpdmU7DQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vIGltcGVhY2htZW50IGV2ZW50DQogICAgICAgICAgICBJbXBlYWNobWVudEFjY2VwdGVkKGV4ZWN1dGl2ZSk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgfSANCiAgICANCiAgICAgIA0KICAgIA0KICAgIC8vICoqKioqKioqKioqKioqKioqKioqKioqKioqKiogLy8NCiAgICAvLyAqICAgICBDb25zdGFudCBHZXR0ZXJzICAgICAqIC8vDQogICAgLy8gKioqKioqKioqKioqKioqKioqKioqKioqKioqKiAvLw0KICAgIA0KICAgIGZ1bmN0aW9uIHZvdGluZ1JpZ2h0c09mKGFkZHJlc3MgX293bmVyKSBjb25zdGFudCByZXR1cm5zICh1aW50MjU2IHJlc3VsdCkgew0KICAgICAgICByZXN1bHQgPSB2b3RpbmdSaWdodHNbX293bmVyXTsNCiAgICB9DQogICAgDQogICAgZnVuY3Rpb24gZ2V0UHJlZmVyZWRRdHlTb2xkKCkgY29uc3RhbnQgcmV0dXJucyAodWludCByZXN1bHQpew0KICAgICAgICByZXR1cm4gcHJlZmVyZWRRdHlTb2xkOw0KICAgIH0NCiAgICANCiAgICBmdW5jdGlvbiBzZXRWaXJ0dWFsRXhjaGFuZ2UoYWRkcmVzcyB2aXJ0dWFsRXhjaGFuZ2VBZGRyKXsNCiAgICAgICAgdmlydHVhbEV4Y2hhbmdlQWRkcmVzcyA9IHZpcnR1YWxFeGNoYW5nZUFkZHI7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gZ2V0SEtHT3duZWQoKSBjb25zdGFudCByZXR1cm5zICh1aW50IHJlc3VsdCl7DQogICAgICAgIHJldHVybiBoYWNrZXJHb2xkLmJhbGFuY2VPZih0aGlzKTsNCiAgICB9DQogICAgDQogICAgZnVuY3Rpb24gZ2V0RXRoZXJWYWx1ZSgpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgcmVzdWx0KXsNCiAgICAgICAgcmV0dXJuIHRoaXMuYmFsYW5jZTsNCiAgICB9DQogICAgDQogICAgZnVuY3Rpb24gZ2V0RXhlY3V0aXZlKCkgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcyByZXN1bHQpew0KICAgICAgICByZXR1cm4gZXhlY3V0aXZlOw0KICAgIH0NCiAgICANCiAgICBmdW5jdGlvbiBnZXRIS0dQcmljZSgpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgcmVzdWx0KXsNCiAgICAgICAgcmV0dXJuIGhrZ1ByaWNlOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGdldEV0aGVyUHJpY2UoKSBjb25zdGFudCByZXR1cm5zICh1aW50IHJlc3VsdCl7DQogICAgICAgIHJldHVybiBldGhlclByaWNlOw0KICAgIH0NCiAgICANCiAgICBmdW5jdGlvbiBnZXREU1ROYW1lKCkgY29uc3RhbnQgcmV0dXJucyhzdHJpbmcgcmVzdWx0KXsNCiAgICAgICAgcmV0dXJuIG5hbWU7DQogICAgfSAgICANCiAgICANCiAgICBmdW5jdGlvbiBnZXREU1ROYW1lQnl0ZXMoKSBjb25zdGFudCByZXR1cm5zKGJ5dGVzMzIgcmVzdWx0KXsNCiAgICAgICAgcmV0dXJuIGNvbnZlcnQobmFtZSk7DQogICAgfSAgICANCg0KICAgIGZ1bmN0aW9uIGdldERTVFN5bWJvbCgpIGNvbnN0YW50IHJldHVybnMoc3RyaW5nIHJlc3VsdCl7DQogICAgICAgIHJldHVybiBzeW1ib2w7DQogICAgfSAgICANCiAgICANCiAgICBmdW5jdGlvbiBnZXREU1RTeW1ib2xCeXRlcygpIGNvbnN0YW50IHJldHVybnMoYnl0ZXMzMiByZXN1bHQpew0KICAgICAgICByZXR1cm4gY29udmVydChzeW1ib2wpOw0KICAgIH0gICAgDQoNCiAgICBmdW5jdGlvbiBnZXRBZGRyZXNzKCkgY29uc3RhbnQgcmV0dXJucyAoYWRkcmVzcyByZXN1bHQpIHsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KICAgIA0KICAgIGZ1bmN0aW9uIGdldFRvdGFsU3VwcGx5KCkgY29uc3RhbnQgcmV0dXJucyAodWludCByZXN1bHQpIHsNCiAgICAgICAgcmV0dXJuIHRvdGFsU3VwcGx5Ow0KICAgIH0gDQogICAgICAgIA0KICAgIGZ1bmN0aW9uIGdldENvbGxlY3RlZEV0aGVyKCkgY29uc3RhbnQgcmV0dXJucyAodWludCByZXN1bHRzKSB7ICAgICAgICANCiAgICAgICAgcmV0dXJuIGNvbGxlY3RlZEV0aGVyOw0KICAgIH0NCiAgICANCiAgICBmdW5jdGlvbiBnZXRDb3VudGVyUHJvcG9zYWxzKCkgY29uc3RhbnQgcmV0dXJucyAodWludCByZXN1bHQpew0KICAgICAgICByZXR1cm4gY291bnRlclByb3Bvc2FsczsNCiAgICB9DQogICAgICAgIA0KICAgIGZ1bmN0aW9uIGdldFByb3Bvc2FsSWRCeUluZGV4KHVpbnQgaSkgY29uc3RhbnQgcmV0dXJucyAoYnl0ZXMzMiByZXN1bHQpew0KICAgICAgICByZXR1cm4gbGlzdFByb3Bvc2Fsc1tpXS5pZDsNCiAgICB9ICAgIA0KDQogICAgZnVuY3Rpb24gZ2V0UHJvcG9zYWxPYmplY3Rpb25CeUluZGV4KHVpbnQgaSkgY29uc3RhbnQgcmV0dXJucyAodWludCByZXN1bHQpew0KICAgICAgICByZXR1cm4gbGlzdFByb3Bvc2Fsc1tpXS52b3Rlc09iamVjdGluZzsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBnZXRQcm9wb3NhbFZhbHVlQnlJbmRleCh1aW50IGkpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgcmVzdWx0KXsNCiAgICAgICAgcmV0dXJuIGxpc3RQcm9wb3NhbHNbaV0udmFsdWU7DQogICAgfSAgICAgICAgICAgICAgICAgIA0KICAgIA0KICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRJbXBlYWNobWVudFVybERldGFpbHMoKSBjb25zdGFudCByZXR1cm5zIChzdHJpbmcgcmVzdWx0KXsNCiAgICAgICAgcmV0dXJuIGxhc3RJbXBlYWNobWVudFByb3Bvc2FsLnVybERldGFpbHM7DQogICAgfQ0KICAgIA0KICAgIA0KICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRJbXBlYWNobWVudFZvdGVzU3VwcG9ydGluZygpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgcmVzdWx0KXsNCiAgICAgICAgcmV0dXJuIGxhc3RJbXBlYWNobWVudFByb3Bvc2FsLnZvdGVzU3VwcG9ydGluZzsNCiAgICB9DQogICAgDQogICAgZnVuY3Rpb24gY29udmVydChzdHJpbmcga2V5KSByZXR1cm5zIChieXRlczMyIHJldCkgew0KICAgICAgICAgICAgaWYgKGJ5dGVzKGtleSkubGVuZ3RoID4gMzIpIHsNCiAgICAgICAgICAgICAgICB0aHJvdzsNCiAgICAgICAgICAgIH0gICAgICANCg0KICAgICAgICAgICAgYXNzZW1ibHkgew0KICAgICAgICAgICAgICAgIHJldCA6PSBtbG9hZChhZGQoa2V5LCAzMikpDQogICAgICAgICAgICB9DQogICAgfSAgICANCiAgICANCiAgICANCiAgICANCiAgICAvLyAqKioqKioqKioqKioqKioqKioqKiogLy8NCiAgICAvLyAqICAgICBNb2RpZmllcnMgICAgICogLy8NCiAgICAvLyAqKioqKioqKioqKioqKioqKioqKiogLy8gICAgDQogDQogICAgbW9kaWZpZXIgb25seUJlZm9yZUVuZCgpIHsgaWYgKG5vdyAgPj0gIGV2ZW50SW5mby5nZXRFdmVudEVuZCgpKSB0aHJvdzsgXzsgfQ0KICAgIG1vZGlmaWVyIG9ubHlBZnRlckVuZCgpICB7IGlmIChub3cgIDwgICBldmVudEluZm8uZ2V0RXZlbnRFbmQoKSkgdGhyb3c7IF87IH0NCiAgICANCiAgICBtb2RpZmllciBvbmx5QWZ0ZXJUcmFkaW5nU3RhcnQoKSAgeyBpZiAobm93ICA8IGV2ZW50SW5mby5nZXRUcmFkaW5nU3RhcnQoKSkgdGhyb3c7IF87IH0NCiAgICANCiAgICBtb2RpZmllciBvbmx5RXhlY3V0aXZlKCkgICAgIHsgaWYgKG1zZy5zZW5kZXIgIT0gZXhlY3V0aXZlKSB0aHJvdzsgXzsgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgDQogICAgbW9kaWZpZXIgb25seUlmQWJsZVRvSXNzdWVUb2tlbnMoKSAgeyBpZiAoIWFibGVUb0lzc3VlVG9rZW5zKSB0aHJvdzsgXzsgfSANCiAgICANCg0KICAgIC8vICoqKioqKioqKioqKioqKioqKiAvLw0KICAgIC8vICogICAgIEV2ZW50cyAgICAgKiAvLw0KICAgIC8vICoqKioqKioqKioqKioqKioqKiAvLyAgICAgICAgDQoNCiAgICANCiAgICBldmVudCBQcmljZUhLR0NoYW5nZSh1aW50IGluZGV4ZWQgcXR5Rm9yT25lSEtHLCB1aW50IGluZGV4ZWQgdG9rZW5zU29sZCwgdWludCBpbmRleGVkIHRvdGFsU3VwcGx5KTsNCiAgICBldmVudCBCdXlGb3JIS0dUcmFuc2FjdGlvbihhZGRyZXNzIGluZGV4ZWQgYnV5ZXIsIHVpbnQgaW5kZXhlZCB0b2tlbnNTb2xkLCB1aW50IGluZGV4ZWQgdG90YWxTdXBwbHksIHVpbnQgcXR5Rm9yT25lSEtHLCB1aW50IHRva2Vuc0Ftb3VudCk7DQogICAgZXZlbnQgQnV5Rm9yRXRoZXJUcmFuc2FjdGlvbihhZGRyZXNzIGluZGV4ZWQgYnV5ZXIsIHVpbnQgaW5kZXhlZCB0b2tlbnNTb2xkLCB1aW50IGluZGV4ZWQgdG90YWxTdXBwbHksIHVpbnQgcXR5Rm9yT25lRXRoZXIsIHVpbnQgdG9rZW5zQW1vdW50KTsNCg0KICAgIGV2ZW50IERzdFRva2Vuc0lzc3VlZCh1aW50IGluZGV4ZWQgcXR5Rm9yT25lSEtHLCB1aW50IGluZGV4ZWQgdG9rZW5zU29sZCwgdWludCBpbmRleGVkIHRvdGFsU3VwcGx5LCB1aW50IHF0eVRvRW1pdCk7DQogICAgDQogICAgZXZlbnQgUHJvcG9zYWxSZXF1ZXN0U3VibWl0dGVkKGJ5dGVzMzIgaWQsIHVpbnQgdmFsdWUsIHVpbnQgdGltZUVuZHMsIHN0cmluZyB1cmwsIGFkZHJlc3Mgc2VuZGVyKTsNCiAgICANCiAgICBldmVudCBFdGhlclJlZGVlbUFjY2VwdGVkKGFkZHJlc3Mgc2VuZGVyLCB1aW50IHZhbHVlKTsNCiAgICANCiAgICBldmVudCBPYmplY3RlZFZvdGUoYnl0ZXMzMiBpZCwgYWRkcmVzcyB2b3RlciwgdWludCB2b3Rlcyk7DQogICAgDQogICAgZXZlbnQgSW1wZWFjaG1lbnRQcm9wb3NlZChhZGRyZXNzIHN1Ym1pdHRlciwgc3RyaW5nIHVybERldGFpbHMsIHVpbnQgdm90aW5kRW5kVFMsIGFkZHJlc3MgbmV3RXhlY3V0aXZlKTsNCiAgICBldmVudCBJbXBlYWNobWVudFN1cHBvcnQoYWRkcmVzcyBzdXBwb3J0dGVyLCB1aW50IHZvdGVzKTsNCiAgICANCiAgICBldmVudCBJbXBlYWNobWVudEFjY2VwdGVkKGFkZHJlc3MgbmV3RXhlY3V0aXZlKTsNCg0KICAgIGV2ZW50IE5ld0V0aGVyUHJpY2UodWludCBuZXdRdHlGb3JPbmVFdGhlcik7DQogICAgZXZlbnQgRGlzYWJsZVRva2VuSXNzdWFuY2UoKTsNCiAgICANCiAgICBldmVudCBCdXJuZWRBbGxSZW1haW5lZFRva2VucygpOw0KICAgIA0KfQ0KDQoNCiANCg0KLyoqDQogKiAgVmlydHVhbEV4Y2hhbmdlIC0gIFRoZSBleGNoYW5nZSBpcyBhIHRyYWRpbmcgc3lzdGVtIHVzZWQNCiAqICAgICAgICAgICAgICAgICAgICAgb24gaGFjay5ldGhlci5jYW1wIGhhY2thdGhvbiBldmVudCB0byANCiAqICAgICAgICAgICAgICAgICAgICAgc3VwcG9ydCB0cmFkaW5nIGEgRFNUIHRva2VucyBmb3IgSEtHLiANCiAqICAgICAgICAgICAgICAgICAgICANCiAqLw0KY29udHJhY3QgVmlydHVhbEV4Y2hhbmdlew0KDQogICAgYWRkcmVzcyBvd25lcjsgIA0KICAgIEV2ZW50SW5mbyBldmVudEluZm87DQogDQogICAgbWFwcGluZyAoYnl0ZXMzMiA9PiBhZGRyZXNzKSBkc3RMaXN0ZWQ7DQogICAgDQogICAgSGFja2VyR29sZCBoYWNrZXJHb2xkOw0KICAgIA0KICAgIGZ1bmN0aW9uIFZpcnR1YWxFeGNoYW5nZShhZGRyZXNzIGhhY2tlckdvbGRBZGRyLCBhZGRyZXNzIGV2ZW50SW5mb0FkZHIpew0KICAgIA0KICAgICAgICBvd25lciA9IG1zZy5zZW5kZXI7DQogICAgICAgIGhhY2tlckdvbGQgPSBIYWNrZXJHb2xkKGhhY2tlckdvbGRBZGRyKTsNCiAgICAgICAgZXZlbnRJbmZvICA9IEV2ZW50SW5mbyhldmVudEluZm9BZGRyKTsNCiAgICB9DQogICAgDQogICAgDQogICAgLyoqDQogICAgICogZW5saXN0IC0gZW5saXN0aW5nIG9uZSBkZWNlbnRyYWxpemVkIHN0YXJ0dXAgdGVhbSB0byANCiAgICAgKiAgICAgICAgICB0aGUgaGFjayBldmVudCB2aXJ0dWFsIGV4Y2hhbmdlLCBtYWtpbmcgdGhlIA0KICAgICAqICAgICAgICAgIERTVCBpbml0YXRlZCB0b2tlbnMgYXZhaWxhYmxlIGZvciBhY3F1aXNpdGlvbi4NCiAgICAgKiANCiAgICAgKiAgQHBhcmFtIGRzdEFkZHJlc3MgLSBhZGRyZXNzIG9mIHRoZSBEU1RDb250cmFjdCANCiAgICAgKiANCiAgICAgKi8gDQogICAgZnVuY3Rpb24gZW5saXN0KGFkZHJlc3MgZHN0QWRkcmVzcykgb25seUJlZm9yZUVuZCB7DQoNCiAgICAgICAgRFNUQ29udHJhY3QgZHN0Q29udHJhY3QgPSBEU1RDb250cmFjdChkc3RBZGRyZXNzKTsNCg0KICAgICAgICBieXRlczMyIHN5bWJvbEJ5dGVzID0gZHN0Q29udHJhY3QuZ2V0RFNUU3ltYm9sQnl0ZXMoKTsNCg0KICAgICAgICAvKiBEb24ndCBlbmxpc3QgMiB3aXRoIHRoZSBzYW1lIG5hbWUgKi8NCiAgICAgICAgaWYgKGlzRXhpc3RCeUJ5dGVzKHN5bWJvbEJ5dGVzKSkgdGhyb3c7DQoNCiAgICAgICAgLy8gT25seSBvd25lciBvZiB0aGUgRFNUIGNhbiBkZXBsb3kgdGhlIERTVCANCiAgICAgICAgaWYgKGRzdENvbnRyYWN0LmdldEV4ZWN1dGl2ZSgpICE9IG1zZy5zZW5kZXIpIHRocm93Ow0KDQogICAgICAgIC8vIEFsbCBnb29kIGVubGlzdCB0aGUgY29tcGFueQ0KICAgICAgICBkc3RMaXN0ZWRbc3ltYm9sQnl0ZXNdID0gZHN0QWRkcmVzczsNCiAgICAgICAgDQogICAgICAgIC8vIEluZGljYXRlIHRvIERTVCB3aGljaCBWaXJ0dWFsIEV4Y2hhbmdlIGlzIGVubGlzdGVkDQogICAgICAgIGRzdENvbnRyYWN0LnNldFZpcnR1YWxFeGNoYW5nZShhZGRyZXNzKHRoaXMpKTsNCiAgICAgICAgDQogICAgICAgIC8vIHJpc2UgRW5saXN0ZWQgZXZlbnQNCiAgICAgICAgRW5saXN0ZWQoZHN0QWRkcmVzcyk7DQogICAgfQ0KICAgIA0KICAgDQoNCiAgICAvKioNCiAgICAgKg0KICAgICAqIGJ1eSAtIG9uIHRoZSBoYWNrYXRob24gdGltZWZyYW1lIHRoYXQgaXMgdGhlIGZ1bmN0aW9uIA0KICAgICAqICAgICAgIHRoYXQgd2lsbCBiZSB0aGUgd2F5IHRvIGJ1eSBzcGVjaWZpYyB0b2tlbnMgZm9yIA0KICAgICAqICAgICAgIHN0YXJ0dXAuDQogICAgICogDQogICAgICogQHBhcmFtIGNvbXBhbnlOYW1lQnl0ZXMgLSB0aGUgY29tcGFueSB0aGF0IGlzIGVubGlzdGVkIG9uIHRoZSBleGNoYW5nZSANCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZCB0aGUgdG9rZW5zIGFyZSBhdmFpbGFibGUNCiAgICAgKiANCiAgICAgKiBAcGFyYW0gaGtnIC0gdGhlIGFtbW91bnQgb2YgaGtnIHRvIHNwZW5kIGZvciBhcXVhc3Rpb24gDQogICAgICoNCiAgICAgKi8NCiAgICBmdW5jdGlvbiBidXkoYnl0ZXMzMiBjb21wYW55TmFtZUJ5dGVzLCB1aW50IGhrZykgb25seUJlZm9yZUVuZA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5zIChib29sIHN1Y2Nlc3MpIHsNCg0KICAgIA0KICAgICAgICAvLyBjaGVjayBEU1QgZXhpc3QgDQogICAgICAgIGlmICghaXNFeGlzdEJ5Qnl0ZXMoY29tcGFueU5hbWVCeXRlcykpIHRocm93Ow0KDQogICAgICAgIC8vIHZhbGlkYXRlIGF2YWlsYWJpbGl0eSAgDQogICAgICAgIERTVENvbnRyYWN0IGRzdENvbnRyYWN0ID0gRFNUQ29udHJhY3QoZHN0TGlzdGVkW2NvbXBhbnlOYW1lQnl0ZXNdKTsNCiAgICAgICAgdWludCB0b2tlbnNRdHkgPSBoa2cgKiBkc3RDb250cmFjdC5nZXRIS0dQcmljZSgpOw0KDQogICAgICAgIGFkZHJlc3MgdmVBZGRyZXNzID0gYWRkcmVzcyh0aGlzKTsgICAgICAgIA0KICAgICAgICANCiAgICAgICAgLy8gZW5zdXJlIHRoYXQgdGhlcmUgaXMgSEtHIGJhbGFuY2UNCiAgICAgICAgdWludCB2YWx1ZUhLR093bmVkID0gaGFja2VyR29sZC5iYWxhbmNlT2YobXNnLnNlbmRlcik7ICAgICAgICANCiAgICAgICAgaWYgKHZhbHVlSEtHT3duZWQgPCBoa2cpIHRocm93OyAgICAgICAgDQogICAgICAgIA0KICAgICAgICAvLyBlbnN1cmUgdGhhdCB0aGVyZSBpcyBIS0cgdG9rZW4gYWxsb3dlZCB0byBiZSBzcGVuZA0KICAgICAgICB1aW50IHZhbHVlQXZhaWxiZU9uRXhjaGFuZ2UgPSBoYWNrZXJHb2xkLmFsbG93YW5jZShtc2cuc2VuZGVyLCB2ZUFkZHJlc3MpOw0KICAgICAgICBpZiAodmFsdWVBdmFpbGJlT25FeGNoYW5nZSA8IGhrZykgdGhyb3c7DQoNCiAgICAgICAgLy8gZW5zdXJlIHRoZXJlIGlzIERTVCB0b2tlbnMgZm9yIHNhbGUNCiAgICAgICAgdWludCBkc3RUb2tlbnMgPSBkc3RDb250cmFjdC5hbGxvd2FuY2UoZHN0Q29udHJhY3QsIHZlQWRkcmVzcyk7DQogICAgICAgIGlmIChkc3RUb2tlbnMgPCBoa2cgKiBkc3RDb250cmFjdC5nZXRIS0dQcmljZSgpKSB0aHJvdzsgICAgDQogICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgLy8gVHJhbnNmZXIgSEtHIHRvIFZpcnR1YWwgRXhjaGFuZ2UgYWNjb3VudCAgDQogICAgICAgIGhhY2tlckdvbGQudHJhbnNmZXJGcm9tKG1zZy5zZW5kZXIsIHZlQWRkcmVzcywgaGtnKTsNCg0KICAgICAgICAvLyBUcmFuc2ZlciB0byBkc3RDb3RyYWN0IG93bmVyc2hpcA0KICAgICAgICBoYWNrZXJHb2xkLnRyYW5zZmVyKGRzdENvbnRyYWN0LmdldEFkZHJlc3MoKSwgaGtnKTsgICAgICAgICANCiAgICAgICAgDQogICAgICAgIC8vIENhbGwgRFNUIHRvIHRyYW5zZmVyIHRva2VucyANCiAgICAgICAgZHN0Q29udHJhY3QuYnV5Rm9ySGFja2VyR29sZChoa2cpOyAgICAgICAgICAgIA0KICAgIH0NCiAgICAgICAgDQoNCiAgICAvLyAqKioqKioqKioqKioqKioqKioqKioqKioqKioqIC8vDQogICAgLy8gKiAgICAgQ29uc3RhbnQgR2V0dGVycyAgICAgKiAvLw0KICAgIC8vICoqKioqKioqKioqKioqKioqKioqKioqKioqKiogLy8gICAgICAgIA0KICAgIA0KDQogICAgZnVuY3Rpb24gaXNFeGlzdEJ5Qnl0ZXMoYnl0ZXMzMiBjb21wYW55TmFtZUJ5dGVzKSBjb25zdGFudCByZXR1cm5zIChib29sIHJlc3VsdCkgew0KICAgICAgICAgICAgDQogICAgICAgIGlmIChkc3RMaXN0ZWRbY29tcGFueU5hbWVCeXRlc10gPT0gMHgwKSANCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgZWxzZSANCiAgICAgICAgICAgIHJldHVybiB0cnVlOyAgICAgICAgICAgICAgICAgIA0KICAgIH0NCiAgICANCiAgICBmdW5jdGlvbiBnZXRFdmVudFN0YXJ0KCkgY29uc3RhbnQgZXZlbnRJbmZvU2V0IHJldHVybnMgKHVpbnQgcmVzdWx0KXsNCiAgICAgICAgcmV0dXJuIGV2ZW50SW5mby5nZXRFdmVudFN0YXJ0KCk7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gZ2V0RXZlbnRFbmQoKSBjb25zdGFudCBldmVudEluZm9TZXQgcmV0dXJucyAodWludCByZXN1bHQpew0KICAgICAgICByZXR1cm4gZXZlbnRJbmZvLmdldEV2ZW50RW5kKCk7DQogICAgfQ0KICAgIA0KICAgIGZ1bmN0aW9uIGdldE5vdygpIGNvbnN0YW50IHJldHVybnMgKHVpbnQgcmVzdWx0KXsNCiAgICAgICAgcmV0dXJuIG5vdzsNCiAgICB9DQogICAgDQoNCg0KICAgIC8vICoqKioqKioqKioqKioqKioqKioqKiAvLw0KICAgIC8vICogICAgIE1vZGlmaWVycyAgICAgKiAvLw0KICAgIC8vICoqKioqKioqKioqKioqKioqKioqKiAvLyAgICAgICAgDQogICAgDQoNCiAgICBtb2RpZmllciBvbmx5T3duZXIoKSAgICB7IGlmIChtc2cuc2VuZGVyICE9IG93bmVyKSAgICAgICAgdGhyb3c7IF87IH0NCiAgICBtb2RpZmllciBldmVudEluZm9TZXQoKSB7IGlmIChldmVudEluZm8gID09IGFkZHJlc3MoMCkpICAgdGhyb3c7IF87IH0NCiAgICANCiAgICBtb2RpZmllciBvbmx5QmVmb3JlRW5kKCkgeyBpZiAobm93ICA+PSBldmVudEluZm8uZ2V0RXZlbnRFbmQoKSkgdGhyb3c7IF87IH0NCiAgICBtb2RpZmllciBvbmx5QWZ0ZXJFbmQoKSAgeyBpZiAobm93ICA8ICBldmVudEluZm8uZ2V0RXZlbnRFbmQoKSkgdGhyb3c7IF87IH0NCiAgICANCg0KICAgIC8vICoqKioqKioqKioqKioqKioqKiAvLw0KICAgIC8vICogICAgIEV2ZW50cyAgICAgKiAvLw0KICAgIC8vICoqKioqKioqKioqKioqKioqKiAvLyAgICAgICAgDQogICAgDQogICAgZXZlbnQgRW5saXN0ZWQoYWRkcmVzcyBpbmRleGVkIGRzdENvbnRyYWN0KTsNCiAgICANCiAgICANCn0='